{% extends "base.html" %}
{% block title %}Risk Şablonu · {{ s.risk_title or s.text }}{% endblock %}

{% block content %}

<style>
  :root{
    --rt-primary:#298fa3;
    --rt-canvas:#f6f7f8;
    --rt-bg:#ffffff;
    --rt-line:#e8eef3;
    --rt-muted:#507895;
    --rt-shadow: 0 6px 16px rgba(15,23,42,.06);
    --rt-radius-xl: 16px;
    --rt-radius-lg: 12px;
  }
  html.dark :root{
    --rt-bg:#0f172a;
    --rt-canvas:#131d1f;
    --rt-line: rgba(148,163,184,.20);
    --rt-muted: rgba(148,163,184,.85);
    --rt-shadow: 0 18px 35px rgba(0,0,0,.35);
  }

  .rt-shell{ max-width: 980px; margin: 0 auto; }

  .rt-topbar{
    position: sticky;
    top: 8px;
    z-index: 10;
    border: 1px solid color-mix(in oklab, var(--rt-line) 100%, transparent);
    background: color-mix(in oklab, var(--rt-bg) 92%, transparent);
    backdrop-filter: blur(10px);
    border-radius: var(--rt-radius-xl);
    box-shadow: var(--rt-shadow);
    padding: .85rem 1rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:.75rem;
    margin-bottom: 1rem;
  }
  .rt-bc{
    display:flex; align-items:center; gap:.55rem;
    font-size:.9rem;
    color: var(--rt-muted);
    font-weight: 700;
    flex-wrap:wrap;
  }
  .rt-bc b{ color: inherit; font-weight: 900; }
  .rt-sep{
    opacity:.75;
    font-size: 14px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .rt-actions{ display:flex; gap:.5rem; flex-wrap:wrap; justify-content:flex-end; }

  .rt-btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.45rem;
    height: 40px;
    padding: 0 .9rem;
    border-radius: var(--rt-radius-lg);
    font-weight: 900;
    border: 1px solid transparent;
    cursor:pointer;
    transition:.15s ease;
    user-select:none;
    text-decoration:none;
    white-space:nowrap;
  }
  .rt-btn:hover{ transform: translateY(-1px); }
  .rt-btn:active{ transform: translateY(0); }

  .rt-btn-ghost{
    background: transparent;
    border-color: color-mix(in oklab, var(--rt-line) 95%, transparent);
    color: inherit;
  }
  .rt-btn-ghost:hover{ background: color-mix(in oklab, var(--rt-canvas) 88%, transparent); }

  .rt-btn-primary{
    background: var(--rt-primary);
    color:#fff;
    box-shadow: 0 10px 20px color-mix(in oklab, var(--rt-primary) 22%, transparent);
  }
  .rt-btn-primary:hover{ filter: brightness(.95); }

  .rt-ic{ font-size: 18px; line-height: 1; }

  .rt-hero{
    margin: .25rem 0 1.1rem;
    padding: 1.2rem 1.25rem;
    border-radius: var(--rt-radius-xl);
    border: 1px solid color-mix(in oklab, var(--rt-line) 100%, transparent);
    background: color-mix(in oklab, var(--rt-bg) 96%, transparent);
    box-shadow: 0 2px 0 rgba(0,0,0,.02);
  }
  .rt-pillrow{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin-bottom: .65rem; }
  .rt-pill{
    display:inline-flex; align-items:center;
    padding:.28rem .65rem;
    border-radius:999px;
    font-size: .72rem;
    font-weight: 950;
    letter-spacing: .08em;
    text-transform: uppercase;
    white-space:nowrap;
  }
  .rt-pill.primary{ background: color-mix(in oklab, var(--rt-primary) 12%, transparent); color: var(--rt-primary); }
  .rt-pill.code{ background: color-mix(in oklab, var(--rt-line) 22%, transparent); color: color-mix(in oklab, var(--rt-muted) 95%, #000); }

  .rt-title{
    font-size: 2rem;
    line-height: 1.1;
    font-weight: 950;
    letter-spacing: -0.02em;
    margin: 0 0 .55rem;
  }
  .rt-lead{
    color: var(--rt-muted);
    font-size: 1.03rem;
    line-height: 1.65;
    max-width: 72ch;
    margin: 0;
  }

  .rt-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 980px){ .rt-grid{ grid-template-columns: 1fr; } }

  .rt-card{
    border-radius: var(--rt-radius-xl);
    border: 1px solid color-mix(in oklab, var(--rt-line) 100%, transparent);
    background: color-mix(in oklab, var(--rt-bg) 96%, transparent);
    box-shadow: 0 2px 0 rgba(0,0,0,.02);
    padding: 1.25rem;
  }
  .rt-cardhead{ display:flex; align-items:center; gap:.7rem; margin-bottom: .85rem; }
  .rt-iconbox{
    width: 42px; height: 42px;
    border-radius: 12px;
    display:flex; align-items:center; justify-content:center;
    background: color-mix(in oklab, var(--rt-line) 18%, transparent);
    color: color-mix(in oklab, var(--rt-muted) 80%, #000);
  }
  .rt-cardhead h3{ margin:0; font-size: 1.05rem; font-weight: 900; letter-spacing: -0.01em; }

  .rt-body{
    color: color-mix(in oklab, var(--rt-muted) 92%, #000);
    line-height: 1.7;
    white-space: pre-wrap;
    font-size: .98rem;
  }
  html.dark .rt-body{ color: color-mix(in oklab, var(--rt-muted) 95%, #fff); }

  .rt-kpis{
    margin-top: 1rem;
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap: .9rem;
  }
  @media (max-width: 860px){ .rt-kpis{ grid-template-columns: 1fr; } }

  .rt-kpi{
    border-radius: var(--rt-radius-xl);
    border: 1px solid color-mix(in oklab, var(--rt-line) 100%, transparent);
    background: color-mix(in oklab, var(--rt-bg) 96%, transparent);
    box-shadow: 0 2px 0 rgba(0,0,0,.02);
    padding: 1rem 1.1rem;
    transition: .18s ease;
  }
  .rt-kpi:hover{ transform: translateY(-2px); }

  .rt-kpi-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
    margin-bottom: .75rem;
    color: var(--rt-muted);
    font-weight: 800;
    font-size: .92rem;
  }
  .rt-kpi-val{ display:flex; align-items:baseline; gap:.5rem; }
  .rt-kpi-num{ font-size: 2.1rem; font-weight: 950; letter-spacing: -0.03em; }
  .rt-kpi-den{ color: color-mix(in oklab, var(--rt-muted) 70%, #000); font-weight: 900; }

  .rt-bar{
    height: 8px;
    border-radius: 999px;
    overflow:hidden;
    background: color-mix(in oklab, var(--rt-line) 25%, transparent);
  }
  .rt-bar > i{
    display:block;
    height: 100%;
    background: color-mix(in oklab, var(--rt-primary) 85%, #fff);
    width: 0%; /* JS set edecek */
    transition: width .35s ease;
  }

  .rt-kpi.score{
    background: color-mix(in oklab, var(--rt-primary) 6%, var(--rt-bg));
    border: 2px solid color-mix(in oklab, var(--rt-primary) 22%, transparent);
    box-shadow: 0 10px 22px color-mix(in oklab, var(--rt-primary) 14%, transparent);
    position: relative;
    overflow:hidden;
  }
  .rt-kpi.score::after{
    content:"";
    position:absolute;
    right: -26px;
    top: -26px;
    width: 96px;
    height: 96px;
    border-radius: 999px;
    background: color-mix(in oklab, var(--rt-primary) 10%, transparent);
  }

  .rt-tag{
    display:inline-flex;
    align-items:center;
    padding:.18rem .5rem;
    border-radius: 999px;
    font-size: .68rem;
    font-weight: 950;
    letter-spacing: .08em;
    text-transform: uppercase;
    white-space:nowrap;
    margin-left: .35rem;
    border: 1px solid transparent;
  }
  .rt-tag.crit{
    background: color-mix(in oklab, #ef4444 16%, transparent);
    color: #ef4444;
    border-color: color-mix(in oklab, #ef4444 28%, transparent);
  }
  .rt-tag.mid{
    background: color-mix(in oklab, #f97316 16%, transparent);
    color: #f97316;
    border-color: color-mix(in oklab, #f97316 28%, transparent);
  }
  .rt-tag.low{
    background: color-mix(in oklab, #22c55e 16%, transparent);
    color: #22c55e;
    border-color: color-mix(in oklab, #22c55e 28%, transparent);
  }

  .rt-footer{
    margin-top: 1.1rem;
    padding-top: 1rem;
    border-top: 1px solid color-mix(in oklab, var(--rt-line) 100%, transparent);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:.75rem;
    flex-wrap:wrap;
    color: var(--rt-muted);
    font-weight: 700;
    font-size: .92rem;
  }
</style>

{% set _title = (s.risk_title or s.text) %}
{% set _cat = (s.category or 'Genel / Kategorisiz') %}
{% set _code = s.risk_code %}
{% set _desc = (s.risk_desc or s.text) %}
{% set _mit = (s.mitigation_hint if s.mitigation_hint else 'Henüz tanımlı önerilen önlem yok. Bu şablondan risk üretirken detaylandırabilirsiniz.') %}

{% set p = (s.default_prob if s.default_prob is not none else None) %}
{% set sev = (s.default_sev if s.default_sev is not none else None) %}
{% set score = (p * sev if (p is not none and sev is not none) else None) %}

{% if score is not none %}
  {% if score >= 12 %}
    {% set score_tag = 'Kritik' %}
    {% set score_tag_cls = 'crit' %}
  {% elif score >= 8 %}
    {% set score_tag = 'Orta' %}
    {% set score_tag_cls = 'mid' %}
  {% else %}
    {% set score_tag = 'Düşük' %}
    {% set score_tag_cls = 'low' %}
  {% endif %}
{% endif %}

{# yüzdeleri hesapla (JS’e data olarak geçeceğiz) #}
{% set p_pct = ((p / 5 * 100) if p is not none else 0) %}
{% set s_pct = ((sev / 5 * 100) if sev is not none else 0) %}

<div class="rt-shell">

  <div class="rt-topbar">
    <div class="rt-bc">
      <span>Kütüphane</span>
      <span class="material-symbols-outlined rt-sep">chevron_right</span>
      <b>Şablon Detayı</b>
    </div>

    <div class="rt-actions">
      <a href="{{ url_for('risk_identify') }}" class="rt-btn rt-btn-ghost">
        <span class="material-symbols-outlined rt-ic">arrow_back</span>
        Listeye dön
      </a>
    </div>
  </div>

  <section class="rt-hero">
    <div class="rt-pillrow">
      <span class="rt-pill primary">{{ _cat }}</span>
      {% if _code %}
        <span class="rt-pill code">{{ _code }}</span>
      {% endif %}
    </div>

    <h1 class="rt-title">{{ _title }}</h1>
    <p class="rt-lead">{{ _desc }}</p>
  </section>

  <div class="rt-grid">

    <section class="rt-card">
      <div class="rt-cardhead">
        <div class="rt-iconbox">
          <span class="material-symbols-outlined">fact_check</span>
        </div>
        <h3>Risk Faktörü</h3>
      </div>
      <div class="rt-body">{{ _desc }}</div>
    </section>

    <section class="rt-card">
      <div class="rt-cardhead">
        <div class="rt-iconbox">
          <span class="material-symbols-outlined">shield</span>
        </div>
        <h3>Önerilen Önlemler</h3>
      </div>
      <div class="rt-body">{{ _mit }}</div>
    </section>

  </div>

  <div class="rt-kpis">

    <div class="rt-kpi">
      <div class="rt-kpi-top">
        <span>Varsayılan Olasılık</span>
        <span class="material-symbols-outlined">signal_cellular_alt</span>
      </div>

      <div class="rt-kpi-val">
        <span class="rt-kpi-num">{{ p if p is not none else '—' }}</span>
        <span class="rt-kpi-den">/ 5</span>
      </div>

      <div class="rt-bar" aria-hidden="true">
        <i class="rt-barfill" data-w="{{ '%.0f'|format(p_pct) }}"></i>
      </div>

      <div style="margin-top:.55rem; color:var(--rt-muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; font-size:.72rem;">
        {% if p is not none %}
          {% if p >= 4 %}Yüksek{% elif p >= 3 %}Orta{% else %}Düşük{% endif %}
        {% else %}
          —
        {% endif %}
      </div>
    </div>

    <div class="rt-kpi">
      <div class="rt-kpi-top">
        <span>Varsayılan Şiddet</span>
        <span class="material-symbols-outlined">report_problem</span>
      </div>

      <div class="rt-kpi-val">
        <span class="rt-kpi-num">{{ sev if sev is not none else '—' }}</span>
        <span class="rt-kpi-den">/ 5</span>
      </div>

      <div class="rt-bar" aria-hidden="true">
        <i class="rt-barfill" data-w="{{ '%.0f'|format(s_pct) }}"></i>
      </div>

      <div style="margin-top:.55rem; color:var(--rt-muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; font-size:.72rem;">
        {% if sev is not none %}
          {% if sev >= 4 %}Yüksek Önem{% elif sev >= 3 %}Orta{% else %}Düşük{% endif %}
        {% else %}
          —
        {% endif %}
      </div>
    </div>

    <div class="rt-kpi score">
      <div class="rt-kpi-top" style="color:var(--rt-primary); font-weight:950;">
        <span>Varsayılan Skor</span>
        <span class="material-symbols-outlined" style="color:var(--rt-primary);">speed</span>
      </div>

      <div class="rt-kpi-val" style="position:relative; z-index:1;">
        <span class="rt-kpi-num" style="font-size:2.5rem; color:var(--rt-primary);">
          {% if score is not none %}{{ score }}{% else %}—{% endif %}
        </span>

        {% if score is not none %}
          <span class="rt-tag {{ score_tag_cls }}">{{ score_tag }}</span>
        {% endif %}
      </div>

      <div style="margin-top:.65rem; position:relative; z-index:1; color: color-mix(in oklab, var(--rt-primary) 70%, transparent); font-weight:700; font-size:.86rem; line-height:1.35;">
        Bu skor, olasılık ve şiddet değerlerinin çarpımı ile hesaplanmıştır.
      </div>
    </div>

  </div>

  <div class="rt-footer">
    <div>
      <span class="material-symbols-outlined" style="font-size:18px; vertical-align:-4px;">info</span>
      Sistem tarafından otomatik olarak oluşturulmuştur.
    </div>
    <div style="display:flex; gap:.5rem; flex-wrap:wrap; justify-content:flex-end;">
      <a href="{{ url_for('risk_identify') }}" class="rt-btn rt-btn-ghost">
        <span class="material-symbols-outlined rt-ic">arrow_back</span>
        Tanımlı risk listesine dön
      </a>
    </div>
  </div>

</div>

<script>
  // Progress bar fill widths (CSS linter'ı çıldırtmasın diye Jinja'yı CSS'e sokmuyoruz)
  (function(){
    const fills = document.querySelectorAll('.rt-barfill[data-w]');
    fills.forEach(el => {
      const w = parseFloat(el.getAttribute('data-w') || '0');
      el.style.width = Math.max(0, Math.min(100, w)) + '%';
    });
  })();
</script>

{% endblock %}
