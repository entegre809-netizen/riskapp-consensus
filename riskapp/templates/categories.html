{% extends "base.html" %}
{% block title %}Kategori Yönetimi · Risk Yönetim{% endblock %}
{% block content %}

<style>
  /* ==========================================================
     Kategori Yönetimi · 2026 Modern UI
     ✅ PATCH/DELETE yok → edit/delete POST ile çalışır
     ========================================================== */

  .toolbar{
    display:flex; gap:.9rem; flex-wrap:wrap; align-items:center; justify-content:space-between;
    margin-bottom: .9rem;
  }
  .toolbar h2{ margin:0; font-weight:900; letter-spacing:-.02em }
  .subline{
    margin:.28rem 0 0;
    color: var(--text-dim);
    max-width: 70ch;
  }

  .grid{ display:grid; gap:14px }
  .grid-2{ grid-template-columns: 360px 1fr }
  @media (max-width: 980px){
    .grid-2{ grid-template-columns: 1fr }
  }

  .searchbar{
    display:flex; gap:.55rem; flex-wrap:wrap; align-items:center;
    padding:.45rem;
    border-radius:14px;
    background: color-mix(in oklab, var(--card) 92%, transparent);
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    margin:.55rem 0 1rem;
    box-shadow: 0 8px 26px rgba(12, 22, 40, .06);
  }
  .searchbar .input{ min-width:260px; flex:1 1 260px }

  .card-lite{
    background: color-mix(in oklab, var(--card) 90%, transparent);
    border:1px dashed color-mix(in oklab, var(--line) 75%, transparent);
    border-radius:16px;
    padding:14px;
  }

  .table-wrap{
    overflow:auto;
    border-radius:14px;
    border:1px solid var(--line);
  }
  .table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width: 880px;
  }
  .table th,.table td{
    padding:.82rem .92rem;
    border-bottom:1px solid color-mix(in oklab, var(--line) 88%, transparent);
    text-align:left;
    vertical-align:top;
    font-size:.98rem;
  }
  .table thead th{
    font-size:.78rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    font-weight:900;
    color: var(--text-dim);
    position: sticky;
    top: 0;
    z-index: 1;
    background: color-mix(in oklab, var(--surface) 84%, transparent);
    border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    backdrop-filter: blur(5px);
  }
  .table tbody tr:hover td{
    background: color-mix(in oklab, var(--primary) 7%, transparent);
  }

  .actions{
    display:flex;
    gap:.5rem;
    flex-wrap:wrap;
    justify-content:flex-end;
    align-items:center;
  }

  details > summary{
    cursor:pointer;
    list-style:none;
    display:inline-flex;
    align-items:center;
    gap:.45rem;
    padding:.58rem .82rem;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:12px;
    background: linear-gradient(180deg, #fff, #f7faff);
    font-weight:900;
  }
  details > summary::-webkit-details-marker{ display:none; }
  [data-theme="dark"] details > summary{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    color:#eaf0ff;
  }
  details[open] > summary{ margin-bottom:.5rem }

  .inner-card{
    border:1px dashed color-mix(in oklab, var(--line) 75%, transparent);
    border-radius:12px;
    padding:12px;
    background: color-mix(in oklab, var(--card) 96%, transparent);
  }

  .swatch{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:.18rem .55rem;
    border-radius:999px;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    background: color-mix(in oklab, var(--card) 92%, transparent);
    font-weight:800;
    font-size:.9rem;
    white-space:nowrap;
  }
  .swatch-dot{
    width:14px; height:14px; border-radius:999px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    flex: 0 0 14px;
  }

  #flash{
    display:none;
    margin:.6rem 0;
    padding:.86rem 1rem;
    border-radius:12px;
    font-weight:800;
    border:1px solid #dbe6ff;
    background: linear-gradient(180deg, #f5f9ff, #eef4ff);
    color:#17223a;
  }
  #flash.success{
    border-color:#baffdf;
    background:linear-gradient(180deg, #eafff4, #d8ffee);
    color:#073a2a;
  }
  #flash.danger{
    border-color:#ffc9c9;
    background:linear-gradient(180deg, #ffefef, #ffe3e3);
    color:#5a1c1c;
  }
  #flash.warning{
    border-color:#ffe6a6;
    background:linear-gradient(180deg, #fff7e0, #fff0c5);
    color:#5a3b00;
  }

  .loading{
    position:fixed;
    inset:0;
    display:none;
    place-items:center;
    z-index:50;
    background: color-mix(in oklab, var(--bg) 40%, transparent);
    backdrop-filter: blur(2px);
  }
  .loading.show{ display:grid }

  .spinner{
    width:44px; height:44px;
    border-radius:999px;
    border:4px solid color-mix(in oklab, var(--line) 70%, transparent);
    border-top-color: var(--primary);
    animation: spin .8s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg) } }

  .hint{
    margin-top:.75rem;
    padding:.9rem 1rem;
    border-radius:14px;
    border:1px solid color-mix(in oklab, var(--primary) 35%, transparent);
    background: color-mix(in oklab, var(--primary) 10%, transparent);
    color: color-mix(in oklab, var(--text) 90%, var(--primary));
  }
  .hint strong{ font-weight:900 }

  /* Dark fixes */
  [data-theme="dark"] .table-wrap{
    background: color-mix(in oklab, var(--card) 70%, #0b1220);
    border-color: rgba(255,255,255,.10);
  }
  [data-theme="dark"] .table thead th{
    color: rgba(226,232,240,.82);
    background: linear-gradient(
      180deg,
      color-mix(in oklab, var(--surface) 75%, #0b1220),
      color-mix(in oklab, var(--surface) 88%, #0b1220)
    );
    border-bottom-color: rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
  }
  [data-theme="dark"] .table th,
  [data-theme="dark"] .table td{
    border-bottom-color: rgba(255,255,255,.08);
    color: rgba(226,232,240,.92);
  }
  [data-theme="dark"] .table tbody td{ background: transparent; }
  [data-theme="dark"] .table tbody tr{ background: rgba(255,255,255,.03); }
  [data-theme="dark"] .table tbody tr:nth-child(even){ background: rgba(255,255,255,.02); }
  [data-theme="dark"] .table tbody tr:hover td{
    background: color-mix(in oklab, var(--primary) 14%, rgba(255,255,255,.04));
  }
</style>

<div class="loading" id="loading">
  <div class="spinner" role="status" aria-label="Yükleniyor"></div>
</div>

<div class="toolbar">
  <div>
    <h2>Kategori Yönetimi</h2>
    <p class="subline">
      Ekle, düzenle, sil; <strong>pasif</strong> kategoriler listelerde gizlenir.
    </p>
  </div>

  <a id="backToIdentify"
     href="{{ url_for('risk_identify') }}"
     class="btn"
     style="display:none">
    ← Risk Tanımlama’ya dön
  </a>
</div>

<div id="flash" role="status" aria-live="polite"></div>

<form id="searchForm" class="searchbar" autocomplete="off">
  <input class="input" id="q" name="q" placeholder="Ara: ad, kod, açıklama…" inputmode="search" />
  <div style="display:flex; gap:.5rem">
    <button class="btn" type="submit">Ara</button>
    <button class="btn" type="button" id="clearSearch" title="Aramayı temizle">Temizle</button>
  </div>
</form>

<div class="grid grid-2">

  <!-- Sol: Yeni kategori -->
  <div>
    <div class="card-lite">
      <h3 style="margin:0 0 .55rem; font-weight:900; letter-spacing:-.01em">Yeni Kategori</h3>

      <!-- ✅ Create = klasik POST -->
      <form id="createForm"
            method="post"
            action="{{ url_for('categories_index', next=request.args.get('next')) }}"
            autocomplete="off">
        <div>
          <label>Ad *</label>
          <input class="input" name="name" required placeholder="Örn: DİZAYN TASARIM RİSKLERİ" maxlength="120">
        </div>

        <div class="grid grid-2" style="margin-top:.55rem">
          <div>
            <label>Kod</label>
            <input class="input" name="code" placeholder="Örn: DTR" maxlength="32">
          </div>

          <div>
            <label>Renk</label>
            <div style="display:flex; gap:.5rem; align-items:center">
              <input class="input" type="color" name="color" value="#0ea371" style="width:64px; padding:0">
              <input class="input" type="text" id="colorHex" value="#0ea371" maxlength="9" title="Hex renk kodu (#RRGGBB)">
            </div>
          </div>
        </div>

        <div style="margin-top:.55rem">
          <label>Açıklama</label>
          <textarea class="input" name="description" rows="2" placeholder="İsteğe bağlı" maxlength="240"></textarea>
        </div>

        <div style="margin-top:.7rem; display:flex; justify-content:flex-end; gap:.5rem">
          <button class="btn btn-primary" type="submit">Ekle</button>
        </div>
      </form>
    </div>

    <div class="hint">
      <strong>İpucu:</strong> Kodlar benzersiz olmalı. Renkler dashboard grafiklerinde hızlı ayrım sağlar.
    </div>
  </div>

  <!-- Sağ: Liste -->
  <div class="card">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th style="width:56px">#</th>
            <th>Ad</th>
            <th style="width:120px">Kod</th>
            <th style="width:160px">Renk</th>
            <th>Açıklama</th>
            <th style="width:120px">Durum</th>
            <th style="width:240px">İşlem</th>
          </tr>
        </thead>
        <tbody id="tbodyCats"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   State + helpers
   ========================================================== */
let CATS = [];

const $  = (sel, ctx=document) => ctx.querySelector(sel);
const flashEl = $("#flash");
const loadingEl = $("#loading");

function showLoading(on=true){ loadingEl.classList.toggle('show', !!on); }
function flash(msg, type="info", dur=2400){
  flashEl.className = type;
  flashEl.textContent = msg;
  flashEl.style.display = "block";
  if(dur){ setTimeout(()=>{ flashEl.style.display="none"; }, dur); }
}
function normalize(s){ return (s||"").toString().trim(); }
function matchQuery(cat, q){
  if(!q) return true;
  const hay = (cat.name + " " + (cat.code||"") + " " + (cat.description||"")).toLowerCase();
  return hay.includes(q.toLowerCase());
}
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
const shouldGoIdentify = ()=> (getParam("next")||"").toLowerCase()==="identify";

/* ---- güvenli string basma (HTML inject / bozulma engeli) ---- */
function escHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function makeColorBadge(color){
  const wrap = document.createElement("span");
  wrap.className = "swatch";
  const dot = document.createElement("span");
  dot.className = "swatch-dot";
  dot.style.background = color || "#ddd";
  const label = document.createElement("span");
  label.textContent = color || "—";
  wrap.appendChild(dot); wrap.appendChild(label);
  return wrap;
}

/* ==========================================================
   API: sadece listeyi JSON'dan çekiyoruz (GET)
   ========================================================== */
async function loadCategories(q=""){
  showLoading(true);
  try{
    const url = q ? `/api/categories?q=${encodeURIComponent(q)}` : "/api/categories";
    const res = await fetch(url, { headers:{ "Accept":"application/json" }});
    if(!res.ok) throw new Error("Liste alınamadı");
    CATS = await res.json();
  } finally { showLoading(false); }
}

/* ==========================================================
   POST helper (edit/delete) — redirect vs login yakalama
   ========================================================== */
async function postForm(url, fd){
  showLoading(true);
  try{
    const res = await fetch(url, {
      method:"POST",
      body: fd,
      redirect: "follow",
      headers:{ "Accept":"text/html" }
    });

    // Eğer login sayfasına yönlendirdiyse genelde URL değişir.
    // Render / auth akışlarında bu çok olur.
    const finalUrl = (res && res.url) ? res.url.toLowerCase() : "";
    if(finalUrl.includes("login")){
      throw new Error("Oturum düşmüş gibi görünüyor (login). Tekrar giriş yap.");
    }

    if(!res.ok){
      throw new Error("İşlem başarısız (" + res.status + ")");
    }
    return true;
  } finally { showLoading(false); }
}

/* ==========================================================
   Render
   ========================================================== */
function renderTable(){
  const q = normalize($("#q").value);
  const tbody = $("#tbodyCats");
  tbody.innerHTML = "";

  const list = CATS.slice()
    .sort((a,b)=>{
      if (a.is_active !== b.is_active) return (a.is_active ? -1 : 1);
      return (a.name||"").localeCompare(b.name||"", "tr");
    })
    .filter(c => matchQuery(c, q));

  if(!list.length){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 7;
    td.className = "small";
    td.style.textAlign = "center";
    td.style.padding = "1.2rem .9rem";
    td.textContent = "Kategori bulunamadı.";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  for (const c of list){
    const tr = document.createElement("tr");

    const tdId = document.createElement("td");
    tdId.style.fontWeight="800";
    tdId.textContent = String(c.id);
    tr.appendChild(tdId);

    const tdName = document.createElement("td");
    tdName.style.fontWeight="900";
    tdName.textContent = c.name || "";
    tr.appendChild(tdName);

    const tdCode = document.createElement("td");
    const badgeCode = document.createElement("span");
    badgeCode.className = "badge";
    badgeCode.textContent = c.code || "—";
    tdCode.appendChild(badgeCode);
    tr.appendChild(tdCode);

    const tdColor = document.createElement("td");
    tdColor.appendChild(makeColorBadge(c.color));
    tr.appendChild(tdColor);

    const tdDesc = document.createElement("td");
    tdDesc.className = "small";
    tdDesc.textContent = c.description || "—";
    tr.appendChild(tdDesc);

    const tdStatus = document.createElement("td");
    const statusSpan = document.createElement("span");
    statusSpan.className = "badge " + (c.is_active ? "score-low" : "score-mid");
    statusSpan.textContent = c.is_active ? "Aktif" : "Pasif";
    tdStatus.appendChild(statusSpan);
    tr.appendChild(tdStatus);

    const tdActions = document.createElement("td");
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = "Düzenle";
    details.appendChild(summary);

    const inner = document.createElement("div");
    inner.className = "inner-card";

    /* ---- Edit form ---- */
    const form = document.createElement("form");
    form.className = "grid grid-2 js-edit";
    form.dataset.id = String(c.id);

    const g1 = document.createElement("div");
    g1.style.gridColumn = "1 / -1";
    g1.innerHTML = `
      <label>Ad *</label>
      <input class="input" name="name" required maxlength="120" value="${escHtml(c.name || '')}">
    `;

    const g2 = document.createElement("div");
    g2.innerHTML = `
      <label>Kod</label>
      <input class="input" name="code" maxlength="32" value="${escHtml(c.code || '')}">
    `;

    const g3 = document.createElement("div");
    g3.innerHTML = `<label>Renk</label>`;
    const rowColor = document.createElement("div");
    rowColor.style.display="flex"; rowColor.style.gap=".5rem"; rowColor.style.alignItems="center";

    const inpColor = document.createElement("input");
    inpColor.className="input";
    inpColor.type="color";
    inpColor.name="color";
    inpColor.style.width="64px";
    inpColor.style.padding="0";
    inpColor.value = c.color || "#0ea371";

    const inpHex = document.createElement("input");
    inpHex.className="input";
    inpHex.type="text";
    inpHex.maxLength=9;
    inpHex.value = c.color || "#0ea371";

    rowColor.appendChild(inpColor); rowColor.appendChild(inpHex);
    g3.appendChild(rowColor);

    inpColor.addEventListener("input", ()=>{ inpHex.value = inpColor.value; });
    inpHex.addEventListener("input", ()=>{
      const v = normalize(inpHex.value);
      if(/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)) inpColor.value = v;
    });

    const g4 = document.createElement("div");
    g4.style.gridColumn="1 / -1";
    // textarea içine güvenli bas: textContent ile set edeceğiz (innerHTML değil)
    const label4 = document.createElement("label");
    label4.textContent = "Açıklama";
    const ta = document.createElement("textarea");
    ta.className="input";
    ta.name="description";
    ta.rows=2;
    ta.maxLength=240;
    ta.textContent = c.description || ""; // ✅ en güvenlisi
    g4.appendChild(label4);
    g4.appendChild(ta);

    const g5 = document.createElement("div");
    g5.style.display="flex"; g5.style.alignItems="center"; g5.style.gap=".4rem";
    const chk = document.createElement("input");
    chk.type="checkbox";
    chk.id="ia_"+c.id;
    chk.name="is_active";
    chk.checked=!!c.is_active;
    const lbl = document.createElement("label");
    lbl.htmlFor=chk.id; lbl.style.margin="0"; lbl.textContent="Aktif";
    g5.appendChild(chk); g5.appendChild(lbl);

    const g6 = document.createElement("div");
    g6.style.gridColumn="1 / -1"; g6.className="actions";
    const btnSave = document.createElement("button");
    btnSave.className="btn btn-primary";
    btnSave.type="submit";
    btnSave.textContent="Kaydet";
    g6.appendChild(btnSave);

    form.appendChild(g1); form.appendChild(g2); form.appendChild(g3);
    form.appendChild(g4); form.appendChild(g5); form.appendChild(g6);

    /* ---- Delete form ---- */
    const delForm = document.createElement("form");
    delForm.className="js-delete actions";
    delForm.dataset.id=String(c.id);
    delForm.style.marginTop=".55rem";
    const btnDel = document.createElement("button");
    btnDel.className="btn btn-danger";
    btnDel.type="submit";
    btnDel.textContent="Sil";
    delForm.appendChild(btnDel);

    inner.appendChild(form);
    inner.appendChild(delForm);
    details.appendChild(inner);
    tdActions.appendChild(details);
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  }
}

/* ==========================================================
   Events
   ========================================================== */
function debounce(fn, t=250){
  let h;
  return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), t); }
}

$("#searchForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{ await loadCategories(normalize($("#q").value)); renderTable(); }
  catch(err){ flash(err.message || "Kategoriler alınamadı","danger"); }
});
$("#q").addEventListener("input", debounce(async ()=>{
  try{ await loadCategories(normalize($("#q").value)); renderTable(); }catch(_){}
}, 300));
$("#clearSearch").addEventListener("click", async ()=>{
  $("#q").value="";
  try{ await loadCategories(); renderTable(); }
  catch(err){ flash(err.message || "Kategoriler alınamadı","danger"); }
});

/* ---- Create renk senkronu ---- */
(function bindCreateColorSync(){
  const colorPicker = document.querySelector('#createForm input[type="color"][name="color"]');
  const hexInput = document.querySelector('#colorHex');
  if(!colorPicker || !hexInput) return;

  colorPicker.addEventListener("input", ()=>{ hexInput.value = colorPicker.value; });
  hexInput.addEventListener("input", ()=>{
    const v = normalize(hexInput.value);
    if(/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)) colorPicker.value = v;
  });

  $("#createForm").addEventListener("submit", ()=>{
    const v = normalize(hexInput.value);
    if(/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)) colorPicker.value = v;
  });
})();

/* ---- Edit/Delete delegation ---- */
document.addEventListener("submit", async (e)=>{
  const editForm = e.target.closest(".js-edit");
  if (editForm){
    e.preventDefault();
    const id = Number(editForm.dataset.id);
    const fd = new FormData(editForm);

    if(!normalize(fd.get("name"))){ flash("Ad zorunlu.","danger"); return; }

    // unchecked checkbox = formdata'da gelmez → backend false yapar; ama biz net:
    if(!fd.get("is_active")) fd.set("is_active","");

    // hex input varsa color'a bas
    const hex = editForm.querySelector('input[type="text"]');
    if (hex && normalize(hex.value)) fd.set("color", hex.value);

    const nextParam = (getParam("next") || "").toLowerCase();
    const url = `/categories/${id}/edit${nextParam ? `?next=${encodeURIComponent(nextParam)}` : ""}`;

    try{
      await postForm(url, fd);

      if (shouldGoIdentify()){
        flash("Kategori güncellendi, yönlendiriliyor…","success");
        window.location.href = "{{ url_for('risk_identify') }}";
        return;
      }

      await loadCategories(normalize($("#q").value));
      renderTable();
      flash("Kategori güncellendi.","success");
    }catch(err){
      flash(err.message || "Hata","danger", 4000);
    }
    return;
  }

  const delForm = e.target.closest(".js-delete");
  if (delForm){
    e.preventDefault();
    const id = Number(delForm.dataset.id);
    if(!confirm("Silinsin mi? Kullanımda ise otomatik pasif yapılabilir.")) return;

    const fd = new FormData();
    const nextParam = (getParam("next") || "").toLowerCase();
    const url = `/categories/${id}/delete${nextParam ? `?next=${encodeURIComponent(nextParam)}` : ""}`;

    try{
      await postForm(url, fd);

      if (shouldGoIdentify()){
        flash("Kategori silindi, yönlendiriliyor…","success");
        window.location.href = "{{ url_for('risk_identify') }}";
        return;
      }

      await loadCategories(normalize($("#q").value));
      renderTable();
      flash("Kategori silindi.","success");
    }catch(err){
      flash(err.message || "Hata","danger", 4000);
    }
  }
});

/* ==========================================================
   Init
   ========================================================== */
(async function init(){
  const url = new URL(window.location.href);
  const qParam = url.searchParams.get("q") || "";
  const nextParam = (url.searchParams.get("next") || "").toLowerCase();

  $("#q").value = qParam;
  if (nextParam === "identify") { $("#backToIdentify").style.display = "inline-flex"; }

  try{
    await loadCategories(qParam);
    renderTable();
  }catch(_){
    flash("Kategoriler yüklenemedi.","danger", 4000);
  }
})();
</script>

{% endblock %}
