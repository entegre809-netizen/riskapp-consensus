{% extends "base.html" %}
{% block title %}Kategori Yönetimi · Risk Yönetim{% endblock %}
{% block content %}

<style>
  /* ==========================================================
     Kategori Yönetimi · 2026 Modern UI (base.html ile uyumlu)
     ========================================================== */
  .toolbar{
    display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:.75rem
  }
  .toolbar h2{ margin:0; font-weight:900 }
  .small{ font-size:.9rem; color: var(--text-dim) }

  .grid{ display:grid; gap:14px }
  .grid-2{ grid-template-columns: 360px 1fr }
  @media (max-width: 980px){ .grid-2{ grid-template-columns: 1fr } }

  /* Arama çubuğu */
  .searchbar{
    display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; padding:.4rem;
    border-radius:12px;
    background: color-mix(in oklab, var(--card) 92%, transparent);
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    margin:.5rem 0 1rem;
  }
  .searchbar .input{ min-width:260px; flex:1 1 260px }

  /* Kartlar / tablo */
  .card-lite{
    background: color-mix(in oklab, var(--card) 90%, transparent);
    border:1px dashed color-mix(in oklab, var(--line) 75%, transparent);
    border-radius:14px; padding:14px;
  }
  .table-wrap{ overflow:auto; border-radius:12px; border:1px solid var(--line) }
  .table{ width:100%; border-collapse:separate; border-spacing:0; min-width:880px }
  .table th,.table td{
    padding:.78rem .9rem; border-bottom:1px solid color-mix(in oklab, var(--line) 88%, transparent);
    text-align:left; vertical-align:top; font-size:.98rem;
  }
  .table thead th{
    font-size:.78rem; text-transform:uppercase; letter-spacing:.08em; font-weight:900;
    color: var(--text-dim);
    position: sticky; top: 0; z-index: 1;
    background: color-mix(in oklab, var(--surface) 84%, transparent);
    border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    backdrop-filter: blur(4px);
  }
  .table tbody tr:hover td{ background: color-mix(in oklab, var(--primary) 7%, transparent) }

  /* Details/edit */
  .actions{ display:flex; gap:.5rem; flex-wrap:wrap; justify-content:flex-end }
  details > summary{
    cursor:pointer; list-style:none; display:inline-flex; align-items:center;
    padding:.55rem .8rem; border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:12px; background: linear-gradient(180deg, #fff, #f7faff);
    font-weight:900;
  }
  [data-theme="dark"] details > summary{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    color:#eaf0ff;
  }
  details[open] > summary{ margin-bottom:.5rem }
  .inner-card{
    border:1px dashed color-mix(in oklab, var(--line) 75%, transparent);
    border-radius:12px; padding:12px; background: color-mix(in oklab, var(--card) 96%, transparent);
  }

  /* Renk rozetleri */
  .swatch{
    display:inline-flex; align-items:center; gap:8px; padding:.18rem .55rem; border-radius:999px;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    background: color-mix(in oklab, var(--card) 92%, transparent);
    font-weight:800; font-size:.9rem;
  }
  .swatch-dot{ width:14px; height:14px; border-radius:999px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.12) }

  /* Flash/bildirim */
  #flash{
    display:none; margin:.6rem 0; padding:.8rem 1rem; border-radius:12px; font-weight:800;
    border:1px solid #dbe6ff; background: linear-gradient(180deg, #f5f9ff, #eef4ff); color:#17223a;
  }
  #flash.success{
    border-color:#baffdf; background:linear-gradient(180deg, #eafff4, #d8ffee); color:#073a2a;
  }
  #flash.danger{
    border-color:#ffc9c9; background:linear-gradient(180deg, #ffefef, #ffe3e3); color:#5a1c1c;
  }

  /* Yükleniyor maskesi (panel üstü) */
  .loading{
    position:fixed; inset:0; display:none; place-items:center; z-index:50;
    background: color-mix(in oklab, var(--bg) 40%, transparent);
    backdrop-filter: blur(2px);
  }
  .loading.show{ display:grid }
  .spinner{
    width:44px; height:44px; border-radius:999px;
    border:4px solid color-mix(in oklab, var(--line) 70%, transparent);
    border-top-color: var(--primary);
    animation: spin .8s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg) } }
</style>

<!-- yükleniyor -->
<div class="loading" id="loading"><div class="spinner" role="status" aria-label="Yükleniyor"></div></div>

<div class="toolbar">
  <div>
    <h2>Kategori Yönetimi</h2>
    <p class="small" style="margin:.25rem 0 0">Ekle, düzenle, sil; <strong>pasif</strong> kategoriler listelerde gizlenir.</p>
  </div>
  <!-- next=identify ise görünür -->
  <a id="backToIdentify" href="{{ url_for('risk_identify') }}" class="btn" style="display:none">← Risk Tanımlama’ya dön</a>
</div>

<!-- bildirim alanı -->
<div id="flash" role="status" aria-live="polite"></div>

<!-- arama -->
<form id="searchForm" class="searchbar" autocomplete="off">
  <input class="input" id="q" name="q" placeholder="Ara: ad, kod, açıklama…" inputmode="search" />
  <div style="display:flex; gap:.5rem">
    <button class="btn" type="submit">Ara</button>
    <button class="btn" type="button" id="clearSearch" title="Aramayı temizle">Temizle</button>
  </div>
</form>

<div class="grid grid-2">
  <!-- Sol: Yeni kategori -->
  <div class="card-lite">
    <h3 style="margin:0 0 .5rem">Yeni Kategori</h3>
    <form id="createForm" autocomplete="off">
      <div>
        <label>Ad *</label>
        <input class="input" name="name" required placeholder="Örn: DİZAYN TASARIM RİSKLERİ" maxlength="80">
      </div>
      <div class="grid grid-2" style="margin-top:.5rem">
        <div>
          <label>Kod</label>
          <input class="input" name="code" placeholder="Örn: DTR" maxlength="16">
        </div>
        <div>
          <label>Renk</label>
          <div style="display:flex; gap:.5rem; align-items:center">
            <input class="input" type="color" name="color" value="#0ea371" style="width:64px; padding:0">
            <input class="input" type="text" id="colorHex" value="#0ea371" maxlength="9" title="Hex renk kodu (#RRGGBB)">
          </div>
        </div>
      </div>
      <div style="margin-top:.5rem">
        <label>Açıklama</label>
        <textarea class="input" name="description" rows="2" placeholder="İsteğe bağlı" maxlength="240"></textarea>
      </div>
      <div style="margin-top:.6rem;display:flex;justify-content:flex-end;gap:.5rem">
        <button class="btn btn-primary" type="submit">Ekle</button>
      </div>
    </form>
  </div>

  <!-- Sağ: Liste -->
  <div class="card">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th style="width:56px">#</th>
            <th>Ad</th>
            <th style="width:120px">Kod</th>
            <th style="width:160px">Renk</th>
            <th>Açıklama</th>
            <th style="width:120px">Durum</th>
            <th style="width:240px">İşlem</th>
          </tr>
        </thead>
        <tbody id="tbodyCats"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ==========================================================
   Global state + yardımcılar
   ========================================================== */
let CATS = [];

const $  = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
const flashEl = $("#flash");
const loadingEl = $("#loading");

function showLoading(on=true){ loadingEl.classList.toggle('show', !!on); }
function flash(msg, type="info", dur=2200){
  flashEl.className = type;
  flashEl.textContent = msg;
  flashEl.style.display = "block";
  if(dur){ setTimeout(()=>{ flashEl.style.display="none"; }, dur); }
}
function normalize(s){ return (s||"").toString().trim(); }
function matchQuery(cat, q){
  if(!q) return true;
  const hay = (cat.name + " " + (cat.code||"") + " " + (cat.description||"")).toLowerCase();
  return hay.includes(q.toLowerCase());
}
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
const shouldGoIdentify = ()=> (getParam("next")||"").toLowerCase()==="identify";

function makeColorBadge(color){
  const wrap = document.createElement("span");
  wrap.className = "swatch";
  const dot = document.createElement("span");
  dot.className = "swatch-dot";
  dot.style.background = color || "#ddd";
  const label = document.createElement("span");
  label.textContent = color || "—";
  wrap.appendChild(dot); wrap.appendChild(label);
  return wrap;
}

/* ==========================================================
   API helpers
   ========================================================== */
async function loadCategories(q=""){
  showLoading(true);
  try{
    const url = q ? `/api/categories?q=${encodeURIComponent(q)}` : "/api/categories";
    const res = await fetch(url, { headers:{ "Accept":"application/json" }});
    if(!res.ok) throw new Error("Liste alınamadı");
    CATS = await res.json();
  } finally { showLoading(false); }
}
async function createCategory(fd){
  showLoading(true);
  try{
    const res = await fetch("/api/categories", { method:"POST", body: fd });
    const j = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((j && j.error) || "Kaydedilemedi");
    return j;
  } finally { showLoading(false); }
}
async function updateCategory(id, fd){
  showLoading(true);
  try{
    const res = await fetch(`/api/categories/${id}`, { method:"PATCH", body: fd });
    const j = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((j && j.error) || "Güncellenemedi");
    return j;
  } finally { showLoading(false); }
}
async function deleteCategory(id){
  showLoading(true);
  try{
    const res = await fetch(`/api/categories/${id}`, { method:"DELETE" });
    const j = await res.json().catch(()=>null);
    if(!res.ok) throw new Error((j && j.error) || "Silinemedi");
    return j;
  } finally { showLoading(false); }
}

/* ==========================================================
   Render
   ========================================================== */
function renderTable(){
  const q = normalize($("#q").value);
  const tbody = $("#tbodyCats");
  tbody.innerHTML = "";

  const list = CATS.slice()
    .sort((a,b)=>{
      if (a.is_active !== b.is_active) return (a.is_active ? -1 : 1);
      return (a.name||"").localeCompare(b.name||"", "tr");
    })
    .filter(c => matchQuery(c, q));

  if(!list.length){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 7; td.className = "small"; td.style.textAlign = "center";
    td.textContent = "Kategori bulunamadı.";
    tr.appendChild(td); tbody.appendChild(tr);
    return;
  }

  for (const c of list){
    const tr = document.createElement("tr");

    const tdId = document.createElement("td");
    tdId.style.fontWeight="800";
    tdId.textContent = String(c.id);
    tr.appendChild(tdId);

    const tdName = document.createElement("td");
    tdName.style.fontWeight="900";
    tdName.textContent = c.name || "";
    tr.appendChild(tdName);

    const tdCode = document.createElement("td");
    const badgeCode = document.createElement("span");
    badgeCode.className = "badge";
    badgeCode.textContent = c.code || "—";
    tdCode.appendChild(badgeCode);
    tr.appendChild(tdCode);

    const tdColor = document.createElement("td");
    tdColor.appendChild(makeColorBadge(c.color));
    tr.appendChild(tdColor);

    const tdDesc = document.createElement("td");
    tdDesc.className = "small";
    tdDesc.textContent = c.description || "—";
    tr.appendChild(tdDesc);

    const tdStatus = document.createElement("td");
    const statusSpan = document.createElement("span");
    statusSpan.className = "badge " + (c.is_active ? "score-low" : "score-mid");
    statusSpan.textContent = c.is_active ? "Aktif" : "Pasif";
    tdStatus.appendChild(statusSpan);
    tr.appendChild(tdStatus);

    const tdActions = document.createElement("td");
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = "Düzenle";
    details.appendChild(summary);

    const inner = document.createElement("div");
    inner.className = "inner-card";

    const form = document.createElement("form");
    form.className = "grid grid-2 js-edit";
    form.dataset.id = String(c.id);

    const g1 = document.createElement("div");
    g1.style.gridColumn = "1 / -1";
    g1.innerHTML = `
      <label>Ad *</label>
      <input class="input" name="name" required maxlength="80" value="${c.name || ''}">
    `;

    const g2 = document.createElement("div");
    g2.innerHTML = `
      <label>Kod</label>
      <input class="input" name="code" maxlength="16" value="${c.code || ''}">
    `;

    const g3 = document.createElement("div");
    g3.innerHTML = `<label>Renk</label>`;
    const rowColor = document.createElement("div");
    rowColor.style.display="flex"; rowColor.style.gap=".5rem"; rowColor.style.alignItems="center";
    const inpColor = document.createElement("input");
    inpColor.className="input"; inpColor.type="color"; inpColor.name="color";
    inpColor.style.width="64px"; inpColor.style.padding="0";
    inpColor.value = c.color || "#0ea371";
    const inpHex = document.createElement("input");
    inpHex.className="input"; inpHex.type="text"; inpHex.maxLength=9; inpHex.value=c.color||"#0ea371";
    rowColor.appendChild(inpColor); rowColor.appendChild(inpHex);
    g3.appendChild(rowColor);

    inpColor.addEventListener("input", ()=>{ inpHex.value = inpColor.value; });
    inpHex.addEventListener("input", ()=>{ if(/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(inpHex.value)) inpColor.value = inpHex.value; });

    const g4 = document.createElement("div");
    g4.style.gridColumn="1 / -1";
    g4.innerHTML = `
      <label>Açıklama</label>
      <textarea class="input" name="description" rows="2" maxlength="240">${c.description || ''}</textarea>
    `;

    const g5 = document.createElement("div");
    g5.style.display="flex"; g5.style.alignItems="center"; g5.style.gap=".4rem";
    const chk = document.createElement("input");
    chk.type="checkbox"; chk.id="ia_"+c.id; chk.name="is_active"; chk.checked=!!c.is_active;
    const lbl = document.createElement("label"); lbl.htmlFor=chk.id; lbl.style.margin="0"; lbl.textContent="Aktif";
    g5.appendChild(chk); g5.appendChild(lbl);

    const g6 = document.createElement("div");
    g6.style.gridColumn="1 / -1"; g6.className="actions";
    const btnSave = document.createElement("button");
    btnSave.className="btn btn-primary"; btnSave.type="submit"; btnSave.textContent="Kaydet";
    g6.appendChild(btnSave);

    form.appendChild(g1); form.appendChild(g2); form.appendChild(g3);
    form.appendChild(g4); form.appendChild(g5); form.appendChild(g6);

    const delForm = document.createElement("form");
    delForm.className="js-delete actions"; delForm.dataset.id=String(c.id); delForm.style.marginTop=".5rem";
    const btnDel = document.createElement("button");
    btnDel.className="btn btn-danger"; btnDel.type="submit"; btnDel.textContent="Sil";
    delForm.appendChild(btnDel);

    inner.appendChild(form); inner.appendChild(delForm);
    details.appendChild(inner);
    tdActions.appendChild(details);
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  }
}

/* ==========================================================
   Olaylar
   ========================================================== */
function debounce(fn, t=250){ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), t); } }

$("#searchForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{ await loadCategories(normalize($("#q").value)); renderTable(); }
  catch(err){ flash(err.message || "Kategoriler alınamadı","danger"); }
});
$("#q").addEventListener("input", debounce(async ()=>{
  try{ await loadCategories(normalize($("#q").value)); renderTable(); }catch(_){}
}, 300));
$("#clearSearch").addEventListener("click", async ()=>{
  $("#q").value=""; try{ await loadCategories(); renderTable(); }
  catch(err){ flash(err.message || "Kategoriler alınamadı","danger"); }
});

// Ekle
$("#createForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const name = normalize(fd.get("name"));
  let color = normalize(fd.get("color")) || "#0ea371";
  const hexInput = $("#colorHex");
  if (hexInput && normalize(hexInput.value)) color = hexInput.value;
  fd.set("color", color);

  if(!name){ flash("Kategori adı zorunlu.","danger"); return; }
  try{
    await createCategory(fd);
    e.target.reset(); $("#colorHex").value = "#0ea371";
    if (shouldGoIdentify()){
      flash("Kategori eklendi, yönlendiriliyor…","success");
      window.location.href = "{{ url_for('risk_identify') }}";
      return;
    }
    await loadCategories(normalize($("#q").value)); renderTable();
    flash("Kategori eklendi.","success");
  }catch(err){ flash(err.message || "Hata","danger"); }
});

// Düzenle / Sil (delegation)
document.addEventListener("submit", async (e)=>{
  const editForm = e.target.closest(".js-edit");
  if (editForm){
    e.preventDefault();
    const id = Number(editForm.dataset.id);
    const fd = new FormData(editForm);
    if(!normalize(fd.get("name"))){ flash("Ad zorunlu.","danger"); return; }
    if(!fd.get("is_active")) fd.set("is_active", "");
    const hex = editForm.querySelector('input[type="text"]');
    const col = editForm.querySelector('input[type="color"]');
    if (hex && col && normalize(hex.value)) fd.set("color", hex.value);
    try{
      await updateCategory(id, fd);
      if (shouldGoIdentify()){
        flash("Kategori güncellendi, yönlendiriliyor…","success");
        window.location.href = "{{ url_for('risk_identify') }}";
        return;
      }
      await loadCategories(normalize($("#q").value)); renderTable();
      flash("Kategori güncellendi.","success");
    }catch(err){ flash(err.message || "Hata","danger"); }
    return;
  }

  const delForm = e.target.closest(".js-delete");
  if (delForm){
    e.preventDefault();
    const id = Number(delForm.dataset.id);
    if(!confirm("Silinsin mi? Kullanımda ise pasif yapmayı düşünebilirsin.")) return;
    try{
      await deleteCategory(id);
      if (shouldGoIdentify()){
        flash("Kategori silindi, yönlendiriliyor…","success");
        window.location.href = "{{ url_for('risk_identify') }}";
        return;
      }
      await loadCategories(normalize($("#q").value)); renderTable();
      flash("Kategori silindi.","success");
    }catch(err){ flash(err.message || "Hata","danger"); }
  }
});

/* ==========================================================
   İlk yükleme
   ========================================================== */
(async function init(){
  const url = new URL(window.location.href);
  const qParam = url.searchParams.get("q") || "";
  const nextParam = (url.searchParams.get("next") || "").toLowerCase();

  $("#q").value = qParam;
  if (nextParam === "identify") { $("#backToIdentify").style.display = "inline-flex"; }

  try{ await loadCategories(qParam); renderTable(); }
  catch(_){ flash("Kategoriler yüklenemedi.","danger"); }
})();
</script>

{% endblock %}
