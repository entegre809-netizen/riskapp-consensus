{% extends "base.html" %}
{% block title %}Yeni Risk{% endblock %}
{% block content %}
<div class="card">
  <h2>Yeni Risk</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}<div class="flash {{ c }}">{{ m }}</div>{% endfor %}
  {% endwith %}

  <div style="display:flex; gap:.5rem; margin:.25rem 0 1rem">
    <a class="btn btn-secondary" href="{{ url_for('risk_identify') }}">Şablon Seç (Kütüphane)</a>
  </div>

  {% if picked_suggestions and picked_suggestions|length > 0 %}
    <div class="card" style="margin:.5rem 0 1rem; border:1px dashed var(--line);">
      <h3 style="margin:0 0 .35rem">Sepetteki şablonlar</h3>
      <details open>
        <summary class="small" style="cursor:pointer">
          Toplam {{ picked_suggestions|length }} adet
        </summary>
        <ul style="margin:.6rem 0 0 1rem">
          {% for s in picked_suggestions %}
            <li class="small" style="margin:.15rem 0">
              <strong>{{ s.category or 'Genel' }}</strong> — {{ s.text }}
              {% if s.risk_code %}<span class="badge" style="margin-left:.35rem">{{ s.risk_code }}</span>{% endif %}
            </li>
          {% endfor %}
        </ul>
      </details>
    </div>

    <!-- Ortak alanlar + oluşturma -->
    <form method="post" style="display:grid; grid-template-columns:1fr 1fr; gap:14px">
      <input type="hidden" name="action" value="create_from_picked">
      <input type="hidden" name="picked_ids" value="{{ picked_suggestions | map(attribute='id') | join(',') }}">

      <div>
        <label>Sorumlu (opsiyonel)</label>
        <input class="input" name="responsible" placeholder="Ad Soyad">
      </div>

      <div>
        <label>Etki Süresi (opsiyonel)</label>
        <input class="input" name="duration" placeholder="örn. 6 ay / proje boyunca">
      </div>

      <!-- YYYY-MM giriş için month input kullanıyoruz -->
      <div>
        <label>Başlangıç (YYYY-MM)</label>
        <input class="input" type="month" name="start_month">
      </div>
      <div>
        <label>Bitiş (YYYY-MM)</label>
        <input class="input" type="month" name="end_month">
      </div>

      <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem">
        <button class="btn btn-primary" type="submit">
          Şablonlardan Risk Oluştur ({{ picked_suggestions|length }})
        </button>
        <a class="btn btn-ghost" href="{{ url_for('risk_identify') }}">Şablon seçimine dön</a>
      </div>
    </form>
  {% else %}
    <div class="panel" style="text-align:center; padding:32px; border:1px dashed var(--line)">
      <h3>Önce şablon seç</h3>
      <p class="small">Yeni riskleri sadece “Tanımlı Risklerden Seç” ekranından oluşturuyoruz.</p>
      <a class="btn btn-primary" href="{{ url_for('risk_identify') }}">Şablon seç →</a>
    </div>
  {% endif %}
</div>
{% endblock %}
