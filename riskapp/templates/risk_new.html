{% extends "base.html" %}
{% block title %}Yeni Risk{% endblock %}
{% block content %}
<div class="card">
  <h2>Yeni Risk</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}
      <div class="flash {{ c }}">{{ m }}</div>
    {% endfor %}
  {% endwith %}

  <div style="display:flex; gap:.5rem; margin:.25rem 0 1rem">
    <a class="btn btn-secondary" href="{{ url_for('risk_identify') }}">Şablon Seç (Kütüphane)</a>

    {% set _picked = picked_suggestions if picked_suggestions is defined and picked_suggestions else [] %}

    {% if _picked and _picked|length > 0 %}
      <!-- Hızlı buton: HER ZAMAN tek riskte birleştirir -->
      <form method="post" id="bulk-create-form">
        <input type="hidden" name="action" value="create_from_picked">
        <input type="hidden" name="picked_ids" value="{{ _picked | map(attribute='id') | join(',') }}">
        <!-- YYYY-MM gizli alanlar (JS doldurur) -->
        <input type="hidden" name="start_month" id="start_month">
        <input type="hidden" name="end_month" id="end_month">
        <!-- Tek riskte birleştir -->
        <input type="hidden" name="merge" value="1">
        <button class="btn btn-primary" type="submit">
          Sepetten Risk Oluştur ({{ _picked|length }})
        </button>
      </form>
    {% endif %}
  </div>

  {% if _picked and _picked|length > 0 %}
    <details class="card" style="margin:.5rem 0 1rem; border:1px dashed var(--line);">
      <summary class="small" style="cursor:pointer">
        Sepetteki şablonlar ({{ _picked|length }})
      </summary>
      <ul style="margin:.6rem 0 0 1rem">
        {% for s in _picked %}
          <li class="small" style="margin:.15rem 0">
            <strong>{{ s.category or 'Genel' }}</strong> — {{ s.text }}
            {% if s.risk_code %}
              <span class="badge" style="margin-left:.35rem">{{ s.risk_code }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </details>
  {% else %}
    <div class="panel" style="text-align:center;padding:32px;border:1px dashed var(--line)">
      <h3>Önce şablon seç</h3>
      <p class="small">Yeni riskleri sadece “Tanımlı Risklerden Seç” ekranından oluşturuyoruz.</p>
      <a class="btn btn-primary" href="{{ url_for('risk_identify', next='identify') }}">Şablon seç →</a>
    </div>
  {% endif %}

  <!-- ORTAK ALANLAR FORMU -->
  <form method="post" class="grid" id="common-form"
        style="grid-template-columns:1fr 1fr; gap:16px; margin-top:10px">
    <input type="hidden" name="action" value="create_from_picked">
    <input type="hidden" name="picked_ids" value="{{ _picked | map(attribute='id') | join(',') }}">
    <!-- YYYY-MM gizli alanlar (JS doldurur) -->
    <input type="hidden" name="start_month" id="start_month_2">
    <input type="hidden" name="end_month" id="end_month_2">

    <div style="grid-column:1/-1">
      <label>Başlık (boşsa şablon metninin ilk 150 karakteri)</label>
      <input class="input" name="title" placeholder="örn. Tedarik gecikmesi, hava koşulları…"
             value="{{ request.form.get('title','') }}">
    </div>

    <div style="grid-column:1/-1">
      <label>Açıklama (boşsa şablon metni kullanılır)</label>
      <textarea class="input" name="description" rows="3"
                placeholder="Ortak açıklama (tüm kayıtlara)">{{ request.form.get('description','') }}</textarea>
    </div>

    <div style="grid-column:1/-1">
      <label>Önlemler (Mitigation — tüm kayıtlara aynı metin)</label>
      <textarea class="input" name="mitigation" rows="3"
                placeholder="Ortak aksiyon/önlemler">{{ request.form.get('mitigation','') }}</textarea>
    </div>

    <div>
      <label>Sorumlu</label>
      <input class="input" name="responsible" placeholder="Ad Soyad"
             value="{{ request.form.get('responsible','') }}">
    </div>

    <div>
      <label>Başlangıç Tarihi</label>
      <input class="input" type="date" id="start_date"
             value="{{ request.form.get('start_date','') }}">
    </div>
    <div>
      <label>Bitiş Tarihi</label>
      <input class="input" type="date" id="end_date"
             value="{{ request.form.get('end_date','') }}">
    </div>

    <!-- İKİ AYRI BUTON: ayrı ayrı / tek riske birleştir -->
    <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end">
      <a class="btn" href="{{ url_for('dashboard') }}">Vazgeç</a>

      <!-- Ayrı ayrı oluştur -->
      <button class="btn" type="submit" name="merge" value="0">Ayrı Ayrı Oluştur</button>

      <!-- Tek riskte birleştir -->
      <button class="btn btn-primary" type="submit" name="merge" value="1">Tek Risk Olarak Birleştir</button>
    </div>
  </form>

  <script>
  (function(){
    // Tarihler → YYYY-MM gizli alanlara yaz
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');

    const hiddenA1  = document.getElementById('start_month');
    const hiddenB1  = document.getElementById('end_month');
    const hiddenA2  = document.getElementById('start_month_2');
    const hiddenB2  = document.getElementById('end_month_2');

    function toYM(dateStr){ return (dateStr && dateStr.length>=10) ? dateStr.slice(0,7) : ""; }
    function syncHidden(){
      const ymS = toYM(startDate.value);
      const ymE = toYM(endDate.value);
      [hiddenA1, hiddenA2].forEach(el => { if(el) el.value = ymS || ""; });
      [hiddenB1, hiddenB2].forEach(el => { if(el) el.value = ymE || ""; });
    }

    startDate?.addEventListener('change', ()=>{
      if(endDate.value && new Date(endDate.value) < new Date(startDate.value)){
        endDate.value = startDate.value;
      }
      syncHidden();
    });
    endDate?.addEventListener('change', ()=>{
      if(startDate.value && new Date(endDate.value) < new Date(startDate.value)){
        startDate.value = endDate.value;
      }
      syncHidden();
    });

    // ilk yüklemede ve submit anında doldur
    syncHidden();
    document.getElementById('bulk-create-form')?.addEventListener('submit', syncHidden);
    document.getElementById('common-form')?.addEventListener('submit', syncHidden);
  })();
  </script>
</div>
{% endblock %}
