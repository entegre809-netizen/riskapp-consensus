{% extends "base.html" %}
{% block title %}Yeni Risk{% endblock %}
{% block content %}
<div class="card">
  <h2>Yeni Risk</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}
      <div class="flash {{ c }}">{{ m }}</div>
    {% endfor %}
  {% endwith %}

  <div style="display:flex; gap:.5rem; margin:.25rem 0 1rem">
    <a class="btn btn-secondary" href="{{ url_for('risk_identify') }}">Şablon Seç (Kütüphane)</a>
    {% if picked_suggestions and picked_suggestions|length > 0 %}
      <form method="post">
        <input type="hidden" name="action" value="create_from_picked">
        <input type="hidden" name="picked_ids" value="{{ picked_suggestions | map(attribute='id') | join(',') }}">
        <button class="btn btn-primary" type="submit">Sepetten Risk Oluştur ({{ picked_suggestions|length }})</button>
      </form>
    {% endif %}
  </div>

  {% if picked_suggestions and picked_suggestions|length > 0 %}
    <details class="card" style="margin:.5rem 0 1rem; border:1px dashed var(--line);">
      <summary class="small" style="cursor:pointer">Sepetteki şablonlar ({{ picked_suggestions|length }})</summary>
      <ul style="margin:.6rem 0 0 1rem">
        {% for s in picked_suggestions %}
          <li class="small" style="margin:.15rem 0">
            <strong>{{ s.category or 'Genel' }}</strong> — {{ s.text }}
            {% if s.risk_code %}<span class="badge" style="margin-left:.35rem">{{ s.risk_code }}</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    </details>
  {% endif %}

  <form method="post" id="risk-new-form" class="grid" style="grid-template-columns:1fr 1fr; gap:16px">
    <div style="grid-column:1/-1">
      <label>Başlık</label>
      <input class="input" name="title" placeholder="Bir başlık yazın…" required>
    </div>

    <div>
      <label>Risk Tipi</label>
      <select class="input" name="risk_type">
        <option value="">—</option>
        <option value="product">Ürün Riski</option>
        <option value="project">Proje Riski</option>
        <option value="process">Süreç/Operasyon</option>
        <option value="schedule">Zaman/Program</option>
        <option value="cost">Maliyet/Finans</option>
        <option value="quality">Kalite</option>
        <option value="safety">İSG/Güvenlik</option>
        <option value="supplier">Tedarikçi/Altyüklenici</option>
        <option value="legal">Hukuk/Sözleşme</option>
        <option value="compliance">Uyum/Regülasyon</option>
        <option value="environment">Çevresel</option>
        <option value="security">Bilgi Güvenliği</option>
        <option value="stakeholder">Paydaş/İletişim</option>
        <option value="technology">Teknoloji/Altyapı</option>
      </select>
    </div>

    <div>
      <label>Sorumlu</label>
      <input class="input" name="responsible" placeholder="Ad Soyad">
    </div>

    <div>
      <label>Olasılık (P · 1–5)</label>
      <select class="input" name="probability">
        {% for i in range(1,6) %}<option value="{{ i }}" {% if i==3 %}selected{% endif %}>{{ i }}</option>{% endfor %}
      </select>
    </div>

    <div>
      <label>Şiddet (S · 1–5)</label>
      <select class="input" name="severity">
        {% for i in range(1,6) %}<option value="{{ i }}" {% if i==3 %}selected{% endif %}>{{ i }}</option>{% endfor %}
      </select>
    </div>

    <div>
      <label>Başlangıç Tarihi</label>
      <input class="input" type="date" id="start_date">
    </div>
    <div>
      <label>Bitiş Tarihi</label>
      <input class="input" type="date" id="end_date">
    </div>
    <div style="grid-column:1/-1">
      <label>Etki Süresi</label>
      <input class="input" name="duration" placeholder="örn. 6 ay / proje boyunca">
    </div>
    <input type="hidden" name="start_month" id="start_month">
    <input type="hidden" name="end_month" id="end_month">

    <div style="grid-column:1/-1">
      <label>Açıklama</label>
      <textarea class="input" name="description" rows="4" placeholder="Riski tanımlayın"></textarea>
    </div>
    <div style="grid-column:1/-1">
      <label>Önlemler (Mitigation)</label>
      <textarea class="input" name="mitigation" rows="4" placeholder="Önerilen faaliyetler"></textarea>
    </div>

    <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end">
      <a class="btn" href="{{ url_for('risk_select') }}">İptal</a>
      <button class="btn btn-primary">Oluştur</button>
    </div>
  </form>

  <script>
  (function(){
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');
    const startYM   = document.getElementById('start_month');
    const endYM     = document.getElementById('end_month');

    function toYM(dateStr){ return (dateStr && dateStr.length>=10) ? dateStr.slice(0,7) : ""; }

    startDate?.addEventListener('change', ()=>{
      startYM.value = toYM(startDate.value);
      if(endDate.value && new Date(endDate.value) < new Date(startDate.value)){
        endDate.value = startDate.value; endYM.value = toYM(endDate.value);
      }
    });
    endDate?.addEventListener('change', ()=>{
      endYM.value = toYM(endDate.value);
      if(startDate.value && new Date(endDate.value) < new Date(startDate.value)){
        startDate.value = endDate.value; startYM.value = toYM(startDate.value);
      }
    });
    document.getElementById('risk-new-form').addEventListener('submit', ()=>{
      if(startDate.value && !startYM.value) startYM.value = toYM(startDate.value);
      if(endDate.value   && !endYM.value)   endYM.value   = toYM(endDate.value);
    });
  })();
  </script>
</div>
{% endblock %}
