{% extends "base.html" %}
{% block title %}Yeni Risk{% endblock %}
{% block content %}
<div class="card">
  <h2>Yeni Risk</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}
      <div class="flash {{ c }}">{{ m }}</div>
    {% endfor %}
  {% endwith %}

  <style>
    /* ---- Basit yardımcılar ---- */
    .mt-1 { margin-top: 6px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; }
    @media (max-width: 900px){
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }

    /* ---- Çoklu seçime ikon koyma (tekli select’lere ok ikonu) ---- */
    /* HATA DÜZELTİLDİ: url(...) içinde backslash yok, her satır ; ile biter */
    select.input:not([multiple]),
    .form-select:not([multiple]) {
      appearance: none;
      -webkit-appearance: none;
      padding-right: 2.2rem;
      background-repeat: no-repeat;
      background-position: right .65rem center;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2310182d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    }
    /* Koyu tema: ok beyaz tonda */
    [data-theme="dark"] select.input:not([multiple]),
    [data-theme="dark"] .form-select:not([multiple]) {
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23e8ecff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    }
  </style>

  <form method="post" class="grid grid-2" id="risk-new-form">
    <!-- Başlık -->
    <div>
      <label>Başlık</label>
      <input class="input" name="title" value="{{ form.get('title') if form else '' }}" required>
    </div>

    <!-- Kategoriler (çoklu seçim) -->
    <div>
      <label class="form-label">Kategoriler</label>
      {% set selected = form.getlist('category_id') if form else [] %}
      <select name="category_id" class="form-select input" multiple size="6" required>
        {% for c in categories %}
          <option value="{{ c.id }}"
                  {% if (c.id|string) in selected %}selected{% endif %}>
            {{ c.name }}{% if c.code %} ({{ c.code|lower }}){% endif %}
          </option>
        {% endfor %}
      </select>
      <div class="small mt-1">
        Birden fazla kategori seçebilirsiniz (Ctrl/Cmd veya Shift ile). Seçtiğiniz her kategori için ayrı bir risk oluşturulur.
      </div>
    </div>

    <!-- Risk Tipi -->
    <div>
      <label>Risk Tipi</label>
      {% set rt = form.get('risk_type') if form else '' %}
      <select class="input" name="risk_type">
        <option value=""        {% if rt == '' %}selected{% endif %}>—</option>
        <option value="product" {% if rt == 'product' %}selected{% endif %}>Ürün Riski</option>
        <option value="project" {% if rt == 'project' %}selected{% endif %}>Proje Riski</option>
        <option value="process"    {% if rt == 'process' %}selected{% endif %}>Süreç/Operasyon</option>
        <option value="schedule"   {% if rt == 'schedule' %}selected{% endif %}>Zaman/Program</option>
        <option value="cost"       {% if rt == 'cost' %}selected{% endif %}>Maliyet/Finans</option>
        <option value="quality"    {% if rt == 'quality' %}selected{% endif %}>Kalite</option>
        <option value="safety"     {% if rt == 'safety' %}selected{% endif %}>İSG/Güvenlik</option>
        <option value="supplier"   {% if rt == 'supplier' %}selected{% endif %}>Tedarikçi/Altyüklenici</option>
        <option value="legal"      {% if rt == 'legal' %}selected{% endif %}>Hukuk/Sözleşme</option>
        <option value="compliance" {% if rt == 'compliance' %}selected{% endif %}>Uyum/Regülasyon</option>
        <option value="environment"{% if rt == 'environment' %}selected{% endif %}>Çevresel</option>
        <option value="security"   {% if rt == 'security' %}selected{% endif %}>Bilgi Güvenliği</option>
        <option value="stakeholder"{% if rt == 'stakeholder' %}selected{% endif %}>Paydaş/İletişim</option>
        <option value="technology" {% if rt == 'technology' %}selected{% endif %}>Teknoloji/Altyapı</option>
      </select>
    </div>

    <!-- Sorumlu -->
    <div>
      <label>Sorumlu</label>
      <input class="input" name="responsible" value="{{ form.get('responsible') if form else '' }}" placeholder="Ad Soyad">
    </div>

    <!-- Olasılık -->
    <div>
      <label>Olasılık (P · 1–5)</label>
      {% set pval = (form.get('probability')|int) if form and form.get('probability') else None %}
      <select class="input" name="probability">
        {% for i in range(1,6) %}
          {% set sel = (pval == i) or ((pval is none) and i==3) %}
          <option value="{{ i }}" {% if sel %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Şiddet -->
    <div>
      <label>Şiddet (S · 1–5)</label>
      {% set sval = (form.get('severity')|int) if form and form.get('severity') else None %}
      <select class="input" name="severity">
        {% for i in range(1,6) %}
          {% set sel = (sval == i) or ((sval is none) and i==3) %}
          <option value="{{ i }}" {% if sel %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Detection (opsiyonel) -->
    
    <!-- Zaman / Etki -->
    <div class="grid-3" style="grid-column:1/-1;">
      <!-- GÖRÜNÜR: gün/ay/yıl seçilebilen HTML date inputları -->
      <div>
        <label>Başlangıç Tarihi</label>
        <input class="input" type="date" id="start_date">
      </div>
      <div>
        <label>Bitiş Tarihi</label>
        <input class="input" type="date" id="end_date">
      </div>
      <div>
        <label>Etki Süresi</label>
        <input class="input" name="duration" placeholder="örn. 6 ay / proje boyunca" value="{{ form.get('duration') if form else '' }}">
      </div>

      <!-- Backend uyumu: GİZLİ YYYY-MM alanları (DB bu formatı bekliyor) -->
      <input type="hidden" name="start_month" id="start_month" value="{{ form.get('start_month') if form else '' }}">
      <input type="hidden" name="end_month"   id="end_month"   value="{{ form.get('end_month') if form else '' }}">
    </div>

    <!-- Açıklama ve Mitigation -->
    <div class="grid-2" style="grid-column:1/-1;">
      <div>
        <label>Açıklama</label>
        <textarea class="input" name="description" rows="4" placeholder="Riski tanımlayın">{{ form.get('description') if form else '' }}</textarea>
      </div>
      <div>
        <label>Önlemler (Mitigation)</label>
        <textarea class="input" name="mitigation" rows="4" placeholder="Önerilen faaliyetler">{{ form.get('mitigation') if form else '' }}</textarea>
      </div>
    </div>

    <!-- Butonlar -->
    <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end">
      <a class="btn" href="{{ url_for('risk_select') }}">İptal</a>
      <button class="btn btn-primary">Oluştur</button>
    </div>
  </form>

  <script>
  (function(){
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');
    const startYM   = document.getElementById('start_month');
    const endYM     = document.getElementById('end_month');

    // "YYYY-MM" -> "YYYY-MM-01"
    function firstDayOfYM(ym){
      if(!ym || ym.length < 7) return "";
      return ym + "-01";
    }
    // "YYYY-MM" -> "YYYY-MM-(28/29/30/31)"
    function lastDayOfYM(ym){
      if(!ym || ym.length < 7) return "";
      const parts = ym.split("-");
      const Y = parseInt(parts[0],10), M = parseInt(parts[1],10);
      if(!Y || !M) return "";
      const d = new Date(Y, M, 0);
      const day = String(d.getDate()).padStart(2,'0');
      return ym + "-" + day;
    }
    // "YYYY-MM-DD" -> "YYYY-MM"
    function toYM(dateStr){
      if(!dateStr || dateStr.length < 10) return "";
      return dateStr.slice(0,7);
    }

    // Açılışta: gizli YYYY-MM değerlerinden görünür tarihleri hydrate et
    (function hydrateVisibleDatesFromHidden(){
      const preStartYM = startYM.value || "";
      const preEndYM   = endYM.value   || "";
      if (preStartYM && !startDate.value){
        startDate.value = firstDayOfYM(preStartYM);
      }
      if (preEndYM && !endDate.value){
        endDate.value = lastDayOfYM(preEndYM);
      }
    })();

    // Değiştikçe: gizli YYYY-MM alanlarını senkronla ve mantıksal kontrol yap
    if (startDate) startDate.addEventListener('change', ()=>{
      startYM.value = toYM(startDate.value);
      if(endDate.value && new Date(endDate.value) < new Date(startDate.value)){
        endDate.value = startDate.value;
        endYM.value = toYM(endDate.value);
      }
    });
    if (endDate) endDate.addEventListener('change', ()=>{
      endYM.value = toYM(endDate.value);
      if(startDate.value && new Date(endDate.value) < new Date(startDate.value)){
        startDate.value = endDate.value;
        startYM.value = toYM(startDate.value);
      }
    });

    // Submit: son kez garanti senkron
    document.getElementById('risk-new-form').addEventListener('submit', ()=>{
      if (startDate.value && !startYM.value) startYM.value = toYM(startDate.value);
      if (endDate.value   && !endYM.value)   endYM.value   = toYM(endDate.value);
    });
  })();
  </script>

</div>
{% endblock %}
