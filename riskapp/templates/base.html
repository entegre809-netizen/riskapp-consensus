<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}Entegre Risk Y√∂netimi{% endblock %}</title>

  <!-- Harici CSS'in kalabilir; bu sayfa kendi stillerini de i√ßeriyor -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* ==========================================================
       RiskApp ¬∑ 2026 Modern UI ‚Äî Base Template
       - I≈üƒ±k/Koyu tema (manuel + sistem tercihi)
       - Mobilde √ºst bar + a√ßƒ±lƒ±r sidebar
       - Eri≈üilebilir odak halkalarƒ±, sticky table head
       - Hafif animasyonlar, yumu≈üak ge√ßi≈üler
       ========================================================== */

    /* Sistem tercihine saygƒ± */
    @media (prefers-color-scheme: dark){ :root{ color-scheme:dark } }
    @media (prefers-color-scheme: light){ :root{ color-scheme:light } }

    /* ====================
       Tema Tokenlarƒ± (Koyu)
       ==================== */
    :root,
    [data-theme="dark"]{
      --bg: #0b1020;
      --bg-soft: #0f1630;
      --surface: #0d152c;

      --card: #121a38cc;  /* hafif cam efekti */
      --card-solid:#121a38;

      --text: #e8ecff;
      --text-dim:#a5b1d6;

      --line: #243055;

      --brand:   #0a0f25;
      --brand-2: #0f1736;
      --primary: #6ea8ff;
      --primary-2:#8fb9ff;
      --success: #39d98a;
      --warning: #f59e0b;
      --danger:  #ef4444;

      --low:#34d399;
      --mid:#f59e0b;
      --high:#ef4444;

      --ring: #6ea8ff;

      --elev: 0 6px 18px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.04);
      --elev-card: 0 16px 36px rgba(8,15,40,.36);
      --glass-blur: saturate(140%) blur(6px);

      --radius-2xl: 18px;
      --radius: 14px;
      --radius-sm: 10px;
      --pad: 14px;

      --font: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --ease: cubic-bezier(.22,1,.36,1);
    }

    /* =====================
       Tema Tokenlarƒ± (A√ßƒ±k)
       ===================== */
    [data-theme="light"]{
      --bg: #f7faff;
      --bg-soft: #ffffff;
      --surface: #f7f9ff;

      --card: #ffffffee;
      --card-solid:#ffffff;

      --text: #0a1328;
      --text-dim:#556384;

      --line: #e6ebf4;

      --brand:   #fff0b8;
      --brand-2: #fff7d8;
      --primary: #ffd24d;
      --primary-2:#ffe07a;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger:  #e05656;

      --ring: #ffd65a;

      --elev: 0 8px 18px rgba(15,23,42,.08), inset 0 0 0 1px rgba(15,23,42,.03);
      --elev-card: 0 14px 28px rgba(15,23,42,.10);
      --glass-blur: saturate(118%) blur(5px);

      --radius-2xl: 18px;
      --radius: 14px;
      --radius-sm: 10px;
      --pad: 14px;

      --font: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* ========== Reset/Global ========== */
    *{ box-sizing:border-box }
    html,body{
      margin:0; padding:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 0% 0%, color-mix(in oklab, var(--brand-2) 46%, transparent) 0%, transparent 60%),
        radial-gradient(1000px 700px at 100% 0%, color-mix(in oklab, var(--brand) 36%, transparent) 0%, transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, color-mix(in oklab, var(--bg) 92%, #ffffff 8%) 100%);
      min-height:100dvh;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
      transition: background .25s ease, color .25s ease;
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
    a{ color:#1247ff; text-decoration:none; font-weight:700 }
    [data-theme="dark"] a{ color:#9fc0ff }
    a:hover{ text-decoration:underline }

    h1,h2,h3{ line-height:1.2; margin:.2rem 0 .7rem; letter-spacing:.01em }
    h1{ font-size: clamp(1.45rem, 2.1vw, 1.9rem); font-weight:900 }
    h2{ font-size: clamp(1.25rem, 1.8vw, 1.55rem); font-weight:850 }
    h3{ font-size: clamp(1.08rem, 1.5vw, 1.25rem); font-weight:800 }

    img{ max-width:100%; height:auto; border-radius: 10px }

    /* ========== Yerle≈üim ========== */
    .shell{
      display:grid;
      grid-template-rows: auto 1fr;
      min-height:100dvh;
    }

    /* √úst bar (mobil ve masa√ºst√º) */
    .topbar{
      position:sticky; top:0; z-index:5;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background: color-mix(in oklab, var(--bg) 86%, transparent);
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
    }
    .topbar .brand{
      display:flex; align-items:center; gap:10px; font-weight:900;
      padding:6px 10px; border-radius:12px;
      background: linear-gradient(180deg, color-mix(in oklab, var(--primary) 22%, transparent), transparent);
      color: color-mix(in oklab, var(--text) 88%, #000 12%);
    }
    .topbar .spacer{ flex:1 }
    .topbar .btn-icon{
      display:inline-grid; place-items:center;
      width:40px; height:40px; border-radius:12px;
      border:1px solid color-mix(in oklab, var(--text) 10%, transparent);
      background: color-mix(in oklab, var(--bg-soft) 76%, transparent);
      cursor:pointer; transition: filter .15s ease;
    }
    .topbar .btn-icon:hover{ filter:brightness(1.06) }

    /* Ana layout: sol men√º + i√ßerik */
    .layout{
      display:grid; grid-template-columns: 280px 1fr; gap:0;
      min-height: calc(100dvh - 62px);
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr }
    }

    /* Desktop: hamburger ile sidebar'ƒ± tamamen gizle */
    @media (min-width: 981px){
      body.sidebar-collapsed .layout{
        grid-template-columns: 1fr;
      }
      body.sidebar-collapsed .sidebar{
        display:none;
      }
    }

    /* Sidebar */
    .sidebar{
      position:sticky; top:62px; align-self:start;
      height: calc(100dvh - 62px);
      overflow:auto;
      background:linear-gradient(180deg, var(--brand) 0%, var(--brand-2) 100%);
      color:#1b2338; padding:16px 0; border-right:1px solid color-mix(in oklab, var(--line) 70%, transparent);
      box-shadow: var(--elev);
      transform: translateX(0); transition: transform .28s var(--ease);
    }
    [data-theme="dark"] .sidebar{
      color:#dbe5ff; border-right:1px solid rgba(255,255,255,.08);
    }
    /* Mobilde kapalƒ± ba≈ülasƒ±n */
    @media (max-width: 980px){
      .sidebar{ position:fixed; inset:62px auto 0 0; width:min(78vw, 300px); transform: translateX(-102%); z-index:6 }
      .sidebar.open{ transform:none }
    }

    .menu-section{ margin:10px 0 16px }
    .menu-title{
      margin:.3rem 0 .4rem 1rem; font-size:.78rem; text-transform:uppercase;
      letter-spacing:.09em; color:#616b86; font-weight:900; opacity:.9;
    }
    [data-theme="dark"] .menu-title{ color:#9fb3ff }

    .menu a{
      display:flex; align-items:center; gap:.55rem;
      padding:.64rem 1.1rem; color:#253052; text-decoration:none;
      border-left:3px solid transparent; border-radius:0 var(--radius-sm) var(--radius-sm) 0;
      transition: background .18s ease, color .18s ease, border-color .18s ease;
      font-weight:700;
    }
    .menu a:hover{ background:rgba(0,0,0,.05); color:#0e172c }
    .menu a.active,[aria-current="page"]{
      background:linear-gradient(90deg, color-mix(in oklab, var(--primary) 28%, transparent), transparent);
      color:#0e172c; border-left-color: var(--primary);
      box-shadow: inset 0 0 0 1px color-mix(in oklab, var(--primary) 24%, transparent);
    }
    [data-theme="dark"] .menu a{ color:#cfe0ff }
    [data-theme="dark"] .menu a:hover{ background:rgba(255,255,255,.06); color:#fff }
    [data-theme="dark"] .menu a.active,
    [data-theme="dark"] .menu a[aria-current="page"]{
      background:linear-gradient(90deg, rgba(110,168,255,.16), rgba(110,168,255,0));
      color:#fff; border-left-color: var(--primary);
      box-shadow: inset 0 0 0 1px rgba(110,168,255,.14);
    }
    .submenu{ margin-left:.25rem; border-left:2px dashed rgba(0,0,0,.06) }
    [data-theme="dark"] .submenu{ border-left-color: rgba(255,255,255,.08) }
    .submenu a{ padding-left:1.2rem; font-size:.98rem }

    /* Ana i√ßerik paneli */
    .main{
      padding: 20px min(4vw, 36px) 40px;
    }
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius-2xl);
      padding: clamp(16px, 2vw, 22px);
      box-shadow: var(--elev-card);
      backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }

    /* Grid yardƒ±mcƒ±larƒ± */
    .grid{ display:grid; gap:14px }
    .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)) }
    .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)) }
    @media (max-width: 980px){
      .grid-2, .grid-3{ grid-template-columns: 1fr }
    }

    /* Formlar */
    label{ display:block; font-size:.86rem; color:var(--text-dim); margin-bottom:.45rem; font-weight:850 }
    .input, select.input, textarea.input{
      width:100%; padding:.78rem .85rem; border-radius:12px;
      border:1px solid color-mix(in oklab, var(--line) 88%, transparent);
      background: linear-gradient(180deg, #ffffff, #f7faff);
      color:#0a1328; outline:none; font-weight:600;
      transition:.2s border-color, .2s box-shadow, .2s background, .2s color;
    }
    .input::placeholder{ color:#8691a9; opacity:.95 }
    .input:focus{
      border-color: color-mix(in oklab, var(--ring) 60%, transparent);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--ring) 35%, transparent), inset 0 0 0 1px rgba(0,0,0,.04);
      background:#ffffff;
    }
    [data-theme="dark"] .input, [data-theme="dark"] select.input, [data-theme="dark"] textarea.input{
      border:1px solid rgba(150,170,220,.35);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      color:#f6f8ff; font-weight:600; color-scheme: dark;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    [data-theme="dark"] .input::placeholder{ color:#aebbff; opacity:.9 }
    [data-theme="dark"] .input:focus{
      border-color: rgba(110,168,255,.85);
      box-shadow: 0 0 0 4px rgba(110,168,255,.22), inset 0 0 0 1px rgba(110,168,255,.35);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      color:#ffffff;
    }
    /* Select oku */
    select.input{ appearance:none; -webkit-appearance:none; padding-right:2.1rem;
      background-position: right .65rem center; background-repeat:no-repeat;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2310182d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    }
    [data-theme="dark"] select.input{
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23e8ecff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    }

    /* Butonlar */
    .btn{
      display:inline-flex; align-items:center; gap:.55rem;
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      background: linear-gradient(180deg, #ffffff, #f4f7ff);
      color:#0f182d; padding:.66rem 1rem; border-radius:12px; cursor:pointer;
      transition: transform .08s ease, filter .15s ease, box-shadow .2s ease, background .25s ease, color .25s ease, border-color .25s ease;
      box-shadow: 0 8px 16px rgba(13,19,33,.08), inset 0 0 0 1px rgba(255,255,255,.95);
      font-weight:900; text-decoration:none; line-height:1;
    }
    .btn:hover{ filter:brightness(1.03); box-shadow: 0 12px 22px rgba(13,19,33,.12), inset 0 0 0 1px rgba(255,255,255,1) }
    .btn:active{ transform: translateY(1px) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-primary{
      background: linear-gradient(180deg, var(--primary), color-mix(in oklab, var(--primary) 78%, #000 22%));
      color:#0a1228; border-color: transparent; text-shadow: 0 1px 0 rgba(255,255,255,.35);
      box-shadow: 0 8px 18px rgba(255,210,77,.22);
    }
    .btn-success{ background: linear-gradient(180deg, #3de097, #18c578); color:#06141d; border-color: transparent; font-weight:800 }
    [data-theme="dark"] .btn{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      color:#eaf0ff;
      box-shadow: 0 6px 14px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    }

    /* Odak halkasƒ± (t√ºm etkile≈üimliler) */
    :where(a, button, .btn, .input, textarea.input, select.input):focus-visible{
      outline: none;
      box-shadow:
        0 0 0 4px color-mix(in oklab, var(--ring) 40%, transparent),
        0 2px 16px color-mix(in oklab, var(--ring) 18%, transparent),
        inset 0 0 0 1px color-mix(in oklab, var(--ring) 50%, transparent);
      border-color: color-mix(in oklab, var(--ring) 65%, transparent);
    }

    /* Tablo */
    .table-wrap{ overflow:auto; border-radius:14px }
    .table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px }
    .table th,.table td{
      padding:.78rem .9rem; border-bottom:1px solid var(--line);
      text-align:left; font-size:.96rem; vertical-align:top;
    }
    .table thead th{
      font-size:.82rem; text-transform:uppercase; letter-spacing:.09em;
      color:var(--text-dim);
      position:sticky; top:0; z-index:1;
      background: color-mix(in oklab, var(--surface) 84%, transparent);
      backdrop-filter: blur(4px);
      border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      font-weight:900;
    }
    .table tbody tr:hover td{ background: color-mix(in oklab, var(--primary) 6%, transparent) }

    /* Flash/Badge */
    .flash{
      margin:.7rem 0; padding:.85rem 1rem; border-radius:12px; font-size:.98rem;
      border:1px solid #ffe3a1; background: linear-gradient(180deg, #fff7df, #fff1c9);
      color:#3a2c0e; box-shadow: inset 0 0 0 1px rgba(255,255,255,.85); font-weight:800;
    }
    .flash.success{ background:linear-gradient(180deg, #eafff4, #d8ffee); color:#073a2a; border-color:#baffdf }
    .flash.danger{  background:linear-gradient(180deg, #ffefef, #ffe3e3); color:#5a1c1c; border-color:#ffc9c9 }
    .flash.info{    background:linear-gradient(180deg, #f5f9ff, #eef4ff); color:#17223a; border-color:#dbe6ff }
    [data-theme="dark"] .flash{
      border-color: rgba(255,255,255,.15);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      color:#f3f6ff;
    }

    .badge{
      display:inline-block; padding:.28rem .6rem; border-radius:999px; font-size:.86rem;
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      background: #fffdf5; color:#4b3a0f; font-weight:800;
    }
    [data-theme="dark"] .badge{
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.08); color:#eaeef7;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .score-low{ background:rgba(16,185,129,.18); color:#116b4f; border-color:rgba(16,185,129,.28) }
    .score-mid{ background:rgba(245,158,11,.18); color:#6f4b00;   border-color:rgba(245,158,11,.28) }
    .score-high{background:rgba(239,68,68,.18);  color:#7a1e1e;   border-color:rgba(239,68,68,.28) }

    .small{ font-size:.86rem; color:var(--text-dim); font-weight:600 }
    .footer{ margin-top:32px; color:var(--text-dim); font-size:.9rem }

    /* Yazdƒ±rma */
    @media print{
      .noprint{ display:none !important }
      body{ background:#fff; color:#111 }
      .topbar, .sidebar{ display:none }
      .main{ padding:0 }
      .panel{ box-shadow:none; border:1px solid #ddd; background:#fff; color:#111 }
      .table th,.table td{ border-color:#eee }
    }

    /* Y√ºksek Kontrast */
    @media (prefers-contrast: more){
      .btn, .input, select.input, textarea.input, .panel, .menu a{ border-width:2px }
      .menu a.active{ outline: 3px solid color-mix(in oklab, var(--ring) 40%, transparent) }
    }

    /* ===========================
       AUTH/HIDE_NAV (login/register veya men√ºs√ºz sayfa)
       =========================== */
    .layout.auth{ grid-template-columns:1fr !important; }
    .auth .sidebar{ display:none !important; }
    .auth #sidebarToggle{ display:none !important; } /* √úst bardaki ‚ò∞ de gizlensin */
  </style>
</head>
<body class="{% block body_class %}{{ 'auth' if (hide_nav|default(false) or request.endpoint=='welcome') }}{% endblock %}">

<div class="shell">
  <!-- √úST BAR -->
  <header class="topbar noprint">
    {% if not (hide_nav|default(false) or request.endpoint=='welcome') %}
      <button class="btn-icon" id="sidebarToggle" aria-label="Men√ºy√º A√ß/Kapat">‚ò∞</button>
    {% endif %}
    <div class="brand">‚ö†Ô∏è Risk Y√∂netimi</div>
    <div class="spacer"></div>

    {% if session.get('username') and request.endpoint != 'welcome' %}
      <div class="small">
        üëã {{ session.get('username') }}
        {% if session.get('role') %} ¬∑ {{ session.get('role')|capitalize }}{% endif %}
      </div>
    {% endif %}

    <button id="themeToggle" class="btn" onclick="window.__toggleTheme?.()" style="margin-left:8px">
      üåô Koyu Tema
    </button>
  </header>

  <div class="layout {% block layout_class %}{{ 'auth' if (hide_nav|default(false) or request.endpoint=='welcome') }}{% endblock %}">
    <!-- SOL MEN√ú -->
    {% block sidebar %}
    {% if not (hide_nav|default(false) or request.endpoint=='welcome') %}
    <aside class="sidebar" id="sidebar">
      <!-- Proje Se√ßici (varsa) -->
      {% if session.get('account_id') %}
        {% set _acc_id = session.get('account_id') %}
        {% set _projects = ProjectInfo.query.filter_by(account_id=_acc_id).order_by(ProjectInfo.created_at.desc()).all() %}
        {% if _projects and _projects|length > 1 %}
          <form method="post" action="{{ url_for('switch_project') }}" class="small" style="padding:0 1rem .75rem">
            <label for="project_id" style="display:block;margin-bottom:6px;font-weight:900">Aktif Proje</label>
            <select class="input" id="project_id" name="project_id" onchange="this.form.submit()">
              {% set _pid = session.get('project_id') %}
              {% for p in _projects %}
                <option value="{{ p.id }}" {{ 'selected' if _pid==p.id }}>{{ p.workplace_name }}</option>
              {% endfor %}
            </select>
          </form>
        {% endif %}
      {% endif %}

      <div class="menu-section">
        <div class="menu-title">Dashboard</div>
        <nav class="menu">
          <a href="{{ url_for('dashboard') }}" class="{{ 'active' if request.endpoint=='dashboard' }}">Genel G√∂r√ºn√ºm</a>
        </nav>
      </div>

      <!-- Rƒ∞SK MEN√úS√ú -->
      <div class="menu-section">
        <div class="menu-title">Risk</div>
        <nav class="menu submenu">
          <a href="{{ url_for('risk_identify') }}" class="{{ 'active' if request.endpoint=='risk_identify' }}">Risk / Kategorisi G√∂r√ºnt√ºleme</a>
          <a href="{{ url_for('risk_new') }}" class="{{ 'active' if request.endpoint=='risk_new' }}">Yeni Risk Tanƒ±mlama</a>
          <a href="{{ url_for('risk_select') }}" class="{{ 'active' if request.endpoint=='risk_select' }}">Ge√ßmi≈ü ƒ∞≈ülem Verilerim</a>
          <a href="{{ url_for('categories_index') }}" class="{{ 'active' if request.endpoint=='categories_index' }}">Kategoriler</a>
          <a href="{{ url_for('schedule') }}" class="{{ 'active' if request.endpoint=='schedule' }}">Zaman √áizelgesi</a>

          {# ‚úÖ Maliyetler linki (endpoint yoksa sayfa patlamasƒ±n) #}
          {% set _has_ep_helper = (has_endpoint is defined) %}
          {% set _costs_ep = (
              'costs' if (
                (_has_ep_helper and has_endpoint('costs')) or
                (not _has_ep_helper and ('costs' in current_app.view_functions))
              )
              else None
          ) %}
          {% if _costs_ep %}
            <a href="{{ url_for(_costs_ep) }}" class="{{ 'active' if request.endpoint==_costs_ep }}">Maliyetler</a>
          {% endif %}

          <a href="{{ url_for('reports') }}" class="{{ 'active' if request.endpoint=='reports' }}">Raporlar</a>

          {% if r is defined %}
            {# Risk detayƒ±ndayken ekstra linkler koyacaksan buraya #}
          {% endif %}

          {% if session.get('role') == 'admin' %}
            <a href="{{ url_for('import_suggestions') }}" class="{{ 'active' if request.endpoint=='import_suggestions' }}">Risk ve Kategori Aktarma (CSV,Excel)</a>
          {% endif %}

          <a href="{{ url_for('responsibles') }}" class="{{ 'active' if request.endpoint=='responsibles' }}">Sorumlu √ñzeti</a>
          <a href="{{ url_for('risks_export_xlsx', title='DENƒ∞Z YAPILARI ƒ∞N≈ûAAT PROJESƒ∞ Rƒ∞SK ANALƒ∞Zƒ∞') }}">Excel (Bi√ßimli) Dƒ±≈üa Aktar</a>
        </nav>
      </div>

      <div class="menu-section">
        <div class="menu-title">Ayarlar</div>
        <nav class="menu submenu">
          {# ---- G√ºvenli admin linki: √∂nce endpoint var mƒ± bakƒ±yoruz ---- #}
          {% set _has_ep_helper = (has_endpoint is defined) %}
          {% set _admin_ep = (
              'admin.admin_users' if (
                (_has_ep_helper and has_endpoint('admin.admin_users')) or
                (not _has_ep_helper and ('admin.admin_users' in current_app.view_functions))
              )
              else (
                'admin_users' if (
                  (_has_ep_helper and has_endpoint('admin_users')) or
                  (not _has_ep_helper and ('admin_users' in current_app.view_functions))
                )
                else None
              )
          ) %}
          {% if _admin_ep %}
            <a href="{{ url_for(_admin_ep) }}"
               class="{{ 'active' if request.endpoint == _admin_ep }}">Kullanƒ±cƒ± Y√∂netimi</a>
          {% endif %}

          <a href="{{ url_for('settings_account') }}" class="{{ 'active' if request.endpoint=='settings_account' }}">Hesap Bilgileri</a>
          <a href="{{ url_for('settings_project') }}" class="{{ 'active' if request.endpoint=='settings_project' }}">Proje Bilgileri</a>
        </nav>
      </div>

      <div class="menu-section">
        <div class="menu-title">Hesap</div>
        <nav class="menu">
          <a href="{{ url_for('logout') }}">Oturumu Kapat</a>
        </nav>
      </div>
    </aside>
    {% endif %}
    {% endblock %}

    <!-- ANA ƒ∞√áERƒ∞K -->
    <main class="main">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="flash {{cat}}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <section class="panel">
        {% block content %}{% endblock %}
      </section>

      <p class="footer">¬© {{ 2025 }} Entegre Risk Y√∂netimi ¬∑ <span class="small">v1</span></p>
    </main>
  </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ‚úÖ Chart.js (Pareto grafikleri i√ßin) -->
<script src="{{ url_for('static', filename='vendor/chart.umd.min.js') }}"></script>

<!-- Tema toggle + sidebar + panel auto-mark -->
<script>
(function(){
  const KEY = 'riskapp.theme';
  const SIDEBAR_KEY = 'riskapp.sidebarCollapsed';
  const root = document.documentElement;
  const getBtnTheme = () => document.getElementById('themeToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');

  function applyTheme(t){
    root.setAttribute('data-theme', t);
    try{ localStorage.setItem(KEY, t); }catch(e){}
    const btn = getBtnTheme();
    if (btn){
      btn.textContent = (t === 'light') ? 'üåô Koyu Tema' : 'üåû A√ßƒ±k Tema';
    }
  }

  const saved = (()=>{ try{ return localStorage.getItem(KEY); }catch(e){ return null } })();
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const initial = saved || (prefersDark ? 'dark' : 'light');
  applyTheme(initial);

  window.__toggleTheme = function(){
    const current = root.getAttribute('data-theme') || 'light';
    applyTheme(current === 'light' ? 'dark' : 'light');
  };

  function isMobile(){
    return window.matchMedia && window.matchMedia('(max-width: 980px)').matches;
  }

  // Desktop i√ßin sidebar collapsed state'ini y√ºkle
  (function initSidebarPref(){
    if (!sidebar) return;
    let collapsed = false;
    try{
      collapsed = localStorage.getItem(SIDEBAR_KEY) === '1';
    } catch(e){}
    if (collapsed && !isMobile()){
      document.body.classList.add('sidebar-collapsed');
    }
  })();

  // Sidebar toggle (mobil + desktop)
  if (sidebarToggle && sidebar){
    sidebarToggle.addEventListener('click', () => {
      if (isMobile()){
        // Mobil: slide-in men√º
        sidebar.classList.toggle('open');
      } else {
        // Desktop: sidebar tamamen gizle/g√∂ster
        document.body.classList.toggle('sidebar-collapsed');
        try{
          const collapsed = document.body.classList.contains('sidebar-collapsed');
          localStorage.setItem(SIDEBAR_KEY, collapsed ? '1' : '0');
        } catch(e){}
      }
    });

    // Sidebar dƒ±≈üƒ±na tƒ±klayƒ±nca kapat (sadece mobilde)
    document.addEventListener('click', (e)=>{
      if (!isMobile()) return;
      if (!sidebar.classList.contains('open')) return;
      const within = sidebar.contains(e.target) || sidebarToggle.contains(e.target);
      if (!within) sidebar.classList.remove('open');
    });

    // Ekran boyutu deƒüi≈üince mobil>desktop ge√ßi≈üinde a√ßƒ±k sidebar'ƒ± kapat
    window.addEventListener('resize', ()=>{
      if (!isMobile()){
        sidebar.classList.remove('open');
      }
    });
  }

  // Deƒüerlendirme / RPN panellerini koyu temada auto-mark (beyaz fix)
  function markAssessmentsPanel(){
    const candidates = document.querySelectorAll('.panel, .card, .section, .box, .content, .container');
    candidates.forEach(el => {
      const titleEl = el.querySelector('h1, h2, h3, .title, .header');
      if (!titleEl) return;
      const t = (titleEl.textContent || '').trim().toLowerCase();
      if (t.startsWith('deƒüerlendirmeler') || t === 'rpn' || t.includes('p / s / d')){
        el.classList.add('assessments');
      }
    });
  }
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', markAssessmentsPanel); }
  else { markAssessmentsPanel(); }
})();
</script>

<!-- ‚úÖ Modal/backdrop kilitlenme sigortasƒ± (hi√ßbir ≈üeyi eksiltmeden sadece ek) -->
<script>
(function(){
  function cleanupBackdrops(){
    // A√ßƒ±k modal yoksa backdrop ve kilidi temizle
    const openModal = document.querySelector('.modal.show');
    if (!openModal){
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('overflow');
      document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    }
  }

  // data-bs-dismiss tƒ±klarƒ±nƒ± garanti kapat (bazƒ± custom markup'larda bootstrap ka√ßƒ±rabiliyor)
  document.addEventListener('click', (e) => {
    const dismissBtn = e.target.closest('[data-bs-dismiss="modal"]');
    if (!dismissBtn) return;

    const modalEl = dismissBtn.closest('.modal');
    if (!modalEl) { cleanupBackdrops(); return; }

    try{
      if (window.bootstrap){
        bootstrap.Modal.getOrCreateInstance(modalEl).hide();
      } else {
        // Bootstrap objesi yoksa yine de sayfa kilidini kaldƒ±r
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        cleanupBackdrops();
      }
    }catch(_){
      modalEl.classList.remove('show');
      modalEl.style.display = 'none';
      cleanupBackdrops();
    }
  });

  // Bootstrap eventleriyle de temizle
  document.addEventListener('hidden.bs.modal', cleanupBackdrops);
  window.addEventListener('pageshow', cleanupBackdrops);

  // ESC ile de ka√ßƒ±≈ü kapƒ±sƒ±
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') cleanupBackdrops();
  });
})();
</script>
{% endblock %}

</body>
</html>
