<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}Entegre Risk YÃ¶netimi{% endblock %}</title>

  <!-- Tailwind (senin RiskApp ÅŸablon dili iÃ§in) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&display=swap" rel="stylesheet"/>

  <!-- Bootstrap kalabilir (modal/backdrop vs) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- Senin ana CSS'in -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#2866bd",
            "background-light": "#f0f2f4",
            "background-dark": "#17191c",
            "slate-muted": "#8B919D",
            charcoal: "#474B52"
          },
          fontFamily: {
            display: ["Space Grotesk", "sans-serif"]
          },
          borderRadius: {
            DEFAULT: "0.5rem",
            lg: "1rem",
            xl: "1.5rem",
            full: "9999px"
          }
        }
      }
    }
  </script>

  <style>
    /* ==========================================================
       RiskApp Â· Base Template (2026 Modern)
       - data-theme tokenlarÄ± (dashboard template'in buna baÄŸlÄ±)
       - Tailwind dark class ile uyum
       - Sticky topbar + modern sidebar
       ========================================================== */

    :root{ color-scheme: light; }
    [data-theme="dark"]{ color-scheme: dark; }

    /* ====================
       Tokenlar (LIGHT)
       ==================== */
    [data-theme="light"]{
      --bg: #f0f2f4;
      --bg-soft: #ffffff;
      --surface: #f6f7f8;

      --card: #ffffff;
      --card-solid:#ffffff;

      --text: #0f172a;
      --text-dim:#64748b;

      --line: #e5e7eb;

      --primary: #2866bd;
      --primary-2:#3b82f6;

      --success: #16a34a;
      --warning: #f59e0b;
      --danger:  #ef4444;

      --ring: rgba(40,102,189,.35);

      --elev: 0 10px 40px -10px rgba(0,0,0,0.08);
      --elev-card: 0 10px 40px -10px rgba(0,0,0,0.10);
      --glass-blur: saturate(120%) blur(8px);

      --radius-2xl: 18px;
      --radius: 14px;
      --radius-sm: 10px;

      --font: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --ease: cubic-bezier(.22,1,.36,1);
    }

    /* ====================
       Tokenlar (DARK)
       ==================== */
    [data-theme="dark"]{
      --bg: #17191c;
      --bg-soft: #121820;
      --surface: #121820;

      --card: #1e2126;
      --card-solid:#1e2126;

      --text: #eaf0ff;
      --text-dim:#9aa4b2;

      --line: rgba(255,255,255,.10);

      --primary: #2866bd;
      --primary-2:#60a5fa;

      --success: #22c55e;
      --warning: #f59e0b;
      --danger:  #ef4444;

      --ring: rgba(96,165,250,.35);

      --elev: 0 10px 40px -10px rgba(0,0,0,0.35);
      --elev-card: 0 16px 40px rgba(0,0,0,.35);
      --glass-blur: saturate(140%) blur(10px);

      --radius-2xl: 18px;
      --radius: 14px;
      --radius-sm: 10px;

      --font: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --ease: cubic-bezier(.22,1,.36,1);
    }

    /* ========== Reset/Global ========== */
    *{ box-sizing:border-box }
    html,body{
      margin:0; padding:0;
      font-family:var(--font);
      color:var(--text);
      background: var(--bg);
      min-height:100dvh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      transition: background .25s ease, color .25s ease;
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }

    a{
      color: var(--primary);
      text-decoration:none;
      font-weight:700;
    }
    a:hover{ text-decoration:underline }

    /* Whisper shadow helper */
    .whisper-shadow{ box-shadow: var(--elev); }

    /* ========== Layout ========== */
    .shell{
      display:grid;
      grid-template-rows: auto 1fr;
      min-height:100dvh;
    }

    /* TOPBAR */
    .topbar{
      position:sticky; top:0; z-index:50;
      height:64px;
      display:flex; align-items:center; gap:12px;
      padding: 0 16px;
      background: color-mix(in oklab, var(--bg-soft) 75%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:-.01em;
    }
    .brand-badge{
      width:38px; height:38px;
      border-radius:12px;
      display:grid; place-items:center;
      background: var(--primary);
      color:#fff;
      box-shadow: 0 12px 24px color-mix(in oklab, var(--primary) 35%, transparent);
    }
    .brand-title{
      font-size:1.1rem;
      color: var(--text);
    }

    .topbar .spacer{ flex:1 }

    .btn-icon{
      width:40px; height:40px;
      display:grid; place-items:center;
      border-radius:12px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 85%, transparent);
      cursor:pointer;
      transition: filter .15s ease, transform .08s ease;
    }
    .btn-icon:hover{ filter:brightness(1.04) }
    .btn-icon:active{ transform: translateY(1px) }

    /* MAIN LAYOUT */
    .layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height: calc(100dvh - 64px);
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    /* Desktop: sidebar collapse */
    @media (min-width: 981px){
      body.sidebar-collapsed .layout{ grid-template-columns: 1fr; }
      body.sidebar-collapsed .sidebar{ display:none; }
    }

    /* Sidebar */
    .sidebar{
      position:sticky; top:64px; align-self:start;
      height: calc(100dvh - 64px);
      overflow:auto;
      background: var(--card);
      border-right:1px solid var(--line);
      padding: 14px 0;
      box-shadow: var(--elev);
      transition: transform .28s var(--ease);
    }
    @media (max-width: 980px){
      .sidebar{
        position:fixed;
        inset:64px auto 0 0;
        width:min(78vw, 300px);
        transform: translateX(-102%);
        z-index:60;
      }
      .sidebar.open{ transform:none; }
    }

    .menu-section{ margin:10px 0 14px; }
    .menu-title{
      margin: .25rem 0 .5rem 1rem;
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color: var(--text-dim);
      font-weight:900;
    }

    .menu a{
      display:flex; align-items:center; gap:.55rem;
      padding:.68rem 1.1rem;
      color: color-mix(in oklab, var(--text) 90%, transparent);
      text-decoration:none;
      border-left:3px solid transparent;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      transition: background .18s ease, color .18s ease, border-color .18s ease;
      font-weight:800;
    }
    .menu a:hover{
      background: color-mix(in oklab, var(--primary) 7%, transparent);
      color: var(--text);
    }
    .menu a.active,[aria-current="page"]{
      background: color-mix(in oklab, var(--primary) 12%, transparent);
      border-left-color: var(--primary);
      color: var(--text);
    }

    .submenu{ margin-left:.25rem; border-left:2px dashed color-mix(in oklab, var(--line) 85%, transparent); }
    .submenu a{ padding-left:1.2rem; font-size:.98rem; }

    /* Main content */
    .main{
      padding: 18px min(4vw, 32px) 40px;
    }
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius-2xl);
      padding: clamp(16px, 2vw, 22px);
      box-shadow: var(--elev-card);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    /* Forms */
    label{ display:block; font-size:.86rem; color:var(--text-dim); margin-bottom:.45rem; font-weight:850; }
    .input, select.input, textarea.input{
      width:100%;
      padding:.78rem .85rem;
      border-radius:12px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 95%, transparent);
      color: var(--text);
      outline:none;
      font-weight:600;
      transition:.2s border-color, .2s box-shadow;
    }
    .input::placeholder{ color: color-mix(in oklab, var(--text-dim) 90%, transparent); }
    .input:focus{
      border-color: color-mix(in oklab, var(--primary) 70%, transparent);
      box-shadow: 0 0 0 4px var(--ring);
    }

    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; gap:.55rem;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 95%, transparent);
      color: var(--text);
      padding:.66rem 1rem;
      border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, filter .15s ease, box-shadow .2s ease;
      box-shadow: 0 10px 30px -15px rgba(0,0,0,.18);
      font-weight:900;
      text-decoration:none;
      line-height:1;
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      background: var(--primary);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 14px 30px -18px color-mix(in oklab, var(--primary) 55%, transparent);
    }
    .btn-success{
      background: var(--success);
      color:#fff;
      border-color: transparent;
    }

    /* Focus ring */
    :where(a, button, .btn, .input, textarea.input, select.input):focus-visible{
      outline:none;
      box-shadow: 0 0 0 4px var(--ring);
      border-color: color-mix(in oklab, var(--primary) 70%, transparent);
    }

    /* Table */
    .table-wrap{ overflow:auto; border-radius:14px; }
    .table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px; }
    .table th,.table td{
      padding:.78rem .9rem;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:.96rem;
      vertical-align:top;
    }
    .table thead th{
      font-size:.82rem;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:var(--text-dim);
      position:sticky; top:0; z-index:1;
      background: color-mix(in oklab, var(--bg-soft) 90%, transparent);
      backdrop-filter: blur(8px);
      font-weight:900;
    }
    .table tbody tr:hover td{
      background: color-mix(in oklab, var(--primary) 6%, transparent);
    }

    /* Flash/Badge */
    .flash{
      margin:.7rem 0;
      padding:.85rem 1rem;
      border-radius:12px;
      font-size:.98rem;
      border:1px solid color-mix(in oklab, var(--primary) 20%, transparent);
      background: color-mix(in oklab, var(--primary) 10%, var(--card));
      color: var(--text);
      font-weight:800;
    }
    .flash.success{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.12); }
    .flash.danger{  border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.12); }
    .flash.info{    border-color: rgba(96,165,250,.25); background: rgba(96,165,250,.12); }

    .badge{
      display:inline-block;
      padding:.28rem .6rem;
      border-radius:999px;
      font-size:.86rem;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color: var(--text);
      font-weight:800;
    }
    .score-low{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.25); }
    .score-mid{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.25); }
    .score-high{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.25); }

    .small{ font-size:.86rem; color:var(--text-dim); font-weight:600; }
    .footer{ margin-top:28px; color:var(--text-dim); font-size:.9rem; }

    /* Print */
    @media print{
      .noprint{ display:none !important; }
      body{ background:#fff; color:#111; }
      .topbar, .sidebar{ display:none; }
      .main{ padding:0; }
      .panel{ box-shadow:none; border:1px solid #ddd; background:#fff; color:#111; }
      .table th,.table td{ border-color:#eee; }
    }

    /* ==========================================================
       AUTH MODE (âœ… /forgot, /login, /welcome vs. iÃ§in FIX)
       - Sidebar kapat
       - Layout tek kolon
       - Main full width + ortalÄ±
       - Base panel kabuÄŸunu sayfaya bÄ±rak (ister sayfa override eder)
       ========================================================== */
    .layout.auth{ grid-template-columns:1fr !important; }
    .auth .sidebar{ display:none !important; }
    .auth #sidebarToggle{ display:none !important; }

    /* auth sayfalarÄ±nda main'in padding/width ayarlarÄ± */
    .auth .main{
      padding: 24px 16px 40px !important;
      width: 100%;
      max-width: 100% !important;
      margin: 0 auto !important;
    }

    /* auth sayfalarÄ±nda panel'i ortala + geniÅŸliÄŸi kontrol et */
    .auth .panel{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
    }

    /* auth sayfalarÄ±nda flash mesajlarÄ± Ã§ok yayÄ±lmasÄ±n */
    .auth .flash{
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>

<body class="{% block body_class %}{{ 'auth' if (hide_nav|default(false) or request.endpoint=='welcome') }}{% endblock %}">

<div class="shell">
  <!-- TOPBAR -->
  <header class="topbar noprint">
    {% if not (hide_nav|default(false) or request.endpoint=='welcome') %}
      <button class="btn-icon" id="sidebarToggle" aria-label="MenÃ¼yÃ¼ AÃ§/Kapat">
        <span class="material-icons-outlined" style="font-size:20px;">menu</span>
      </button>
    {% endif %}

    <div class="brand">
      <div class="brand-badge">
        <span class="material-icons-outlined" style="font-size:22px;">shield</span>
      </div>
      <div class="brand-title">RiskApp</div>
    </div>

    <div class="spacer"></div>

    {% if session.get('username') and request.endpoint != 'welcome' %}
      <div class="small" style="white-space:nowrap;">
        ðŸ‘‹ {{ session.get('username') }}
        {% if session.get('role') %} Â· {{ session.get('role')|capitalize }}{% endif %}
      </div>
    {% endif %}

    <button id="themeToggle" class="btn" onclick="window.__toggleTheme?.()" style="margin-left:8px">
      ðŸŒ™ Koyu Tema
    </button>
  </header>

  <div class="layout {% block layout_class %}{{ 'auth' if (hide_nav|default(false) or request.endpoint=='welcome') }}{% endblock %}">
    <!-- SIDEBAR -->
    {% block sidebar %}
    {% if not (hide_nav|default(false) or request.endpoint=='welcome') %}
    <aside class="sidebar" id="sidebar">

      <!-- Proje SeÃ§ici (varsa) -->
      {% if session.get('account_id') %}
        {% set _acc_id = session.get('account_id') %}
        {% set _projects = ProjectInfo.query.filter_by(account_id=_acc_id).order_by(ProjectInfo.created_at.desc()).all() %}
        {% if _projects and _projects|length > 1 %}
          <form method="post" action="{{ url_for('switch_project') }}" class="small" style="padding:0 1rem .75rem">
            <label for="project_id" style="display:block;margin-bottom:6px;font-weight:900">Aktif Proje</label>
            <select class="input" id="project_id" name="project_id" onchange="this.form.submit()">
              {% set _pid = session.get('project_id') %}
              {% for p in _projects %}
                <option value="{{ p.id }}" {{ 'selected' if _pid==p.id }}>{{ p.workplace_name }}</option>
              {% endfor %}
            </select>
          </form>
        {% endif %}
      {% endif %}

      <div class="menu-section">
        <div class="menu-title">Dashboard</div>
        <nav class="menu">
          <a href="{{ url_for('dashboard') }}" class="{{ 'active' if request.endpoint=='dashboard' }}">Genel GÃ¶rÃ¼nÃ¼m</a>
        </nav>
      </div>

      <div class="menu-section">
        <div class="menu-title">Risk</div>
        <nav class="menu submenu">
          <a href="{{ url_for('risk_identify') }}" class="{{ 'active' if request.endpoint=='risk_identify' }}">Risk / Kategorisi GÃ¶rÃ¼ntÃ¼leme</a>
          <a href="{{ url_for('risk_new') }}" class="{{ 'active' if request.endpoint=='risk_new' }}">Yeni Risk TanÄ±mlama</a>
          <a href="{{ url_for('risk_select') }}" class="{{ 'active' if request.endpoint=='risk_select' }}">GeÃ§miÅŸ Ä°ÅŸlem Verilerim</a>
          <a href="{{ url_for('categories_index') }}" class="{{ 'active' if request.endpoint=='categories_index' }}">Kategoriler</a>
          <a href="{{ url_for('schedule') }}" class="{{ 'active' if request.endpoint=='schedule' }}">Zaman Ã‡izelgesi</a>

          {# âœ… Maliyetler linki (endpoint yoksa sayfa patlamasÄ±n) #}
          {% set _has_ep_helper = (has_endpoint is defined) %}
          {% set _costs_ep = (
              'costs' if (
                (_has_ep_helper and has_endpoint('costs')) or
                (not _has_ep_helper and ('costs' in current_app.view_functions))
              )
              else None
          ) %}
          {% if _costs_ep %}
            <a href="{{ url_for(_costs_ep) }}" class="{{ 'active' if request.endpoint==_costs_ep }}">Maliyetler</a>
          {% endif %}

          <a href="{{ url_for('reports') }}" class="{{ 'active' if request.endpoint=='reports' }}">Raporlar</a>

          {# âœ…âœ… Pareto Analizi (endpoint varsa gÃ¶ster) #}
          {% set _pareto_ep = (
              'pareto_view' if (
                (_has_ep_helper and has_endpoint('pareto_view')) or
                (not _has_ep_helper and ('pareto_view' in current_app.view_functions))
              )
              else None
          ) %}
          {% if _pareto_ep %}
            <a href="{{ url_for(_pareto_ep) }}" class="{{ 'active' if request.endpoint==_pareto_ep }}">Pareto Analizi</a>
          {% endif %}

          {% if session.get('role') == 'admin' %}
            <a href="{{ url_for('import_suggestions') }}" class="{{ 'active' if request.endpoint=='import_suggestions' }}">Risk ve Kategori Aktarma (CSV,Excel)</a>
          {% endif %}

          <a href="{{ url_for('responsibles') }}" class="{{ 'active' if request.endpoint=='responsibles' }}">Sorumlu Ã–zeti</a>
          <a href="{{ url_for('risks_export_xlsx', title='DENÄ°Z YAPILARI Ä°NÅžAAT PROJESÄ° RÄ°SK ANALÄ°ZÄ°') }}">Excel (BiÃ§imli) DÄ±ÅŸa Aktar</a>
        </nav>
      </div>

      <div class="menu-section">
        <div class="menu-title">Ayarlar</div>
        <nav class="menu submenu">
          {% set _has_ep_helper = (has_endpoint is defined) %}
          {% set _admin_ep = (
              'admin.admin_users' if (
                (_has_ep_helper and has_endpoint('admin.admin_users')) or
                (not _has_ep_helper and ('admin.admin_users' in current_app.view_functions))
              )
              else (
                'admin_users' if (
                  (_has_ep_helper and has_endpoint('admin_users')) or
                  (not _has_ep_helper and ('admin_users' in current_app.view_functions))
                )
                else None
              )
          ) %}
          {% if _admin_ep %}
            <a href="{{ url_for(_admin_ep) }}"
               class="{{ 'active' if request.endpoint == _admin_ep }}">KullanÄ±cÄ± YÃ¶netimi</a>
          {% endif %}

          <a href="{{ url_for('settings_account') }}" class="{{ 'active' if request.endpoint=='settings_account' }}">Hesap Bilgileri</a>
          <a href="{{ url_for('settings_project') }}" class="{{ 'active' if request.endpoint=='settings_project' }}">Proje Bilgileri</a>
        </nav>
      </div>

      <div class="menu-section">
        <div class="menu-title">Hesap</div>
        <nav class="menu">
          <a href="{{ url_for('logout') }}">Oturumu Kapat</a>
        </nav>
      </div>
    </aside>
    {% endif %}
    {% endblock %}

    <!-- MAIN -->
    <main class="main">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="flash {{cat}}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <section class="panel whisper-shadow">
        {% block content %}{% endblock %}
      </section>

      <p class="footer">Â© {{ 2025 }} Entegre Risk YÃ¶netimi Â· <span class="small">v1</span></p>
    </main>
  </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- âœ… Chart.js (Pareto grafikleri iÃ§in) -->
<script src="{{ url_for('static', filename='vendor/chart.umd.min.js') }}"></script>

<script>
(function(){
  const KEY = 'riskapp.theme';
  const SIDEBAR_KEY = 'riskapp.sidebarCollapsed';
  const root = document.documentElement;

  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const btnTheme = () => document.getElementById('themeToggle');

  function applyTheme(t){
    // 1) data-theme (senin CSS tokenlarÄ± iÃ§in)
    root.setAttribute('data-theme', t);

    // 2) Tailwind dark class (ÅŸablonlarÄ±n iÃ§in)
    root.classList.toggle('dark', t === 'dark');

    try{ localStorage.setItem(KEY, t); }catch(e){}

    const btn = btnTheme();
    if (btn){
      btn.textContent = (t === 'light') ? 'ðŸŒ™ Koyu Tema' : 'ðŸŒž AÃ§Ä±k Tema';
    }
  }

  const saved = (()=>{ try{ return localStorage.getItem(KEY); }catch(e){ return null } })();
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const initial = saved || (prefersDark ? 'dark' : 'light');
  applyTheme(initial);

  window.__toggleTheme = function(){
    const current = root.getAttribute('data-theme') || 'light';
    applyTheme(current === 'light' ? 'dark' : 'light');
  };

  function isMobile(){
    return window.matchMedia && window.matchMedia('(max-width: 980px)').matches;
  }

  // Desktop iÃ§in sidebar collapsed state'ini yÃ¼kle
  (function initSidebarPref(){
    if (!sidebar) return;
    let collapsed = false;
    try{ collapsed = localStorage.getItem(SIDEBAR_KEY) === '1'; } catch(e){}
    if (collapsed && !isMobile()){
      document.body.classList.add('sidebar-collapsed');
    }
  })();

  // Sidebar toggle (mobil + desktop)
  if (sidebarToggle && sidebar){
    sidebarToggle.addEventListener('click', () => {
      if (isMobile()){
        sidebar.classList.toggle('open');
      } else {
        document.body.classList.toggle('sidebar-collapsed');
        try{
          const collapsed = document.body.classList.contains('sidebar-collapsed');
          localStorage.setItem(SIDEBAR_KEY, collapsed ? '1' : '0');
        } catch(e){}
      }
    });

    // Mobilde dÄ±ÅŸa tÄ±klayÄ±nca kapat
    document.addEventListener('click', (e)=>{
      if (!isMobile()) return;
      if (!sidebar.classList.contains('open')) return;
      const within = sidebar.contains(e.target) || sidebarToggle.contains(e.target);
      if (!within) sidebar.classList.remove('open');
    });

    // Resize: mobil>desktop geÃ§iÅŸinde aÃ§Ä±k sidebar'Ä± kapat
    window.addEventListener('resize', ()=>{
      if (!isMobile()){
        sidebar.classList.remove('open');
      }
    });
  }
})();
</script>

<!-- âœ… Modal/backdrop kilitlenme sigortasÄ± (ek, bir ÅŸey eksiltmez) -->
<script>
(function(){
  function cleanupBackdrops(){
    const openModal = document.querySelector('.modal.show');
    if (!openModal){
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('overflow');
      document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    }
  }

  document.addEventListener('click', (e) => {
    const dismissBtn = e.target.closest('[data-bs-dismiss="modal"]');
    if (!dismissBtn) return;

    const modalEl = dismissBtn.closest('.modal');
    if (!modalEl) { cleanupBackdrops(); return; }

    try{
      if (window.bootstrap){
        bootstrap.Modal.getOrCreateInstance(modalEl).hide();
      } else {
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        cleanupBackdrops();
      }
    }catch(_){
      modalEl.classList.remove('show');
      modalEl.style.display = 'none';
      cleanupBackdrops();
    }
  });

  document.addEventListener('hidden.bs.modal', cleanupBackdrops);
  window.addEventListener('pageshow', cleanupBackdrops);

  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') cleanupBackdrops();
  });
})();
</script>
{% endblock %}

</body>
</html>
