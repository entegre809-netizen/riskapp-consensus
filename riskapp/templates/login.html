<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Giriş</title>

  <!-- Ana tasarım dosyan -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* ——— Login’e özel hafif stil: mevcut tema tokenlarını kullanır ——— */
    :root{ --login-max: 440px }

    body{
      min-height: 100dvh;
      display:grid;
      place-items:center;
      padding: 24px 16px;
    }

    .login-wrap{
      width:100%;
      max-width: var(--login-max);
    }

    .card{
      padding: clamp(16px, 3.2vw, 24px);
      border-radius: var(--radius, 14px);
      background: var(--card, #fff);
      border: 1px solid var(--line, #e6ebf4);
      box-shadow: var(--elev-card, 0 12px 28px rgba(15,23,42,.08));
      backdrop-filter: var(--glass-blur, none);
    }

    .card h1{
      margin:.25rem 0 .85rem;
      font-size: clamp(1.25rem, 2.6vw, 1.6rem);
      font-weight: 900;
      letter-spacing: .01em;
    }

    .desc{
      margin:-.35rem 0 1rem;
      color: var(--muted, #556384);
      font-size: .95rem;
    }

    .field{ display:flex; flex-direction:column; gap:.45rem; margin-bottom:.9rem }
    .input-group{ display:flex; gap:.5rem; align-items:stretch }
    .input-group .input{ flex:1 }

    .muted{ opacity:.9; color: var(--muted, #6b7280) }
    .tiny{ font-size:.85rem }
    .error{ color: var(--danger, #b00020) }

    .is-invalid{
      border-color: var(--danger, #b00020) !important;
      box-shadow: 0 0 0 .12rem color-mix(in oklab, var(--danger, #b00020) 20%, transparent);
    }

    .btn-ghost{
      background: transparent;
      border:1px solid color-mix(in oklab, currentColor 20%, transparent);
      color: inherit;
      padding: .66rem .8rem;
      border-radius:12px;
      line-height:1;
    }

    .actions{
      margin-top:12px;
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:space-between;
    }

    /* Yardım/hata metni hizası */
    .help-row{
      display:flex; gap:8px; align-items:flex-start; justify-content:space-between;
    }

    /* Küçük marka / telif */
    .foot{
      margin-top: .9rem;
      text-align:center;
      color: var(--muted, #6b7692);
      font-size: .85rem;
    }
  </style>
</head>
<body>
  <main class="login-wrap">
    <section class="card" role="form" aria-labelledby="loginTitle">
      <h1 id="loginTitle">Giriş</h1>
      <p class="desc">Hesabınıza erişmek için e-posta ve şifrenizi girin.</p>

      {# Flash mesajları #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="flash {{cat}}" role="alert" aria-live="polite">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="loginForm" method="post" novalidate>
        {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}

        <!-- E-posta -->
        <div class="field">
          <label for="email">E-posta</label>
          <input
            class="input"
            id="email"
            type="email"
            name="email"
            placeholder="ornek@firma.com"
            value="{{ (email or '')|trim|e }}"
            required
            inputmode="email"
            autocomplete="email"
            maxlength="120"
            aria-describedby="emailHelp emailErr"
            aria-invalid="false"
          >
          <div class="help-row">
            <small id="emailHelp" class="muted tiny">Kurumsal e-postanızı girin (boşluk/emoji kabul edilmez).</small>
            <small id="emailErr" class="tiny error" hidden>E-posta formatı hatalı.</small>
          </div>
        </div>

        <!-- Şifre -->
        <div class="field">
          <label for="password">Şifre</label>
          <div class="input-group">
            <input
              class="input"
              id="password"
              type="password"
              name="password"
              placeholder="••••••••"
              required
              minlength="8"
              maxlength="128"
              autocomplete="current-password"
              pattern="^(?=.*[A-Za-z])(?=.*\d).{8,128}$"
              title="En az bir harf ve bir rakam içermelidir."
              aria-describedby="pwdHelp pwdErr"
              aria-invalid="false"
            >
            <button class="btn btn-ghost" type="button" id="togglePwd" aria-controls="password" aria-pressed="false" aria-label="Şifreyi göster/gizle">Göster</button>
          </div>
          <div class="help-row">
            <small id="pwdHelp" class="muted tiny">En az 8 karakter, harf + rakam önerilir.</small>
            <small id="pwdErr" class="tiny error" hidden>Şifre kurala uymuyor.</small>
          </div>
        </div>

        <!-- Referans Kodu (opsiyonel) -->
        <div class="field">
          <label for="ref_code">Referans Kodu <span class="muted tiny">(opsiyonel)</span></label>
          <input
            class="input"
            id="ref_code"
            type="text"
            name="ref_code"
            placeholder="PRJ-2025-123456"
            value="{{ (ref_code or '')|trim|e }}"
            inputmode="text"
            maxlength="32"
            autocomplete="one-time-code"
            aria-describedby="refHelp"
          >
          <small id="refHelp" class="muted tiny">Admin’in atadığı kod. İlk/tek admin için gerekmez.</small>
        </div>

        <!-- Remember me -->
        <div class="field" style="margin:.2rem 0;">
          <label for="remember" style="display:flex; align-items:center; gap:.55rem;">
            <input id="remember" name="remember" type="checkbox" {% if remember %}checked{% endif %}>
            <span>Beni hatırla</span>
          </label>
        </div>

        <!-- CTA’lar -->
        <div class="actions">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <a class="btn" href="{{ url_for('setup_step1') }}">Kayıt ol</a>
            <a class="btn" href="{{ url_for('forgot_password') }}">Şifremi unuttum</a>
          </div>
          <button class="btn btn-primary" id="submitBtn" type="submit">Giriş yap</button>
        </div>
      </form>

      <p class="foot">Girişte sorun mu var? <a href="mailto:support@ornek.com">support@ornek.com</a></p>
    </section>
  </main>

  <script>
  (function () {
    const form = document.getElementById('loginForm');
    const btn = document.getElementById('submitBtn');
    const email = document.getElementById('email');
    const pwd = document.getElementById('password');
    const ref = document.getElementById('ref_code');
    const togglePwd = document.getElementById('togglePwd');

    const emailErr = document.getElementById('emailErr');
    const pwdErr = document.getElementById('pwdErr');

    // Metin temizleme — emoji/boşluk sil
    const stripEmojis = (s) => s.replace(/\p{Extended_Pictographic}/gu, '');
    const cleanEmail = (v) => stripEmojis(v).replace(/\s+/g,'');
    const cleanPassword = (v) => stripEmojis(v);

    // caret pozisyonunu koruyarak alanı güncelle
    function replaceKeepingCaret(input, next){
      const before = input.value;
      if (before === next) return;
      const delta = before.length - next.length;
      const pos = input.selectionStart;
      input.value = next;
      if (typeof pos === 'number') input.setSelectionRange(pos - delta, pos - delta);
    }

    // E-posta doğrulama
    email.addEventListener('input', () => {
      replaceKeepingCaret(email, cleanEmail(email.value));
      const valid = email.checkValidity();
      email.classList.toggle('is-invalid', !valid);
      email.setAttribute('aria-invalid', String(!valid));
      emailErr.hidden = valid;
    });

    // Şifre doğrulama
    pwd.addEventListener('input', () => {
      replaceKeepingCaret(pwd, cleanPassword(pwd.value));
      const valid = pwd.checkValidity();
      pwd.classList.toggle('is-invalid', !valid);
      pwd.setAttribute('aria-invalid', String(!valid));
      pwdErr.hidden = valid;
    });

    // Ref code: otomatik UPPERCASE + boşlukları kaldır
    if (ref){
      ref.addEventListener('input', () => {
        const next = ref.value.toUpperCase().replace(/\s+/g,'');
        replaceKeepingCaret(ref, next);
      });
    }

    // Şifre göster/gizle
    if (togglePwd){
      togglePwd.addEventListener('click', () => {
        const isText = pwd.type === 'text';
        pwd.type = isText ? 'password' : 'text';
        togglePwd.textContent = isText ? 'Göster' : 'Gizle';
        togglePwd.setAttribute('aria-pressed', String(!isText));
        pwd.focus();
      });
    }

    // Submit — çift tık kilidi + alan bazlı hata odaklama
    form.addEventListener('submit', (e) => {
      const allValid = form.checkValidity();
      if (!allValid){
        e.preventDefault();
        [email, pwd].forEach(el => {
          const valid = el.checkValidity();
          el.classList.toggle('is-invalid', !valid);
          el.setAttribute('aria-invalid', String(!valid));
          (el.id === 'email' ? emailErr : pwdErr).hidden = valid;
        });
        const firstInvalid = form.querySelector('.is-invalid');
        (firstInvalid || email).focus();
        return;
      }
      btn.disabled = true;
      btn.textContent = 'Gönderiliyor...';
    });

    // İlk odak: e-posta; doluysa şifre
    if (!email.value) email.focus(); else pwd.focus();
  })();
  </script>
</body>
</html>
