{% extends "base.html" %}
{% block title %}Zaman Ã‡izelgesi{% endblock %}
{% block content %}
<div class="card">
  <h2 style="margin:0 0 .35rem">Risk Zaman Ã‡izelgesi</h2>
  <p class="small" style="margin:.15rem 0 1rem">
    Risklerin baÅŸlangÄ±Ã§/bitiÅŸ tarihine gÃ¶re <strong>tablo</strong> veya <strong>aylÄ±k takvim</strong> gÃ¶rÃ¼nÃ¼mÃ¼.
  </p>

  {# ---------- FORM/STATE ---------- #}
  {% set view = request.args.get('view','table') %}
  {% set cur_m = (request.args.get('month') or current_month or 1)|int %}
  {% set cur_y = (request.args.get('year')  or current_year  or 2025)|int %}
  {% set month_names = ['Ocak','Åžubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'] %}

  {# Seviye etiketleri #}
  {% set grade_labels = {
    'critical':   'Ã‡ok yÃ¼ksek',
    'moderate':   'YÃ¼ksek',
    'low':        'Orta',
    'acceptable': 'DÃ¼ÅŸÃ¼k',
    'very_low':   'Ã‡ok dÃ¼ÅŸÃ¼k'
  } %}

  {# ---------- GÃœVENLÄ° YEDEKLER ---------- #}
  {% set rows_safe   = rows   or [] %}
  {% set months_safe = months or month_names %}

  {# ---------- FÄ°LTRELER ---------- #}
  <form method="get" class="noprint"
        style="margin-bottom:12px; display:grid; gap:8px; grid-template-columns: repeat(6, minmax(0,1fr)); align-items:end">
    <div>
      <label>Arama</label>
      <input class="input" type="text" name="q" value="{{ request.args.get('q','') }}" placeholder="BaÅŸlÄ±k, kategori, sorumlu...">
    </div>
    <div>
      <label>Kategori</label>
      <select class="input" name="category">
        <option value="">TÃ¼mÃ¼</option>
        {% for c in (categories or []) %}
          <option value="{{ c }}" {{ 'selected' if request.args.get('category')==c }}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Sorumlu</label>
      <select class="input" name="owner">
        <option value="">TÃ¼mÃ¼</option>
        {% for o in (owners or []) %}
          <option value="{{ o }}" {{ 'selected' if request.args.get('owner')==o }}>{{ o }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Seviye</label>
      <select class="input" name="grade">
        <option value="">TÃ¼mÃ¼</option>
        {% for g in ['critical','moderate','low','acceptable','very_low'] %}
          <option value="{{ g }}"
                  {{ 'selected' if request.args.get('grade')==g }}>
            {{ grade_labels.get(g, g|capitalize) }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Durum</label>
      <select class="input" name="status">
        <option value="">TÃ¼mÃ¼</option>
        {% for s in (statuses or ['Yeni','AÃ§Ä±k','Ä°lerliyor','KapalÄ±']) %}
          <option value="{{ s }}" {{ 'selected' if request.args.get('status')==s }}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="display:flex; gap:6px">
      <div style="flex:1">
        <label>Ay</label>
        <select class="input" name="month">
          {% for name in month_names %}
            <option value="{{ loop.index }}" {{ 'selected' if cur_m==loop.index }}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="width:110px">
        <label>YÄ±l</label>
        <input class="input" type="number" name="year" value="{{ cur_y }}">
      </div>
    </div>

    <div style="grid-column: 1 / -1; display:flex; gap:8px; align-items:center; justify-content:space-between">
      <div style="display:flex; gap:8px">
        <a class="btn" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
        <a class="btn" href="{{ url_for('risk_select') }}">Risk KÃ¼tÃ¼phanesi</a>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        {% if view == 'calendar' %}
        <div class="icon-btn" style="gap:8px">
          ðŸ”Ž Boyut
          <input id="calZoom" type="range" min="1" max="1.6" step="0.05" value="1" style="width:140px">
          <span id="calZoomLbl" class="small" style="min-width:42px;text-align:right">100%</span>
        </div>
        {% endif %}
        <label style="margin:0">GÃ¶rÃ¼nÃ¼m</label>
        <select class="input" name="view" onchange="this.form.submit()" style="width:150px">
          <option value="table" {{ 'selected' if view=='table' }}>Tablo</option>
          <option value="calendar" {{ 'selected' if view=='calendar' }}>Takvim</option>
        </select>
        <button class="btn btn-primary" type="submit">Uygula</button>

        {# ---- PDF Export butonu ---- #}
        <a class="btn"
           href="{{ url_for(
                    'schedule_pdf',
                    q=request.args.get('q',''),
                    category=request.args.get('category',''),
                    owner=request.args.get('owner',''),
                    status=request.args.get('status',''),
                    grade=request.args.get('grade',''),
                    month=cur_m,
                    year=cur_y,
                    view=view
                ) }}"
           target="_blank"
           rel="noopener">
          ðŸ“„ PDF
        </a>
      </div>
    </div>
  </form>

  <style>
    :root{ --cal-scale: 1; }
    .cal-zoom-shell{ width:100%; overflow:auto; }

    /* Timeline / takvim bar renkleri */
    .gx-critical{
      background:#fecaca;
      outline:1px solid #b91c1c;
    }
    .gx-moderate{
      background:#fed7aa;
      outline:1px solid #b45309;
    }
    .gx-low{
      background:#fef3c7;
      outline:1px solid #a16207;
    }
    .gx-acceptable{
      background:#bbf7d0;
      outline:1px solid #15803d;
    }
    .gx-very_low{
      background:#e5e7eb;
      outline:1px solid #4b5563;
    }

    /* Seviye chipâ€™leri */
    .risk-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:.18rem .55rem;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      border:1px solid transparent;
    }
    .risk-chip.critical{
      background:#b91c1c;
      border-color:#7f1d1d;
    }
    .risk-chip.moderate{
      background:#b45309;
      border-color:#92400e;
    }
    .risk-chip.low{
      background:#a16207;
      border-color:#854d0e;
    }
    .risk-chip.acceptable{
      background:#15803d;
      border-color:#166534;
    }
    .risk-chip.very_low{
      background:#374151;
      border-color:#1f2937;
    }

    .icon-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(0,0,0,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(245,248,255,.9));
      padding:.25rem .5rem;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
    }
    .icon-btn:hover{ filter:brightness(1.02) }

    .table-scroll{
      overflow:auto;
      border:1px solid color-mix(in oklab, var(--line) 75%, transparent);
      border-radius:12px;
    }
    .timeline-table {
      border-collapse: collapse;
      width:100%;
      table-layout: fixed;
      min-width:760px;
    }
    .timeline-table th,
    .timeline-table td {
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      padding:8px;
      font-size: 12px;
    }
    .timeline-table thead th{
      position:sticky;
      top:0;
      background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
      z-index:1;
    }
    .timeline-table th.month { text-align:center; white-space:nowrap; }
    .tl-bar { height: 18px; border-radius: 999px; cursor:pointer; }
    .risk-title {
      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-weight:700
    }
    .risk-meta { color:var(--muted); font-size:12px; }

    .calendar-wrap{
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      border-radius:12px;
      overflow:hidden;
      transform: scale(var(--cal-scale));
      transform-origin: top left;
      width:100%;
    }
    .cal-header{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
      border-bottom:1px solid color-mix(in oklab, var(--line) 85%, transparent);
    }
    .cal-header div{
      padding:.6rem .5rem;
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      color:var(--muted);
      text-align:center
    }
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: calc(20px * var(--cal-scale));
    }
    .cal-cell{
      min-height:140px;
      border-right:1px solid color-mix(in oklab, var(--line) 75%, transparent);
      border-bottom:1px solid color-mix(in oklab, var(--line) 75%, transparent);
      position:relative;
      padding:10px
    }
    .cal-cell:nth-child(7n){ border-right:0 }
    .cal-date{
      font-size:12px;
      color:var(--muted);
      position:absolute;
      top:10px;
      right:10px
    }
    .cal-badge{
      position:relative;
      margin-top:22px;
      padding:.35rem .55rem;
      border-radius:10px;
      font-size:13px;
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      cursor:grab
    }
    .cal-badge .lvl{
      font-weight:800;
      margin-right:4px;
      text-transform:uppercase;
    }
    .cal-badge:active{ cursor:grabbing; }
    .cal-more{
      position:absolute;
      bottom:8px;
      left:8px;
      right:8px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer
    }

    /* +N daha popover */
    .cal-pop{
      position:absolute;
      left:8px;
      right:8px;
      bottom:34px;
      background: var(--card-solid);
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      border-radius:10px;
      padding:8px;
      box-shadow: var(--elev-card);
      max-height:220px;
      overflow:auto;
      z-index:5;
      font-size:12px;
    }
    .cal-pop .cal-badge{ margin:4px 0; display:block; }
    .cal-pop .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      color:var(--muted)
    }
    .cal-pop .close{
      cursor:pointer;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent)
    }

    .muted-day{ opacity:.45 }
    @media (max-width: 980px){
      .cal-cell{ min-height:110px; }
      .risk-title{ max-width:240px; }
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal-backdrop.show{
      display:flex;
    }
    .modal{
      background:var(--card-solid);
      border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
      border-radius:14px;
      padding:14px;
      width:min(460px, 92vw);
      box-shadow: var(--elev-card);
    }
    .modal h3{ margin:.2rem 0 .5rem }
  </style>

  {% if view == 'table' %}
  <div class="table-scroll">
    <table class="timeline-table" role="table" aria-label="Risk Zaman Ã‡izelgesi">
      <thead>
        <tr>
          <th style="width:340px">Risk</th>
          {% for m in months_safe %}
            <th class="month">{{ m }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in rows_safe %}
          {% set r = row.risk %}
          <tr>
            <td>
              <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
                <div>
                  <div class="risk-title">
                    <a href="{{ url_for('risk_detail', risk_id=r.id) }}">{{ r.title }}</a>
                  </div>
                  <div class="risk-meta">
                    {{ r.category or '-' }} Â· RPN: {{ '%.2f'|format(r.avg_rpn()) if r.avg_rpn() is not none else 'â€”' }} Â· {{ r.status or 'â€”' }}
                  </div>
                  <div class="small" style="margin-top:4px">
                    <span class="risk-chip {{ row.grade or 'acceptable' }}">
                      {{ grade_labels.get(row.grade, row.grade|capitalize) }}
                    </span>
                    {% if r.start_month or r.end_month %}
                      Â· <span>{{ r.start_month or 'â€”' }} â†’ {{ r.end_month or 'â€”' }}</span>
                    {% endif %}
                  </div>
                </div>
                <div style="display:flex; gap:6px; align-items:center">
                  <a class="icon-btn" href="{{ url_for('risk_detail', risk_id=r.id) }}">ðŸ“„ Detay</a>
                  <button class="icon-btn"
                          data-open-reminder
                          data-risk-id="{{ r.id }}"
                          data-risk-title="{{ r.title }}">ðŸ”” HatÄ±rlat</button>
                </div>
              </div>
            </td>
            {% for m in months_safe %}
              {% set active = (m in (row.active or [])) %}
              <td>
                {% if active %}
                  <div class="tl-bar gx-{{ row.grade or 'acceptable' }}"
                       title="{{ r.title }} Â· {{ m }}"
                       data-open-reminder
                       data-risk-title="{{ r.title }}"></div>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% else %}
          <tr><td colspan="{{ 1 + months_safe|length }}">KayÄ±tlÄ± risk yok.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  {% if view == 'calendar' %}
    {% set can_calendar = (rows_safe|selectattr('startYM')|list) or (rows_safe|selectattr('endYM')|list) %}
    {% if not can_calendar %}
      <div class="flash info" style="margin-top:8px">
        Takvim iÃ§in her riskte <strong>baÅŸlangÄ±Ã§</strong> ve/veya <strong>bitiÅŸ</strong> ayÄ± olmalÄ±
        (Ã¶rn. <code>start_month</code> / <code>end_month</code> â†’ YYYY-MM).
      </div>
    {% else %}
      <div class="cal-zoom-shell">
        <div class="calendar-wrap" id="calendarRoot"
             data-month="{{ cur_m }}" data-year="{{ cur_y }}"
             data-detail-pattern="{{ url_for('risk_detail', risk_id=0) }}">
          <div class="cal-header">
            {% for d in ['Pzt','Sal','Ã‡ar','Per','Cum','Cmt','Paz'] %}
              <div>{{ d }}</div>
            {% endfor %}
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>
      </div>

      <script type="application/json" id="risks-json">
      [
        {% for row in rows_safe %}
          {% set r = row.risk %}
          {
            "id": {{ r.id|int }},
            "title": {{ (r.title or '')|tojson }},
            "startYM": {{ (row.startYM or r.start_month or '')|tojson }},
            "endYM":   {{ (row.endYM   or r.end_month   or '')|tojson }},
            "grade":   {{ (row.grade or 'acceptable')|tojson }},
            "category": {{ (r.category or '-')|tojson }},
            "status":   {{ (r.status or '-')|tojson }}
          }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
      </script>

      <script>
      (function(){
        const dataTag = document.getElementById('risks-json');
        const risksRaw = dataTag ? JSON.parse(dataTag.textContent) : [];
        const root = document.getElementById('calendarRoot');
        const grid = document.getElementById('calGrid');
        if(!root || !grid) return;

        const month = parseInt(root.dataset.month, 10) || (new Date().getMonth()+1);
        const year  = parseInt(root.dataset.year, 10) || (new Date().getFullYear());

        // detay link ÅŸablonu
        const detailPattern = root.dataset.detailPattern || '/risks/0';
        const toDetail = (id) => detailPattern.replace('/0', `/${id}`);
        const goDetail = (id, newTab=false) =>
          newTab ? window.open(toDetail(id), '_blank', 'noopener')
                 : (window.location.href = toDetail(id));

        const toFirst = (ym) => {
          if(!ym) return null;
          const [Y,M] = ym.split('-').map(x => parseInt(x,10));
          if(!Y || !M) return null;
          return new Date(Y, M-1, 1);
        };
        const toLast = (ym) => {
          if(!ym) return null;
          const [Y,M] = ym.split('-').map(x => parseInt(x,10));
          if(!Y || !M) return null;
          return new Date(Y, M, 0);
        };

        const startOfMonth = new Date(year, month-1, 1);
        const endOfMonth   = new Date(year, month, 0);
        const dow = (d) => (d.getDay() + 6) % 7;

        const firstPad = dow(startOfMonth);
        const totalDays = endOfMonth.getDate();
        const totalCells = Math.ceil((firstPad + totalDays) / 7) * 7;

        grid.innerHTML = "";
        for(let i=0; i<totalCells; i++){
          const cell = document.createElement('div');
          cell.className = 'cal-cell';
          cell.addEventListener('dragover', ev => ev.preventDefault()); // droppable
          cell.addEventListener('drop', async (ev) => {
            ev.preventDefault();
            const rid = ev.dataTransfer.getData('text/risk-id');
            if(!rid) return;
            const ym = `${year}-${String(month).padStart(2,'0')}`;
            // Alt: sadece start, Shift: sadece end, aksi: ikisi
            const onlyStart = ev.altKey;
            const onlyEnd   = ev.shiftKey;
            let payload = {};
            if (onlyStart) payload.start_month = ym;
            else if (onlyEnd) payload.end_month = ym;
            else payload = { start_month: ym, end_month: ym };

            try{
              const resp = await fetch(`/api/risks/${rid}/set-months`, {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: new URLSearchParams(payload).toString()
              });
              const js = await resp.json();
              if(!js.ok){ alert('GÃ¼ncellenemedi.'); return; }
              window.location.reload();
            }catch(e){ alert('AÄŸ hatasÄ±: ' + e); }
          });

          const dayNum = i - firstPad + 1;
          const inMonth = (dayNum >= 1 && dayNum <= totalDays);
          if(!inMonth) cell.classList.add('muted-day');

          const dateEl = document.createElement('div');
          dateEl.className = 'cal-date';
          dateEl.textContent = inMonth ? dayNum : '';
          cell.appendChild(dateEl);

          grid.appendChild(cell);
        }

        const risks = risksRaw.map(r => {
          const sFirst = toFirst(r.startYM);
          const eLast  = toLast(r.endYM);
          const s = sFirst || toFirst(r.endYM);
          const e = eLast  || toLast(r.startYM);
          return { ...r, s, e };
        });

        const cells = Array.from(grid.children);
        risks.forEach(r => {
          if(!r.s || !r.e) return;

          const s = new Date(Math.max(r.s, startOfMonth));
          const e = new Date(Math.min(r.e, endOfMonth));
          if (s > e) return;

          for(let dt = new Date(s); dt <= e; dt.setDate(dt.getDate()+1)){
            const idx = dow(startOfMonth) + dt.getDate()-1;
            const cell = cells[idx];
            if(!cell) continue;

            const badge = document.createElement('div');
            badge.className = `cal-badge gx-${r.grade}`;
            badge.title = `${r.title} â€¢ ${r.category} â€¢ ${r.status}`;
            badge.setAttribute('data-open-reminder','');
            badge.setAttribute('data-risk-title', r.title || 'Risk HatÄ±rlatÄ±cÄ±');
            badge.dataset.riskId = r.id;
            badge.draggable = true;
            badge.addEventListener('dragstart', (ev) => {
              ev.dataTransfer.setData('text/risk-id', String(r.id));
            });
            badge.addEventListener('click', (ev) => {
              goDetail(r.id, (ev.ctrlKey || ev.metaKey));
            });

            const letter = (r.grade||'a')[0].toUpperCase();
            badge.innerHTML = `<span class="lvl">${letter}</span> ${r.title}`;

            const shown = parseInt(cell.dataset.shown || "0", 10);
            if (shown < 3) {
              cell.appendChild(badge);
              cell.dataset.shown = String(shown + 1);
            } else {
              let more = cell.querySelector('.cal-more');
              if (!more) {
                more = document.createElement('div');
                more.className = 'cal-more';
                more.dataset.count = "1";
                more.dataset.items = JSON.stringify([]);
                more.textContent = '+1 daha';
                cell.appendChild(more);
              } else {
                const n = parseInt(more.dataset.count || "1", 10) + 1;
                more.dataset.count = String(n);
                more.textContent = `+${n} daha`;
              }
              const payload = { id: r.id, title: r.title, grade: r.grade, category: r.category, status: r.status };
              const items = JSON.parse(more.dataset.items || '[]');
              items.push(payload);
              more.dataset.items = JSON.stringify(items);
            }
          }
        });

        // +N daha -> popover
        grid.addEventListener('click', (ev)=>{
          const more = ev.target.closest('.cal-more');
          if(!more) return;

          const parent = more.parentElement;
          const existing = parent.querySelector('.cal-pop');
          if(existing){ existing.remove(); return; }

          const items = JSON.parse(more.dataset.items || '[]');
          const pop = document.createElement('div');
          pop.className = 'cal-pop';

          const head = document.createElement('div');
          head.className = 'head';
          head.innerHTML = `<span>Gizli kayÄ±tlar (${items.length})</span><span class="close">Kapat</span>`;
          pop.appendChild(head);

          items.forEach(it=>{
            const b = document.createElement('div');
            b.className = `cal-badge gx-${it.grade || 'acceptable'}`;
            b.setAttribute('data-open-reminder','');
            b.setAttribute('data-risk-title', it.title || 'Risk HatÄ±rlatÄ±cÄ±');
            b.title = `${it.title} â€¢ ${it.category || '-'} â€¢ ${it.status || '-'}`;
            b.dataset.riskId = it.id;
            b.innerHTML = `<span class="lvl">${(it.grade||'a')[0].toUpperCase()}</span> ${it.title}`;
            b.addEventListener('click', (ev)=> goDetail(it.id, (ev.ctrlKey||ev.metaKey)));
            pop.appendChild(b);
          });

          parent.appendChild(pop);
          pop.querySelector('.close').addEventListener('click', ()=> pop.remove());
        });

        // HÃ¼cre dÄ±ÅŸÄ±na tÄ±klayÄ±nca popover'larÄ± kapat
        document.addEventListener('click', (e)=>{
          if(e.target.closest('.cal-pop') || e.target.closest('.cal-more')) return;
          document.querySelectorAll('.cal-pop').forEach(p=>p.remove());
        });
      })();
      </script>
    {% endif %}
  {% endif %}

  {# ---------- HATIRLATICI MODALI ---------- #}
  <div class="modal-backdrop" id="remModal">
    <div class="modal">
      <h3>ðŸ”” HatÄ±rlatÄ±cÄ± oluÅŸtur</h3>
      <div class="small" style="margin-bottom:8px;color:var(--muted)">
        Etkinlik takviminize <code>.ics</code> olarak eklenecek.
      </div>

      <div style="display:grid; gap:8px; grid-template-columns:1fr 1fr">
        <div>
          <label>BaÅŸlÄ±k</label>
          <input class="input" id="remTitle" placeholder="Ã–rn: Risk gÃ¶zden geÃ§irme">
        </div>
        <div>
          <label>Tarih</label>
          <input class="input" id="remDate" type="date">
        </div>
        <div>
          <label>BaÅŸlangÄ±Ã§ (saat)</label>
          <input class="input" id="remTimeStart" type="time" value="09:00">
        </div>
        <div>
          <label>SÃ¼re (dakika)</label>
          <input class="input" id="remDuration" type="number" value="60" min="10" step="5">
        </div>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
        <button class="btn" id="remCancel">VazgeÃ§</button>
        <button class="btn btn-primary" id="remSave">Takvime ekle (.ics)</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const modal  = document.getElementById('remModal');
    const title  = document.getElementById('remTitle');
    const dateEl = document.getElementById('remDate');
    const tStart = document.getElementById('remTimeStart');
    const durEl  = document.getElementById('remDuration');
    const btnOk  = document.getElementById('remSave');
    const btnNo  = document.getElementById('remCancel');

    function openModal(prefill){
      modal.classList.add('show');
      title.value = prefill?.title || '';
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      dateEl.value = prefill?.date || `${yyyy}-${mm}-${dd}`;
      tStart.value = prefill?.time || '09:00';
      durEl.value  = prefill?.dur  || 60;
    }
    function closeModal(){ modal.classList.remove('show'); }

    function createICS({title, startISO, endISO, description=""}){
      const ics = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//RiskApp//Schedule//TR',
        'CALSCALE:GREGORIAN',
        'BEGIN:VEVENT',
        `UID:${(crypto && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2))}@riskapp`,
        `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z`,
        `DTSTART:${startISO}`,
        `DTEND:${endISO}`,
        `SUMMARY:${(title||'').replace(/\n/g,' ')}`,
        `DESCRIPTION:${description.replace(/\n/g,' ')}`,
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');

      const blob = new Blob([ics], {type: 'text/calendar;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (title || 'hatirlatma') + '.ics';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-open-reminder]');
      if(!btn) return;
      const rTitle = btn.dataset.riskTitle || 'Risk HatÄ±rlatÄ±cÄ±';
      openModal({ title: rTitle });
    });

    modal.addEventListener('click', (e)=>{ if(e.target === modal){ closeModal(); }});
    btnNo.addEventListener('click', closeModal);

    btnOk.addEventListener('click', ()=>{
      const ttl = title.value?.trim() || 'Risk HatÄ±rlatÄ±cÄ±';
      const d   = dateEl.value;
      const ts  = tStart.value || '09:00';
      const dur = Math.max(parseInt(durEl.value||'60',10), 10);
      if(!d){ alert('Tarih seÃ§melisin.'); return; }

      const start = new Date(d + 'T' + ts + ':00');
      const end   = new Date(start.getTime() + dur*60000);
      const toICS = (dt)=> new Date(dt.getTime() - dt.getTimezoneOffset()*60000)
                          .toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';

      createICS({
        title: ttl,
        startISO: toICS(start),
        endISO: toICS(end),
        description: 'Risk uygulamasÄ±ndan oluÅŸturuldu.'
      });
      closeModal();
    });
  })();
  </script>

  {% if view == 'calendar' %}
  <script>
  (function(){
    const root = document.querySelector(':root');
    const z = document.getElementById('calZoom');
    const lbl = document.getElementById('calZoomLbl');
    if(!root || !z) return;

    const KEY = 'riskapp.cal.scale';
    const clamp = v => Math.min(1.6, Math.max(1.0, v));

    const saved = parseFloat(localStorage.getItem(KEY) || '1');
    const init = clamp(isNaN(saved) ? 1 : saved);

    const apply = (val) => {
      root.style.setProperty('--cal-scale', String(val));
      if(lbl) lbl.textContent = Math.round(val * 100) + '%';
    };

    z.value = init;
    apply(init);

    z.addEventListener('input', () => {
      const v = clamp(parseFloat(z.value || '1'));
      apply(v);
      localStorage.setItem(KEY, String(v));
    });
  })();
  </script>
  {% endif %}

</div>
{% endblock %}
