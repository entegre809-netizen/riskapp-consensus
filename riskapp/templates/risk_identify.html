{% extends "base.html" %}
{% block title %}Risk Tanımlama{% endblock %}

{% block content %}
<style>
  /* ---------- Sayfa-özel (base tokenlarını kullanır) ---------- */
  :root{
    --gap-1: 6px; --gap-2: 10px; --gap-3: 14px; --gap-4: 18px;
    --round-sm: 10px; --round: 14px;
  }

  .toolbar {
    position: sticky; top: 8px; z-index: 2;
    display:flex; gap:.75rem; align-items:flex-end; flex-wrap:wrap;
    padding: .75rem; margin: 0 0 1rem;
    border:1px solid color-mix(in oklab, var(--line) 82%, transparent);
    border-radius: var(--radius);
    background: color-mix(in oklab, var(--bg-soft) 98%, transparent);
    box-shadow: var(--elev-1);
    backdrop-filter: var(--glass-blur);
  }
  .toolbar .group{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:flex-end }
  .toolbar .fill{ flex:1 }
  .input, select.input{ height: 40px; padding: .5rem .75rem; }

  .cat-grid{ display:grid; gap:var(--gap-4); grid-template-columns: repeat(3, minmax(0,1fr)); }
  @media (max-width:1200px){ .cat-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width:820px){ .cat-grid{ grid-template-columns: 1fr; } }

  .cat-card{
    border:1px solid color-mix(in oklab, var(--line) 85%, transparent);
    border-radius: var(--round);
    padding:12px; background: var(--card);
    box-shadow: 0 8px 26px rgba(0,0,0,.07);
  }
  .cat-head{ display:flex; align-items:flex-end; gap:.55rem; margin:4px 0 10px }
  .cat-head h3{ letter-spacing:.02em; font-variant: all-small-caps; font-weight: 900; opacity:.9 }
  .cat-count{ font-weight:900; color:var(--muted); background: color-mix(in oklab, var(--brand-2) 80%, transparent); padding:.12rem .5rem; border-radius:999px; }

  .bulk-row{ margin:6px 0 10px; display:flex; justify-content:space-between; align-items:center; gap:.5rem }
  .bulk-row .right{ display:flex; gap:.5rem; align-items:center }

  .table-select{ width:100%; border-collapse:separate; border-spacing:0; border-radius: 12px; overflow: clip; }
  .table-select th,.table-select td{
    padding:.6rem .7rem;
    border-bottom:1px solid color-mix(in oklab, var(--line) 82%, transparent);
    vertical-align:top; font-size:.96rem;
  }
  .table-select thead th{
    position:sticky; top:0; z-index:1;
    text-transform:uppercase; letter-spacing:.08em; font-weight:1000; font-size:.76rem;
    color:var(--muted);
    background: linear-gradient(180deg, color-mix(in oklab, var(--bg-soft) 98%, transparent), transparent);
    border-bottom:1px solid color-mix(in oklab, var(--line) 88%, transparent);
  }
  .table-select tbody tr:nth-child(even) td{
    background: color-mix(in oklab, var(--bg) 96%, transparent);
  }
  .table-select tbody tr:hover td{
    background: color-mix(in oklab, var(--primary) 5%, transparent);
  }

  /* Kolon hizaları */
  .table-select th:nth-child(1),
  .table-select td:nth-child(1){ width: 48px; }
  .table-select th:nth-child(4),
  .table-select td:nth-child(4){ width: 120px; text-align:center; }
  .table-select th:nth-child(5),
  .table-select td:nth-child(5),
  .table-select th:nth-child(6),
  .table-select td:nth-child(6){ width: 110px; text-align:center; }
  .table-select th:last-child,
  .table-select td:last-child{ width: 150px; }

  .risk-badge{ display:inline-flex; align-items:center; gap:.4rem }
  .risk-code{ display:inline-block; min-width:3ch }

  .inline-edit{
    border:1px solid color-mix(in oklab, var(--line) 85%, transparent);
    border-radius: var(--radius-sm);
    background: color-mix(in oklab, var(--bg-soft) 98%, transparent);
    padding:10px;
  }
  .edit-row[hidden]{ display:none }
  .row-actions{ display:flex; gap:.5rem; flex-wrap:wrap }

  /* Butonlar: kompakt ve sakin */
  .btn{ padding:.5rem .8rem; border-radius: 10px; }
  .btn-danger{
    background: color-mix(in oklab, var(--danger) 18%, transparent);
    color: color-mix(in oklab, var(--danger) 85%, #fff 15%);
    border: 1px solid color-mix(in oklab, var(--danger) 35%, transparent);
    box-shadow: none;
  }
  .btn-danger:hover{ background: color-mix(in oklab, var(--danger) 28%, transparent); }
  [data-theme="dark"] .btn-danger{
    background: color-mix(in oklab, var(--danger) 25%, transparent);
    border-color: color-mix(in oklab, var(--danger) 45%, transparent);
    color:#ffecec;
  }
  .btn-ghost{ background:transparent; border:1px dashed color-mix(in oklab, var(--line) 70%, transparent); opacity:.9 }
  .btn-ghost:hover{ opacity:1 }
  .btn.btn-edit{ background: color-mix(in oklab, var(--primary) 16%, transparent); border-color: transparent; }

  .pager{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:12px }
  .pager .btn[aria-disabled="true"]{ pointer-events:none; opacity:.5 }
  .totalinfo{ color:var(--muted); font-size:.9rem; margin-top:.35rem }

  /* küçük iyileştirmeler */
  .input-search{ min-width: clamp(220px, 26vw, 340px) }
  .w-code{ width:110px }
  .w-num{ width:130px }
  .w-ops{ width:170px }
  .text-muted{ opacity:.8 }
  .kbd{ font: 600 .82rem var(--mono); padding:.08rem .35rem; border-radius:6px;
        border:1px solid color-mix(in oklab, var(--line) 80%, transparent) }

  /* Sticky action bar (seçim yapılınca gösterilecek) */
  .actionbar{
    position: sticky; bottom: 8px; z-index: 5;
    display: none; /* JS ile görünür */
    margin-top: 10px;
    justify-content: flex-end; gap: var(--gap-2);
  }
  .actionbar .chip{
    align-self:center; font-weight:900; font-size:.9rem;
    padding:.35rem .6rem; border-radius:999px;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 95%, transparent);
  }

  /* Dar ekranda sağ “İşlem” sabit kalsın */
  @media (max-width: 1100px){
    .table-select th:nth-child(7), .table-select td:nth-child(7){
      position: sticky; right: 0; background: inherit;
    }
  }
</style>

<div class="card">
  <h2 style="margin:0 0 .35rem; letter-spacing:.01em">Tanımlı Risklerden Seç</h2>

  <!-- Sticky Üst araç çubuğu -->
  <div class="toolbar noprint" role="region" aria-label="Filtreler">
    <form method="get" action="{{ url_for('risk_identify') }}" class="group" id="filter-form">
      <div>
        <label class="small" for="cat">Kategori</label>
        <select id="cat" name="cat" class="input" style="min-width:220px">
          <option value="__all__" {% if (cat or '__all__') == '__all__' %}selected{% endif %}>— Tüm Kategoriler —</option>
          <option value="" {% if cat == '' %}selected{% endif %}>Genel / Kategorisiz</option>
          {% for cname in (filter_cat_names or []) %}
            <option value="{{ cname }}" {% if cname == cat %}selected{% endif %}>{{ cname }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="small" for="q">Ara <span class="text-muted">(Ctrl/⌘+K)</span></label>
        <input id="q" name="q" class="input input-search" value="{{ q or '' }}" placeholder="Metin / kod ara…">
      </div>
      <div>
        <label class="small">&nbsp;</label>
        <button class="btn" type="submit" title="Filtreleri uygula">Uygula</button>
      </div>
      {% if q or (cat and cat != '__all__') %}
      <div>
        <label class="small">&nbsp;</label>
        <a class="btn btn-ghost" href="{{ url_for('risk_identify') }}" title="Filtreleri temizle">Sıfırla</a>
      </div>
      {% endif %}
    </form>

    <div class="fill"></div>

    <div class="group">
      <a class="btn" href="{{ url_for('categories_index') }}?next=identify" title="Kategorileri yönet">Kategori Yönetimi</a>
      <a class="btn" href="{{ url_for('import_suggestions') }}" title="CSV / XLSX ile içe aktar">CSV/XLSX İçe Aktar</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}<div class="flash {{c}}">{{m}}</div>{% endfor %}
  {% endwith %}

  {% if not categories or categories|length == 0 %}
    <div class="flash info">
      Henüz tanımlı risk şablonu yok. Önce <a href="{{ url_for('import_suggestions') }}">CSV/XLSX içe aktar</a> 
      veya <a href="{{ url_for('categories_index') }}?next=identify">Kategori Yönetimi</a> üzerinden kategorileri tanımlayın.
    </div>
  {% endif %}

  <!-- Ana seçim formu (arka planda ID json gönderir) -->
  <form method="post" id="select-form" action="{{ url_for('risk_identify') }}">
    <input type="hidden" name="action" value="add_selected">
    <input type="hidden" name="selected_json" id="selected_json">
  </form>

  <div class="cat-grid">
    {% for cat, risks in categories.items() %}
      {% set cat_idx = loop.index0 %}
      {% set cat_name = cat or 'Genel / Kategorisiz' %}
      {% set slug = (cat_name|lower|replace(' ', '-')|replace('/', '-')|replace('.', '-') ) %}

      <section class="cat-card" id="cat-{{ slug }}" aria-label="{{ cat_name }}">
        <div class="cat-head">
          <h3 style="margin:0">{{ cat_name }}</h3>
          <span class="small cat-count" id="count-{{ cat_idx }}">(0 seçili)</span>
        </div>

        {% if session.get('role') == 'admin' %}
        <details style="margin:6px 0 12px;">
          <summary class="small" style="cursor:pointer; user-select:none;">➕ Bu kategoriye yeni madde ekle</summary>
          <form method="post" action="{{ url_for('admin_suggestion_create') }}" class="grid grid-2" style="margin-top:.5rem;">
            <input type="hidden" name="category" value="{{ cat_name }}">
            <div style="grid-column:1/-1">
              <label>Risk Metni</label>
              <textarea class="input" name="text" rows="2" required placeholder="Risk cümlesi..."></textarea>
            </div>
            <div>
              <label>Risk Kodu</label>
              <input class="input" name="risk_code" placeholder="örn: UYR02">
            </div>
            <div>
              <label>Vars. Olasılık (1–5)</label>
              <input class="input" type="number" name="default_prob" min="1" max="5" placeholder="—">
            </div>
            <div>
              <label>Vars. Şiddet (1–5)</label>
              <input class="input" type="number" name="default_sev" min="1" max="5" placeholder="—">
            </div>
            <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:.5rem;">
              <button class="btn btn-primary" type="submit">Ekle</button>
            </div>
          </form>
        </details>
        {% endif %}

        <div class="bulk-row">
          <label class="small">
            <input type="checkbox" class="toggle-all" data-group="{{ cat_idx }}">
            <strong>Tümünü seç / kaldır</strong>
          </label>
          <div class="right small">
            <button type="button" class="btn btn-ghost btn-collapse" data-target="#cat-{{ slug }}" title="Kategori tablosunu daralt/aç">Daralt ▼</button>
            <a class="btn btn-ghost" href="#top" title="Sayfa başına dön">↑</a>
          </div>
        </div>

        <div class="table-wrap" data-collapsible>
          <table class="table-select">
            <thead>
              <tr>
                <th style="width:56px">Seç</th>
                <th>Risk</th>
                <th>RİSK FAKTÖRÜ</th>
                <th class="w-code">Risk Kodu</th>
                <th class="w-num">Vars. Olasılık</th>
                <th class="w-num">Vars. Şiddet</th>
                <th class="w-ops">İşlem</th>
              </tr>
            </thead>
            <tbody>
            {% for s in risks %}
              {% set row_idx = loop.index0 %}
              {% set cb_id = 'sel-' ~ cat_idx ~ '-' ~ row_idx %}

              <!-- Görünen satır -->
              <tr>
                <td>
                  <input
                    id="{{ cb_id }}"
                    type="checkbox"
                    name="selected"
                    value="{{ s.id }}"
                    class="chk chk-{{ cat_idx }}"
                    data-group="{{ cat_idx }}"
                    aria-labelledby="lbl-{{ cb_id }}"
                    form="select-form"
                  >
                </td>

                <!-- RİSK (kısa başlık + rozet) -->
                <td>
                  <label class="risk-label" id="lbl-{{ cb_id }}" for="{{ cb_id }}">
                    <span class="risk-badge">
                      <span class="badge risk-code" title="Risk kodu kopyala" data-copy="{{ s.risk_code or '' }}">{{ s.risk_code or '—' }}</span>
                      <span class="small text-muted">{{ s.category or 'Genel' }}</span>
                    </span>
                  </label>
                </td>

                <!-- RİSK FAKTÖRÜ (uzun metin) -->
                <td class="small">
                  {{ s.text }}
                </td>

                <!-- Ayrı Risk Kodu sütunu -->
                <td><span class="badge">{{ s.risk_code or '—' }}</span></td>

                <td>{{ s.default_prob if s.default_prob is not none else '—' }}</td>
                <td>{{ s.default_sev  if s.default_sev  is not none else '—' }}</td>
                <td>
                  <div class="row-actions">
                    {% if session.get('role') == 'admin' %} 
                      <button class="btn btn-edit" type="button" data-sid="{{ s.id }}">Düzenle</button>
                      <form method="post"
                            action="{{ url_for('admin_suggestion_delete', sid=s.id) }}"
                            onsubmit="return confirm('Bu şablonu silmek istediğinize emin misiniz?');">
                        <button class="btn btn-danger" type="submit">Sil</button>
                      </form>
                    {% else %}
                      <span class="small" style="opacity:.7;">(düzenleme için admin)</span>
                    {% endif %}
                  </div>
                </td>
              </tr>

              {% if session.get('role') == 'admin' %}
              <!-- Düzenleme satırı -->
              <tr id="editrow-{{ s.id }}" class="edit-row" hidden>
                <td colspan="7">
                  <div class="inline-edit">
                    <form method="post" action="{{ url_for('admin_suggestion_update', sid=s.id) }}" class="grid grid-2">
                      <div style="grid-column:1/-1">
                        <label>Risk Metni</label>
                        <textarea class="input" name="text" rows="2" required>{{ s.text }}</textarea>
                      </div>
                      <div>
                        <label>Kategori</label>
                        <input class="input" name="category" value="{{ s.category or '' }}">
                      </div>
                      <div>
                        <label>Risk Kodu</label>
                        <input class="input" name="risk_code" value="{{ s.risk_code or '' }}">
                      </div>
                      <div>
                        <label>Varsayılan Olasılık (1–5)</label>
                        <input class="input" name="default_prob" type="number" min="1" max="5" value="{{ s.default_prob or '' }}">
                      </div>
                      <div>
                        <label>Varsayılan Şiddet (1–5)</label>
                        <input class="input" name="default_sev" type="number" min="1" max="5" value="{{ s.default_sev or '' }}">
                      </div>
                      <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end">
                        <button class="btn btn-primary" type="submit">Kaydet</button>
                        <button class="btn btn-ghost btn-cancel-edit" type="button" data-sid="{{ s.id }}">İptal</button>
                      </div>
                    </form>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    {% endfor %}
  </div>

  <div class="totalinfo">
    Toplam kayıt: {{ total }}{% if pages and pages > 1 %} • Sayfa {{ page }}/{{ pages }}{% endif %}
  </div>

  <div class="pager noprint">
    <a class="btn" aria-disabled="{{ 'true' if page <= 1 else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=1) }}">« İlk</a>
    <a class="btn" aria-disabled="{{ 'true' if page <= 1 else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=(page - 1 if page > 1 else 1)) }}">‹ Önceki</a>
    <a class="btn" aria-disabled="{{ 'true' if page >= pages else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=(page + 1 if page < pages else pages)) }}">Sonraki ›</a>
    <a class="btn" aria-disabled="{{ 'true' if page >= pages else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=pages) }}">Son »</a>
  </div>

  <!-- Sticky Action Bar: seçim olunca görünür -->
  <div class="actionbar noprint" id="actionbar">
    <span class="chip" id="selCounter">0 seçili</span>
    <button type="submit" class="btn btn-success" form="select-form">
      Seçilenleri Ekle
    </button>
  </div>
</div>

<script>
  // --- yardımcılar ---
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const $  = (sel, ctx=document) => ctx.querySelector(sel);

  // grup sayaç
  function updateCount(groupIdx){
    const boxes = $$('.chk-' + groupIdx);
    const sel = boxes.filter(b => b.checked).length;
    const el = $('#count-' + groupIdx);
    if (el) el.textContent = '(' + sel + ' seçili)';
  }

  // global sayaç + action bar
  const bar = $('#actionbar');
  const counter = $('#selCounter');
  function updateGlobalCount(){
    const total = $$('input[type="checkbox"][name="selected"]:checked').length;
    if(counter) counter.textContent = total + ' seçili';
    if(bar) bar.style.display = total > 0 ? 'flex' : 'none';
  }

  // toplu seç / kaldır
  $$('.toggle-all').forEach(tg => {
    tg.addEventListener('change', () => {
      const g = tg.getAttribute('data-group');
      $$('.chk-' + g).forEach(c => c.checked = tg.checked);
      updateCount(g);
      updateGlobalCount();
    });
    updateCount(tg.getAttribute('data-group'));
  });

  // tek tek değiştikçe sayaçlar
  $$('input[type="checkbox"][name="selected"]').forEach(c => {
    c.classList.add('chk');
    c.addEventListener('change', () => {
      const g = c.getAttribute('data-group');
      updateCount(g);
      updateGlobalCount();
    });
  });
  // ilk yüklemede durum
  updateGlobalCount();

  // inline edit aç/kapat
  document.addEventListener('click', (e) => {
    const editBtn = e.target.closest('.btn-edit');
    if (editBtn){
      const sid = editBtn.getAttribute('data-sid');
      const row = $('#editrow-' + sid);
      if (row) row.toggleAttribute('hidden');
      return;
    }
    const cancelBtn = e.target.closest('.btn-cancel-edit');
    if (cancelBtn){
      const sid2 = cancelBtn.getAttribute('data-sid');
      const row2 = $('#editrow-' + sid2);
      if (row2) row2.setAttribute('hidden','');
      return;
    }
  });

  // seçili ID'leri JSON olarak gönder (disable ile çift tıklamayı engelle)
  (function(){
    const form = $('#select-form'); if (!form) return;
    form.addEventListener('submit', function(){
      const checked = $$('input[type="checkbox"][name="selected"]:checked');
      const ids = checked.map(el => parseInt(el.value, 10)).filter(v => !isNaN(v));
      const hidden = $('#selected_json'); if (hidden) hidden.value = JSON.stringify(ids);
      $$('input[type="checkbox"][name="selected"]').forEach(el => el.disabled = true);
    });
  })();

  // risk kodu rozetine tıklayınca kopyala (soft feedback)
  document.addEventListener('click', async (e) => {
    const badge = e.target.closest('.risk-badge .badge');
    if (!badge) return;
    const code = badge.getAttribute('data-copy') || badge.textContent.trim();
    if (!code || code === '—') return;
    try {
      await navigator.clipboard.writeText(code);
      badge.style.outline='2px solid currentColor';
      setTimeout(() => badge.style.outline='', 700);
    } catch (_) {}
  });

  // kategori panelini daralt/aç (ikonlu metin)
  $$('.btn-collapse').forEach(btn => {
    const sel = btn.getAttribute('data-target');
    const box = document.querySelector(sel + ' .table-wrap');
    function setLabel(){
      const collapsed = box && box.style.display === 'none';
      btn.textContent = collapsed ? 'Genişlet ▲' : 'Daralt ▼';
    }
    btn.addEventListener('click', () => {
      if (!box) return;
      box.style.display = (box.style.display === 'none') ? '' : 'none';
      setLabel();
    });
    setLabel();
  });

  // Ctrl/⌘ + K → odak arama
  document.addEventListener('keydown', (e) => {
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    if ((isMac && e.metaKey && e.key.toLowerCase()==='k') || (!isMac && e.ctrlKey && e.key.toLowerCase()==='k')){
      e.preventDefault();
      const q = $('#q'); if (q){ q.focus(); q.select(); }
    }
  });

  // aramada debounce (enter’a basmadan 500ms sonra gönder)
  (function(){
    const q = $('#q'); const form = $('#filter-form');
    if(!q || !form) return;
    let t=null;
    q.addEventListener('input', ()=>{
      if(t) clearTimeout(t);
      t = setTimeout(()=> form.requestSubmit(), 500);
    });
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); form.requestSubmit(); } });
  })();
</script>
{% endblock %}
