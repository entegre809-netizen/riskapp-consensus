{% extends "base.html" %}
{% block title %}Risk TanÄ±mlama{% endblock %}

{% block content %}
<style>
  /* ---------- Sayfa-Ã¶zel (base tokenlarÄ±nÄ± kullanÄ±r) ---------- */
  :root{
    --gap-1: 6px; --gap-2: 10px; --gap-3: 14px; --gap-4: 18px;
    --round-sm: 10px; --round: 14px;
  }

  .toolbar {
    position: sticky; top: 8px; z-index: 2;
    display:flex; gap:.75rem; align-items:flex-end; flex-wrap:wrap;
    padding: .75rem; margin: 0 0 1rem;
    border:1px solid color-mix(in oklab, var(--line) 82%, transparent);
    border-radius: var(--radius);
    background: color-mix(in oklab, var(--bg-soft) 98%, transparent);
    box-shadow: var(--elev-1);
    backdrop-filter: var(--glass-blur);
  }
  .toolbar .group{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:flex-end }
  .toolbar .fill{ flex:1 }
  .input, select.input{ height: 40px; padding: .5rem .75rem; }

  .cat-grid{ display:grid; gap:var(--gap-4); grid-template-columns: repeat(3, minmax(0,1fr)); }
  @media (max-width:1200px){ .cat-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width:820px){ .cat-grid{ grid-template-columns: 1fr; } }

  .cat-card{
    border:1px solid color-mix(in oklab, var(--line) 85%, transparent);
    border-radius: var(--round);
    padding:12px; background: var(--card);
    box-shadow: 0 8px 26px rgba(0,0,0,.07);
  }
  .cat-head{ display:flex; align-items:flex-end; gap:.55rem; margin:4px 0 10px }
  .cat-head h3{ letter-spacing:.02em; font-variant: all-small-caps; font-weight: 900; opacity:.9 }
  .cat-count{ font-weight:900; color:var(--muted); background: color-mix(in oklab, var(--brand-2) 80%, transparent); padding:.12rem .5rem; border-radius:999px; }

  .bulk-row{ margin:6px 0 10px; display:flex; justify-content:space-between; align-items:center; gap:.5rem }
  .bulk-row .right{ display:flex; gap:.5rem; align-items:center }

  .table-select{ width:100%; border-collapse:separate; border-spacing:0; border-radius: 12px; overflow: clip; }
  .table-select th,.table-select td{
    padding:.6rem .7rem;
    border-bottom:1px solid color-mix(in oklab, var(--line) 82%, transparent);
    vertical-align:top; font-size:.96rem;
  }
  .table-select thead th{
    position:sticky; top:0; z-index:1;
    text-transform:uppercase; letter-spacing:.08em; font-weight:1000; font-size:.76rem;
    color:var(--muted);
    background: linear-gradient(180deg, color-mix(in oklab, var(--bg-soft) 98%, transparent), transparent);
    border-bottom:1px solid color-mix(in oklab, var(--line) 88%, transparent);
  }
  .table-select tbody tr:nth-child(even) td{ background: color-mix(in oklab, var(--bg) 96%, transparent); }
  .table-select tbody tr:hover td{ background: color-mix(in oklab, var(--primary) 5%, transparent); }

  /* Kolon hizalarÄ± */
  .table-select th:nth-child(1), .table-select td:nth-child(1){ width: 48px; }
  .table-select th:nth-child(4), .table-select td:nth-child(4){ width: 120px; text-align:center; }
  .table-select th:nth-child(5), .table-select td:nth-child(5),
  .table-select th:nth-child(6), .table-select td:nth-child(6){ width: 110px; text-align:center; }
  .table-select th:last-child, .table-select td:last-child{ width: 150px; }

  .risk-badge{ display:inline-flex; align-items:center; gap:.4rem }
  .risk-code{ display:inline-block; min-width:3ch }

  .risk-title{
    font-weight:600;
    display:inline-block;
  }

  .inline-edit{
    border:1px solid color-mix(in oklab, var(--line) 85%, transparent);
    border-radius: var(--radius-sm);
    background: color-mix(in oklab, var(--bg-soft) 98%, transparent);
    padding:10px;
  }
  .edit-row[hidden]{ display:none }
  .row-actions{ display:flex; gap:.5rem; flex-wrap:wrap }

  /* Butonlar: kompakt ve sakin */
  .btn{ padding:.5rem .8rem; border-radius: 10px; }
  .btn-danger{
    background: color-mix(in oklab, var(--danger) 18%, transparent);
    color: color-mix(in oklab, var(--danger) 85%, #fff 15%);
    border: 1px solid color-mix(in oklab, var(--danger) 35%, transparent);
    box-shadow: none;
  }
  .btn-danger:hover{ background: color-mix(in oklab, var(--danger) 28%, transparent); }
  [data-theme="dark"] .btn-danger{
    background: color-mix(in oklab, var(--danger) 25%, transparent);
    border-color: color-mix(in oklab, var(--danger) 45%, transparent);
    color:#ffecec;
  }
  .btn-ghost{ background:transparent; border:1px dashed color-mix(in oklab, var(--line) 70%, transparent); opacity:.9 }
  .btn-ghost:hover{ opacity:1 }
  .btn.btn-edit{ background: color-mix(in oklab, var(--primary) 16%, transparent); border-color: transparent; }

  /* ğŸ” kÃ¼Ã§Ã¼k detay butonu */
  .btn-icon{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:.15rem .35rem;
    border-radius:999px;
    border:1px solid color-mix(in oklab, var(--line) 70%, transparent);
    background:transparent;
    font-size:.9rem;
    cursor:pointer;
  }
  .btn-icon:hover{
    background: color-mix(in oklab, var(--primary) 10%, transparent);
  }

  .pager{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:12px }
  .pager .btn[aria-disabled="true"]{ pointer-events:none; opacity:.5 }
  .totalinfo{ color:var(--muted); font-size:.9rem; margin-top:.35rem }

  /* kÃ¼Ã§Ã¼k iyileÅŸtirmeler */
  .input-search{
  min-width: clamp(220px, 26vw, 340px);
}
  .w-code{ width:110px }
  .w-num{ width:130px }
  .w-ops{ width:170px }
  .text-muted{ opacity:.8 }
  .kbd{ font: 600 .82rem var(--mono); padding:.08rem .35rem; border-radius:6px;
        border:1px solid color-mix(in oklab, var(--line) 80%, transparent) }

  /* Sticky action bar (seÃ§im yapÄ±lÄ±nca gÃ¶sterilecek) */
  .actionbar{
    position: sticky; bottom: 8px; z-index: 5;
    display: none; /* JS ile gÃ¶rÃ¼nÃ¼r */
    margin-top: 10px;
    justify-content: flex-end; gap: var(--gap-2);
  }
  .actionbar .chip{
    align-self:center; font-weight:900; font-size:.9rem;
    padding:.35rem .6rem; border-radius:999px;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 95%, transparent);
  }

  /* Dar ekranda saÄŸ â€œÄ°ÅŸlemâ€ sabit kalsÄ±n DIÅI â€” varsayÄ±lan kapalÄ± (hotfix ile birlikte) */
  @media (max-width: 1100px){
    .table-select th:last-child, .table-select td:last-child{ position: static !important; }
  }

  /* ====== RISK TABLE OVERLAP HOTFIX ====== */
  .table-wrap{ overflow-x: auto !important; overflow-y: visible !important; }
  .table-select{ table-layout: auto !important; min-width: 980px; }
  .table-select thead th{
    position: sticky; top: 0; z-index: 3; background: inherit;
  }
  .table-select td, .table-select th{ position: relative; z-index: 1; }
  .table-select th:last-child, .table-select td:last-child{
    position: static !important; right: auto !important; background: inherit; z-index: 2; white-space: nowrap;
  }
  .row-actions{ display: inline-flex !important; gap: 8px !important; flex-wrap: nowrap !important; align-items: center; }
  .row-actions form{ margin:0 }
  .row-actions .btn{ white-space: nowrap; }
  .table-select th:nth-child(2), .table-select td:nth-child(2){ min-width: 180px; }
  .table-select th:nth-child(3), .table-select td:nth-child(3){ min-width: 260px; }
  .cat-card:hover{ transform: none !important; }
  .table-select tbody tr:nth-child(even) td,
  .table-select tbody tr:hover td{ background-clip: padding-box; }

  /* --- Mitigation (Ã¶nerilen Ã¶nlemler) bloÄŸu (link + gizli kutu) --- */
  .mit-link{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:.82rem;
    color:var(--muted);
    text-decoration:none;
    margin-top:4px;
  }
  .mit-link::before{
    content:"âœ";
    font-size:.8rem;
    opacity:.7;
  }
  .mit-link.is-open{
    color:var(--primary);
  }
  .mit-box{
    display:none;
    margin-top:4px;
    padding:6px 8px;
    border-radius:8px;
    border:1px dashed color-mix(in oklab, var(--line) 80%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
    font-size:.8rem;
    white-space:pre-wrap;
  }
</style>

<div class="card" id="top">
  <h2 style="margin:0 0 .35rem; letter-spacing:.01em">TanÄ±mlÄ± Risklerden SeÃ§</h2>

  <!-- Sticky Ãœst araÃ§ Ã§ubuÄŸu -->
  <div class="toolbar noprint" role="region" aria-label="Filtreler">
    <form method="get" action="{{ url_for('risk_identify') }}" class="group" id="filter-form">
      <div>
        <label class="small" for="cat">Kategori</label>
        <select id="cat" name="cat" class="input" style="min-width:220px">
          <option value="__all__" {% if (cat or '__all__') == '__all__' %}selected{% endif %}>â€” TÃ¼m Kategoriler â€”</option>
          <option value="" {% if cat == '' %}selected{% endif %}>Genel / Kategorisiz</option>
          {% for cname in (filter_cat_names or []) %}
            <option value="{{ cname }}" {% if cname == cat %}selected{% endif %}>{{ cname }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="small" for="q">Ara <span class="text-muted">(Ctrl/âŒ˜+K)</span></label>
        <input id="q" name="q" class="input input-search" value="{{ q or '' }}" placeholder="Metin / kod araâ€¦">
      </div>
      <div>
        <label class="small">&nbsp;</label>
        <button class="btn" type="submit" title="Filtreleri uygula">Uygula</button>
      </div>
      {% if q or (cat and cat != '__all__') %}
      <div>
        <label class="small">&nbsp;</label>
        <a class="btn btn-ghost" href="{{ url_for('risk_identify') }}" title="Filtreleri temizle">SÄ±fÄ±rla</a>
      </div>
      {% endif %}
    </form>

    <div class="fill"></div>

    <div class="group">
      <a class="btn" href="{{ url_for('categories_index') }}?next=identify" title="Kategorileri yÃ¶net">Kategori YÃ¶netimi</a>
      <a class="btn" href="{{ url_for('import_suggestions') }}" title="CSV / XLSX ile iÃ§e aktar">CSV/XLSX Ä°Ã§e Aktar</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}<div class="flash {{c}}">{{m}}</div>{% endfor %}
  {% endwith %}

  {% if not categories or categories|length == 0 %}
    <div class="flash info">
      HenÃ¼z tanÄ±mlÄ± risk ÅŸablonu yok. Ã–nce <a href="{{ url_for('import_suggestions') }}">CSV/XLSX iÃ§e aktar</a> 
      veya <a href="{{ url_for('categories_index') }}?next=identify">Kategori YÃ¶netimi</a> Ã¼zerinden kategorileri tanÄ±mlayÄ±n.
    </div>
  {% endif %}

  <!-- Ana seÃ§im formu -->
  <form method="post" id="select-form" action="{{ url_for('risk_identify') }}">
    <!-- action deÄŸeri butonlardan geliyor -->
    <input type="hidden" name="selected_json" id="selected_json">
  </form>

  <div class="cat-grid">
    {% for cat, risks in categories.items() %}
      {% set cat_idx = loop.index0 %}
      {% set cat_name = cat or 'Genel / Kategorisiz' %}
      {% set slug = (cat_name|lower|replace(' ', '-')|replace('/', '-')|replace('.', '-') ) %}

      <section class="cat-card" id="cat-{{ slug }}" aria-label="{{ cat_name }}">
        <div class="cat-head">
          <h3 style="margin:0">{{ cat_name }}</h3>
          <span class="small cat-count" id="count-{{ cat_idx }}">(0 seÃ§ili)</span>
        </div>

        {% if session.get('role') == 'admin' %}
        <details style="margin:6px 0 12px;">
          <summary class="small" style="cursor:pointer; user-select:none;">â• Bu kategoriye yeni madde ekle</summary>
          <form method="post" action="{{ url_for('admin_suggestion_create') }}" class="grid grid-2" style="margin-top:.5rem;">
            <input type="hidden" name="category" value="{{ cat_name }}">
            <div style="grid-column:1/-1">
              <label>
                Risk Metni
                <span class="small text-muted">(kÄ±sa ve net yazÄ±n; Ã§ok uzun metinler kaydedilmeyebilir)</span>
              </label>
              <textarea class="input" name="text" rows="2" required placeholder="Risk cÃ¼mlesi..."></textarea>
            </div>

            <!-- Risk FaktÃ¶rÃ¼ -->
            <div style="grid-column:1/-1">
              <label>Risk FaktÃ¶rÃ¼ (aÃ§Ä±klama)</label>
              <textarea class="input" name="risk_desc" rows="2"
                        placeholder="Jeoteknik, batimetrik veya Ã§evresel verilerin eksik/yanlÄ±ÅŸ olmasÄ± sonucu tasarÄ±m parametrelerinin hatalÄ± belirlenmesi gibi..."></textarea>
            </div>

            <!-- Ã–nerilen Ã–nlemler -->
            <div style="grid-column:1/-1">
              <label>Ã–nerilen Ã–nlemler (opsiyonel)</label>
              <textarea class="input" name="mitigation_hint" rows="2"
                        placeholder="Ã–nerilen Ã¶nlemleri yazabilirsiniz (iÅŸ paketleri, RFI sÃ¼resi, KPIâ€™lar vb.)"></textarea>
            </div>

            <div>
              <label>Risk Kodu
                <span class="small text-muted">(ilk 3 harf, son 2 rakam Â· Ã¶rn: UYR02)</span>
              </label>
              <input class="input"
                     name="risk_code"
                     placeholder="Ã¶rn: UYR02"
                     pattern="[A-Za-z]{3}[0-9]{2}"
                     title="Ä°lk 3 karakter harf, son 2 karakter rakam olmalÄ±. Ã–rn: UYR02">
            </div>
            <div>
              <label>Vars. OlasÄ±lÄ±k (1â€“5)</label>
              <input class="input" type="number" name="default_prob" min="1" max="5" placeholder="â€”">
            </div>
            <div>
              <label>Vars. Åiddet (1â€“5)</label>
              <input class="input" type="number" name="default_sev" min="1" max="5" placeholder="â€”">
            </div>
            <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:.5rem;">
              <button class="btn btn-primary" type="submit">Ekle</button>
            </div>
          </form>
        </details>
        {% endif %}

        <div class="bulk-row">
          <label class="small">
            <input type="checkbox" class="toggle-all" data-group="{{ cat_idx }}">
            <strong>TÃ¼mÃ¼nÃ¼ seÃ§ / kaldÄ±r</strong>
          </label>
          <div class="right small">
            <button type="button" class="btn btn-ghost btn-collapse" data-target="#cat-{{ slug }}" title="Kategori tablosunu daralt/aÃ§">Daralt â–¼</button>
            <a class="btn btn-ghost" href="#top" title="Sayfa baÅŸÄ±na dÃ¶n">â†‘</a>
          </div>
        </div>

        <div class="table-wrap" data-collapsible>
          <table class="table-select">
            <thead>
              <tr>
                <th style="width:56px">SeÃ§</th>
                <th>Risk</th>
                <th>RÄ°SK FAKTÃ–RÃœ</th>
                <th class="w-code">Risk Kodu</th>
                <th class="w-num">Vars. OlasÄ±lÄ±k</th>
                <th class="w-num">Vars. Åiddet</th>
                <th class="w-ops">Ä°ÅŸlem</th>
              </tr>
            </thead>
            <tbody>
            {% for s in risks %}
              {% set row_idx = loop.index0 %}
              {% set cb_id = 'sel-' ~ cat_idx ~ '-' ~ row_idx %}

              <tr>
                <td>
                  <input
                    id="{{ cb_id }}"
                    type="checkbox"
                    name="selected"
                    value="{{ s.id }}"
                    class="chk chk-{{ cat_idx }}"
                    data-group="{{ cat_idx }}"
                    aria-labelledby="lbl-{{ cb_id }}"
                    form="select-form"
                  >
                </td>

                <!-- RÄ°SK: kÄ±sa risk adÄ± + kategori + bÃ¼yÃ¼teÃ§ -->
                <td>
                  <label class="risk-label" id="lbl-{{ cb_id }}" for="{{ cb_id }}">
                    <div class="risk-badge">
                      <span class="risk-title">
                        {{ s.risk_title or s.text }}
                      </span>
                      <a href="{{ url_for('risk_template_detail', ref_id=s.id) }}"
                         class="btn-icon"
                         title="Risk detayÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                        ğŸ”
                      </a>
                    </div>
                  </label>
                </td>

                <!-- RÄ°SK FAKTÃ–RÃœ + Mitigation -->
                <td class="small">
                  {{ s.risk_desc or s.text }}
                  {% if s.mitigation_hint %}
                    <br>
                    <a href="#"
                       class="mit-link"
                       data-target="mit-{{ s.id }}">
                      Ã–nerilen Ã¶nlemleri gÃ¶ster
                    </a>
                    <div id="mit-{{ s.id }}" class="mit-box">
                      {{ s.mitigation_hint }}
                    </div>
                  {% endif %}
                </td>

                <td><span class="badge" data-copy="{{ s.risk_code or '' }}">{{ s.risk_code or 'â€”' }}</span></td>
                <td>{{ s.default_prob if s.default_prob is not none else 'â€”' }}</td>
                <td>{{ s.default_sev  if s.default_sev  is not none else 'â€”' }}</td>
                <td>
                  <div class="row-actions">
                    {% if session.get('role') == 'admin' %}
                      <button class="btn btn-edit" type="button" data-sid="{{ s.id }}">DÃ¼zenle</button>
                      <form method="post"
                            action="{{ url_for('admin_suggestion_delete', sid=s.id) }}"
                            onsubmit="return confirm('Bu ÅŸablonu silmek istediÄŸinize emin misiniz?');">
                        <button class="btn btn-danger" type="submit">Sil</button>
                      </form>
                    {% else %}
                      <span class="small" style="opacity:.7;">(dÃ¼zenleme iÃ§in admin)</span>
                    {% endif %}
                  </div>
                </td>
              </tr>

              {% if session.get('role') == 'admin' %}
              <tr id="editrow-{{ s.id }}" class="edit-row" hidden>
                <td colspan="7">
                  <div class="inline-edit">
                    <form method="post" action="{{ url_for('admin_suggestion_update', sid=s.id) }}" class="grid grid-2">
                      <div style="grid-column:1/-1">
                        <label>
                          Risk Metni
                          <span class="small text-muted">(kÄ±sa ve net tutun; gereksiz uzun metinler reddedilebilir)</span>
                        </label>
                        <textarea class="input" name="text" rows="2" required>{{ s.text }}</textarea>
                      </div>

                      <!-- edit iÃ§in Risk FaktÃ¶rÃ¼ -->
                      <div style="grid-column:1/-1">
                        <label>Risk FaktÃ¶rÃ¼ (aÃ§Ä±klama)</label>
                        <textarea class="input" name="risk_desc" rows="2">{{ s.risk_desc or '' }}</textarea>
                      </div>

                      <!-- edit iÃ§in Ã–nerilen Ã–nlemler -->
                      <div style="grid-column:1/-1">
                        <label>Ã–nerilen Ã–nlemler (opsiyonel)</label>
                        <textarea class="input" name="mitigation_hint" rows="2">{{ s.mitigation_hint or '' }}</textarea>
                      </div>

                      <div>
                        <label>Kategori</label>
                        <input class="input" name="category" value="{{ s.category or '' }}">
                      </div>
                      <div>
                        <label>
                          Risk Kodu
                          <span class="small text-muted">(ilk 3 harf, son 2 rakam Â· Ã¶rn: UYR02)</span>
                        </label>
                        <input class="input"
                               name="risk_code"
                               value="{{ s.risk_code or '' }}"
                               pattern="[A-Za-z]{3}[0-9]{2}"
                               title="Ä°lk 3 karakter harf, son 2 karakter rakam olmalÄ±. Ã–rn: UYR02">
                      </div>
                      <div>
                        <label>VarsayÄ±lan OlasÄ±lÄ±k (1â€“5)</label>
                        <input class="input" name="default_prob" type="number" min="1" max="5" value="{{ s.default_prob or '' }}">
                      </div>
                      <div>
                        <label>VarsayÄ±lan Åiddet (1â€“5)</label>
                        <input class="input" name="default_sev" type="number" min="1" max="5" value="{{ s.default_sev or '' }}">
                      </div>
                      <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end">
                        <button class="btn btn-primary" type="submit">Kaydet</button>
                        <button class="btn btn-ghost btn-cancel-edit" type="button" data-sid="{{ s.id }}">Ä°ptal</button>
                      </div>
                    </form>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    {% endfor %}
  </div>

  <div class="totalinfo">
    Toplam kayÄ±t: {{ total }}{% if pages and pages > 1 %} â€¢ Sayfa {{ page }}/{{ pages }}{% endif %}
  </div>

  <div class="pager noprint">
    <a class="btn" aria-disabled="{{ 'true' if page <= 1 else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=1) }}">Â« Ä°lk</a>
    <a class="btn" aria-disabled="{{ 'true' if page <= 1 else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=(page - 1 if page > 1 else 1)) }}">â€¹ Ã–nceki</a>
    <a class="btn" aria-disabled="{{ 'true' if page >= pages else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=(page + 1 if page < pages else pages)) }}">Sonraki â€º</a>
    <a class="btn" aria-disabled="{{ 'true' if page >= pages else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=pages) }}">Son Â»</a>
  </div>

  <!-- Sticky Action Bar: seÃ§im olunca gÃ¶rÃ¼nÃ¼r -->
  <div class="actionbar noprint" id="actionbar">
    <span class="chip" id="selCounter">0 seÃ§ili</span>

    <!-- yeni akÄ±ÅŸ: risk_newâ€™de formda aÃ§ -->
    <button type="submit" class="btn btn-primary"
            form="select-form" name="action" value="pick_for_new"
            title="SeÃ§ili ÅŸablonlarÄ± yeni risk formuna taÅŸÄ±">
      Yeni Risk Formunda AÃ§
    </button>
  </div>
</div>

<script>
  // --- yardÄ±mcÄ±lar ---
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const $  = (sel, ctx=document) => ctx.querySelector(sel);

  function updateCount(groupIdx){
    const sel = $$('.chk-' + groupIdx).filter(b => b.checked).length;
    const el = $('#count-' + groupIdx);
    if (el) el.textContent = '(' + sel + ' seÃ§ili)';
  }

  // global sayaÃ§ + action bar
  const bar = $('#actionbar');
  const counter = $('#selCounter');
  function updateGlobalCount(){
    const total = $$('input[type="checkbox"][name="selected"]:checked').length;
    if(counter) counter.textContent = total + ' seÃ§ili';
    if(bar) bar.style.display = total > 0 ? 'flex' : 'none';
  }

  // toplu seÃ§ / kaldÄ±r
  $$('.toggle-all').forEach(tg => {
    tg.addEventListener('change', () => {
      const g = tg.getAttribute('data-group');
      $$('.chk-' + g).forEach(c => c.checked = tg.checked);
      updateCount(g); updateGlobalCount();
    });
    updateCount(tg.getAttribute('data-group'));
  });

  // tek tek deÄŸiÅŸtikÃ§e sayaÃ§lar
  $$('input[type="checkbox"][name="selected"]').forEach(c => {
    c.classList.add('chk');
    c.addEventListener('change', () => {
      const g = c.getAttribute('data-group');
      updateCount(g); updateGlobalCount();
    });
  });
  updateGlobalCount();

  // inline edit aÃ§/kapat
  document.addEventListener('click', (e) => {
    const editBtn = e.target.closest('.btn-edit');
    if (editBtn){
      const sid = editBtn.getAttribute('data-sid');
      const row = $('#editrow-' + sid);
      if (row) row.toggleAttribute('hidden');
      return;
    }
    const cancelBtn = e.target.closest('.btn-cancel-edit');
    if (cancelBtn){
      const sid2 = cancelBtn.getAttribute('data-sid');
      const row2 = $('#editrow-' + sid2);
      if (row2) row2.setAttribute('hidden','');
      return;
    }
  });

  // seÃ§ili ID'leri JSON olarak gÃ¶nder
  (function(){
    const form = $('#select-form'); if (!form) return;
    form.addEventListener('submit', function(){
      const ids = $$('input[type="checkbox"][name="selected"]:checked')
        .map(el => parseInt(el.value, 10)).filter(v => !isNaN(v));
      const hidden = $('#selected_json'); if (hidden) hidden.value = JSON.stringify(ids);
      $$('input[type="checkbox"][name="selected"]').forEach(el => el.disabled = true);
    });
  })();

  // risk kodu rozetine tÄ±kla â†’ kopyala
  document.addEventListener('click', async (e) => {
    const badge = e.target.closest('.risk-badge .badge'); if (!badge) return;
    const code = badge.getAttribute('data-copy') || badge.textContent.trim();
    if (!code || code === 'â€”') return;
    try {
      await navigator.clipboard.writeText(code);
      badge.style.outline='2px solid currentColor';
      setTimeout(()=>badge.style.outline='', 700);
    } catch {}
  });

  // kategori panelini daralt/aÃ§ (ikonlu metin)
  $$('.btn-collapse').forEach(btn => {
    const sel = btn.getAttribute('data-target');
    const box = document.querySelector(sel + ' .table-wrap');
    function setLabel(){
      const collapsed = box && box.style.display === 'none';
      btn.textContent = collapsed ? 'GeniÅŸlet â–²' : 'Daralt â–¼';
    }
    btn.addEventListener('click', () => {
      if (!box) return;
      box.style.display = (box.style.display === 'none') ? '' : 'none';
      setLabel();
    });
    setLabel();
  });

  // Ctrl/âŒ˜ + K â†’ aramaya odak
  document.addEventListener('keydown', (e) => {
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    if ((isMac && e.metaKey && e.key.toLowerCase()==='k') || (!isMac && e.ctrlKey && e.key.toLowerCase()==='k')){
      e.preventDefault(); const q = $('#q'); if (q){ q.focus(); q.select(); }
    }
  });

  // aramada debounce + Enter
  (function(){
    const q = $('#q'); const form = $('#filter-form'); if(!q || !form) return;
    let t=null;
    q.addEventListener('input', ()=>{ if(t) clearTimeout(t); t = setTimeout(()=> form.requestSubmit(), 500); });
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); form.requestSubmit(); } });
  })();

  // tablo geniÅŸse: yatay scrollâ€™u zorla (gÃ¶rsel taÅŸma olmasÄ±n)
  (function(){
    document.querySelectorAll('.table-wrap').forEach(w => {
      const t = w.querySelector('table'); if(!t) return;
      if (t.scrollWidth > w.clientWidth) w.style.overflowX = 'auto';
    });
  })();

  // Ã–nerilen Ã¶nlemler linki â†’ kutu aÃ§/kapa
  document.addEventListener('click', (e) => {
    const link = e.target.closest('.mit-link');
    if (!link) return;
    e.preventDefault();
    const targetId = link.dataset.target;
    const box = document.getElementById(targetId);
    if (!box) return;

    const isOpen = box.style.display === 'block';
    box.style.display = isOpen ? 'none' : 'block';
    link.classList.toggle('is-open', !isOpen);
    link.textContent = isOpen ? 'Ã–nerilen Ã¶nlemleri gÃ¶ster' : 'Ã–nerilen Ã¶nlemleri gizle';
  });
</script>
{% endblock %}
