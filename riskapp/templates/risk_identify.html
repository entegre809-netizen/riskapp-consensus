{% extends "base.html" %}
{% block title %}Risk Tanƒ±mlama{% endblock %}

{% block content %}
<style>
  /* =========================================================
     Risk Identify ‚Äî "Enterprise / Tailwind-like" UI
     Feature kaybƒ± YOK: aynƒ± Jinja + aynƒ± JS akƒ±≈üƒ±
     ========================================================= */

  :root{
    --gap-1: 6px; --gap-2: 10px; --gap-3: 14px; --gap-4: 18px;
    --round-sm: 10px; --round: 14px;

    /* fallback'ler (base yoksa patlamasƒ±n) */
    --primary: #2866bd;
    --bg: #ffffff;
    --bg-soft: #f8fafc;
    --card: rgba(255,255,255,.92);
    --line: rgba(148,163,184,.35);
    --muted: rgba(100,116,139,1);
    --radius: 16px;
    --radius-sm: 12px;
    --elev-1: 0 10px 26px -18px rgba(15,23,42,.25);
    --glass-blur: blur(10px);
    --danger: #ef4444;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
  }

  [data-theme="dark"]{
    --bg: #0b1220;
    --bg-soft: rgba(18,24,32,.72);
    --card: rgba(18,24,32,.62);
    --line: rgba(51,65,85,.55);
    --muted: rgba(148,163,184,1);
  }

  /* ---------- Sayfa wrapper ---------- */
  .page{
    position: relative;
  }

  /* ---------- Ba≈ülƒ±k ---------- */
  .page-title{
    margin: 0 0 .35rem;
    letter-spacing:.01em;
    font-weight: 900;
  }
  .page-sub{
    margin: 0 0 1rem;
    color: var(--muted);
    font-size: .95rem;
  }

  /* ---------- Toolbar (sticky) ---------- */
  .toolbar {
    position: sticky; top: 8px; z-index: 3;
    display:flex; gap:.75rem; align-items:flex-end; flex-wrap:wrap;
    padding: .85rem; margin: 0 0 1rem;
    border:1px solid color-mix(in oklab, var(--line) 90%, transparent);
    border-radius: var(--radius);
    background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
    box-shadow: var(--elev-1);
    backdrop-filter: var(--glass-blur);
  }
  .toolbar .group{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:flex-end }
  .toolbar .fill{ flex:1 }

  .input, select.input, textarea.input{
    height: 40px;
    padding: .55rem .8rem;
    border-radius: 12px;
    border: 1px solid color-mix(in oklab, var(--line) 92%, transparent);
    background: color-mix(in oklab, var(--bg) 96%, transparent);
    color: inherit;
    outline: none;
  }
  textarea.input{ height: auto; }

  .input:focus, select.input:focus, textarea.input:focus{
    border-color: color-mix(in oklab, var(--primary) 55%, var(--line));
    box-shadow: 0 0 0 4px color-mix(in oklab, var(--primary) 20%, transparent);
  }

  .input-search{ min-width: clamp(220px, 26vw, 360px); }

  /* ---------- Grid ---------- */
  .cat-grid{ display:grid; gap:var(--gap-4); grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media (max-width: 980px){ .cat-grid{ grid-template-columns: 1fr; } }

  /* ---------- Category card ---------- */
  .cat-card{
    border:1px solid color-mix(in oklab, var(--line) 92%, transparent);
    border-radius: 18px;
    padding: 14px;
    background: color-mix(in oklab, var(--bg) 96%, transparent);
    box-shadow: 0 10px 28px -22px rgba(15,23,42,.25);
    transition: box-shadow .18s ease, transform .18s ease, border-color .18s ease;
  }
  .cat-card:hover{
    border-color: color-mix(in oklab, var(--primary) 30%, var(--line));
    box-shadow: 0 18px 42px -26px rgba(15,23,42,.32);
    transform: translateY(-1px);
  }
  [data-theme="dark"] .cat-card{
    background: rgba(18,24,32,.58);
  }
  [data-theme="dark"] .cat-card:hover{ transform: translateY(-1px); }

  .cat-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
    margin: 2px 0 12px;
  }
  .cat-left{
    display:flex;
    align-items:center;
    gap:.6rem;
    min-width: 0;
  }
  .cat-head h3{
    margin: 0;
    font-weight: 950;
    letter-spacing: -0.01em;
    font-size: 1.05rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ‚úÖ Category icon (screenshot style) */
  .cat-ico{
    width: 34px;
    height: 34px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    background: color-mix(in oklab, var(--primary) 10%, transparent);
    border: 1px solid color-mix(in oklab, var(--primary) 22%, transparent);
    color: var(--primary);
    flex: 0 0 auto;
  }
  .cat-ico svg{ width: 18px; height: 18px; display:block; }

  .cat-count{
    font-weight: 900;
    color: var(--muted);
    background: color-mix(in oklab, var(--primary) 10%, transparent);
    border: 1px solid color-mix(in oklab, var(--primary) 22%, transparent);
    padding: .18rem .55rem;
    border-radius: 999px;
    font-size: .82rem;
    white-space: nowrap;
  }

  /* ---------- Bulk row ---------- */
  .bulk-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:.6rem;
    flex-wrap:wrap;
    padding: 10px 10px;
    border: 1px solid color-mix(in oklab, var(--line) 82%, transparent);
    border-radius: 14px;
    background: color-mix(in oklab, var(--bg-soft) 90%, transparent);
    margin: 0 0 12px;
  }
  [data-theme="dark"] .bulk-row{
    background: rgba(30,33,38,.40);
  }
  .bulk-row .right{ display:flex; gap:.5rem; align-items:center }

  /* ---------- Table wrapper ---------- */
  .table-wrap{
    overflow-x: auto !important;
    overflow-y: visible !important;
    border-radius: 14px;
    border: 1px solid color-mix(in oklab, var(--line) 88%, transparent);
    background: color-mix(in oklab, var(--bg) 97%, transparent);
  }
  [data-theme="dark"] .table-wrap{
    background: rgba(18,24,32,.40);
  }

  .table-select{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    table-layout: auto !important;
    min-width: 980px;
  }

  .table-select th,.table-select td{
    padding: .8rem .85rem;
    border-bottom: 1px solid color-mix(in oklab, var(--line) 82%, transparent);
    vertical-align: top;
    font-size: .95rem;
  }

  .table-select thead th{
    position: sticky;
    top: 0;
    z-index: 3;
    text-transform: uppercase;
    letter-spacing: .12em;
    font-weight: 950;
    font-size: .72rem;
    color: color-mix(in oklab, var(--muted) 88%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 92%, transparent);
    border-bottom: 1px solid color-mix(in oklab, var(--line) 92%, transparent);
    white-space: nowrap;
  }

  .table-select tbody tr:hover td{
    background: color-mix(in oklab, var(--primary) 6%, transparent);
  }

  /* Kolon hizalarƒ± */
  .table-select th:nth-child(1), .table-select td:nth-child(1){ width: 54px; }
  .table-select th:nth-child(4), .table-select td:nth-child(4){ width: 120px; text-align:center; }
  .table-select th:nth-child(5), .table-select td:nth-child(5),
  .table-select th:nth-child(6), .table-select td:nth-child(6){ width: 130px; text-align:center; }
  .table-select th:last-child, .table-select td:last-child{ width: 180px; }

  /* ---------- Chips / badges ---------- */
  .chip{
    display:inline-flex;
    align-items:center;
    gap:.4rem;
    padding: .2rem .55rem;
    border-radius: 999px;
    border:1px solid color-mix(in oklab, var(--line) 86%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 94%, transparent);
    font-size: .82rem;
    font-weight: 800;
    color: color-mix(in oklab, var(--muted) 92%, transparent);
    white-space: nowrap;
  }

  .code-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding: .14rem .5rem;
    border-radius: 999px;
    background: color-mix(in oklab, var(--primary) 12%, transparent);
    border: 1px solid color-mix(in oklab, var(--primary) 22%, transparent);
    color: var(--primary);
    font: 900 .74rem/1 var(--mono);
    letter-spacing: .06em;
    text-transform: uppercase;
    cursor: pointer;
    user-select:none;
    white-space: nowrap;
  }

  .risk-title{
    font-weight: 800;
    color: inherit;
  }

  /* group-hover detail button */
  .risk-inline{
    display:flex;
    align-items:center;
    gap:.55rem;
    min-width: 0;
  }
  .btn-mini{
    opacity: 0;
    transform: translateY(1px);
    transition: opacity .15s ease, transform .15s ease, background .15s ease, border-color .15s ease;
  }
  tr:hover .btn-mini{
    opacity: 1;
    transform: translateY(0);
  }

  .btn-icon{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width: 30px;
    height: 30px;
    border-radius: 10px;
    border: 1px solid color-mix(in oklab, var(--line) 84%, transparent);
    background: transparent;
    cursor: pointer;
    text-decoration:none;
    font-size: 1rem;
    line-height: 1;
  }
  .btn-icon:hover{
    border-color: color-mix(in oklab, var(--primary) 30%, var(--line));
    background: color-mix(in oklab, var(--primary) 8%, transparent);
  }

  /* ---------- Buttons (compact) ---------- */
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.5rem;
    padding: .55rem .85rem;
    border-radius: 12px;
    border: 1px solid color-mix(in oklab, var(--line) 86%, transparent);
    background: color-mix(in oklab, var(--bg) 96%, transparent);
    color: inherit;
    font-weight: 900;
    font-size: .92rem;
    text-decoration:none;
    cursor:pointer;
    transition: transform .08s ease, filter .16s ease, border-color .16s ease, background .16s ease;
  }
  .btn:hover{ transform: translateY(-1px); border-color: color-mix(in oklab, var(--primary) 28%, var(--line)); }

  .btn-primary{
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
    box-shadow: 0 16px 38px -22px color-mix(in oklab, var(--primary) 55%, transparent);
  }
  .btn-primary:hover{ filter: brightness(1.03); }

  .btn-ghost{
    background: transparent;
    border-style: dashed;
    opacity: .95;
  }
  .btn-ghost:hover{ opacity: 1; }

  .btn-danger{
    background: color-mix(in oklab, var(--danger) 18%, transparent);
    color: color-mix(in oklab, var(--danger) 85%, #fff 15%);
    border: 1px solid color-mix(in oklab, var(--danger) 35%, transparent);
    box-shadow: none;
  }
  .btn-danger:hover{ background: color-mix(in oklab, var(--danger) 28%, transparent); }

  .btn-edit{
    background: color-mix(in oklab, var(--primary) 12%, transparent);
    border-color: transparent;
  }

  /* ---------- Inline edit ---------- */
  .inline-edit{
    border:1px solid color-mix(in oklab, var(--line) 86%, transparent);
    border-radius: 14px;
    background: color-mix(in oklab, var(--bg-soft) 92%, transparent);
    padding: 12px;
  }
  .edit-row[hidden]{ display:none }
  .row-actions{
    display: inline-flex;
    gap: 8px;
    flex-wrap: nowrap;
    align-items: center;
  }
  .row-actions form{ margin:0 }

  /* ---------- Pager + info ---------- */
  .pager{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:12px }
  .pager .btn[aria-disabled="true"]{ pointer-events:none; opacity:.5 }
  .totalinfo{ color:var(--muted); font-size:.92rem; margin-top: .6rem }

  .small{ color: var(--muted); font-size: .9rem; }
  .text-muted{ opacity: .82; }

  /* ---------- Mitigation toggle ---------- */
  .mit-link{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:.82rem;
    color: color-mix(in oklab, var(--muted) 92%, transparent);
    text-decoration:none;
    margin-top: 6px;
  }
  .mit-link::before{ content:"‚ûú"; opacity:.75; }
  .mit-link.is-open{ color: var(--primary); }
  .mit-box{
    display:none;
    margin-top:6px;
    padding:8px 10px;
    border-radius: 12px;
    border:1px dashed color-mix(in oklab, var(--line) 84%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 92%, transparent);
    font-size:.84rem;
    white-space:pre-wrap;
  }

  /* ---------- Bottom action bar (fixed, screenshot style) ---------- */
  .actionbar{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 18px;
    width: min(980px, calc(100% - 24px));
    z-index: 60;
    display: none; /* JS a√ßacak */
  }
  .actionbar-inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    padding: 16px 18px;
    border-radius: 18px;
    background: #0b1220;
    color: #fff;
    border: 1px solid rgba(148,163,184,.22);
    box-shadow: 0 22px 50px -26px rgba(0,0,0,.6);
  }
  [data-theme="dark"] .actionbar-inner{
    background: #000;
    border-color: rgba(148,163,184,.18);
  }
  .action-left{
    display:flex;
    align-items:center;
    gap: 12px;
    min-width: 0;
  }
  .action-ico{
    width: 44px; height: 44px;
    border-radius: 14px;
    display:grid;
    place-items:center;
    background: var(--primary);
    box-shadow: 0 14px 30px -20px rgba(40,102,189,.85);
    flex: 0 0 auto;
    font-weight: 900;
  }
  .action-meta{ min-width:0 }
  .action-meta h4{
    margin: 0;
    font-size: 1.05rem;
    font-weight: 950;
    letter-spacing: -0.01em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .action-meta p{
    margin: 2px 0 0;
    font-size: .78rem;
    color: rgba(226,232,240,.75);
  }
  .action-right{
    display:flex;
    align-items:center;
    gap: 10px;
    flex-wrap: wrap;
    justify-content:flex-end;
  }
  .btn-clear{
    background: transparent;
    border: 0;
    color: rgba(226,232,240,.78);
    font-weight: 800;
    cursor:pointer;
    padding: .45rem .5rem;
    border-radius: 12px;
  }
  .btn-clear:hover{ color:#fff; background: rgba(255,255,255,.06); }

  /* k√º√ß√ºk ekran */
  @media (max-width: 520px){
    .actionbar-inner{ flex-direction: column; align-items: stretch; }
    .action-right{ width: 100%; }
    .action-right .btn{ width: 100%; justify-content:center; }
  }
</style>

<div class="page card" id="top">
  <h2 class="page-title">Tanƒ±mlƒ± Risklerden Se√ß</h2>
  <p class="page-sub">Kategorilere g√∂re filtreleyin, ≈üablonlarƒ± se√ßin ve yeni risk formunda a√ßƒ±n.</p>

  <!-- Sticky √úst ara√ß √ßubuƒüu -->
  <div class="toolbar noprint" role="region" aria-label="Filtreler">
    <form method="get" action="{{ url_for('risk_identify') }}" class="group" id="filter-form">
      <div>
        <label class="small" for="cat">Kategori</label>
        <select id="cat" name="cat" class="input" style="min-width:220px">
          <option value="__all__" {% if (cat or '__all__') == '__all__' %}selected{% endif %}>‚Äî T√ºm Kategoriler ‚Äî</option>
          <option value="" {% if cat == '' %}selected{% endif %}>Genel / Kategorisiz</option>
          {% for cname in (filter_cat_names or []) %}
            <option value="{{ cname }}" {% if cname == cat %}selected{% endif %}>{{ cname }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="small" for="q">Ara <span class="text-muted">(Ctrl/‚åò+K)</span></label>
        <input id="q" name="q" class="input input-search" value="{{ q or '' }}" placeholder="Metin / kod ara‚Ä¶">
      </div>

      <div>
        <label class="small">&nbsp;</label>
        <button class="btn" type="submit" title="Filtreleri uygula">Uygula</button>
      </div>

      {% if q or (cat and cat != '__all__') %}
      <div>
        <label class="small">&nbsp;</label>
        <a class="btn btn-ghost" href="{{ url_for('risk_identify') }}" title="Filtreleri temizle">Sƒ±fƒ±rla</a>
      </div>
      {% endif %}
    </form>

    <div class="fill"></div>

    <div class="group">
      <a class="btn" href="{{ url_for('categories_index') }}?next=identify" title="Kategorileri y√∂net">Kategori Y√∂netimi</a>
      <a class="btn" href="{{ url_for('import_suggestions') }}" title="CSV / XLSX ile i√ße aktar">CSV/XLSX ƒ∞√ße Aktar</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c,m in messages %}<div class="flash {{c}}">{{m}}</div>{% endfor %}
  {% endwith %}

  {% if not categories or categories|length == 0 %}
    <div class="flash info">
      Hen√ºz tanƒ±mlƒ± risk ≈üablonu yok. √ñnce <a href="{{ url_for('import_suggestions') }}">CSV/XLSX i√ße aktar</a>
      veya <a href="{{ url_for('categories_index') }}?next=identify">Kategori Y√∂netimi</a> √ºzerinden kategorileri tanƒ±mlayƒ±n.
    </div>
  {% endif %}

  <!-- Ana se√ßim formu -->
  <form method="post" id="select-form" action="{{ url_for('risk_identify') }}">
    <!-- action deƒüeri butonlardan geliyor -->
    <input type="hidden" name="selected_json" id="selected_json">
  </form>

  <div class="cat-grid">
    {% for cat, risks in categories.items() %}
      {% set cat_idx = loop.index0 %}
      {% set cat_name = cat or 'Genel / Kategorisiz' %}
      {% set slug = (cat_name|lower|replace(' ', '-')|replace('/', '-')|replace('.', '-') ) %}
      {% set cn = (cat_name|lower) %}

      <section class="cat-card" id="cat-{{ slug }}" aria-label="{{ cat_name }}">
        <div class="cat-head">
          <div class="cat-left">
            <!-- ‚úÖ ICON -->
            <span class="cat-ico" aria-hidden="true">
              {% if 'ula≈ü' in cn or 'ulas' in cn %}
                <!-- Bus -->
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M6 16V7a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M7 16h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M8 20a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM16 20a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" fill="currentColor"/>
                  <path d="M7 10h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              {% elif '√ßevre' in cn or 'cevre' in cn or 'eko' in cn %}
                <!-- Leaf -->
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M20 4s-7 1-11 5-5 11-5 11 7-1 11-5 5-11 5-11Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M9 15c2-2 6-6 11-11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              {% elif 'g√ºven' in cn or 'guven' in cn or 'i≈ü' in cn or 'is ' in cn %}
                <!-- Shield -->
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 3 20 7v6c0 5-3.5 8-8 9-4.5-1-8-4-8-9V7l8-4Z"
                        stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M9 12l2 2 4-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              {% elif 'finans' in cn or 'mali' in cn %}
                <!-- Coin -->
                <svg viewBox="0 0 24 24" fill="none">
                  <ellipse cx="12" cy="8" rx="7" ry="3" stroke="currentColor" stroke-width="2"/>
                  <path d="M5 8v8c0 1.7 3.1 3 7 3s7-1.3 7-3V8" stroke="currentColor" stroke-width="2"/>
                </svg>
              {% elif 'kalite' in cn or 'quality' in cn %}
                <!-- Star -->
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="m12 3 2.6 6.2 6.7.6-5.1 4.4 1.6 6.5L12 17.8 6.2 20.7l1.6-6.5L2.7 9.8l6.7-.6L12 3Z"
                        stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                </svg>
              {% else %}
                <!-- Default dot -->
                <svg viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="5" fill="currentColor"/>
                </svg>
              {% endif %}
            </span>

            <h3>{{ cat_name }}</h3>
            <span class="cat-count" id="count-{{ cat_idx }}">0 se√ßili</span>
          </div>

          <div class="small" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
            <span class="chip">{{ risks|length }} kayƒ±t</span>
            <a class="btn btn-ghost" href="#top" title="Sayfa ba≈üƒ±na d√∂n">‚Üë</a>
          </div>
        </div>

        {% if session.get('role') == 'admin' %}
        <details style="margin: 2px 0 12px;">
          <summary class="small" style="cursor:pointer; user-select:none;">‚ûï Bu kategoriye yeni madde ekle</summary>
          <form method="post" action="{{ url_for('admin_suggestion_create') }}" class="grid grid-2" style="margin-top:.6rem;">
            <input type="hidden" name="category" value="{{ cat_name }}">
            <div style="grid-column:1/-1">
              <label>
                Risk Metni
                <span class="small text-muted">(kƒ±sa ve net yazƒ±n; √ßok uzun metinler kaydedilmeyebilir)</span>
              </label>
              <textarea class="input" name="text" rows="2" required placeholder="Risk c√ºmlesi..."></textarea>
            </div>

            <div style="grid-column:1/-1">
              <label>Risk Fakt√∂r√º (a√ßƒ±klama)</label>
              <textarea class="input" name="risk_desc" rows="2"
                        placeholder="Jeoteknik, batimetrik veya √ßevresel verilerin eksik/yanlƒ±≈ü olmasƒ± sonucu tasarƒ±m parametrelerinin hatalƒ± belirlenmesi gibi..."></textarea>
            </div>

            <div style="grid-column:1/-1">
              <label>√ñnerilen √ñnlemler (opsiyonel)</label>
              <textarea class="input" name="mitigation_hint" rows="2"
                        placeholder="√ñnerilen √∂nlemleri yazabilirsiniz (i≈ü paketleri, RFI s√ºresi, KPI‚Äôlar vb.)"></textarea>
            </div>

            <div>
              <label>Risk Kodu
                <span class="small text-muted">(ilk 3 harf, son 2 rakam ¬∑ √∂rn: UYR02)</span>
              </label>
              <input class="input"
                     name="risk_code"
                     placeholder="√∂rn: UYR02"
                     pattern="[A-Za-z]{3}[0-9]{2}"
                     title="ƒ∞lk 3 karakter harf, son 2 karakter rakam olmalƒ±. √ñrn: UYR02">
            </div>

            <div>
              <label>Vars. Olasƒ±lƒ±k (1‚Äì5)</label>
              <input class="input" type="number" name="default_prob" min="1" max="5" placeholder="‚Äî">
            </div>

            <div>
              <label>Vars. ≈ûiddet (1‚Äì5)</label>
              <input class="input" type="number" name="default_sev" min="1" max="5" placeholder="‚Äî">
            </div>

            <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:.5rem;">
              <button class="btn btn-primary" type="submit">Ekle</button>
            </div>
          </form>
        </details>
        {% endif %}

        <div class="bulk-row">
          <label class="small" style="display:flex; align-items:center; gap:.55rem;">
            <input type="checkbox" class="toggle-all" data-group="{{ cat_idx }}">
            <strong>T√ºm√ºn√º se√ß / kaldƒ±r</strong>
          </label>

          <div class="right small">
            <button type="button" class="btn btn-ghost btn-collapse" data-target="#cat-{{ slug }}" title="Kategori tablosunu daralt/a√ß">Daralt ‚ñº</button>
          </div>
        </div>

        <div class="table-wrap" data-collapsible>
          <table class="table-select">
            <thead>
              <tr>
                <th>Se√ß</th>
                <th>Risk</th>
                <th>Risk Fakt√∂r√º</th>
                <th>Risk Kodu</th>
                <th>Vars. Olasƒ±lƒ±k</th>
                <th>Vars. ≈ûiddet</th>
                <th>ƒ∞≈ülem</th>
              </tr>
            </thead>

            <tbody>
            {% for s in risks %}
              {% set row_idx = loop.index0 %}
              {% set cb_id = 'sel-' ~ cat_idx ~ '-' ~ row_idx %}

              <tr>
                <td>
                  <input
                    id="{{ cb_id }}"
                    type="checkbox"
                    name="selected"
                    value="{{ s.id }}"
                    class="chk chk-{{ cat_idx }}"
                    data-group="{{ cat_idx }}"
                    aria-labelledby="lbl-{{ cb_id }}"
                    form="select-form"
                  >
                </td>

                <td>
                  <label class="risk-label" id="lbl-{{ cb_id }}" for="{{ cb_id }}" style="cursor:pointer;">
                    <div class="risk-inline">
                      <span class="risk-title">
                        {{ s.risk_title or s.text }}
                      </span>

                      <a href="{{ url_for('risk_template_detail', sid=s.id) }}"
                         class="btn-icon btn-mini"
                         title="Risk detayƒ±nƒ± g√∂r√ºnt√ºle"
                         aria-label="Risk detayƒ±nƒ± g√∂r√ºnt√ºle">
                        üîç
                      </a>
                    </div>
                  </label>
                </td>

                <td class="small">
                  <span class="chip" title="Risk fakt√∂r√º / a√ßƒ±klama">
                    {{ (s.risk_desc or '‚Äî')[:60] }}{% if (s.risk_desc or '')|length > 60 %}‚Ä¶{% endif %}
                  </span>

                  {% if s.risk_desc and (s.risk_desc|length > 60) %}
                    <div style="margin-top:6px; color: color-mix(in oklab, var(--muted) 92%, transparent);">
                      {{ s.risk_desc }}
                    </div>
                  {% endif %}

                  {% if s.mitigation_hint %}
                    <a href="#" class="mit-link" data-target="mit-{{ s.id }}">√ñnerilen √∂nlemleri g√∂ster</a>
                    <div id="mit-{{ s.id }}" class="mit-box">{{ s.mitigation_hint }}</div>
                  {% endif %}
                </td>

                <td style="text-align:center;">
                  <span class="code-badge" data-copy="{{ s.risk_code or '' }}">
                    {{ s.risk_code or '‚Äî' }}
                  </span>
                </td>

                <td style="text-align:center;">
                  <span class="chip">{{ s.default_prob if s.default_prob is not none else '‚Äî' }}/5</span>
                </td>

                <td style="text-align:center;">
                  <span class="chip">{{ s.default_sev if s.default_sev is not none else '‚Äî' }}/5</span>
                </td>

                <td>
                  <div class="row-actions">
                    {% if session.get('role') == 'admin' %}
                      <button class="btn btn-edit" type="button" data-sid="{{ s.id }}">D√ºzenle</button>
                      <form method="post"
                            action="{{ url_for('admin_suggestion_delete', sid=s.id) }}"
                            onsubmit="return confirm('Bu ≈üablonu silmek istediƒüinize emin misiniz?');">
                        <button class="btn btn-danger" type="submit">Sil</button>
                      </form>
                    {% else %}
                      <span class="small" style="opacity:.75;">(d√ºzenleme i√ßin admin)</span>
                    {% endif %}
                  </div>
                </td>
              </tr>

              {% if session.get('role') == 'admin' %}
              <tr id="editrow-{{ s.id }}" class="edit-row" hidden>
                <td colspan="7">
                  <div class="inline-edit">
                    <form method="post" action="{{ url_for('admin_suggestion_update', sid=s.id) }}" class="grid grid-2">
                      <div style="grid-column:1/-1">
                        <label>
                          Risk Metni
                          <span class="small text-muted">(kƒ±sa ve net tutun; gereksiz uzun metinler reddedilebilir)</span>
                        </label>
                        <textarea class="input" name="text" rows="2" required>{{ s.text }}</textarea>
                      </div>

                      <div style="grid-column:1/-1">
                        <label>Risk Fakt√∂r√º (a√ßƒ±klama)</label>
                        <textarea class="input" name="risk_desc" rows="2">{{ s.risk_desc or '' }}</textarea>
                      </div>

                      <div style="grid-column:1/-1">
                        <label>√ñnerilen √ñnlemler (opsiyonel)</label>
                        <textarea class="input" name="mitigation_hint" rows="2">{{ s.mitigation_hint or '' }}</textarea>
                      </div>

                      <div>
                        <label>Kategori</label>
                        <input class="input" name="category" value="{{ s.category or '' }}">
                      </div>

                      <div>
                        <label>
                          Risk Kodu
                          <span class="small text-muted">(ilk 3 harf, son 2 rakam ¬∑ √∂rn: UYR02)</span>
                        </label>
                        <input class="input"
                               name="risk_code"
                               value="{{ s.risk_code or '' }}"
                               pattern="[A-Za-z]{3}[0-9]{2}"
                               title="ƒ∞lk 3 karakter harf, son 2 karakter rakam olmalƒ±. √ñrn: UYR02">
                      </div>

                      <div>
                        <label>Varsayƒ±lan Olasƒ±lƒ±k (1‚Äì5)</label>
                        <input class="input" name="default_prob" type="number" min="1" max="5" value="{{ s.default_prob or '' }}">
                      </div>

                      <div>
                        <label>Varsayƒ±lan ≈ûiddet (1‚Äì5)</label>
                        <input class="input" name="default_sev" type="number" min="1" max="5" value="{{ s.default_sev or '' }}">
                      </div>

                      <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end">
                        <button class="btn btn-primary" type="submit">Kaydet</button>
                        <button class="btn btn-ghost btn-cancel-edit" type="button" data-sid="{{ s.id }}">ƒ∞ptal</button>
                      </div>
                    </form>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    {% endfor %}
  </div>

  <div class="totalinfo">
    Toplam kayƒ±t: {{ total }}{% if pages and pages > 1 %} ‚Ä¢ Sayfa {{ page }}/{{ pages }}{% endif %}
  </div>

  <div class="pager noprint">
    <a class="btn" aria-disabled="{{ 'true' if page <= 1 else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=1) }}">¬´ ƒ∞lk</a>
    <a class="btn" aria-disabled="{{ 'true' if page <= 1 else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=(page - 1 if page > 1 else 1)) }}">‚Äπ √ñnceki</a>
    <a class="btn" aria-disabled="{{ 'true' if page >= pages else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=(page + 1 if page < pages else pages)) }}">Sonraki ‚Ä∫</a>
    <a class="btn" aria-disabled="{{ 'true' if page >= pages else 'false' }}"
       href="{{ url_for('risk_identify', q=(q or None), cat=(cat or None), page=pages) }}">Son ¬ª</a>
  </div>
</div>

<!-- Fixed bottom action bar (se√ßim olunca g√∂r√ºn√ºr) -->
<div class="actionbar noprint" id="actionbar">
  <div class="actionbar-inner">
    <div class="action-left">
      <div class="action-ico">‚úì</div>
      <div class="action-meta">
        <h4><span id="selCounter">0</span> Risk Se√ßildi</h4>
        <p>Se√ßili ≈üablonlar yeni risk formuna ta≈üƒ±nacak.</p>
      </div>
    </div>

    <div class="action-right">
      <button type="button" class="btn-clear" id="clearSelection">Se√ßimi Temizle</button>

      <button type="submit" class="btn btn-primary"
              form="select-form" name="action" value="pick_for_new"
              title="Se√ßili ≈üablonlarƒ± yeni risk formuna ta≈üƒ±">
        Yeni Risk Formunda A√ß ‚Üí
      </button>
    </div>
  </div>
</div>

<script>
  // --- yardƒ±mcƒ±lar ---
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const $  = (sel, ctx=document) => ctx.querySelector(sel);

  function updateCount(groupIdx){
    const sel = $$('.chk-' + groupIdx).filter(b => b.checked).length;
    const el = $('#count-' + groupIdx);
    if (el) el.textContent = sel + ' se√ßili';
  }

  // global saya√ß + action bar
  const bar = $('#actionbar');
  const counterNum = $('#selCounter');

  function updateGlobalCount(){
    const total = $$('input[type="checkbox"][name="selected"]:checked').length;
    if(counterNum) counterNum.textContent = String(total);
    if(bar) bar.style.display = total > 0 ? 'block' : 'none';
  }

  // toplu se√ß / kaldƒ±r
  $$('.toggle-all').forEach(tg => {
    tg.addEventListener('change', () => {
      const g = tg.getAttribute('data-group');
      $$('.chk-' + g).forEach(c => c.checked = tg.checked);
      updateCount(g); updateGlobalCount();
    });
    updateCount(tg.getAttribute('data-group'));
  });

  // tek tek deƒüi≈ütik√ße saya√ßlar
  $$('input[type="checkbox"][name="selected"]').forEach(c => {
    c.classList.add('chk');
    c.addEventListener('change', () => {
      const g = c.getAttribute('data-group');
      updateCount(g); updateGlobalCount();
    });
  });
  updateGlobalCount();

  // se√ßimi temizle
  const clearBtn = $('#clearSelection');
  if (clearBtn){
    clearBtn.addEventListener('click', () => {
      $$('input[type="checkbox"][name="selected"]:checked').forEach(c => c.checked = false);
      $$('.toggle-all').forEach(tg => tg.checked = false);
      $$('.toggle-all').forEach(tg => updateCount(tg.getAttribute('data-group')));
      updateGlobalCount();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  // inline edit a√ß/kapat
  document.addEventListener('click', (e) => {
    const editBtn = e.target.closest('.btn-edit');
    if (editBtn){
      const sid = editBtn.getAttribute('data-sid');
      const row = $('#editrow-' + sid);
      if (row) row.toggleAttribute('hidden');
      return;
    }
    const cancelBtn = e.target.closest('.btn-cancel-edit');
    if (cancelBtn){
      const sid2 = cancelBtn.getAttribute('data-sid');
      const row2 = $('#editrow-' + sid2);
      if (row2) row2.setAttribute('hidden','');
      return;
    }
  });

  // se√ßili ID'leri JSON olarak g√∂nder
  (function(){
    const form = $('#select-form'); if (!form) return;
    form.addEventListener('submit', function(){
      const ids = $$('input[type="checkbox"][name="selected"]:checked')
        .map(el => parseInt(el.value, 10)).filter(v => !isNaN(v));
      const hidden = $('#selected_json'); if (hidden) hidden.value = JSON.stringify(ids);
      $$('input[type="checkbox"][name="selected"]').forEach(el => el.disabled = true);
    });
  })();

  // risk kodu rozetine tƒ±kla ‚Üí kopyala
  document.addEventListener('click', async (e) => {
    const badge = e.target.closest('.code-badge'); if (!badge) return;
    const code = badge.getAttribute('data-copy') || badge.textContent.trim();
    if (!code || code === '‚Äî') return;
    try {
      await navigator.clipboard.writeText(code);
      const old = badge.style.outline;
      badge.style.outline = '2px solid currentColor';
      setTimeout(()=>badge.style.outline = old, 700);
    } catch {}
  });

  // kategori panelini daralt/a√ß
  $$('.btn-collapse').forEach(btn => {
    const sel = btn.getAttribute('data-target');
    const box = document.querySelector(sel + ' .table-wrap');
    function setLabel(){
      const collapsed = box && box.style.display === 'none';
      btn.textContent = collapsed ? 'Geni≈ület ‚ñ≤' : 'Daralt ‚ñº';
    }
    btn.addEventListener('click', () => {
      if (!box) return;
      box.style.display = (box.style.display === 'none') ? '' : 'none';
      setLabel();
    });
    setLabel();
  });

  // Ctrl/‚åò + K ‚Üí aramaya odak
  document.addEventListener('keydown', (e) => {
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    if ((isMac && e.metaKey && e.key.toLowerCase()==='k') || (!isMac && e.ctrlKey && e.key.toLowerCase()==='k')){
      e.preventDefault();
      const q = $('#q');
      if (q){ q.focus(); q.select(); }
    }
  });

  // aramada debounce + Enter
  (function(){
    const q = $('#q'); const form = $('#filter-form'); if(!q || !form) return;
    let t=null;
    q.addEventListener('input', ()=>{ if(t) clearTimeout(t); t = setTimeout(()=> form.requestSubmit(), 500); });
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); form.requestSubmit(); } });
  })();

  // √ñnerilen √∂nlemler linki ‚Üí kutu a√ß/kapa
  document.addEventListener('click', (e) => {
    const link = e.target.closest('.mit-link');
    if (!link) return;
    e.preventDefault();
    const targetId = link.dataset.target;
    const box = document.getElementById(targetId);
    if (!box) return;

    const isOpen = box.style.display === 'block';
    box.style.display = isOpen ? 'none' : 'block';
    link.classList.toggle('is-open', !isOpen);
    link.textContent = isOpen ? '√ñnerilen √∂nlemleri g√∂ster' : '√ñnerilen √∂nlemleri gizle';
  });
</script>
{% endblock %}
