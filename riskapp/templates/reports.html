{% extends "base.html" %}
{% block title %}Raporlar · Risk Yönetim{% endblock %}
{% block content %}

<style>
  /* =========================
     Reports UI (page-scoped)
     ========================= */
  .rp-wrap{ display:flex; flex-direction:column; gap:18px; }

  .rp-top{
    display:flex; align-items:flex-end; justify-content:space-between;
    gap:12px; flex-wrap:wrap;
  }
  .rp-breadcrumb{
    display:flex; align-items:center; gap:8px;
    font-size:.78rem;
    color: var(--text-dim);
    font-weight:700;
  }
  .rp-breadcrumb .sep{ opacity:.6; }
  .rp-title{
    margin:4px 0 0;
    font-size: 2rem;
    font-weight: 950;
    letter-spacing: -.02em;
    line-height: 1.15;
  }
  .rp-actions{ display:flex; gap:10px; flex-wrap:wrap; }

  .rp-btn{
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.62rem .9rem;
    border-radius: 12px;
    border:1px solid var(--line);
    background: color-mix(in oklab, var(--card) 92%, transparent);
    color: var(--text);
    font-weight:900;
    text-decoration:none;
    line-height:1;
    transition: filter .15s ease, transform .08s ease;
  }
  .rp-btn:hover{ filter:brightness(1.03); }
  .rp-btn:active{ transform: translateY(1px); }

  /* KPI grid */
  .rp-kpis{
    display:grid; gap:12px;
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
  @media (max-width: 980px){ .rp-kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 560px){ .rp-kpis{ grid-template-columns: 1fr; } }

  .rp-kpi{
    border:1px solid var(--line);
    background: color-mix(in oklab, var(--card) 96%, transparent);
    border-radius: 16px;
    padding: 14px 14px;
    box-shadow: 0 10px 24px -18px rgba(0,0,0,.22);
  }
  .rp-kpi .label{
    font-size:.72rem;
    text-transform:uppercase;
    letter-spacing:.12em;
    font-weight:900;
    color: var(--text-dim);
  }
  .rp-kpi .val{
    margin-top:8px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:950;
    font-size: 1.6rem;
    letter-spacing: -.02em;
  }
  .rp-chip{
    font-size: .72rem;
    font-weight: 900;
    padding: .18rem .55rem;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: color-mix(in oklab, var(--card) 92%, transparent);
    color: var(--text);
    white-space:nowrap;
  }
  .rp-chip.ok{
    border-color: rgba(34,197,94,.28);
    background: rgba(34,197,94,.14);
    color: color-mix(in oklab, #22c55e 78%, var(--text));
  }
  .rp-chip.bad{
    border-color: rgba(239,68,68,.28);
    background: rgba(239,68,68,.14);
    color: color-mix(in oklab, #ef4444 78%, var(--text));
  }
  [data-theme="dark"] .rp-chip.ok,
  [data-theme="dark"] .rp-chip.bad{ color: rgba(255,255,255,.92); }

  /* Table shell */
  .rp-table-card{
    border:1px solid var(--line);
    background: color-mix(in oklab, var(--card) 96%, transparent);
    border-radius: 18px;
    overflow:hidden;
    box-shadow: 0 16px 36px -26px rgba(0,0,0,.35);
    position: relative;
    z-index: 1;
  }
  .rp-table-toolbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
    padding: 12px 14px;
    border-bottom:1px solid var(--line);
    background: color-mix(in oklab, var(--bg-soft) 90%, transparent);
  }
  [data-theme="dark"] .rp-table-toolbar{
    background: color-mix(in oklab, var(--card-solid) 86%, transparent);
  }

  .rp-search{
    position:relative;
    min-width: 260px;
    flex: 1;
    max-width: 520px;
  }
  .rp-search input{
    width:100%;
    padding:.68rem .85rem .68rem 2.2rem;
    border-radius: 12px;
    border:1px solid var(--line);
    background: color-mix(in oklab, var(--card) 95%, transparent);
    color: var(--text);
    outline:none;
    font-weight:700;
  }
  .rp-search .icon{
    position:absolute; left:12px; top:50%;
    transform: translateY(-50%);
    opacity:.55;
    font-size: 18px;
  }

  /* ✅✅ Bootstrap .table WHITE BG override (dark mode dahil) */
  .rp-table-card .table{
    margin:0;
    min-width: 760px;
    color: var(--text);
    background: transparent !important;
  }
  .rp-table-card .table > :not(caption) > * > *{
    background: transparent !important;
    color: inherit;
  }
  .rp-table-card .table thead th{
    background: color-mix(in oklab, var(--bg-soft) 92%, transparent) !important;
  }
  [data-theme="dark"] .rp-table-card .table thead th{
    background: color-mix(in oklab, var(--card-solid) 86%, transparent) !important;
  }
  .rp-table-card .table tbody tr:hover > *{
    background: color-mix(in oklab, var(--primary) 6%, transparent) !important;
  }

  /* Risk cell */
  .rp-risk{ display:flex; flex-direction:column; gap:4px; }
  .rp-risk .name{ font-weight:950; letter-spacing:-.01em; }
  .rp-risk .id{
    font-size:.74rem;
    letter-spacing:.08em;
    text-transform:uppercase;
    color: var(--text-dim);
    font-weight:800;
  }

  /* Category pill */
  .rp-pill{
    display:inline-flex; align-items:center;
    padding:.25rem .55rem;
    border-radius: 999px;
    border:1px solid var(--line);
    font-size:.78rem;
    font-weight:900;
    background: color-mix(in oklab, var(--card) 92%, transparent);
    color: var(--text);
    white-space:nowrap;
  }
  .rp-pill.op{ border-color: rgba(59,130,246,.28); background: rgba(59,130,246,.12); }
  .rp-pill.fin{ border-color: rgba(245,158,11,.30); background: rgba(245,158,11,.14); }
  .rp-pill.leg{ border-color: rgba(99,102,241,.28); background: rgba(99,102,241,.12); }
  .rp-pill.str{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.12); }
  [data-theme="dark"] .rp-pill{ color: rgba(255,255,255,.92); }

  /* Score badge */
  .rp-score{
    width:34px; height:34px;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:999px;
    background: var(--primary);
    color:#fff;
    font-weight:950;
    font-size:.82rem;
    box-shadow: 0 12px 22px -16px color-mix(in oklab, var(--primary) 55%, transparent);
  }

  /* Costs */
  .rp-costs{ display:flex; flex-wrap:wrap; gap:.35rem; }
  .rp-cost{
    display:inline-flex; align-items:center;
    padding:.22rem .55rem;
    border-radius: 10px;
    border:1px solid var(--line);
    background: color-mix(in oklab, var(--card) 92%, transparent);
    font-size:.74rem;
    font-weight:900;
    color: var(--text-dim);
    white-space:nowrap;
  }
  [data-theme="dark"] .rp-cost{
    color: rgba(255,255,255,.72);
    background: color-mix(in oklab, var(--card-solid) 82%, transparent);
  }

  .rp-muted{ color: var(--text-dim); font-weight:700; }

  /* Footer/pagination bar */
  .rp-foot{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
    padding: 12px 14px;
    border-top:1px solid var(--line);
    background: color-mix(in oklab, var(--bg-soft) 90%, transparent);
  }
  [data-theme="dark"] .rp-foot{
    background: color-mix(in oklab, var(--card-solid) 86%, transparent);
  }

  .rp-pages{ display:flex; gap:6px; align-items:center; }
  .rp-page{
    width:34px; height:34px;
    display:grid; place-items:center;
    border-radius: 10px;
    border:1px solid var(--line);
    background: color-mix(in oklab, var(--card) 92%, transparent);
    color: var(--text);
    font-weight:900;
    text-decoration:none;
  }
  .rp-page.active{
    background: var(--primary);
    border-color: transparent;
    color:#fff;
  }

  /* Bootstrap modal dark safety */
  [data-theme="dark"] .modal-content{
    background: var(--card-solid);
    color: var(--text);
    border-color: rgba(148,163,184,.22);
  }
  [data-theme="dark"] .modal-header,
  [data-theme="dark"] .modal-footer{
    border-color: rgba(148,163,184,.16);
  }

  /* ✅✅ Modal "altta kalıyor" FIX (z-index + scroll) */
  .modal{ z-index: 20050 !important; }
  .modal-backdrop{ z-index: 20040 !important; }
  .rp-wrap{ position: relative; z-index: 1; }
  .modal-body{ max-height: calc(100vh - 220px); overflow: auto; }
</style>

{# -----------------------------
   Query param okuma
   ----------------------------- #}
{% set q = request.args.get('q','') %}
{% set f_category = request.args.get('category','') %}
{% set f_min_score = request.args.get('min_score','') %}
{% set f_currency = request.args.get('currency','') %}

{# -----------------------------
   KPI hesapları
   ----------------------------- #}
{% set _kritik = 0 %}
{% set _try = 0 %}
{% set _usd = 0 %}
{% set _other_cur_count = 0 %}

{% for r in risks %}
  {% set _sc = r.score() %}
  {% if _sc and (_sc is number) and _sc >= 80 %}
    {% set _kritik = _kritik + 1 %}
  {% endif %}

  {% set totals = (cost_map.get(r.id, []) if cost_map is defined else []) %}
  {% if totals and totals|length > 0 %}
    {% for cur, total in totals %}
      {% set _c = (cur or 'TRY')|upper %}
      {% set _t = (total or 0) %}
      {% if _c == 'TRY' %}
        {% set _try = _try + _t %}
      {% elif _c == 'USD' %}
        {% set _usd = _usd + _t %}
      {% else %}
        {% set _other_cur_count = _other_cur_count + 1 %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

{% macro compact(n) -%}
  {%- set x = (n or 0) -%}
  {%- if x >= 1000000 -%}
    {{ '%.1f'|format(x / 1000000) }}M
  {%- elif x >= 1000 -%}
    {{ '%.0f'|format(x / 1000) }}K
  {%- else -%}
    {{ '%.0f'|format(x) }}
  {%- endif -%}
{%- endmacro %}

{# Pagination (backend varsa kullan, yoksa fallback) #}
{% set page = (page if page is defined else (request.args.get('page', 1)|int)) %}
{% set per_page = (per_page if per_page is defined else (request.args.get('per_page', 20)|int)) %}
{% set total_count = (total_count if total_count is defined else (risks|length if risks is defined else 0)) %}
{% set pages = (pages if pages is defined else ((total_count + per_page - 1) // per_page)) %}
{% set showing_from = (showing_from if showing_from is defined else ((page - 1) * per_page + 1 if total_count > 0 else 0)) %}
{% set showing_to = (showing_to if showing_to is defined else ([page * per_page, total_count] | min)) %}

{# URL builder: mevcut args + update #}
{% set _args = request.args.to_dict(flat=True) %}
{% macro page_url(p) -%}
  {%- set d = _args.copy() -%}
  {%- set _ = d.update({'page': p}) -%}
  {{ url_for(request.endpoint, **d) }}
{%- endmacro %}

{# ✅ Dışa Aktar: endpoint varsa bağla (query'leri de gönder) #}
{% set _export_ep = None %}
{% if current_app is defined and current_app.view_functions is defined %}
  {% if 'reports_export_xlsx' in current_app.view_functions %}
    {% set _export_ep = 'reports_export_xlsx' %}
  {% elif 'risks_export_xlsx' in current_app.view_functions %}
    {% set _export_ep = 'risks_export_xlsx' %}
  {% endif %}
{% endif %}
{% set export_url = (url_for(_export_ep, **_args) if _export_ep else '#') %}

<div class="rp-wrap">

  <!-- Top -->
  <div class="rp-top">
    <div>
      <div class="rp-breadcrumb">
        <span>Portal</span><span class="sep">/</span><span style="color:var(--primary)">Raporlar</span>
      </div>
      <h1 class="rp-title">Raporlar</h1>
    </div>

    <div class="rp-actions">
      <button class="rp-btn" type="button" data-bs-toggle="modal" data-bs-target="#filterModal">
        <span class="material-icons-outlined" style="font-size:18px;">filter_list</span>
        Filtrele
      </button>

      <a class="rp-btn"
         href="{{ export_url }}"
         role="button"
         {% if export_url == '#' %}aria-disabled="true" style="opacity:.65; cursor:not-allowed"{% endif %}>
        <span class="material-icons-outlined" style="font-size:18px;">file_download</span>
        Dışa Aktar
      </a>
    </div>
  </div>

  <!-- KPI -->
  <div class="rp-kpis">
    <div class="rp-kpi">
      <div class="label">Aktif Riskler</div>
      <div class="val">
        <span>{{ total_count }}</span>
        <span class="rp-chip ok">+4%</span>
      </div>
    </div>

    <div class="rp-kpi">
      <div class="label">Kritik Skorlar</div>
      <div class="val">
        <span>{{ _kritik }}</span>
        <span class="rp-chip bad">+2</span>
      </div>
    </div>

    <div class="rp-kpi">
      <div class="label">Toplam TRY Etki</div>
      <div class="val">
        <span>{{ compact(_try) }}</span>
        <span class="material-icons-outlined" style="opacity:.45;">trending_up</span>
      </div>
    </div>

    <div class="rp-kpi">
      <div class="label">Toplam USD Etki</div>
      <div class="val">
        <span>{{ compact(_usd) }}</span>
        <span class="material-icons-outlined" style="opacity:.45;">account_balance_wallet</span>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="rp-table-card">
    <div class="rp-table-toolbar">
      <form class="rp-search" method="get" action="{{ url_for(request.endpoint) }}">
        {% for k,v in _args.items() %}
          {% if k not in ['q','page'] %}
            <input type="hidden" name="{{k}}" value="{{v}}">
          {% endif %}
        {% endfor %}
        <span class="material-icons-outlined icon">search</span>
        <input
          id="rpQ"
          name="q"
          type="text"
          value="{{ q }}"
          placeholder="Raporlarda ara..."
          oninput="window.__rpFilter?.(this.value)"
        />
      </form>

      <div style="display:flex; gap:8px; align-items:center;">
        {% if _other_cur_count > 0 %}
          <span class="rp-muted" style="font-size:.86rem;">+{{ _other_cur_count }} diğer para birimi</span>
        {% endif %}
        <span class="rp-muted" style="font-size:.86rem;">{{ total_count }} kayıt</span>
      </div>
    </div>

    <div class="table-wrap" style="border-radius:0;">
      <table class="table" id="rpTable">
        <thead>
          <tr>
            <th>Risk</th>
            <th>Kategori</th>
            <th style="width:110px; text-align:center;">Skor (RPN)</th>
            <th style="width:300px;">Maliyet</th>
            <th style="width:140px; text-align:right;">İşlem</th>
          </tr>
        </thead>

        <tbody>
          {% for r in risks %}
          {% set sc = r.score() %}
          {% set cat = (r.category or '-') %}
          {% set cat_l = (cat|string|lower) %}
          {% set cat_class = (
              'op' if ('operasyon' in cat_l) else
              'fin' if ('finans' in cat_l) else
              'leg' if ('yasal' in cat_l or 'uyum' in cat_l or 'kvkk' in cat_l) else
              'str' if ('stratej' in cat_l) else
              ''
          ) %}

          <tr data-filter="{{ (r.title ~ ' ' ~ cat ~ ' ' ~ (r.id|string))|lower }}">
            <td>
              <div class="rp-risk">
                <div class="name">{{ r.title }}</div>
                <div class="id">ID-{{ r.id }}</div>
              </div>
            </td>

            <td>
              <span class="rp-pill {{cat_class}}">{{ cat }}</span>
            </td>

            <td style="text-align:center;">
              {% if sc %}
                <span class="rp-score">
                  {% if sc is number %}{{ '%.0f'|format(sc) }}{% else %}{{ sc }}{% endif %}
                </span>
              {% else %}
                <span class="rp-muted">—</span>
              {% endif %}
            </td>

            <td>
              {% set totals = (cost_map.get(r.id, []) if cost_map is defined else []) %}
              {% if totals and totals|length > 0 %}
                <div class="rp-costs">
                  {% for cur, total in totals %}
                    <span class="rp-cost">{{ (cur or "TRY")|upper }} {{ "%.2f"|format(total or 0) }}</span>
                  {% endfor %}
                </div>
              {% else %}
                <span class="rp-muted">—</span>
              {% endif %}
            </td>

            <td style="text-align:right;">
              <a class="btn" href="{{ url_for('report_view', risk_id=r.id) }}">Görüntüle</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="rp-foot">
      <span class="rp-muted" style="font-size:.86rem;">
        {% if total_count > 0 %}
          Toplam {{ total_count }} kayıttan {{ showing_from }}-{{ showing_to }} arası gösteriliyor
        {% else %}
          Kayıt bulunamadı
        {% endif %}
      </span>

      <div class="rp-pages" aria-label="Sayfalama">
        {% if pages > 1 %}
          <a class="rp-page" href="{{ page_url(1) }}" aria-label="İlk">«</a>
          <a class="rp-page" href="{{ page_url(page-1 if page>1 else 1) }}" aria-label="Önceki">‹</a>

          {% set start = (page - 2 if page - 2 > 1 else 1) %}
          {% set end = (page + 2 if page + 2 < pages else pages) %}

          {% for p in range(start, end+1) %}
            <a class="rp-page {{ 'active' if p==page }}" href="{{ page_url(p) }}">{{ p }}</a>
          {% endfor %}

          <a class="rp-page" href="{{ page_url(page+1 if page<pages else pages) }}" aria-label="Sonraki">›</a>
          <a class="rp-page" href="{{ page_url(pages) }}" aria-label="Son">»</a>
        {% else %}
          <span class="rp-muted" style="font-size:.86rem;">Sayfa 1 / 1</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- =========================
     Filter Modal (Bootstrap)
     ========================= -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="filterForm" class="modal-content" method="get" action="{{ url_for(request.endpoint) }}">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:950; letter-spacing:-.02em;">Filtrele</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
        <div>
          <label>Arama</label>
          <input class="input" name="q" value="{{ q }}" placeholder="Risk adı, kategori, ID...">
        </div>

        <div>
          <label>Kategori</label>
          <select class="input" name="category">
            <option value="">Tümü</option>
            <option value="Operasyonel" {{ 'selected' if f_category=='Operasyonel' }}>Operasyonel</option>
            <option value="Finansal" {{ 'selected' if f_category=='Finansal' }}>Finansal</option>
            <option value="Yasal" {{ 'selected' if f_category=='Yasal' }}>Yasal</option>
            <option value="Stratejik" {{ 'selected' if f_category=='Stratejik' }}>Stratejik</option>
          </select>
        </div>

        <div>
          <label>Minimum Skor (RPN)</label>
          <input class="input" type="number" name="min_score" value="{{ f_min_score }}" min="0" step="1" placeholder="örn: 80">
        </div>

        <div>
          <label>Para Birimi</label>
          <select class="input" name="currency">
            <option value="">Hepsi</option>
            <option value="TRY" {{ 'selected' if f_currency|upper=='TRY' }}>TRY</option>
            <option value="USD" {{ 'selected' if f_currency|upper=='USD' }}>USD</option>
            <option value="EUR" {{ 'selected' if f_currency|upper=='EUR' }}>EUR</option>
          </select>
        </div>

        <input type="hidden" name="page" value="1">
        <input type="hidden" name="per_page" value="{{ per_page }}">
      </div>

      <div class="modal-footer">
        <a class="btn" href="{{ url_for(request.endpoint) }}">Sıfırla</a>
        <button type="submit" class="btn btn-primary">Uygula</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  // Client-side hızlı filtre
  window.__rpFilter = function(q){
    q = (q || '').toLowerCase().trim();
    const rows = document.querySelectorAll('#rpTable tbody tr');
    rows.forEach(tr => {
      const hay = (tr.getAttribute('data-filter') || '');
      tr.style.display = (!q || hay.includes(q)) ? '' : 'none';
    });
  };

  const initQ = (document.getElementById('rpQ')?.value || '').trim();
  if (initQ) window.__rpFilter(initQ);

  // ✅ Modal z-index garanti (bazı layoutlarda header/sidebar çok yüksek z-index basıyor)
  document.addEventListener('shown.bs.modal', function(e){
    const bd = document.querySelector('.modal-backdrop');
    if (bd) bd.style.zIndex = '20040';
    e.target.style.zIndex = '20050';
  });

  // ✅ Filtre "Uygula" -> modal kapanıp submit olsun (takılı kalmasın)
  const form = document.getElementById('filterForm');
  const modalEl = document.getElementById('filterModal');
  if (form && modalEl){
    form.addEventListener('submit', function(){
      try{
        if (window.bootstrap){
          const inst = bootstrap.Modal.getInstance(modalEl) || bootstrap.Modal.getOrCreateInstance(modalEl);
          inst.hide();
        }
      }catch(e){}
    });
  }
})();
</script>

{% endblock %}
