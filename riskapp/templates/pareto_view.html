{% extends "base.html" %}
{% block title %}Pareto Analizi · Risk Yönetim{% endblock %}

{% block content %}
<style>
  /* Page-local polish (base.html'e dokunmadan modern görünüm) */
  .pareto-wrap{ display:flex; flex-direction:column; gap:12px; }
  .pareto-topbar{
    display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;
  }
  .pareto-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.75);
    backdrop-filter: blur(8px);
    color:#0f172a; font-weight:600;
  }
  .chip small{ font-weight:500; color:#64748b; }

  .toolbar{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    padding:10px; border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.72);
    backdrop-filter: blur(10px);
  }
  .toolbar .input{ min-width: 190px; }
  .toolbar .btn{ white-space:nowrap; }
  .toolbar .sep{ width:1px; height:28px; background: rgba(15,23,42,.10); margin:0 4px; }

  .grid-2{
    display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;
  }
  @media (max-width: 980px){
    .grid-2{ grid-template-columns: 1fr; }
  }

  .chart-card{
    margin:0; padding:12px; border-radius:16px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.92);
  }
  .chart-row{ display:grid; grid-template-columns: 1fr; gap:10px; }

  canvas{ width:100%; height:260px; display:block; }

  /* Table improvements */
  .table-wrap{ overflow:auto; border-radius:14px; border:1px solid rgba(15,23,42,.10); }
  table.table{ margin:0; }
  table.table thead th{
    position: sticky; top: 0;
    background: #fff;
    z-index: 1;
    box-shadow: 0 1px 0 rgba(15,23,42,.08);
  }
  .muted{ color:#64748b; }
  .mono{ font-variant-numeric: tabular-nums; }

  .badge{
    display:inline-flex; align-items:center;
    padding:4px 8px; border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(15,23,42,.04);
    color:#0f172a;
    font-size:12px; font-weight:600;
  }

  .skeleton{
    background: linear-gradient(90deg, rgba(15,23,42,.05), rgba(15,23,42,.10), rgba(15,23,42,.05));
    background-size: 200% 100%;
    animation: sk 1.2s infinite linear;
    border-radius: 10px;
    height: 14px;
  }
  @keyframes sk{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  .err{
    border:1px solid rgba(239,68,68,.25);
    background: rgba(239,68,68,.06);
    color:#991b1b;
    padding:10px 12px;
    border-radius:14px;
    font-weight:600;
  }

  .ai-box{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.65);
  }
</style>

<div class="card pareto-wrap">
  <div class="pareto-topbar">
    <div style="display:flex; flex-direction:column; gap:6px;">
      <h3 style="margin:0">Pareto Analizi (Maliyet)</h3>
      <div id="meta" class="muted">
        <div class="skeleton" style="width: 420px;"></div>
      </div>
    </div>

    <div class="pareto-actions">
      <form method="get" action="{{ url_for('pareto_view') }}" style="display:flex; gap:8px; align-items:center;">
        <label style="font-weight:600;">Para Birimi</label>
        <select name="currency" class="input" onchange="this.form.submit()">
          {% for c in ["TRY","USD","EUR"] %}
            <option value="{{c}}" {% if currency==c %}selected{% endif %}>{{c}}</option>
          {% endfor %}
        </select>
      </form>

      <a class="btn" href="{{ url_for('pareto_view') }}?currency={{currency}}">Yenile</a>
    </div>
  </div>

  <!-- Controls -->
  <div class="toolbar">
    <input id="q" class="input" type="search" placeholder="Risk / kategori ara…" />
    <select id="sort" class="input" title="Sıralama">
      <option value="value_desc">Tutar (Azalan)</option>
      <option value="value_asc">Tutar (Artan)</option>
      <option value="pct_desc">% (Azalan)</option>
      <option value="pct_asc">% (Artan)</option>
      <option value="title_az">Başlık (A→Z)</option>
      <option value="title_za">Başlık (Z→A)</option>
      <option value="cat_az">Kategori (A→Z)</option>
    </select>

    <label class="chip" style="cursor:pointer;">
      <input id="onlyTop80" type="checkbox" style="accent-color:#f59e0b;" />
      <span>Yalnız Top 80%</span>
    </label>

    <!-- Scenario controls (sep öncesi) -->
    <select id="scope" class="input" title="Senaryo kapsamı">
      <option value="top3">Senaryo: Top 3</option>
      <option value="top80">Senaryo: Top 80</option>
      <option value="topcat">Senaryo: Top Kategori</option>
    </select>

    <label class="chip" style="gap:10px;">
      <span>Cut</span>
      <input id="cut" type="range" min="0" max="30" value="10" style="width:140px;" />
      <small><span id="cutVal" class="mono">10</span>%</small>
    </label>

    <div class="sep"></div>

    <button id="btnCsv" class="btn" type="button">CSV indir</button>
    <button id="btnCopyAI" class="btn" type="button">AI kopyala</button>

    <span id="countChip" class="chip" style="margin-left:auto;">
      <span>Gösterilen</span>
      <small><span id="shownCount" class="mono">0</span>/<span id="allCount" class="mono">0</span></small>
    </span>
  </div>

  <div class="grid-2">
    <!-- LEFT -->
    <div class="card" style="margin:0">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
        <h4 style="margin:0">Top Riskler (80/20)</h4>
        <span id="topCats" class="muted"></span>
      </div>

      <div class="chart-card" style="margin-top:10px;">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap;">
          <span class="badge">Pareto Grafiği (Bar + Kümülatif %)</span>
          <span id="chartHint" class="muted" style="font-size:12px;">İlk 25 risk çizilir (performans için).</span>
        </div>
        <canvas id="paretoChart" width="900" height="260"></canvas>
      </div>

      <div class="table-wrap" style="margin-top:10px;">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th style="width:52px;">#</th>
              <th>Risk</th>
              <th>Kategori</th>
              <th style="text-align:right;">Tutar</th>
              <th style="text-align:right;">%</th>
              <th style="text-align:right;">Kümülatif %</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="err" style="display:none; margin-top:10px;" class="err"></div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="margin:0">
      <h4 style="margin:0 0 10px 0">AI Özet</h4>

      <div id="aiBadges" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;"></div>

      <div id="aiSummary" class="ai-box" style="color:#0f172a; line-height:1.5;">
        <div class="skeleton" style="width: 92%;"></div>
        <div class="skeleton" style="width: 78%; margin-top:8px;"></div>
        <div class="skeleton" style="width: 66%; margin-top:8px;"></div>
      </div>

      <h4 style="margin:12px 0 8px 0">İçgörüler</h4>
      <div id="aiInsights" style="display:grid; gap:10px;"></div>

      <h4 style="margin:12px 0 8px 0">Önerilen Aksiyonlar</h4>
      <div id="aiActions" style="display:grid; gap:10px;"></div>

      <!-- ✅ NEW: Top risks -->
      <h4 style="margin:12px 0 8px 0">Top Riskler (AI)</h4>
      <div id="aiTopRisks" style="display:grid; gap:10px;"></div>

      <div id="aiErr" style="display:none; margin-top:10px;" class="err"></div>
    </div>
  </div>
</div>

<script>
(async function(){
  const currency = "{{ currency }}";

  const meta = document.getElementById("meta");
  const tbody = document.querySelector("#tbl tbody");
  const errBox = document.getElementById("err");

  const aiSummary = document.getElementById("aiSummary");
  const aiInsights = document.getElementById("aiInsights");
  const aiActions = document.getElementById("aiActions");
  const aiBadges = document.getElementById("aiBadges");
  const aiTopRisks = document.getElementById("aiTopRisks");
  const aiErr = document.getElementById("aiErr");

  const q = document.getElementById("q");
  const sortSel = document.getElementById("sort");
  const onlyTop80 = document.getElementById("onlyTop80");

  const scopeSel = document.getElementById("scope");
  const cutRange = document.getElementById("cut");
  const cutVal = document.getElementById("cutVal");

  const btnCsv = document.getElementById("btnCsv");
  const btnCopyAI = document.getElementById("btnCopyAI");

  const shownCount = document.getElementById("shownCount");
  const allCount = document.getElementById("allCount");
  const topCatsEl = document.getElementById("topCats");

  const canvas = document.getElementById("paretoChart");
  const ctx = canvas.getContext("2d");

  let raw = null;
  let viewItems = [];

  function fmt(n){
    const x = Number(n);
    if (!isFinite(x)) return n;
    return x.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function safeText(s){
    return (s ?? "").toString();
  }

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function hideErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  async function fetchJson(url){
    const r = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!r.ok) throw new Error(`HTTP ${r.status} · ${url}`);
    return await r.json();
  }

  function computePctIfMissing(items, total){
    let cum = 0;
    return items.map(it => {
      const value = Number(it.value || 0);
      const pct = isFinite(Number(it.pct)) ? Number(it.pct) : (total ? (value / total * 100) : 0);
      cum += pct;
      const cum_pct = isFinite(Number(it.cum_pct)) ? Number(it.cum_pct) : cum;
      return { ...it, value, pct, cum_pct };
    });
  }

  function applyView(){
    const items = (raw?.items || []);
    const total = Number(raw?.total || 0);
    const top80 = Number(raw?.top_80_count || 0);

    let list = computePctIfMissing(items, total);

    const term = safeText(q.value).trim().toLowerCase();
    if (term){
      list = list.filter(it => {
        const t = safeText(it.title).toLowerCase();
        const c = safeText(it.category).toLowerCase();
        const id = safeText(it.risk_id);
        return t.includes(term) || c.includes(term) || id.includes(term);
      });
    }
    if (onlyTop80.checked && top80 > 0){
      list = list.slice(0, top80);
    }

    const key = sortSel.value;
    const byStr = (a,b,dir=1) => (safeText(a).localeCompare(safeText(b), undefined, {sensitivity:"base"})) * dir;
    list.sort((a,b) => {
      switch(key){
        case "value_desc": return (b.value - a.value);
        case "value_asc":  return (a.value - b.value);
        case "pct_desc":   return (b.pct - a.pct);
        case "pct_asc":    return (a.pct - b.pct);
        case "title_az":   return byStr(a.title, b.title, 1);
        case "title_za":   return byStr(a.title, b.title, -1);
        case "cat_az":     return byStr(a.category, b.category, 1);
        default: return 0;
      }
    });

    viewItems = list;

    allCount.textContent = String(items.length);
    shownCount.textContent = String(viewItems.length);

    renderTable(viewItems, top80);
    renderTopCats(items, top80);
    renderChart(items, top80);

    meta.textContent = `Toplam: ${fmt(total)} ${currency} · %80’i oluşturan risk sayısı: ${top80} · Son güncelleme: ${new Date().toLocaleString()}`;
  }

  function renderTable(list, top80){
    tbody.innerHTML = "";
    const frag = document.createDocumentFragment();

    list.forEach((it, i) => {
      const tr = document.createElement("tr");
      const idx = i + 1;

      const title = safeText(it.title) || ("Risk #" + safeText(it.risk_id));
      const cat = safeText(it.category) || "-";
      const rid = safeText(it.risk_id);

      tr.innerHTML = `
        <td class="mono">${idx}</td>
        <td>
          <a href="/reports/${encodeURIComponent(rid)}">${title}</a>
          <div class="muted" style="font-size:12px;">ID: <span class="mono">${rid}</span></div>
        </td>
        <td>${cat}</td>
        <td class="mono" style="text-align:right;">${fmt(it.value)} ${currency}</td>
        <td class="mono" style="text-align:right;">%${fmt(it.pct)}</td>
        <td class="mono" style="text-align:right;">%${fmt(it.cum_pct)}</td>
      `;

      if (!onlyTop80.checked && top80 > 0 && idx <= top80){
        tr.style.background = "rgba(255, 215, 0, .10)";
      }
      frag.appendChild(tr);
    });

    tbody.appendChild(frag);

    if (!list.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" class="muted" style="padding:14px;">Kayıt yok. Filtre çok acımasız olabilir.</td>`;
      tbody.appendChild(tr);
    }
  }

  function renderTopCats(items, top80){
    if (!items?.length){ topCatsEl.textContent = ""; return; }
    const slice = items.slice(0, Math.max(0, top80));
    const map = {};
    for (const it of slice){
      const c = safeText(it.category) || "GENEL";
      map[c] = (map[c] || 0) + Number(it.value || 0);
    }
    const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3);
    if (!top.length){ topCatsEl.textContent = ""; return; }

    const txt = top.map(([c,v]) => `${c}: ${fmt(v)} ${currency}`).join(" · ");
    topCatsEl.textContent = `Top kategori yükü: ${txt}`;
  }

  function clearCanvas(){
    ctx.clearRect(0,0,canvas.width, canvas.height);
  }

  function renderChart(items, top80){
    clearCanvas();
    if (!items?.length) return;

    const N = Math.min(25, items.length);
    const total = Number(raw?.total || 0) || 1;
    const list = computePctIfMissing(items.slice(0, N), total);

    const W = canvas.width, H = canvas.height;
    const padL = 46, padR = 14, padT = 14, padB = 34;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    const maxVal = Math.max(...list.map(x => Number(x.value||0)), 1);
    const barW = plotW / N;

    ctx.save();
    ctx.globalAlpha = 1;
    ctx.lineWidth = 1;

    ctx.strokeStyle = "rgba(15,23,42,.18)";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + plotH);
    ctx.lineTo(padL + plotW, padT + plotH);
    ctx.stroke();

    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const steps = 4;
    for (let s=0; s<=steps; s++){
      const y = padT + plotH - (plotH * s/steps);
      ctx.strokeStyle = "rgba(15,23,42,.08)";
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(padL + plotW, y);
      ctx.stroke();

      const val = maxVal * s/steps;
      ctx.fillStyle = "rgba(15,23,42,.55)";
      ctx.fillText(fmt(val), 6, y + 4);
    }

    let cum = 0;
    const points = [];

    for (let i=0; i<N; i++){
      const it = list[i];
      const v = Number(it.value||0);
      const pct = total ? (v/total*100) : 0;
      cum += pct;

      const x = padL + i * barW;
      const barH = (v / maxVal) * plotH;
      const y = padT + plotH - barH;

      ctx.fillStyle = (top80 > 0 && (i+1) <= top80) ? "rgba(245, 158, 11, .55)" : "rgba(99, 102, 241, .40)";
      ctx.fillRect(x + 3, y, Math.max(2, barW - 6), barH);

      const cx = x + barW/2;
      const cy = padT + plotH - (Math.min(100, cum)/100) * plotH;
      points.push([cx, cy]);
    }

    ctx.strokeStyle = "rgba(15,23,42,.65)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((p, idx) => {
      if (idx === 0) ctx.moveTo(p[0], p[1]);
      else ctx.lineTo(p[0], p[1]);
    });
    ctx.stroke();

    ctx.strokeStyle = "rgba(239,68,68,.55)";
    ctx.setLineDash([6,4]);
    const y80 = padT + plotH - 0.8 * plotH;
    ctx.beginPath();
    ctx.moveTo(padL, y80);
    ctx.lineTo(padL + plotW, y80);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle = "rgba(239,68,68,.85)";
    ctx.fillText("80%", padL + plotW - 26, y80 - 6);

    ctx.fillStyle = "rgba(15,23,42,.45)";
    ctx.font = "11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const every = N > 12 ? 2 : 1;
    for (let i=0; i<N; i+=every){
      const x = padL + i*barW + 3;
      ctx.fillText(String(i+1), x, padT + plotH + 18);
    }

    ctx.restore();
  }

  function downloadCsv(){
    if (!raw?.items?.length) return;

    const rows = [];
    rows.push(["index","risk_id","title","category","value","pct","cum_pct","currency"].join(","));

    const total = Number(raw.total || 0);
    const list = computePctIfMissing(raw.items, total);

    const exportList = (viewItems?.length ? viewItems : list);
    exportList.forEach((it, idx) => {
      const row = [
        idx+1,
        `"${String(it.risk_id ?? "").replaceAll('"','""')}"`,
        `"${String(it.title ?? "").replaceAll('"','""')}"`,
        `"${String(it.category ?? "").replaceAll('"','""')}"`,
        Number(it.value || 0),
        Number(it.pct || 0),
        Number(it.cum_pct || 0),
        currency
      ];
      rows.push(row.join(","));
    });

    const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `pareto_${currency}_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  function copyAI(){
    const summary = safeText(aiSummary.textContent).trim();

    let acts = "";
    const cards = Array.from(document.querySelectorAll("#aiActions .ai-box"));
    if (cards.length){
      acts = cards.map(c => "- " + (c.querySelector("div")?.textContent || "Aksiyon")).join("\n");
    }

    let risks = "";
    const rCards = Array.from(document.querySelectorAll("#aiTopRisks .ai-box"));
    if (rCards.length){
      risks = rCards.map(c => "- " + (c.querySelector("a")?.textContent?.trim() || "Risk")).join("\n");
    }

    const cut = Number(cutRange.value || 10);
    const scope = scopeSel.value || "top3";

    const txt =
`AI Özet (${currency})
Scope=${scope} Cut=${cut}%

${summary}

Aksiyonlar:
${acts || "- (yok)"}

Top Riskler:
${risks || "- (yok)"}`
    ;
    navigator.clipboard?.writeText(txt);
  }

  // UI helpers for AI section
  function badge(text){
    const el = document.createElement("span");
    el.className = "badge";
    el.textContent = text;
    return el;
  }

  function card(title, text){
    const wrap = document.createElement("div");
    wrap.className = "ai-box";
    wrap.style.background = "rgba(255,255,255,.75)";
    wrap.innerHTML = `
      <div style="font-weight:800; color:#0f172a;">${title || ""}</div>
      <div style="margin-top:6px; color:#334155; line-height:1.45;">${text || ""}</div>
    `;
    return wrap;
  }

  function priorityPill(p){
    const el = document.createElement("span");
    el.className = "badge";
    const pr = (p || "low").toLowerCase();
    el.textContent = pr === "high" ? "Yüksek" : pr === "medium" ? "Orta" : "Düşük";
    el.style.borderColor = pr === "high" ? "rgba(239,68,68,.25)" : pr === "medium" ? "rgba(245,158,11,.25)" : "rgba(15,23,42,.10)";
    el.style.background = pr === "high" ? "rgba(239,68,68,.08)" : pr === "medium" ? "rgba(245,158,11,.10)" : "rgba(15,23,42,.04)";
    el.style.color = pr === "high" ? "#991b1b" : pr === "medium" ? "#92400e" : "#0f172a";
    return el;
  }

  function actionCard(a){
    const wrap = document.createElement("div");
    wrap.className = "ai-box";
    wrap.style.background = "rgba(255,255,255,.75)";

    const title = a?.title || "Aksiyon";
    const details = a?.details || "";
    const kpi = a?.kpi || "";
    const url = a?.url;

    const topRow = document.createElement("div");
    topRow.style.display = "flex";
    topRow.style.justifyContent = "space-between";
    topRow.style.gap = "10px";
    topRow.style.alignItems = "flex-start";

    const left = document.createElement("div");
    left.style.fontWeight = "800";
    left.style.color = "#0f172a";
    left.textContent = title;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flexWrap = "wrap";
    right.appendChild(priorityPill(a?.priority));
    if (a?.type) right.appendChild(badge(String(a.type)));

    topRow.appendChild(left);
    topRow.appendChild(right);

    const body = document.createElement("div");
    body.style.marginTop = "8px";
    body.style.color = "#334155";
    body.style.lineHeight = "1.45";
    body.textContent = details;

    wrap.appendChild(topRow);
    wrap.appendChild(body);

    if (kpi){
      const k = document.createElement("div");
      k.style.marginTop = "8px";
      k.className = "muted";
      k.innerHTML = `<span class="badge">KPI</span> <span class="mono" style="margin-left:6px;">${kpi}</span>`;
      wrap.appendChild(k);
    }

    if (url){
      const link = document.createElement("a");
      link.href = url;
      link.className = "btn";
      link.style.marginTop = "10px";
      link.style.display = "inline-flex";
      link.textContent = "Riske git";
      wrap.appendChild(link);
    }

    return wrap;
  }

  // ✅ NEW: Top risk mini card
  function riskMiniCard(r){
    const wrap = document.createElement("div");
    wrap.className = "ai-box";
    wrap.style.background = "rgba(255,255,255,.75)";

    const id = r?.id ?? r?.risk_id;
    const title = r?.title || (id != null ? `Risk #${id}` : "Risk");
    const category = r?.category || "GENEL";
    const value = Number(r?.value || 0);
    const pct = Number(r?.pct || 0);
    const url = r?.url || (id != null ? `/reports/${encodeURIComponent(id)}` : "#");

    const ci = r?.cost_items || {};
    const nItems = Number(ci?.n_items || 0);
    const sumTotal = Number(ci?.sum_total || 0);
    const topItems = Array.isArray(ci?.top_cost_items) ? ci.top_cost_items : [];
    const freqBreak = ci?.freq_breakdown || {};

    const head = document.createElement("div");
    head.style.display = "flex";
    head.style.justifyContent = "space-between";
    head.style.gap = "10px";
    head.style.alignItems = "flex-start";

    const left = document.createElement("div");
    left.innerHTML = `
      <a href="${url}" style="font-weight:900; color:#0f172a; text-decoration:none;">
        ${title}
      </a>
      <div class="muted" style="font-size:12px; margin-top:2px;">
        ID: <span class="mono">${id ?? "-"}</span> · Kategori: <span style="font-weight:700;">${category}</span>
      </div>
    `;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flexWrap = "wrap";
    right.appendChild(badge(`%${isFinite(pct) ? pct.toFixed(1) : "0.0"}`));
    right.appendChild(badge(`${fmt(value)} ${currency}`));
    if (nItems) right.appendChild(badge(`${nItems} kalem`));

    head.appendChild(left);
    head.appendChild(right);
    wrap.appendChild(head);

    if (nItems || sumTotal){
      const s = document.createElement("div");
      s.className = "muted";
      s.style.marginTop = "8px";
      s.innerHTML = `CostItem toplamı: <span class="mono">${fmt(sumTotal)} ${currency}</span>`;
      wrap.appendChild(s);
    }

    if (topItems.length){
      const box = document.createElement("div");
      box.style.marginTop = "10px";
      box.innerHTML = `<div style="font-weight:800; color:#0f172a; font-size:12px;">En pahalı kalemler</div>`;
      const ul = document.createElement("ul");
      ul.style.margin = "6px 0 0 16px";
      ul.style.color = "#334155";
      ul.style.fontSize = "13px";

      topItems.slice(0,3).forEach(ci => {
        const li = document.createElement("li");
        const nm = (ci?.name || "Kalem").toString();
        const tv = fmt(Number(ci?.total || 0));
        const fq = (ci?.frequency || "belirsiz").toString();
        li.textContent = `${nm} · ${tv} ${currency} · ${fq}`;
        ul.appendChild(li);
      });

      box.appendChild(ul);
      wrap.appendChild(box);
    }

    const freqKeys = freqBreak ? Object.keys(freqBreak) : [];
    if (freqKeys.length){
      const topF = freqKeys
        .map(k => [k, Number(freqBreak[k] || 0)])
        .sort((a,b)=>b[1]-a[1])
        .slice(0,2);

      const f = document.createElement("div");
      f.className = "muted";
      f.style.marginTop = "8px";
      f.textContent = "Periyot: " + topF.map(([k,v]) => `${k} (${fmt(v)} ${currency})`).join(" · ");
      wrap.appendChild(f);
    }

    return wrap;
  }

  async function loadAI(){
    aiErr.style.display = "none";
    aiBadges.innerHTML = "";
    aiInsights.innerHTML = "";
    aiActions.innerHTML = "";
    aiTopRisks.innerHTML = "";

    cutVal.textContent = String(cutRange.value || 10);

    aiSummary.innerHTML = `
      <div class="skeleton" style="width: 92%;"></div>
      <div class="skeleton" style="width: 78%; margin-top:8px;"></div>
      <div class="skeleton" style="width: 66%; margin-top:8px;"></div>
    `;

    const cut = Number(cutRange.value || 10) / 100;
    const scope = scopeSel.value || "top3";

    try{
      const ai = await fetchJson(`/analytics/pareto/ai?currency=${encodeURIComponent(currency)}&top_n=10&cut=${encodeURIComponent(cut)}&scope=${encodeURIComponent(scope)}`);

      aiSummary.textContent = ai.summary || "Özet yok.";

      const m = ai.meta || {};
      if (m.top_80_count != null) aiBadges.appendChild(badge(`Top80: ${m.top_80_count}`));
      if (m.scope_label) aiBadges.appendChild(badge(`Scope: ${m.scope_label}`));
      else if (m.scope) aiBadges.appendChild(badge(`Scope: ${m.scope}`));
      if (m.scenario_saving != null) aiBadges.appendChild(badge(`Tasarruf: ${fmt(m.scenario_saving)} ${currency}`));
      if (m.cat_hhi != null) aiBadges.appendChild(badge(`Cat HHI: ${Number(m.cat_hhi).toFixed(3)}`));
      if (m.risk_hhi != null) aiBadges.appendChild(badge(`Risk HHI: ${Number(m.risk_hhi).toFixed(3)}`));

      (ai.insights || []).forEach(ins => {
        aiInsights.appendChild(card(ins.title || ins.type || "İçgörü", ins.text || ""));
      });
      if (!(ai.insights || []).length){
        aiInsights.appendChild(card("İçgörü", "İçgörü yok."));
      }

      if (Array.isArray(ai.actions) && ai.actions.length){
        if (typeof ai.actions[0] === "string"){
          ai.actions.forEach(s => aiActions.appendChild(card("Aksiyon", s)));
        } else {
          ai.actions.forEach(a => aiActions.appendChild(actionCard(a)));
        }
      } else {
        aiActions.appendChild(card("Aksiyon", "Aksiyon önerisi yok."));
      }

      // ✅ NEW: Top risks render
      const trs = Array.isArray(ai.top_risks) ? ai.top_risks : [];
      if (trs.length){
        trs.forEach(r => aiTopRisks.appendChild(riskMiniCard(r)));
      } else {
        aiTopRisks.appendChild(card("Top Riskler", "AI top_risks dönmedi. Endpoint çıktısını kontrol et."));
      }

    } catch(e){
      aiErr.style.display = "block";
      aiErr.textContent = "AI kısmı patladı. " + (e?.message || e);
      aiSummary.textContent = "Özet yok.";
    }
  }

  // events
  q.addEventListener("input", () => applyView());
  sortSel.addEventListener("change", () => applyView());
  onlyTop80.addEventListener("change", () => applyView());
  btnCsv.addEventListener("click", downloadCsv);
  btnCopyAI.addEventListener("click", copyAI);

  scopeSel.addEventListener("change", loadAI);
  cutRange.addEventListener("input", () => { cutVal.textContent = cutRange.value; });
  cutRange.addEventListener("change", loadAI);

  // 1) Pareto data
  try {
    hideErr();
    const data = await fetchJson(`/analytics/pareto?currency=${encodeURIComponent(currency)}`);
    raw = data;

    const total = Number(data.total || 0);
    const top80 = Number(data.top_80_count || 0);
    meta.textContent = `Toplam: ${fmt(total)} ${currency} · %80’i oluşturan risk sayısı: ${top80}`;

    applyView();
  } catch (e){
    showErr("Pareto verisi alınamadı. Sunucu veya endpoint gitti mi kontrol et: " + (e?.message || e));
    meta.textContent = "Veri yok.";
  }

  // 2) AI load
  await loadAI();

})();
</script>
{% endblock %}
