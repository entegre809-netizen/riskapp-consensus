{% extends "base.html" %}
{% block title %}Kullanƒ±cƒ± Y√∂netimi{% endblock %}

{% block content %}
<style>
  /* ============================================================
     ‚úÖ RiskDetail tasarƒ±m diline uyarlama
     - primary/line/card deƒüi≈ükenleri (base.html'den gelebilir)
     - light/dark desteƒüi
     - cam/soft card, premium table, pill/badge
     ============================================================ */

  .page{ display:grid; gap:12px; }
  .sticky-top{
    position: sticky; top: 8px; z-index: 5;
    background: var(--bg, transparent);
    padding: 8px 0 0;
  }

  .muted { opacity:.78; font-size:.92rem; color: color-mix(in oklab, var(--text,#0f172a) 55%, transparent); }
  [data-theme="dark"] .muted{ color: rgba(226,232,240,.72); opacity:1; }

  .row{ display:flex; gap:10px; align-items:center; }
  .grow{ flex:1; }
  .right{ display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }

  /* ===== Card (RiskDetail vibe) ===== */
  .um-card{
    padding: 14px;
    border-radius: 14px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    background: color-mix(in oklab, var(--card,#fff) 96%, transparent);
    box-shadow: 0 12px 28px rgba(0,0,0,.06);
  }
  [data-theme="dark"] .um-card{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    box-shadow: 0 16px 34px rgba(0,0,0,.35);
  }

  .um-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    padding: 6px 6px 14px;
    border-bottom: 1px solid var(--line,#e5e7eb);
    margin-bottom: 14px;
  }
  [data-theme="dark"] .um-head{ border-color: rgba(255,255,255,.12); }

  .um-title{
    margin:0;
    font-size: 1.05rem;
    font-weight: 900;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .um-ico{
    width:32px; height:32px;
    border-radius: 10px;
    display:flex; align-items:center; justify-content:center;
    background: color-mix(in oklab, var(--primary,#2563eb) 10%, transparent);
    border:1px solid color-mix(in oklab, var(--primary,#2563eb) 25%, transparent);
  }

  /* ===== Toolbar / Chips ===== */
  .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:.28rem .6rem;
    border-radius:999px;
    font-size:.82rem;
    border:1px solid var(--line,#e5e7eb);
    background: color-mix(in oklab, var(--card,#fff) 92%, transparent);
    font-weight:800;
    white-space:nowrap;
  }
  [data-theme="dark"] .pill{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    color: var(--text,#e5e7eb);
  }

  .dot{ width:8px; height:8px; border-radius:999px; background:#94a3b8; }

  /* ===== Buttons (base.html'deki btn'lerle √ßakƒ±≈ümasƒ±n diye uyumlu) ===== */
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    border-radius: 12px;
    padding: .55rem .75rem;
    font-weight: 900;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 75%, transparent);
    background: color-mix(in oklab, var(--card,#fff) 92%, transparent);
    color: color-mix(in oklab, var(--text,#0f172a) 88%, transparent);
    cursor:pointer;
    text-decoration:none;
    user-select:none;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease;
    white-space:nowrap;
  }
  .btn:hover{ filter: brightness(.98); transform: translateY(-1px); border-color: color-mix(in oklab, var(--primary,#2563eb) 28%, var(--line,#e5e7eb) 72%); }
  .btn:active{ transform: translateY(0); }
  .btn:disabled, .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

  .btn-primary{
    background: color-mix(in oklab, var(--primary,#2563eb) 92%, white 8%);
    border-color: color-mix(in oklab, var(--primary,#2563eb) 80%, black 20%);
    color:#fff;
    box-shadow: 0 12px 28px color-mix(in oklab, var(--primary,#2563eb) 22%, transparent);
  }
  .btn-danger{
    background: color-mix(in oklab, #ef4444 16%, transparent);
    border-color: color-mix(in oklab, #ef4444 30%, transparent);
    color: color-mix(in oklab, #991b1b 92%, black 8%);
  }
  [data-theme="dark"] .btn{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    color: rgba(226,232,240,.92);
  }
  [data-theme="dark"] .btn:hover{ border-color: color-mix(in oklab, var(--primary,#6ea8ff) 30%, rgba(255,255,255,.14) 70%); }
  [data-theme="dark"] .btn-danger{
    background: color-mix(in oklab, #ef4444 12%, transparent);
    border-color: color-mix(in oklab, #ef4444 22%, transparent);
    color:#fecaca;
  }

  .btn.tiny{ padding:.35rem .55rem; font-size:.82rem; border-radius: 10px; font-weight:900; }

  /* ===== Inputs ===== */
  .input{
    height: 40px;
    border-radius: 10px;
    border: 1px solid color-mix(in oklab, var(--line,#e5e7eb) 85%, transparent);
    background: color-mix(in oklab, var(--card,#fff) 92%, transparent);
    padding: .45rem .65rem;
    outline:none;
    min-width: 140px;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .input:focus{
    border-color: color-mix(in oklab, var(--primary,#2563eb) 55%, var(--line,#e5e7eb) 45%);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary,#2563eb) 18%, transparent);
  }
  [data-theme="dark"] .input{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    color: rgba(226,232,240,.92);
  }

  /* ===== Flash ===== */
  .flash{
    margin:10px 0;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 70%, transparent);
    background: color-mix(in oklab, var(--card,#fff) 94%, transparent);
    font-weight:700;
  }
  [data-theme="dark"] .flash{
    border-color: rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }

  /* ===== Table ===== */
  .table-wrap{
    overflow:auto;
    border-radius: 14px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    background: color-mix(in oklab, var(--card,#fff) 96%, transparent);
  }
  [data-theme="dark"] .table-wrap{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
  }

  table.table-modern{ width:100%; border-collapse:separate; border-spacing:0; }
  table.table-modern thead th{
    position: sticky; top: 0; z-index: 1;
    background: color-mix(in oklab, var(--bg-soft,#f3f4f6) 90%, transparent);
    border-bottom:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    font-size:.72rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    opacity:.78;
    padding: 12px 10px;
    text-align:left;
    white-space:nowrap;
  }
  [data-theme="dark"] table.table-modern thead th{
    background: rgba(255,255,255,.04);
    border-bottom-color: rgba(255,255,255,.10);
    opacity:.9;
  }

  table.table-modern td{
    padding: 12px 10px;
    vertical-align: top;
    border-bottom:1px solid color-mix(in oklab, var(--line,#e5e7eb) 55%, transparent);
  }
  table.table-modern tbody tr:last-child td{ border-bottom:none; }

  .row-actions{
    display:flex;
    gap:10px;
    align-items:flex-start;
    flex-wrap:wrap;
  }
  .table-actions{ width: 520px; }
  @media (max-width: 1200px){ .table-actions{ width:auto; } }

  /* ===== Badges ===== */
  .badge{
    display:inline-flex;
    align-items:center;
    padding:.28rem .58rem;
    border-radius: 999px;
    font-size:.78rem;
    font-weight:900;
    border:1px solid transparent;
  }
  .badge-role-admin{
    background: color-mix(in oklab, var(--primary,#2563eb) 14%, transparent);
    border-color: color-mix(in oklab, var(--primary,#2563eb) 22%, transparent);
    color: color-mix(in oklab, var(--primary,#2563eb) 92%, black 8%);
  }
  .badge-role-uzman{
    background: color-mix(in oklab, var(--card,#fff) 92%, transparent);
    border-color: color-mix(in oklab, var(--line,#e5e7eb) 70%, transparent);
    color: color-mix(in oklab, var(--text,#0f172a) 75%, transparent);
  }
  [data-theme="dark"] .badge-role-uzman{
    background: rgba(255,255,255,.04);
    border-color: rgba(255,255,255,.12);
    color: rgba(226,232,240,.85);
  }

  .badge-status-active{
    background: color-mix(in oklab, #22c55e 14%, transparent);
    border-color: color-mix(in oklab, #22c55e 24%, transparent);
    color: color-mix(in oklab, #137a3a 90%, black 10%);
  }
  .badge-status-pending{
    background: color-mix(in oklab, #f59e0b 16%, transparent);
    border-color: color-mix(in oklab, #f59e0b 24%, transparent);
    color: color-mix(in oklab, #9a6700 92%, black 8%);
  }
  .badge-status-disabled{
    background: color-mix(in oklab, var(--bg-soft,#f3f4f6) 88%, transparent);
    border-color: color-mix(in oklab, var(--line,#e5e7eb) 70%, transparent);
    color: color-mix(in oklab, var(--text,#0f172a) 50%, transparent);
  }
  [data-theme="dark"] .badge-status-disabled{
    background: rgba(255,255,255,.04);
    border-color: rgba(255,255,255,.12);
    color: rgba(226,232,240,.65);
  }

  code{
    padding:.12rem .35rem;
    border-radius:8px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    background: color-mix(in oklab, var(--bg-soft,#f3f4f6) 92%, transparent);
    font-weight:800;
    font-size:.86rem;
  }
  [data-theme="dark"] code{
    border-color: rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color: rgba(226,232,240,.92);
  }
</style>

<div class="container page">
  <div class="card sticky-top">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div class="grow">
        <div class="row" style="gap:10px; flex-wrap:wrap">
          <h2 style="margin:0">Kullanƒ±cƒ± Y√∂netimi</h2>
          <span class="pill" title="Y√∂netim ekranƒ±">
            <span style="font-weight:900">üë§</span> Hesaplar
          </span>
        </div>
        <div class="muted" style="margin-top:6px">
          Rolleri, durumlarƒ± ve ref kodlarƒ±nƒ± buradan y√∂netebilirsin.
        </div>
      </div>

      <div class="toolbar noprint">
        <a class="btn" href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>
      </div>
    </div>

    {% if totals %}
      <div class="toolbar" style="margin-top:10px">
        <span class="pill"><span class="dot" style="background:#94a3b8"></span> Toplam: {{ totals.all }}</span>
        <span class="pill"><span class="dot" style="background:#16a34a"></span> Aktif: {{ totals.active }}</span>
        <span class="pill"><span class="dot" style="background:#f59e0b"></span> Bekleyen: {{ totals.pending }}</span>
        <span class="pill"><span class="dot" style="background:#6b7280"></span> Devre dƒ±≈üƒ±: {{ totals.disabled }}</span>
        <span class="pill"><span class="dot" style="background:color-mix(in oklab, var(--primary,#2563eb) 85%, black 15%)"></span> Admin: {{ totals.admins }}</span>
      </div>
    {% endif %}
  </div>

  <div class="um-card">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for c,m in messages %}
          <div class="flash {{c}}">
            {{m}}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="table-wrap">
      <table class="table-modern">
        <thead>
          <tr>
            <th>Ad Soyad</th>
            <th>E-posta</th>
            <th>√únvan</th>
            <th>Rol</th>
            <th>Durum</th>
            <th>Ref Kodu</th>
            <th class="table-actions">ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            {% set st = (u.status or 'pending') %}
            {% set is_self = (u.id == session.get('account_id')) %}
            <tr>
              <td style="min-width:200px;">
                <div style="font-weight:900">{{ u.contact_name }}</div>
                {% if is_self %}
                  <div class="muted" style="font-size:.86rem;">(Siz)</div>
                {% endif %}
              </td>

              <td style="min-width:240px;">{{ u.email }}</td>
              <td style="min-width:170px;">{{ u.contact_title or '‚Äî' }}</td>

              <td style="min-width:120px;">
                {% if (u.role or 'uzman') == 'admin' %}
                  <span class="badge badge-role-admin">admin</span>
                {% else %}
                  <span class="badge badge-role-uzman">uzman</span>
                {% endif %}
              </td>

              <td style="min-width:140px;">
                <span class="badge
                  {{ 'badge-status-active' if st=='active'
                     else 'badge-status-pending' if st=='pending'
                     else 'badge-status-disabled' }}">
                  {{ st }}
                </span>
              </td>

              <td style="min-width:190px;">
                {% if u.ref_code %}
                  <code>{{ u.ref_code }}</code>
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </td>

              <td>
                <div class="row-actions">
                  {# Rol g√ºncelle #}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        class="toolbar" style="gap:8px">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="set_role">
                    <select name="new_role" class="input" aria-label="Rol"
                            {% if is_self %}disabled{% endif %}>
                      <option value="uzman"
                        {{ 'selected' if (u.role or 'uzman')=='uzman' }}>uzman</option>
                      <option value="admin"
                        {{ 'selected' if u.role=='admin' }}>admin</option>
                    </select>
                    <button class="btn btn-primary" title="Rol√º g√ºncelle"
                            {% if is_self %}disabled{% endif %}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M4 12h16M4 6h16M4 18h10"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      G√ºncelle
                    </button>
                  </form>

                  {# Durum g√ºncelle #}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        class="toolbar" style="gap:8px">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="set_status">
                    <select name="new_status" class="input" aria-label="Durum"
                            {{ 'disabled' if is_self }}>
                      {% for st_opt in ['pending','active','disabled'] %}
                        <option value="{{ st_opt }}"
                          {{ 'selected' if st==st_opt else '' }}>
                          {{ st_opt }}
                        </option>
                      {% endfor %}
                    </select>
                    <button class="btn" {{ 'disabled' if is_self }}
                            title="Durumu g√ºncelle">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="m4 12 4 4 12-12"
                              stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Kaydet
                    </button>
                    {% if is_self %}
                      <span class="muted" style="font-size:.88rem;">
                        Kendi hesabƒ±nƒ±zƒ±n rol ve durumunu buradan deƒüi≈ütiremezsiniz.
                      </span>
                    {% endif %}
                  </form>

                  {# Ref ata / e-posta bildir #}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        class="toolbar" style="gap:8px">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="assign_ref">
                    <input class="input" name="ref_code"
                           placeholder="Kod (bo≈ü: √ºret)"
                           value="{{ u.ref_code or '' }}" style="width:170px">
                    <label style="display:inline-flex; gap:8px; align-items:center; font-size:.9rem; font-weight:800;">
                      <input type="checkbox" name="notify_email" value="1">
                      e-posta g√∂nder
                    </label>
                    <button class="btn" title="Ref kod ata veya g√ºncelle">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5v14M5 12h14"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Ref Ata/G√ºncelle
                    </button>
                  </form>

                  {# Gmail'de hazƒ±r mail a√ß #}
                  {% if u.ref_code and u.email %}
                    <a class="btn tiny" href="{{ url_for('admin_compose_ref', uid=u.id) }}"
                       target="_blank" title="Gmail'de hazƒ±r mail a√ß">
                      Gmail ile G√∂nder
                    </a>
                  {% endif %}

                  {# Ref kod temizle #}
                  {% if u.ref_code %}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        onsubmit="return confirm('Ref kodu silinsin mi?');">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="clear_ref">
                    <button class="btn btn-danger tiny" title="Ref kodu temizle">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6l12 12M6 18 18 6"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Ref Sil
                    </button>
                  </form>
                  {% endif %}
                </div>

                <div class="muted" style="margin-top:10px;">
                  {% if st != 'active' %}
                    Not: Bu kullanƒ±cƒ± giri≈ü yapabilmek i√ßin <em>active</em> olmalƒ±
                    ve kendisine bir <em>ref kodu</em> atanmalƒ±dƒ±r.
                  {% else %}
                    Not: Giri≈üte e-posta + ≈üifre + <em>ref kodu</em> gereklidir.
                  {% endif %}
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="7" style="padding:18px; text-align:center" class="muted">
                Kayƒ±tlƒ± kullanƒ±cƒ± bulunamadƒ±.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="toolbar" style="margin-top:14px">
      <a class="btn" href="{{ url_for('dashboard') }}">‚Üê Geri</a>
    </div>
  </div>
</div>
{% endblock %}
