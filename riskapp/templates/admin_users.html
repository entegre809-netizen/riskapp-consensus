{% extends "base.html" %}
{% block title %}Kullanıcı Yönetimi{% endblock %}

{% block content %}
<style>
  .card-modern {
    background: #fff;
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    padding: 18px 18px 6px;
  }
  .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .stat-chip {
    display:inline-flex; gap:8px; align-items:center;
    padding:6px 10px; border-radius: 999px;
    background:#f7f7f9; border:1px solid #eee;
    font-size:.9rem; color:#333;
  }
  .stat-dot { width:8px; height:8px; border-radius:50%; background:#bbb; }
  .table-wrap { overflow:auto; border:1px solid #eee; border-radius:12px; }
  table.table-modern { width:100%; border-collapse:separate; border-spacing:0; }
  table.table-modern thead th {
    position: sticky; top: 0; z-index: 1;
    background: #fafafa; color:#444; font-weight:600;
    border-bottom:1px solid #eee;
  }
  table.table-modern th, table.table-modern td { padding:12px 10px; vertical-align:middle; }
  table.table-modern tbody tr + tr td { border-top:1px solid #f1f1f4; }
  .badge {
    display:inline-block; padding:.35rem .6rem;
    border-radius:999px; font-size:.78rem; font-weight:600;
  }
  .badge-role-admin   { background:#e9f3ff; color:#0b5ed7; border:1px solid #cfe2ff; }
  .badge-role-uzman   { background:#f3f4f6; color:#374151; border:1px solid #e5e7eb; }
  .badge-status-active   { background:#e8f7ee; color:#137a3a; border:1px solid #bde5cd; }
  .badge-status-pending  { background:#fff7e6; color:#9a6700; border:1px solid #ffe1a8; }
  .badge-status-disabled { background:#f3f4f6; color:#6b7280; border:1px solid #e5e7eb; }
  .muted { color:#6b7280; }

  .btn, .btn-primary, .btn-secondary, .btn-danger {
    display:inline-flex; align-items:center; gap:6px; white-space:nowrap; cursor:pointer;
    border-radius:10px; padding:8px 12px; border:1px solid transparent; font-weight:600;
    background:#f5f6f8; color:#222; font-size:.9rem;
  }
  .btn-primary { background:#0d6efd; color:#fff; }
  .btn-secondary { background:#eef2f7; color:#222; }
  .btn-danger { background:#fee2e2; color:#991b1b; border-color:#fecaca; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }

  .btn.tiny, .btn-secondary.tiny, .btn-danger.tiny {
    padding:4px 8px; font-size:.8rem; border-radius:8px;
  }

  .input {
    border:1px solid #e5e7eb; border-radius:10px;
    padding:7px 10px; min-width:140px;
  }
  .input:focus {
    outline:none; border-color:#0d6efd33;
    box-shadow:0 0 0 4px #0d6efd1a;
  }
  .row-actions { display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }
  .table-actions { width: 520px; }
  @media (max-width: 1200px) { .table-actions { width:auto; } }
</style>

<div class="container">
  <div class="card-modern">
    <div class="toolbar" style="justify-content:space-between; margin-bottom:10px">
      <div class="toolbar">
        <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">← Geri</a>
        <a class="btn" href="{{ url_for('admin_refcodes_list') }}">Ref Kodları Yönetimi</a>
      </div>

      {% if totals %}
      <div class="toolbar">
        <span class="stat-chip">
          <span class="stat-dot" style="background:#94a3b8"></span>
          Toplam: {{ totals.all }}
        </span>
        <span class="stat-chip">
          <span class="stat-dot" style="background:#16a34a"></span>
          Aktif: {{ totals.active }}
        </span>
        <span class="stat-chip">
          <span class="stat-dot" style="background:#f59e0b"></span>
          Bekleyen: {{ totals.pending }}
        </span>
        <span class="stat-chip">
          <span class="stat-dot" style="background:#6b7280"></span>
          Devre dışı: {{ totals.disabled }}
        </span>
        <span class="stat-chip">
          <span class="stat-dot" style="background:#0b5ed7"></span>
          Admin: {{ totals.admins }}
        </span>
      </div>
      {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for c,m in messages %}
          <div class="flash {{c}}" style="margin:8px 0; padding:10px 12px; border-radius:10px; border:1px solid #eee; background:#fcfcfd">
            {{m}}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="table-wrap">
      <table class="table-modern">
        <thead>
          <tr>
            <th>Ad Soyad</th>
            <th>E-posta</th>
            <th>Ünvan</th>
            <th>Rol</th>
            <th>Durum</th>
            <th>Ref Kodu</th>
            <th class="table-actions">İşlem</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            {% set st = (u.status or 'pending') %}
            {% set is_self = (u.id == session.get('account_id')) %}
            <tr>
              <td style="min-width:180px;">
                <div style="font-weight:600">{{ u.contact_name }}</div>
                {% if is_self %}
                  <div class="muted" style="font-size:.85rem;">(Siz)</div>
                {% endif %}
              </td>

              <td style="min-width:220px;">{{ u.email }}</td>
              <td style="min-width:160px;">{{ u.contact_title or '—' }}</td>

              <td style="min-width:110px;">
                {% if (u.role or 'uzman') == 'admin' %}
                  <span class="badge badge-role-admin">admin</span>
                {% else %}
                  <span class="badge badge-role-uzman">uzman</span>
                {% endif %}
              </td>

              <td style="min-width:120px;">
                <span class="badge
                  {{ 'badge-status-active' if st=='active'
                     else 'badge-status-pending' if st=='pending'
                     else 'badge-status-disabled' }}">
                  {{ st }}
                </span>
              </td>

              <td style="min-width:170px;">
                {% if u.ref_code %}
                  <code>{{ u.ref_code }}</code>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>

              <td>
                <div class="row-actions">
                  {# Rol güncelle #}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        class="toolbar" style="gap:8px">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="set_role">
                    <select name="new_role" class="input" aria-label="Rol"
                            {% if is_self %}disabled{% endif %}>
                      <option value="uzman"
                        {{ 'selected' if (u.role or 'uzman')=='uzman' }}>uzman</option>
                      <option value="admin"
                        {{ 'selected' if u.role=='admin' }}>admin</option>
                    </select>
                    <button class="btn btn-primary" title="Rolü güncelle"
                            {% if is_self %}disabled{% endif %}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M4 12h16M4 6h16M4 18h10"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Güncelle
                    </button>
                  </form>

                  {# Durum güncelle #}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        class="toolbar" style="gap:8px">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="set_status">
                    <select name="new_status" class="input" aria-label="Durum"
                            {{ 'disabled' if is_self }}>
                      {% for st_opt in ['pending','active','disabled'] %}
                        <option value="{{ st_opt }}"
                          {{ 'selected' if st==st_opt else '' }}>
                          {{ st_opt }}
                        </option>
                      {% endfor %}
                    </select>
                    <button class="btn" {{ 'disabled' if is_self }}
                            title="Durumu güncelle">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="m4 12 4 4 12-12"
                              stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Kaydet
                    </button>
                    {% if is_self %}
                      <span class="muted" style="font-size:.85rem;">
                        Kendi hesabınızın rol ve durumunu buradan değiştiremezsiniz.
                      </span>
                    {% endif %}
                  </form>

                  {# Ref ata / e-posta bildir #}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        class="toolbar" style="gap:8px">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="assign_ref">
                    <input class="input" name="ref_code"
                           placeholder="Kod (boş: üret)"
                           value="{{ u.ref_code or '' }}" style="width:170px">
                    <label style="display:inline-flex; gap:6px; align-items:center; font-size:.9rem;">
                      <input type="checkbox" name="notify_email" value="1">
                      e-posta gönder
                    </label>
                    <button class="btn" title="Ref kod ata veya güncelle">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5v14M5 12h14"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Ref Ata/Güncelle
                    </button>
                  </form>

                  {# Gmail'de hazır mail aç #}
                  {% if u.ref_code and u.email %}
                    <a class="btn btn-secondary tiny"
                       href="{{ url_for('admin_compose_ref', uid=u.id) }}"
                       target="_blank"
                       title="Gmail'de hazır mail aç">
                      Gmail ile Gönder
                    </a>
                  {% endif %}

                  {# Ref kod temizle #}
                  {% if u.ref_code %}
                  <form method="post" action="{{ url_for('admin_users') }}"
                        onsubmit="return confirm('Ref kodu silinsin mi?');">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input type="hidden" name="action" value="clear_ref">
                    <button class="btn btn-danger tiny" title="Ref kodu temizle">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6l12 12M6 18 18 6"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      Ref Sil
                    </button>
                  </form>
                  {% endif %}
                </div>

                <div class="muted" style="margin-top:8px; font-size:.9em;">
                  {% if st != 'active' %}
                    Not: Bu kullanıcı giriş yapabilmek için <em>active</em> olmalı
                    ve kendisine bir <em>ref kodu</em> atanmalıdır.
                  {% else %}
                    Not: Girişte e-posta + şifre + <em>ref kodu</em> gereklidir.
                  {% endif %}
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="7" style="padding:18px; text-align:center" class="muted">
                Kayıtlı kullanıcı bulunamadı.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="toolbar" style="margin-top:14px">
      <a class="btn" href="{{ url_for('dashboard') }}">← Geri</a>
    </div>
  </div>
</div>
{% endblock %}
