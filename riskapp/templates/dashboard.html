{% extends "base.html" %}
{% block title %}Dashboard Â· Risk YÃ¶netim{% endblock %}
{% block content %}

<style>
  /* Dashboard'a Ã¶zgÃ¼ ufak dokunuÅŸlar */
  .kpis{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:14px; margin-bottom:14px; }
  @media (max-width: 980px){ .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  .kpi{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:14px 16px; border:1px solid #e8edf7; border-radius:12px;
    background: var(--card); box-shadow: var(--elev-card); backdrop-filter: var(--glass-blur);
  }
  [data-theme="dark"] .kpi{ border:1px solid rgba(255,255,255,.09); }
  .kpi .label{ font-weight:900; letter-spacing:.02em; color:var(--muted); font-size:.9rem }
  .kpi .value{ font-weight:900; font-size:1.25rem }

  .legend{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .legend .badge{ font-weight:900 }

  .empty{
    border:1px dashed var(--line); border-radius:12px; padding:22px; text-align:center; color:var(--muted)
  }

  /* ==========================================================
     RISK MATRIX â€” BaÅŸlÄ±klÄ± 5Ã—5 Ä±sÄ± haritasÄ± (PÃ—S)
     EÅŸikler: 1â€“3 yeÅŸil / 4â€“8 sarÄ± / 9â€“12 turuncu / 15â€“25 kÄ±rmÄ±zÄ±
     ========================================================== */
  .risk-matrix{
    display:grid;
    grid-template-columns: 160px repeat(5, 1fr);
    grid-auto-rows: 74px;
    gap: 8px;
    margin-top: 10px;
  }
  .rm-corner{
    display:grid; place-items:center;
    color:var(--muted);
    font-weight:900; text-transform:uppercase; letter-spacing:.08em;
    background:transparent;
  }
  .rm-colhead,.rm-rowhead{
    position:relative;
    display:flex; align-items:center; justify-content:space-between;
    gap:8px; padding:10px 12px;

    /* Fallback (VS Code ÅŸikayet etmez) */
    border:1px dashed var(--line-weak, rgba(0,0,0,.12));
    border-radius:12px;
    background: var(--bg-soft, rgba(0,0,0,.03));
  }
  /* TarayÄ±cÄ± destekliyorsa color-mix'e yÃ¼kselt */
  @supports (color: color-mix(in oklab, black, white)) {
    .rm-colhead,.rm-rowhead{
      border:1px dashed color-mix(in oklab, var(--line) 70%, transparent);
      background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
    }
  }

  .rm-colhead{ flex-direction:column; align-items:flex-start; }
  .rm-coltitle,.rm-rowtitle{ font-weight:900; }
  .rm-colnum,.rm-rownum{ font: 900 .9rem var(--mono, ui-monospace); opacity:.75; }

  .rm-cell{
    position:relative; display:grid; align-content:center; justify-items:center;
    border-radius: 12px;
    border: 2px solid rgba(0,0,0,.08);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.6);
    cursor: pointer;
    padding: 6px;
    transition: transform .06s ease, box-shadow .15s ease, filter .15s ease;
    text-decoration: none; color: inherit;
  }
  /* Fallback */
  .rm-cell:focus-visible{ outline:none; box-shadow: 0 0 0 4px rgba(59,130,246,.35); }
  /* color-mix destekliyse ring'i gÃ¼zelleÅŸtir */
  @supports (color: color-mix(in oklab, black, white)) {
    .rm-cell:focus-visible{ box-shadow: 0 0 0 4px color-mix(in oklab, var(--ring) 35%, transparent); }
  }
  .rm-cell:hover{ transform: translateY(-1px); filter: brightness(1.02); }

  .rm-score{ font: 900 1.1rem/1 var(--mono, ui-monospace); }
  .rm-count{
    position:absolute; right:8px; bottom:6px;
    font-weight:800; font-size:.86rem; opacity:.9;
    padding:.12rem .45rem; border-radius:999px;
    border:1px solid rgba(0,0,0,.12);
    background: rgba(255,255,255,.66);
  }
  [data-theme="dark"] .rm-count{ background: rgba(0,0,0,.25); border-color: rgba(255,255,255,.18); }

  /* renkler */
  .rm-cell.low  { background: #0f2f18; border-color:#1d5d3a; color:#bff5d3; }
  .rm-cell.mid  { background: #3a2e05; border-color:#7a5c0b; color:#ffe6a6; }
  .rm-cell.hi   { background: #4b2400; border-color:#a24e0a; color:#ffd7b5; }
  .rm-cell.crit { background: #3b0b0b; border-color:#7f1d1d; color:#ffd0d0; }

  html[data-theme="light"] .rm-cell.low  { background:#d1fae5; border-color:#9fe3c9; color:#0d3a2c; }
  html[data-theme="light"] .rm-cell.mid  { background:#fde68a; border-color:#f3c24f; color:#5a3f00; }
  html[data-theme="light"] .rm-cell.hi   { background:#fdba74; border-color:#f59e0b; color:#4a2500; }
  html[data-theme="light"] .rm-cell.crit { background:#fecaca; border-color:#f87171; color:#5a1010; }

  /* kÃ¶ÅŸe etiketleri (isteÄŸe baÄŸlÄ± yÃ¶n ipucu) */
  .risk-matrix .rm-corner::after{
    content:"OlasÄ±lÄ±k â†’"; font-weight:900; color:var(--muted);
  }
  .risk-matrix .rm-rowhead:first-of-type::before{
    content:"â†‘ Åiddet"; position:absolute; transform:rotate(-90deg) translate(-40%, -120%);
    transform-origin:left top; color:var(--muted); font-weight:900;
  }
</style>

{# ==== KPIâ€™leri hesapla (frontend) ==== #}
{% set ns = namespace(total=0, low=0, mid=0, high=0, sum=0.0, have=0) %}
{% for r in risks or [] %}
  {% set sc = r.score() %}
  {% if sc %}
    {% set ns.sum  = ns.sum + sc %}
    {% set ns.have = ns.have + 1 %}
    {% if sc <= 8 %}{% set ns.low = ns.low + 1 %}
    {% elif sc <= 15 %}{% set ns.mid = ns.mid + 1 %}
    {% else %}{% set ns.high = ns.high + 1 %}{% endif %}
  {% endif %}
  {% set ns.total = ns.total + 1 %}
{% endfor %}
{% set avg = (ns.sum / ns.have) if ns.have > 0 else None %}

<div class="kpis">
  <div class="kpi">
    <div class="label">Toplam Risk</div>
    <div class="value">{{ ns.total }}</div>
  </div>
  <div class="kpi">
    <div class="label">YÃ¼ksek Skor</div>
    <div class="value"><span class="badge score-high">{{ ns.high }}</span></div>
  </div>
  <div class="kpi">
    <div class="label">Orta / DÃ¼ÅŸÃ¼k</div>
    <div class="value">
      <span class="badge score-mid">{{ ns.mid }}</span>
      &nbsp;/&nbsp;
      <span class="badge score-low">{{ ns.low }}</span>
    </div>
  </div>
  <div class="kpi">
    <div class="label">Ortalama Skor</div>
    <div class="value">{{ avg and ('%.2f'|format(avg)) or 'â€”' }}</div>
  </div>
</div>

<div class="grid grid-2">
  <!-- Sol: Genel GÃ¶rÃ¼nÃ¼m -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Genel GÃ¶rÃ¼nÃ¼m</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="{{ url_for('risk_select') }}">Riskler</a>
        {% if session.get('role') == 'admin' %}
          <a class="btn" href="{{ url_for('categories_index') }}">Kategori YÃ¶netimi</a>
        {% endif %}
        <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
      </div>
    </div>

    {% if risks and risks|length > 0 %}
      <div class="table-wrap" style="overflow-x:auto;margin-top:8px">
        <table class="table">
          <thead>
            <tr>
              <th>BaÅŸlÄ±k</th>
              <th style="width:200px">Kategori</th>
              <th style="width:120px; text-align:center">Skor</th>
              <th style="width:160px">Durum</th>
            </tr>
          </thead>
          <tbody>
            {% for r in risks[:8] %}
            {% set sc = r.score() %}
            <tr>
              <td>
                <a href="{{ url_for('risk_detail', risk_id=r.id) }}">{{ r.title }}</a>
                {% if r.description %}
                  <div class="small" style="margin-top:2px; max-width:72ch; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    {{ r.description }}
                  </div>
                {% endif %}
              </td>
              <td>{{ r.category or "-" }}</td>
              <td style="text-align:center">
                {% if sc %}
                  <span class="badge {% if sc<=8 %}score-low{% elif sc<=15 %}score-mid{% else %}score-high{% endif %}"
                        title="PÃ—S = {{ '%.2f'|format(sc) if sc is number else sc }}">
                    {{ '%.2f'|format(sc) if sc is number else sc }}
                  </span>
                {% else %}<span class="badge">â€”</span>{% endif %}
              </td>
              <td>{{ r.status or 'â€”' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:6px">
        Son gÃ¼ncellenen 8 risk gÃ¶steriliyor. TÃ¼mÃ¼ iÃ§in â€œRisklerâ€ sayfasÄ±na gidin.
      </div>
    {% else %}
      <div class="empty">
        <h4 style="margin:0 0 .3rem">HenÃ¼z risk yok</h4>
        <div class="small">HÄ±zlÄ± baÅŸlamak iÃ§in bir ÅŸablon seÃ§in veya yeni bir risk oluÅŸturun.</div>
        <div style="margin-top:.6rem; display:flex; gap:8px; justify-content:center">
          <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
          <a class="btn" href="{{ url_for('risk_identify') }}">ğŸ“‹ Åablondan SeÃ§</a>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- SaÄŸ: Risk Matrisi (baÅŸlÄ±klÄ±) -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Risk Matrisi</h3>
      <div class="legend">
        <span class="badge score-low">1â€“3 DÃ¼ÅŸÃ¼k</span>
        <span class="badge score-mid">4â€“8 Orta</span>
        <span class="badge" style="background:rgba(253,186,116,.25);color:#4a2500;border-color:#f59e0b">9â€“12 YÃ¼ksek</span>
        <span class="badge" style="background:rgba(239,68,68,.20);color:#7a1e1e;border-color:#ef4444">15â€“25 Kritik</span>
      </div>
    </div>

    {% set prob_labels = ['Ã‡ok DÃ¼ÅŸÃ¼k','DÃ¼ÅŸÃ¼k','OlasÄ±','YÃ¼ksek','Ã‡ok YÃ¼ksek'] %}
    {% set sev_labels  = ['Ã–nemsiz','KÃ¼Ã§Ã¼k','Orta','BÃ¼yÃ¼k','Felaket'] %}

    <div class="risk-matrix" role="grid" aria-label="OlasÄ±lÄ±k Ã— Åiddet matrisi">
      <div class="rm-corner"></div>
      {% for p in range(1,6) %}
        <div class="rm-colhead" role="columnheader">
          <div class="rm-coltitle">{{ prob_labels[p-1] }}</div>
          <div class="rm-colnum">{{ p }}</div>
        </div>
      {% endfor %}

      {% for s in range(5,0,-1) %}
        <div class="rm-rowhead" role="rowheader">
          <div class="rm-rowtitle">{{ sev_labels[s-1] }}</div>
          <div class="rm-rownum">{{ s }}</div>
        </div>
        {% for p in range(1,6) %}
          {% set score = p * s %}
          {% set count = (matrix[5-s][p-1]) if matrix is defined else 0 %}
          {% set lvl = 'low' if score<=3 else ('mid' if score<=8 else ('hi' if score<=12 else 'crit')) %}
          <a class="rm-cell {{ lvl }}"
             href="{{ url_for('risk_select') }}?p={{p}}&s={{s}}"
             title="Åiddet {{s}} Â· OlasÄ±lÄ±k {{p}} â†’ Skor {{score}} Â· {{count}} adet"
             role="gridcell" aria-label="S={{s}}, P={{p}}, Skor {{score}}, {{count}} adet">
            <span class="rm-score">{{ score }}</span>
            <span class="rm-count">{{ count }}</span>
          </a>
        {% endfor %}
      {% endfor %}
    </div>

    <div class="small" style="margin-top:8px">
      HÃ¼crelerde bÃ¼yÃ¼k sayÄ± <strong>skor (PÃ—S)</strong>, saÄŸ altta <strong>adet</strong> gÃ¶sterilir.
    </div>
  </div>
</div>

<!-- Alt: HÄ±zlÄ± Ä°ÅŸlemler -->
<div class="card" style="margin-top:12px">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <h3 style="margin:0">HÄ±zlÄ± Ä°ÅŸlemler</h3>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <a class="btn" href="{{ url_for('risk_identify') }}">ğŸ“‹ Risk TanÄ±mla</a>
      {% if session.get('role') == 'admin' %}
        <a class="btn" href="{{ url_for('categories_index') }}">ğŸ—‚ï¸ Kategori YÃ¶netimi</a>
        <a class="btn" href="{{ url_for('import_suggestions') }}">â¬†ï¸ CSV Ä°Ã§e Aktar</a>
      {% endif %}
      <a class="btn" href="{{ url_for('risks_export_csv') }}">â¬‡ï¸ CSV DÄ±ÅŸa Aktar</a>
      <a class="btn" href="{{ url_for('settings_account') }}">âš™ï¸ Hesap AyarlarÄ±</a>
      <a class="btn" href="{{ url_for('settings_project') }}">ğŸ·ï¸ Proje Bilgileri</a>
    </div>
  </div>
</div>

{% endblock %}
