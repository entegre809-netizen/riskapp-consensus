{% extends "base.html" %}
{% block title %}Dashboard ¬∑ Risk Y√∂netim{% endblock %}
{% block content %}

<style>
  /* ================================
     RiskApp Dashboard ‚Äî Tailwind-look
     (SIFIR feature kaybƒ±: aynƒ± Jinja/JS)
     ================================ */

  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

  /* Bu sayfa √∂zel tipografi */
  .dash-scope{
    font-family: "Space Grotesk", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial;
  }

  /* --- Bu sayfada buton/rozetleri tailwind gibi yap (base‚Äôi bozma) --- */
  .dash-scope .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.5rem;
    padding: .72rem 1rem;
    border-radius: 12px;
    border: 1px solid rgba(148,163,184,.35);
    background: rgba(255,255,255,.85);
    color: #0f172a;
    text-decoration:none;
    font-weight: 700;
    font-size: .92rem;
    box-shadow: 0 10px 30px -18px rgba(15,23,42,.25);
    backdrop-filter: blur(10px);
    transition: transform .08s ease, filter .18s ease, border-color .18s ease;
  }
  [data-theme="dark"] .dash-scope .btn{
    background: rgba(30,33,38,.75);
    color: #e5e7eb;
    border-color: rgba(148,163,184,.18);
  }
  .dash-scope .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); border-color: rgba(40,102,189,.35); }

  .dash-scope .btn.btn-primary{
    background: #2866bd;
    border-color: #2866bd;
    color: #fff;
    box-shadow: 0 14px 36px -18px rgba(40,102,189,.65);
  }
  .dash-scope .btn.btn-primary:hover{ filter: brightness(1.03); }

  .dash-scope .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding: .22rem .55rem;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,.35);
    font-weight: 900;
    font-size: .85rem;
    line-height: 1;
    background: rgba(255,255,255,.7);
  }
  [data-theme="dark"] .dash-scope .badge{
    background: rgba(30,33,38,.55);
  }

  /* Base‚Äôteki score-low/mid/high varsa yine √ßalƒ±≈üƒ±r, yoksa fallback */
  .dash-scope .score-low { background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.35); color: #166534; }
  .dash-scope .score-mid { background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.38); color: #854d0e; }
  .dash-scope .score-high{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35); color: #7f1d1d; }
  [data-theme="dark"] .dash-scope .score-low { color:#86efac; }
  [data-theme="dark"] .dash-scope .score-mid { color:#fde68a; }
  [data-theme="dark"] .dash-scope .score-high{ color:#fecaca; }

  /* üîß Legend i√ßin ‚ÄúY√ºksek(11‚Äì15)‚Äù uyumlu rozet */
  .dash-scope .score-hi{
    background: rgba(251,146,60,.18);
    border-color: rgba(251,146,60,.38);
    color: #7c2d12;
  }
  [data-theme="dark"] .dash-scope .score-hi{ color:#fed7aa; }

  /* --- KPI‚Äôler --- */
  .kpis{
    display:grid;
    grid-template-columns: repeat(6, minmax(0,1fr));
    gap: 12px;
    margin-bottom: 14px;
  }
  @media (max-width: 1200px){ .kpis{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (max-width: 860px){  .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 520px){  .kpis{ grid-template-columns: 1fr; } }

  .kpi{
    padding: 16px;
    border-radius: 16px;
    border: 1px solid rgba(226,232,240,.9);
    background: rgba(255,255,255,.92);
    box-shadow: 0 14px 40px -26px rgba(15,23,42,.22);
    display:flex;
    flex-direction:column;
    gap: 10px;
    min-height: 88px;
  }
  [data-theme="dark"] .kpi{
    background: rgba(30,33,38,.72);
    border-color: rgba(51,65,85,.55);
  }
  .kpi .label{
    font-size: .72rem;
    text-transform: uppercase;
    letter-spacing: .12em;
    color: #64748b;
    font-weight: 900;
  }
  [data-theme="dark"] .kpi .label{ color:#94a3b8; }
  .kpi .value{
    font-size: 1.65rem;
    font-weight: 900;
    letter-spacing: -0.02em;
    display:flex; align-items:center; justify-content:space-between;
  }

  .kpi.primary{
    background: #2866bd;
    border-color: #2866bd;
    color: #fff;
    box-shadow: 0 18px 50px -28px rgba(40,102,189,.75);
  }
  .kpi.primary .label{ color: rgba(255,255,255,.55); }
  .kpi.primary .value{ color:#fff; }

  /* --- Kartlar --- */
  .card{
    border-radius: 16px;
    border: 1px solid rgba(226,232,240,.9);
    background: rgba(255,255,255,.92);
    box-shadow: 0 14px 40px -26px rgba(15,23,42,.22);
    padding: 16px;
    min-width: 0;
  }
  [data-theme="dark"] .card{
    background: rgba(30,33,38,.72);
    border-color: rgba(51,65,85,.55);
  }

  .grid{ display:grid; gap: 12px; }
  .grid-2{ grid-template-columns: 1.7fr 1fr; }
  @media (max-width: 980px){ .grid-2{ grid-template-columns: 1fr; } }

  .card-head{
    display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(226,232,240,.75);
    margin-bottom: 12px;
  }
  [data-theme="dark"] .card-head{ border-color: rgba(51,65,85,.45); }

  .card-title{
    margin:0;
    display:flex; align-items:center; gap:10px;
    font-weight: 900;
    font-size: 1.05rem;
  }
  .pill{
    width: 34px; height: 34px;
    border-radius: 12px;
    display:grid; place-items:center;
    background: rgba(40,102,189,.14);
    border: 1px solid rgba(40,102,189,.22);
    color:#2866bd;
    font-weight: 900;
  }

  /* --- Tablo --- */
  .table-wrap{ overflow:auto; border-radius: 14px; }
  .table{
    width:100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 720px;
  }
  .table thead th{
    position: sticky;
    top: 0;
    z-index: 1;
    background: rgba(248,250,252,.92);
    color:#64748b;
    font-size: .74rem;
    text-transform: uppercase;
    letter-spacing: .12em;
    font-weight: 900;
    padding: 14px 14px;
    border-bottom: 1px solid rgba(226,232,240,.9);
  }
  [data-theme="dark"] .table thead th{
    background: rgba(18,24,32,.68);
    color:#94a3b8;
    border-color: rgba(51,65,85,.55);
  }
  .table td{
    padding: 14px 14px;
    border-bottom: 1px solid rgba(226,232,240,.75);
    vertical-align: top;
    font-size: .95rem;
  }
  [data-theme="dark"] .table td{ border-color: rgba(51,65,85,.45); }
  .table tbody tr:hover td{ background: rgba(40,102,189,.04); }
  [data-theme="dark"] .table tbody tr:hover td{ background: rgba(40,102,189,.08); }

  /* --- Risk matrix --- */
  .risk-matrix{
    --label-w: 140px;
    --cell-size: 60px;
    display:grid;
    grid-template-columns: var(--label-w) repeat(5, var(--cell-size));
    grid-auto-rows: var(--cell-size);
    gap: 8px;
    margin-top: 10px;
  }
  @media (max-width: 980px){ .risk-matrix{ --label-w: 120px; --cell-size: 56px; } }
  @media (max-width: 640px){ .risk-matrix{ --label-w: 112px; --cell-size: 52px; } }

  .rm-corner{ display:grid; place-items:center; color:#94a3b8; font-weight:900; }
  .rm-corner::after{ content:"Olasƒ±lƒ±k ‚Üí"; }

  .rm-colhead,.rm-rowhead{
    border-radius: 14px;
    padding: 10px 10px;
    border: 1px solid rgba(226,232,240,.9);
    background: rgba(248,250,252,.85);
    display:flex;
    justify-content:space-between;
    gap: 8px;
    align-items:flex-start;
  }
  [data-theme="dark"] .rm-colhead, [data-theme="dark"] .rm-rowhead{
    border-color: rgba(51,65,85,.55);
    background: rgba(18,24,32,.55);
  }
  .rm-colhead{ flex-direction:column; }
  .rm-coltitle,.rm-rowtitle{ font-weight: 900; font-size: .86rem; }
  .rm-colnum,.rm-rownum{ font-weight: 900; opacity:.6; }

  .risk-matrix .rm-rowhead:first-of-type::before{
    content:"‚Üë ≈ûiddet";
    position:absolute;
    transform: rotate(-90deg) translate(-40%, -120%);
    transform-origin:left top;
    color: #94a3b8;
    font-weight: 900;
  }

  /* ‚úÖ FIX: skor ortada, adet saƒü-altta; √ºst √ºste binme yok */
  .rm-cell{
    position:relative;
    border-radius: 14px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    font-weight: 900;
    border: 1px solid rgba(0,0,0,.06);
    transition: transform .08s ease, filter .16s ease;
    overflow:hidden;
    min-height: var(--cell-size);
  }
  .rm-cell:hover{ transform: translateY(-1px); filter: brightness(1.02); }
  .rm-cell:focus-visible{ outline: 4px solid rgba(40,102,189,.22); outline-offset: 2px; }

  .rm-score{
    font: 900 1.06rem/1 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
    letter-spacing: -0.02em;
  }

  .rm-count{
    position:absolute;
    right: 6px;
    bottom: 6px;
    font-weight: 900;
    font-size: .72rem;
    padding: .12rem .42rem;
    border-radius: 999px;
    background: rgba(255,255,255,.55);
    border: 1px solid rgba(0,0,0,.10);
    line-height: 1;
    pointer-events: none;
  }
  [data-theme="dark"] .rm-count{
    background: rgba(0,0,0,.28);
    border-color: rgba(255,255,255,.14);
  }

  /* renk e≈üikleri */
  html[data-theme="light"] .rm-cell.low  { background:#d1fae5; border-color:#9fe3c9; color:#0d3a2c; }
  html[data-theme="light"] .rm-cell.mid  { background:#fde68a; border-color:#f3c24f; color:#5a3f00; }
  html[data-theme="light"] .rm-cell.hi   { background:#fdba74; border-color:#f59e0b; color:#4a2500; }
  html[data-theme="light"] .rm-cell.crit { background:#fecaca; border-color:#f87171; color:#5a1010; }

  [data-theme="dark"] .rm-cell.low  { background:#0f2f18; border-color:#1d5d3a; color:#bff5d3; }
  [data-theme="dark"] .rm-cell.mid  { background:#3a2e05; border-color:#7a5c0b; color:#ffe6a6; }
  [data-theme="dark"] .rm-cell.hi   { background:#4b2400; border-color:#a24e0a; color:#ffd7b5; }
  [data-theme="dark"] .rm-cell.crit { background:#3b0b0b; border-color:#7f1d1d; color:#ffd0d0; }

  /* Donut alanlarƒ± */
  .donut-grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
  @media (max-width: 980px){ .donut-grid{ grid-template-columns: 1fr; } }
  .donut-card{
    border: 1px solid rgba(226,232,240,.9);
    background: rgba(255,255,255,.92);
    border-radius: 16px;
    padding: 14px;
  }
  [data-theme="dark"] .donut-card{
    border-color: rgba(51,65,85,.55);
    background: rgba(18,24,32,.55);
  }
  .donut-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 8px; }
  .donut-title{ font-weight: 900; }

  .legend-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
  .legend-chip{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid rgba(226,232,240,.9);
    background: rgba(248,250,252,.65);
    border-radius:999px;
    padding: 4px 10px;
    font-weight: 900;
    font-size: .86rem;
  }
  [data-theme="dark"] .legend-chip{
    border-color: rgba(51,65,85,.55);
    background: rgba(30,33,38,.45);
  }
  .chip-dot{ width:10px; height:10px; border-radius:999px; }

  .small{ color:#64748b; }
  [data-theme="dark"] .small{ color:#94a3b8; }

  .empty{
    border: 2px dashed rgba(226,232,240,.9);
    border-radius: 16px;
    padding: 22px;
    text-align:center;
    background: rgba(248,250,252,.65);
    color:#64748b;
  }
  [data-theme="dark"] .empty{
    border-color: rgba(51,65,85,.55);
    background: rgba(18,24,32,.55);
    color:#94a3b8;
  }

  .quick-actions{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .quick-actions .btns{ display:flex; gap:8px; flex-wrap:wrap; }
</style>

<div class="dash-scope">

  {# ==== KPI hesap: her risk i√ßin Risk.score() (detaydakiyle aynƒ±) ==== #}
  {% set ns = namespace(total=0, low=0, mid=0, high=0, crit=0, sum=0.0, have=0) %}
  {% for r in risks or [] %}
    {% set sc = r.score() %}
    {% if sc is not none %}
      {% set ns.sum  = ns.sum + sc %}
      {% set ns.have = ns.have + 1 %}
      {# 1‚Äì4 D√º≈ü√ºk, 5‚Äì10 Orta, 11‚Äì15 Y√ºksek, 16‚Äì25 √áok Y√ºksek #}
      {% if sc <= 4 %}
        {% set ns.low = ns.low + 1 %}
      {% elif sc <= 10 %}
        {% set ns.mid = ns.mid + 1 %}
      {% elif sc <= 15 %}
        {% set ns.high = ns.high + 1 %}
      {% else %}
        {% set ns.crit = ns.crit + 1 %}
      {% endif %}
    {% endif %}
    {% set ns.total = ns.total + 1 %}
  {% endfor %}
  {% set avg = (ns.sum / ns.have) if ns.have > 0 else None %}

  <!-- ===== KPIs ===== -->
  <div class="kpis" role="list" aria-label="√ñzet g√∂stergeler">
    <div class="kpi" role="listitem">
      <div class="label">Total Risk</div>
      <div class="value">{{ ns.total }}</div>
    </div>

    <div class="kpi" role="listitem">
      <div class="label">Critical</div>
      <div class="value"><span class="badge score-high">{{ ns.crit }}</span></div>
    </div>

    <div class="kpi" role="listitem">
      <div class="label">High</div>
      <div class="value"><span class="badge score-high">{{ ns.high }}</span></div>
    </div>

    <div class="kpi" role="listitem">
      <div class="label">Medium</div>
      <div class="value"><span class="badge score-mid">{{ ns.mid }}</span></div>
    </div>

    <div class="kpi" role="listitem">
      <div class="label">Low</div>
      <div class="value"><span class="badge score-low">{{ ns.low }}</span></div>
    </div>

    <div class="kpi primary" role="listitem">
      <div class="label">Avg Score</div>
      <div class="value">{{ avg and ('%.2f'|format(avg)) or '‚Äî' }}</div>
    </div>
  </div>

  <!-- ===== √úST ƒ∞Kƒ∞Lƒ∞: Genel G√∂r√ºn√ºm + Risk Matrisi ===== -->
  <div class="grid grid-2">
    <!-- Sol: Genel G√∂r√ºn√ºm -->
    <div class="card" aria-labelledby="genelTitle">
      <div class="card-head">
        <h3 id="genelTitle" class="card-title"><span class="pill">‚â°</span>General Overview</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="{{ url_for('risk_select') }}">View All Risks</a>
          {% if session.get('role') == 'admin' %}
            <a class="btn" href="{{ url_for('categories_index') }}">Category Management</a>
          {% endif %}
          <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Define Risk</a>
        </div>
      </div>

      {% if risks and risks|length > 0 %}
        <div class="table-wrap" style="margin-top:8px">
          <table class="table">
            <thead>
              <tr>
                <th>Risk Title</th>
                <th style="width:200px">Category</th>
                <th style="width:120px; text-align:center">Impact</th>
                <th style="width:160px">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for r in risks[:8] %}
              {% set sc = r.score() %}
              <tr>
                <td>
                  <a href="{{ url_for('risk_detail', risk_id=r.id) }}">{{ r.title }}</a>
                  {% if r.description %}
                    <div class="small" style="margin-top:4px; max-width:72ch; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                      {{ r.description }}
                    </div>
                  {% endif %}
                </td>
                <td>{{ r.category or "-" }}</td>
                <td style="text-align:center">
                  {% if sc is not none %}
                    <span class="badge
                                {% if sc<=4 %}score-low
                                {% elif sc<=10 %}score-mid
                                {% else %}score-high{% endif %}"
                          title="Skor: {{ '%.2f'|format(sc) }}">
                      {{ '%.2f'|format(sc) }}
                    </span>
                  {% else %}
                    <span class="badge">‚Äî</span>
                  {% endif %}
                </td>
                <td>{{ r.status or '‚Äî' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px">
          Son g√ºncellenen 8 risk g√∂steriliyor. T√ºm√º i√ßin ‚ÄúRiskler‚Äù sayfasƒ±na gidin.
        </div>
      {% else %}
        <div class="empty" role="note" aria-live="polite">
          <h4 style="margin:0 0 .3rem; font-weight:900;">Hen√ºz risk yok</h4>
          <div class="small">Hƒ±zlƒ± ba≈ülamak i√ßin bir ≈üablon se√ßin veya yeni bir risk olu≈üturun.</div>
          <div style="margin-top:.8rem; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
            <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
            <a class="btn" href="{{ url_for('risk_identify') }}">üìã ≈ûablondan Se√ß</a>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Saƒü: Risk Matrisi -->
    <div class="card" aria-labelledby="matrixTitle">
      <div class="card-head">
        <h3 id="matrixTitle" class="card-title"><span class="pill">‚ñ¶</span>Risk Matrix</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <span class="badge score-low">1‚Äì4</span>
          <span class="badge score-mid">5‚Äì10</span>
          <span class="badge score-hi">11‚Äì15</span>
          <span class="badge score-high">16‚Äì25</span>
        </div>
      </div>

      {% set prob_labels = ['√áok D√º≈ü√ºk','D√º≈ü√ºk','Orta','Y√ºksek','√áok Y√ºksek'] %}
      {% set sev_labels  = ['√áok D√º≈ü√ºk','D√º≈ü√ºk','Orta','Y√ºksek','√áok Y√ºksek'] %}

      <div class="risk-matrix" role="grid" aria-label="Olasƒ±lƒ±k √ó ≈ûiddet matrisi">
        <div class="rm-corner" aria-hidden="true"></div>

        {# Olasƒ±lƒ±k: 5 ‚Üí 1 (√áok Y√ºksek ‚Üí √áok D√º≈ü√ºk) #}
        {% for p in range(5,0,-1) %}
          <div class="rm-colhead" role="columnheader" aria-label="Olasƒ±lƒ±k {{p}}: {{ prob_labels[p-1] }}">
            <div class="rm-coltitle">{{ prob_labels[p-1] }}</div>
            <div class="rm-colnum">{{ p }}</div>
          </div>
        {% endfor %}

        {# Satƒ±rlar: ≈ûiddet 5 ‚Üí 1 #}
        {% for s in range(5,0,-1) %}
          <div class="rm-rowhead" role="rowheader" aria-label="≈ûiddet {{s}}: {{ sev_labels[s-1] }}" style="position:relative">
            <div class="rm-rowtitle">{{ sev_labels[s-1] }}</div>
            <div class="rm-rownum">{{ s }}</div>
          </div>

          {% for p in range(5,0,-1) %}
            {% set score = p * s %}
            {% set lvl = 'low' if score<=4 else ('mid' if score<=10 else ('hi' if score<=15 else 'crit')) %}

            {% set cell = namespace(cnt=0) %}
            {% for r in risks or [] %}
              {% set evals = (r.evaluations or [])|sort(attribute='id') %}
              {% if evals %}
                {% set last_eval = evals|last %}
                {% if last_eval.probability == p and last_eval.severity == s %}
                  {% set cell.cnt = cell.cnt + 1 %}
                {% endif %}
              {% endif %}
            {% endfor %}

            <a class="rm-cell {{ lvl }}"
               href="{{ url_for('risk_select') }}?p={{p}}&s={{s}}"
               title="≈ûiddet {{s}} ¬∑ Olasƒ±lƒ±k {{p}} ‚Üí Skor {{score}} ¬∑ {{cell.cnt}} adet"
               role="gridcell"
               aria-label="S={{s}}, P={{p}}, Skor {{score}}, {{cell.cnt}} adet"
               tabindex="0">
              <span class="rm-score">{{ score }}</span>
              <span class="rm-count">{{ cell.cnt }}</span>
            </a>
          {% endfor %}
        {% endfor %}
      </div>

      <div class="small" style="margin-top:10px">
        H√ºcrelerde b√ºy√ºk sayƒ± <strong>skor (P√óS)</strong>, saƒü altta <strong>adet</strong> g√∂sterilir.
      </div>
    </div>
  </div>

  <!-- ===== Donut‚Äôlar ===== -->
  <div class="card" style="margin-top:12px" aria-labelledby="donutTitle">
    <div class="card-head">
      <h3 id="donutTitle" class="card-title"><span class="pill">‚óé</span>Category & Risk Distribution</h3>
      <div class="small">D√º≈ü√ºk / Orta / Y√ºksek / √áok Y√ºksek</div>
    </div>

    {% if category_stats and category_stats|length > 0 %}
      <script id="categoryStats" type="application/json">{{ category_stats|tojson }}</script>

      <div class="donut-grid">
        <div class="donut-card">
          <div class="donut-head">
            <div class="donut-title">1- Kategori Bazƒ±nda Daƒüƒ±lƒ±m</div>
            <div class="small" id="catTotal"></div>
          </div>
          <canvas id="donut-categories" height="220" aria-label="Kategori daƒüƒ±lƒ±m donut" role="img"></canvas>
          <div class="legend-row" id="legend-cats"></div>
        </div>

        <div class="donut-card">
          <div class="donut-head">
            <div class="donut-title">2- Risk Seviyeleri (Toplam)</div>
          </div>
          <canvas id="donut-levels" height="220" aria-label="Seviye daƒüƒ±lƒ±m donut" role="img"></canvas>
          <div class="legend-row" id="legend-levels"></div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        (function(){
          const raw = document.getElementById('categoryStats');
          const stats = raw ? JSON.parse(raw.textContent || '[]') : [];
          const rows = stats.filter(r => (r.cat || '').toLowerCase() !== 'toplam riskler');

          // üîß 1. renk primary (#2866bd) ‚Äî marka tutarlƒ±lƒ±ƒüƒ±
          const PALETTE = ['#2866bd','#60a5fa','#34d399','#f59e0b','#ef4444','#a78bfa','#f472b6','#22d3ee','#84cc16','#fb7185','#f97316'];
          const LEVEL_COLORS = { low:'#22c55e', mid:'#f59e0b', high:'#fb923c', vhigh:'#ef4444' };

          // 1) Kategori Donut
          const catLabels = rows.map(r => r.cat);
          const catCounts = rows.map(r => Number(r.total)||0);
          const catColors = catLabels.map((_,i)=> PALETTE[i % PALETTE.length]);

          new Chart(document.getElementById('donut-categories').getContext('2d'), {
            type: 'doughnut',
            data: { labels: catLabels, datasets: [{ data: catCounts, backgroundColor: catColors, borderWidth: 0 }]},
            options: {
              cutout: '65%',
              plugins: {
                legend: { display:false },
                tooltip: { callbacks:{ label:(c)=> `${c.label}: ${c.parsed} adet` } }
              }
            }
          });

          const totalCat = catCounts.reduce((a,b)=>a+b,0);
          const catTotalEl = document.getElementById('catTotal');
          if (catTotalEl) catTotalEl.textContent = `${totalCat} adet`;

          const legendCats = document.getElementById('legend-cats');
          catLabels.forEach((lbl, i) => {
            const n = catCounts[i]||0;
            const el = document.createElement('span');
            el.className = 'legend-chip';
            el.innerHTML = `<span class="chip-dot" style="background:${catColors[i]}"></span>${lbl} (${n})`;
            legendCats.appendChild(el);
          });

          // 2) Seviye Donut
          const sum = k => rows.reduce((a,r)=> a + (Number(r[k])||0), 0);
          const lvlLabels = ['D√º≈ü√ºk','Orta','Y√ºksek','√áok Y√ºksek'];
          const lvlKeys   = ['low','mid','high','vhigh'];
          const lvlData   = lvlKeys.map(k => sum(k));
          const lvlColors = lvlKeys.map(k => LEVEL_COLORS[k]);

          new Chart(document.getElementById('donut-levels').getContext('2d'), {
            type: 'doughnut',
            data: { labels: lvlLabels, datasets: [{ data: lvlData, backgroundColor: lvlColors, borderWidth: 0 }]},
            options: {
              cutout: '65%',
              plugins: {
                legend: { display:false },
                tooltip: { callbacks:{ label:(c)=> `${c.label}: ${c.parsed} adet` } }
              }
            }
          });

          const legendLvls = document.getElementById('legend-levels');
          lvlLabels.forEach((lbl, i) => {
            const el = document.createElement('span');
            el.className = 'legend-chip';
            el.innerHTML = `<span class="chip-dot" style="background:${lvlColors[i]}"></span>${lbl} (${lvlData[i]})`;
            legendLvls.appendChild(el);
          });
        })();
      </script>
    {% else %}
      <div class="empty">Grafik olu≈üturmak i√ßin yeterli veri yok.</div>
    {% endif %}
  </div>

  <!-- ===== Hƒ±zlƒ± ƒ∞≈ülemler ===== -->
  <div class="card" style="margin-top:12px">
    <div class="quick-actions">
      <h3 style="margin:0; font-weight:900;">Quick Actions</h3>
      <div class="btns">
        <a class="btn" href="{{ url_for('risk_identify') }}">üìã Risk Tanƒ±mla</a>
        {% if session.get('role') == 'admin' %}
          <a class="btn" href="{{ url_for('categories_index') }}">üóÇÔ∏è Kategori Y√∂netimi</a>
          <a class="btn" href="{{ url_for('import_suggestions') }}">‚¨ÜÔ∏è CSV ƒ∞√ße Aktar</a>
        {% endif %}
        <a class="btn" href="{{ url_for('risks_export_csv') }}">‚¨áÔ∏è CSV Dƒ±≈üa Aktar</a>
        <a class="btn" href="{{ url_for('settings_account') }}">‚öôÔ∏è Hesap Ayarlarƒ±</a>
        <a class="btn" href="{{ url_for('settings_project') }}">üè∑Ô∏è Proje Bilgileri</a>
      </div>
    </div>
  </div>

</div>

{% endblock %}
