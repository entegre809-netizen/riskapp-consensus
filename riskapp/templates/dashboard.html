{% extends "base.html" %}
{% block title %}Dashboard · Risk Yönetim{% endblock %}
{% block content %}

<style>
  /* ================================
     DASHBOARD — Modern 2026 dokunuşu
     (base.html token’larıyla uyumlu)
     ================================ */

  /* ----- KPI’ler ----- */
  .kpis{
    display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:14px; margin-bottom:14px;
  }
  @media (max-width: 1200px){ .kpis{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (max-width: 980px){  .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 540px){  .kpis{ grid-template-columns: 1fr; } }

  .kpi{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:14px 16px; border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:14px;
    background: var(--card);
    box-shadow: var(--elev-card);
    backdrop-filter: var(--glass-blur);
    transition: transform .08s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
  }
  .kpi:hover{ transform: translateY(-1px); filter:brightness(1.02); }
  [data-theme="dark"] .kpi{ border:1px solid rgba(255,255,255,.10); }

  .kpi .label{ font-weight:900; letter-spacing:.02em; color:var(--text-dim); font-size:.9rem }
  .kpi .value{ font-weight:900; font-size:1.28rem; display:flex; align-items:center; gap:6px }

  /* ----- Genel grid kartları ----- */
  .card{
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:14px; background:var(--card); box-shadow: var(--elev-card);
    padding:16px; backdrop-filter: var(--glass-blur);
  }
  [data-theme="dark"] .card{ border:1px solid rgba(255,255,255,.10); }

  .grid{ display:grid; gap:14px }
  .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)) }
  @media (max-width: 980px){ .grid-2{ grid-template-columns: 1fr } }

  .legend{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .legend .badge{ font-weight:900 }

  .empty{
    border:2px dashed color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:14px; padding:24px; text-align:center; color:var(--text-dim);
    background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
  }

  /* ===========================
     RISK MATRIX — 5×5 ısı haritası
     Eşikler: 1–3 yeşil / 4–8 sarı / 9–12 turuncu / 15–25 kırmızı
     =========================== */
  .risk-matrix{
    display:grid;
    grid-template-columns: 160px repeat(5, 1fr);
    grid-auto-rows: 74px;
    gap: 8px;
    margin-top: 10px;
  }
  @media (max-width: 720px){
    .risk-matrix{ grid-template-columns: 120px repeat(5, 1fr); grid-auto-rows: 64px; }
  }

  .rm-corner{
    display:grid; place-items:center;
    color:var(--text-dim); font-weight:900; text-transform:uppercase; letter-spacing:.08em;
  }
  .rm-colhead,.rm-rowhead{
    position:relative; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px;
    border:1px dashed color-mix(in oklab, var(--line) 70%, transparent);
    border-radius:12px; background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
    font-weight:800;
  }
  .rm-colhead{ flex-direction:column; align-items:flex-start; }
  .rm-coltitle,.rm-rowtitle{ font-weight:900; }
  .rm-colnum,.rm-rownum{ font: 900 .9rem var(--mono); opacity:.75; }

  .rm-cell{
    position:relative; display:grid; align-content:center; justify-items:center;
    border-radius: 12px; border: 2px solid rgba(0,0,0,.06);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.6);
    cursor: pointer; padding: 6px;
    transition: transform .06s ease, box-shadow .15s ease, filter .15s ease, outline-color .15s ease;
    text-decoration: none; color: inherit; user-select:none;
  }
  .rm-cell:hover{ transform: translateY(-1px); filter: brightness(1.02); }
  .rm-cell:focus-visible{
    outline: 4px solid color-mix(in oklab, var(--ring) 35%, transparent);
    outline-offset: 1px;
  }

  .rm-score{ font: 900 1.1rem/1 var(--mono); }
  .rm-count{
    position:absolute; right:8px; bottom:6px;
    font-weight:800; font-size:.86rem; opacity:.92;
    padding:.12rem .45rem; border-radius:999px;
    border:1px solid rgba(0,0,0,.12);
    background: rgba(255,255,255,.66);
  }
  [data-theme="dark"] .rm-count{ background: rgba(0,0,0,.25); border-color: rgba(255,255,255,.18); }

  /* renkler */
  .rm-cell.low  { background: #0f2f18; border-color:#1d5d3a; color:#bff5d3; }
  .rm-cell.mid  { background: #3a2e05; border-color:#7a5c0b; color:#ffe6a6; }
  .rm-cell.hi   { background: #4b2400; border-color:#a24e0a; color:#ffd7b5; }
  .rm-cell.crit { background: #3b0b0b; border-color:#7f1d1d; color:#ffd0d0; }

  html[data-theme="light"] .rm-cell.low  { background:#d1fae5; border-color:#9fe3c9; color:#0d3a2c; }
  html[data-theme="light"] .rm-cell.mid  { background:#fde68a; border-color:#f3c24f; color:#5a3f00; }
  html[data-theme="light"] .rm-cell.hi   { background:#fdba74; border-color:#f59e0b; color:#4a2500; }
  html[data-theme="light"] .rm-cell.crit { background:#fecaca; border-color:#f87171; color:#5a1010; }

  .risk-matrix .rm-corner::after{
    content:"Olasılık →"; font-weight:900; color:var(--text-dim);
  }
  .risk-matrix .rm-rowhead:first-of-type::before{
    content:"↑ Şiddet"; position:absolute; transform:rotate(-90deg) translate(-40%, -120%);
    transform-origin:left top; color:var(--text-dim); font-weight:900;
  }

  /* ----- Donut’lar ----- */
  .donut-grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
  @media (max-width:980px){ .donut-grid{ grid-template-columns:1fr; } }
  .donut-card{ border:1px solid color-mix(in oklab, var(--line) 80%, transparent); border-radius:14px; padding:12px; background:var(--card); }
  [data-theme="dark"] .donut-card{ border:1px solid rgba(255,255,255,.10); }
  .donut-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:10px; flex-wrap:wrap }
  .donut-title{ font-weight:900; }
  .legend-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .legend-chip{ display:inline-flex; align-items:center; gap:6px; border:1px solid color-mix(in oklab, var(--line) 80%, transparent); border-radius:999px; padding:2px 8px; font-weight:800; }
  [data-theme="dark"] .legend-chip{ border:1px solid rgba(255,255,255,.14); }
  .chip-dot{ width:10px; height:10px; border-radius:999px; display:inline-block }

  /* ----- Tablo ----- */
  .table-wrap{ overflow:auto; border-radius:14px; }
  .table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px }
  .table th,.table td{
    padding:.72rem .9rem; border-bottom:1px solid color-mix(in oklab, var(--line) 84%, transparent);
    text-align:left; font-size:.95rem; vertical-align:top;
  }
  .table thead th{
    font-size:.80rem; text-transform:uppercase; letter-spacing:.09em;
    color:var(--text-dim);
    position:sticky; top:0; z-index:1;
    background: color-mix(in oklab, var(--surface) 84%, transparent);
    backdrop-filter: blur(4px);
    border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    font-weight:900;
  }
  .table tbody tr:hover td{ background: color-mix(in oklab, var(--primary) 6%, transparent) }

  .quick-actions{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap }
  .quick-actions .btns{ display:flex; flex-wrap:wrap; gap:8px }


  /* =========================================================
     Layout Stabilization Kit — cihazlar arası kaymaları azaltır
     ========================================================= */

  /* 0) Tutarlı ölçüm */
  *, *::before, *::after { box-sizing: border-box; }

  /* 1) Tutarlı font ailesi + metrikler */
  :root{
    --font-sans: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    --base-font-px: 14.5px;
  }
  html, body{ font-family: var(--font-sans); line-height: 1.25; }

  /* 2) Taban yazı boyutunu rem ile yönet (vw/clamp yok) */
  html { font-size: var(--base-font-px); }
  @media (max-width: 1280px){ html{ font-size: 14px; } }
  @media (max-width: 980px){  html{ font-size: 13.5px; } }
  @media (max-width: 540px){  html{ font-size: 13px; } }

  /* 3) Risk Matrisi: ölçüleri değişkenle kilitle, sarmayı engelle */
  .risk-matrix{
    --label-w: 140px;
    --cell-size: 64px;
    grid-template-columns: var(--label-w) repeat(5, var(--cell-size));
    grid-auto-rows: var(--cell-size);
    gap: 8px;
    margin-top: 10px;
  }
  @media (max-width: 980px){
    .risk-matrix{ --label-w: 120px; --cell-size: 58px; }
  }
  @media (max-width: 640px){
    .risk-matrix{ --label-w: 110px; --cell-size: 52px; }
  }
  .rm-colhead, .rm-rowhead{ white-space: nowrap; min-width: 0; padding:8px 10px; border-radius:10px; }
  .rm-coltitle, .rm-rowtitle{ overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
  .rm-colnum, .rm-rownum{ flex-shrink: 0; }
  .rm-cell{ padding:4px; border-width:1.5px; border-radius:10px; }
  .rm-score{ font: 900 1rem/1 var(--mono); }
  .rm-count{ right:6px; bottom:5px; font-size:.78rem; white-space: nowrap; }

  /* 4) Kart/KPI’larda daha güvenli min ölçüler */
  .kpi{ min-height: 48px; }
  .card{ min-width: 0; }

  /* 5) Tablo başlıkları ve scrollbar istikrarı */
  .table thead th{ white-space: nowrap; }
  .table-wrap{ scrollbar-gutter: stable both-edges; }

  /* 6) color-mix desteklenmiyorsa sınır rengi fallback */
  @supports not (color: color-mix(in oklab, white 50%, black)) {
    .kpi, .card, .legend-chip, .table th, .table td { border-color: var(--line); }
  }
</style>

{# ==== KPI hesap (frontend): risks + r.score() üzerinden ==== #}
{% set ns = namespace(total=0, low=0, mid=0, high=0, sum=0.0, have=0) %}
{% for r in risks or [] %}
  {% set sc = r.score() %}
  {% if sc %}
    {% set ns.sum  = ns.sum + sc %}
    {% set ns.have = ns.have + 1 %}
    {% if sc <= 8 %}{% set ns.low = ns.low + 1 %}
    {% elif sc <= 15 %}{% set ns.mid = ns.mid + 1 %}
    {% else %}{% set ns.high = ns.high + 1 %}{% endif %}
  {% endif %}
  {% set ns.total = ns.total + 1 %}
{% endfor %}
{% set avg = (ns.sum / ns.have) if ns.have > 0 else None %}

<!-- ===== KPIs ===== -->
<div class="kpis" role="list" aria-label="Özet göstergeler">
  <div class="kpi" role="listitem">
    <div class="label">Toplam Risk</div>
    <div class="value">{{ ns.total }}</div>
  </div>
  <div class="kpi" role="listitem">
    <div class="label">Yüksek Skor</div>
    <div class="value"><span class="badge score-high">{{ ns.high }}</span></div>
  </div>
  <div class="kpi" role="listitem">
    <div class="label">Orta / Düşük</div>
    <div class="value">
      <span class="badge score-mid">{{ ns.mid }}</span>
      &nbsp;/&nbsp;
      <span class="badge score-low">{{ ns.low }}</span>
    </div>
  </div>
  <div class="kpi" role="listitem">
    <div class="label">Ortalama Skor</div>
    <div class="value">{{ avg and ('%.2f'|format(avg)) or '—' }}</div>
  </div>
</div>

<!-- ===== ÜST İKİLİ: Genel Görünüm + Risk Matrisi ===== -->
<div class="grid grid-2">
  <!-- Sol: Genel Görünüm -->
  <div class="card" aria-labelledby="genelTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 id="genelTitle" style="margin:0">Genel Görünüm</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="{{ url_for('risk_select') }}">Riskler</a>
        {% if session.get('role') == 'admin' %}
          <a class="btn" href="{{ url_for('categories_index') }}">Kategori Yönetimi</a>
        {% endif %}
        <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
      </div>
    </div>

    {% if risks and risks|length > 0 %}
      <div class="table-wrap" style="overflow-x:auto;margin-top:8px">
        <table class="table">
          <thead>
            <tr>
              <th>Başlık</th>
              <th style="width:200px">Kategori</th>
              <th style="width:120px; text-align:center">Skor</th>
              <th style="width:160px">Durum</th>
            </tr>
          </thead>
          <tbody>
            {% for r in risks[:8] %}
            {% set sc = r.score() %}
            <tr>
              <td>
                <a href="{{ url_for('risk_detail', risk_id=r.id) }}">{{ r.title }}</a>
                {% if r.description %}
                  <div class="small" style="margin-top:2px; max-width:72ch; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    {{ r.description }}
                  </div>
                {% endif %}
              </td>
              <td>{{ r.category or "-" }}</td>
              <td style="text-align:center">
                {% if sc %}
                  <span class="badge {% if sc<=8 %}score-low{% elif sc<=15 %}score-mid{% else %}score-high{% endif %}"
                        title="P×S = {{ '%.2f'|format(sc) if sc is number else sc }}">
                    {{ '%.2f'|format(sc) if sc is number else sc }}
                  </span>
                {% else %}<span class="badge">—</span>{% endif %}
              </td>
              <td>{{ r.status or '—' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:6px">
        Son güncellenen 8 risk gösteriliyor. Tümü için “Riskler” sayfasına gidin.
      </div>
    {% else %}
      <div class="empty" role="note" aria-live="polite">
        <h4 style="margin:0 0 .3rem">Henüz risk yok</h4>
        <div class="small">Hızlı başlamak için bir şablon seçin veya yeni bir risk oluşturun.</div>
        <div style="margin-top:.6rem; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
          <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
          <a class="btn" href="{{ url_for('risk_identify') }}">📋 Şablondan Seç</a>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Sağ: Risk Matrisi (başlıklı) -->
  <div class="card" aria-labelledby="matrixTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 id="matrixTitle" style="margin:0">Risk Matrisi</h3>
      <div class="legend" aria-label="Seviye açıklamaları">
        <span class="badge score-low">1–3 Düşük</span>
        <span class="badge score-mid">4–8 Orta</span>
        <span class="badge" style="background:rgba(253,186,116,.25);color:#4a2500;border-color:#f59e0b">9–12 Yüksek</span>
        <span class="badge" style="background:rgba(239,68,68,.20);color:#7a1e1e;border-color:#ef4444">15–25 Kritik</span>
      </div>
    </div>

    {% set prob_labels = ['Çok Düşük','Düşük','Olası','Yüksek','Çok Yüksek'] %}
    {% set sev_labels  = ['Önemsiz','Küçük','Orta','Büyük','Felaket'] %}

    <div class="risk-matrix" role="grid" aria-label="Olasılık × Şiddet matrisi">
      <div class="rm-corner" aria-hidden="true"></div>
      {% for p in range(1,6) %}
        <div class="rm-colhead" role="columnheader" aria-label="Olasılık {{p}}: {{ prob_labels[p-1] }}">
          <div class="rm-coltitle">{{ prob_labels[p-1] }}</div>
          <div class="rm-colnum">{{ p }}</div>
        </div>
      {% endfor %}

      {% for s in range(5,0,-1) %}
        <div class="rm-rowhead" role="rowheader" aria-label="Şiddet {{s}}: {{ sev_labels[s-1] }}">
          <div class="rm-rowtitle">{{ sev_labels[s-1] }}</div>
          <div class="rm-rownum">{{ s }}</div>
        </div>
        {% for p in range(1,6) %}
          {% set score = p * s %}
          {% set count = (matrix[5-s][p-1]) if matrix is defined else 0 %}
          {% set lvl = 'low' if score<=3 else ('mid' if score<=8 else ('hi' if score<=12 else 'crit')) %}
          <a class="rm-cell {{ lvl }}"
             href="{{ url_for('risk_select') }}?p={{p}}&s={{s}}"
             title="Şiddet {{s}} · Olasılık {{p}} → Skor {{score}} · {{count}} adet"
             role="gridcell" aria-label="S={{s}}, P={{p}}, Skor {{score}}, {{count}} adet" tabindex="0">
            <span class="rm-score">{{ score }}</span>
            <span class="rm-count">{{ count }}</span>
          </a>
        {% endfor %}
      {% endfor %}
    </div>

    <div class="small" style="margin-top:8px">
      Hücrelerde büyük sayı <strong>skor (P×S)</strong>, sağ altta <strong>adet</strong> gösterilir.
    </div>
  </div>
</div>

<!-- ===== 2 Donut: Kategori Dağılımı + Risk Seviyeleri ===== -->
<div class="card" style="margin-top:12px" aria-labelledby="donutTitle">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
    <h3 id="donutTitle" style="margin:0">Kategori & Risk Dağılımı (Donut)</h3>
    <div class="small">Düşük / Orta / Yüksek / Çok Yüksek</div>
  </div>

  {% if category_stats and category_stats|length > 0 %}
    <script id="categoryStats" type="application/json">{{ category_stats|tojson }}</script>

    <div class="donut-grid">
      <div class="donut-card">
        <div class="donut-head">
          <div class="donut-title">1- Kategori Bazında Dağılım</div>
          <div class="small" id="catTotal"></div>
        </div>
        <canvas id="donut-categories" height="220" aria-label="Kategori dağılım donut" role="img"></canvas>
        <div class="legend-row" id="legend-cats"></div>
      </div>

      <div class="donut-card">
        <div class="donut-head">
          <div class="donut-title">2- Risk Seviyeleri (Toplam)</div>
        </div>
        <canvas id="donut-levels" height="220" aria-label="Seviye dağılım donut" role="img"></canvas>
        <div class="legend-row" id="legend-levels"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function(){
        const raw = document.getElementById('categoryStats');
        const stats = raw ? JSON.parse(raw.textContent || '[]') : [];
        const rows = stats.filter(r => (r.cat || '').toLowerCase() !== 'toplam riskler');

        // Renk paleti (kategori donut için)
        const PALETTE = ['#60a5fa','#34d399','#f59e0b','#ef4444','#a78bfa','#f472b6','#22d3ee','#84cc16','#fb7185','#f97316'];
        // Seviye renkleri
        const LEVEL_COLORS = { low:'#22c55e', mid:'#f59e0b', high:'#fb923c', vhigh:'#ef4444' };

        // --- 1) Kategori Donut ---
        const catLabels = rows.map(r => r.cat);
        const catCounts = rows.map(r => Number(r.total)||0);
        const catColors = catLabels.map((_,i)=> PALETTE[i % PALETTE.length]);

        new Chart(document.getElementById('donut-categories').getContext('2d'), {
          type: 'doughnut',
          data: { labels: catLabels, datasets: [{ data: catCounts, backgroundColor: catColors, borderWidth: 0 }]},
          options: {
            cutout: '65%',
            plugins: {
              legend: { display:false },
              tooltip: { callbacks:{ label:(c)=> `${c.label}: ${c.parsed} adet` } }
            }
          }
        });

        const totalCat = catCounts.reduce((a,b)=>a+b,0);
        const catTotalEl = document.getElementById('catTotal');
        if (catTotalEl) catTotalEl.textContent = `${totalCat} adet`;

        const legendCats = document.getElementById('legend-cats');
        catLabels.forEach((lbl, i) => {
          const n = catCounts[i]||0;
          const el = document.createElement('span');
          el.className = 'legend-chip';
          el.innerHTML = `<span class="chip-dot" style="background:${catColors[i]}"></span>${lbl} (${n})`;
          legendCats.appendChild(el);
        });

        // --- 2) Seviye Donut ---
        const sum = k => rows.reduce((a,r)=> a + (Number(r[k])||0), 0);
        const lvlLabels = ['Düşük','Orta','Yüksek','Çok Yüksek'];
        const lvlKeys   = ['low','mid','high','vhigh'];
        const lvlData   = lvlKeys.map(k => sum(k));
        const lvlColors = lvlKeys.map(k => LEVEL_COLORS[k]);

        new Chart(document.getElementById('donut-levels').getContext('2d'), {
          type: 'doughnut',
          data: { labels: lvlLabels, datasets: [{ data: lvlData, backgroundColor: lvlColors, borderWidth: 0 }]},
          options: {
            cutout: '65%',
            plugins: {
              legend: { display:false },
              tooltip: { callbacks:{ label:(c)=> `${c.label}: ${c.parsed} adet` } }
            }
          }
        });

        const legendLvls = document.getElementById('legend-levels');
        lvlLabels.forEach((lbl, i) => {
          const el = document.createElement('span');
          el.className = 'legend-chip';
          el.innerHTML = `<span class="chip-dot" style="background:${lvlColors[i]}"></span>${lbl} (${lvlData[i]})`;
          legendLvls.appendChild(el);
        });
      })();
    </script>
  {% else %}
    <div class="empty">Grafik oluşturmak için yeterli veri yok.</div>
  {% endif %}
</div>

<!-- ===== Alt: Hızlı İşlemler ===== -->
<div class="card" style="margin-top:12px">
  <div class="quick-actions">
    <h3 style="margin:0">Hızlı İşlemler</h3>
    <div class="btns">
      <a class="btn" href="{{ url_for('risk_identify') }}">📋 Risk Tanımla</a>
      {% if session.get('role') == 'admin' %}
        <a class="btn" href="{{ url_for('categories_index') }}">🗂️ Kategori Yönetimi</a>
        <a class="btn" href="{{ url_for('import_suggestions') }}">⬆️ CSV İçe Aktar</a>
      {% endif %}
      <a class="btn" href="{{ url_for('risks_export_csv') }}">⬇️ CSV Dışa Aktar</a>
      <a class="btn" href="{{ url_for('settings_account') }}">⚙️ Hesap Ayarları</a>
      <a class="btn" href="{{ url_for('settings_project') }}">🏷️ Proje Bilgileri</a>
    </div>
  </div>
</div>

{% endblock %}
