{% extends "base.html" %}
{% block title %}Dashboard Â· Risk YÃ¶netim{% endblock %}
{% block content %}

<style>
  /* ================================
     DASHBOARD â€” RiskApp UI Uyum Paketi
     (base.html tokenâ€™larÄ±yla %100 uyumlu)
     ================================ */

  /* ----- KPIâ€™ler ----- */
  .kpis{
    display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
    gap:14px; margin-bottom:14px;
  }
  @media (max-width: 1200px){ .kpis{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (max-width: 980px){  .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 540px){  .kpis{ grid-template-columns: 1fr; } }

  .kpi{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:14px 16px;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:14px;
    background: var(--card);
    box-shadow: var(--elev-card);
    backdrop-filter: var(--glass-blur);
    transition: transform .08s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
    min-height: 52px;
  }
  .kpi:hover{ transform: translateY(-1px); filter:brightness(1.02); }
  [data-theme="dark"] .kpi{ border:1px solid rgba(255,255,255,.10); }

  .kpi .label{
    font-weight:900; letter-spacing:.02em;
    color:var(--text-dim);
    font-size:.9rem;
  }
  .kpi .value{
    font-weight:900;
    font-size:1.28rem;
    display:flex; align-items:center; gap:6px;
  }

  /* KPI "accent" â€” primary sayÄ±yÄ± biraz Ã¶ne Ã§Ä±karalÄ±m (opsiyonel, Ã¶zellik silmez) */
  .kpi.accent{
    border-color: color-mix(in oklab, var(--primary) 28%, var(--line));
    box-shadow:
      0 18px 40px -26px color-mix(in oklab, var(--primary) 55%, transparent),
      var(--elev-card);
  }
  .kpi.accent .value{
    color: color-mix(in oklab, var(--primary) 92%, var(--text));
  }

  /* ----- Kartlar ----- */
  .card{
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:14px;
    background:var(--card);
    box-shadow: var(--elev-card);
    padding:16px;
    backdrop-filter: var(--glass-blur);
    min-width: 0;
  }
  [data-theme="dark"] .card{ border:1px solid rgba(255,255,255,.10); }

  .grid{ display:grid; gap:14px }
  .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)) }
  @media (max-width: 980px){ .grid-2{ grid-template-columns: 1fr } }

  .legend{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  .legend .badge{ font-weight:900 }

  .empty{
    border:2px dashed color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:14px; padding:24px; text-align:center; color:var(--text-dim);
    background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
  }

  /* ===========================
     RISK MATRIX â€” 5Ã—5 Ä±sÄ± haritasÄ±
     EÅŸikler: 1â€“4 low / 5â€“10 mid / 11â€“15 hi / 16â€“25 crit
     (RiskApp primary + premium tonlar)
     =========================== */
  .risk-matrix{
    --label-w: 150px;
    --cell-size: 64px;
    display:grid;
    grid-template-columns: var(--label-w) repeat(5, var(--cell-size));
    grid-auto-rows: var(--cell-size);
    gap: 8px;
    margin-top: 10px;
  }
  @media (max-width: 980px){
    .risk-matrix{ --label-w: 130px; --cell-size: 58px; }
  }
  @media (max-width: 640px){
    .risk-matrix{ --label-w: 120px; --cell-size: 52px; }
  }

  .rm-corner{
    display:grid; place-items:center;
    color:var(--text-dim);
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.08em;
  }

  .rm-colhead,.rm-rowhead{
    position:relative;
    display:flex; align-items:flex-start; justify-content:space-between; gap:8px;
    padding:8px 10px;
    border:1px solid color-mix(in oklab, var(--line) 70%, transparent);
    border-radius:12px;
    background: color-mix(in oklab, var(--surface) 82%, transparent);
    font-weight:850;
    min-width: 0;
  }
  .rm-colhead{ flex-direction:column; align-items:flex-start; }

  .rm-coltitle,.rm-rowtitle{ font-weight:900; }
  .rm-colnum,.rm-rownum{ font: 900 .9rem var(--mono); opacity:.75; flex-shrink:0; }

  .rm-cell{
    position:relative;
    display:grid; align-content:center; justify-items:center;
    border-radius: 12px;
    border: 1.5px solid color-mix(in oklab, var(--line) 85%, transparent);
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.55),
      0 10px 24px -18px rgba(0,0,0,.22);
    cursor: pointer;
    padding: 4px;
    transition: transform .06s ease, box-shadow .15s ease, filter .15s ease, outline-color .15s ease;
    text-decoration: none;
    color: inherit;
    user-select:none;
  }
  [data-theme="dark"] .rm-cell{
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.10),
      0 16px 32px -26px rgba(0,0,0,.55);
  }

  .rm-cell:hover{ transform: translateY(-1px); filter: brightness(1.02); }
  .rm-cell:focus-visible{
    outline: 4px solid color-mix(in oklab, var(--ring) 55%, transparent);
    outline-offset: 1px;
  }

  .rm-score{ font: 900 1rem/1 var(--mono); }
  .rm-count{
    position:absolute; right:6px; bottom:5px;
    font-weight:900; font-size:.78rem;
    padding:.12rem .45rem;
    border-radius:999px;
    border:1px solid color-mix(in oklab, var(--line) 85%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 72%, transparent);
    white-space: nowrap;
  }
  [data-theme="dark"] .rm-count{
    background: rgba(0,0,0,.25);
    border-color: rgba(255,255,255,.14);
  }

  /* ---- RiskApp uyumlu matris renkleri (premium, okunaklÄ±) ---- */
  /* LIGHT */
  html[data-theme="light"] .rm-cell.low{
    background: color-mix(in oklab, #22c55e 18%, #ffffff);
    border-color: color-mix(in oklab, #22c55e 35%, var(--line));
    color: #0f2a1f;
  }
  html[data-theme="light"] .rm-cell.mid{
    background: color-mix(in oklab, #f59e0b 24%, #ffffff);
    border-color: color-mix(in oklab, #f59e0b 40%, var(--line));
    color: #402b05;
  }
  html[data-theme="light"] .rm-cell.hi{
    background: color-mix(in oklab, #fb923c 26%, #ffffff);
    border-color: color-mix(in oklab, #fb923c 42%, var(--line));
    color: #3b1f05;
  }
  html[data-theme="light"] .rm-cell.crit{
    background: color-mix(in oklab, #ef4444 18%, #ffffff);
    border-color: color-mix(in oklab, #ef4444 38%, var(--line));
    color: #4a1010;
  }

  /* DARK */
  html[data-theme="dark"] .rm-cell.low{
    background: color-mix(in oklab, #22c55e 22%, #0b1220);
    border-color: rgba(34,197,94,.30);
    color: #c8ffe4;
  }
  html[data-theme="dark"] .rm-cell.mid{
    background: color-mix(in oklab, #f59e0b 20%, #0b1220);
    border-color: rgba(245,158,11,.30);
    color: #ffe8b0;
  }
  html[data-theme="dark"] .rm-cell.hi{
    background: color-mix(in oklab, #fb923c 20%, #0b1220);
    border-color: rgba(251,146,60,.30);
    color: #ffd7bf;
  }
  html[data-theme="dark"] .rm-cell.crit{
    background: color-mix(in oklab, #ef4444 18%, #0b1220);
    border-color: rgba(239,68,68,.30);
    color: #ffd0d0;
  }

  /* Primary dokunuÅŸ: crit hÃ¼creleri azÄ±cÄ±k "RiskApp" hissi taÅŸÄ±sÄ±n */
  .rm-cell.crit{
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.14),
      0 18px 40px -28px color-mix(in oklab, var(--primary) 35%, transparent);
  }

  .risk-matrix .rm-corner::after{
    content:"OlasÄ±lÄ±k â†’";
    font-weight:900;
    color:var(--text-dim);
  }
  .risk-matrix .rm-rowhead:first-of-type::before{
    content:"â†‘ Åiddet";
    position:absolute;
    transform:rotate(-90deg) translate(-40%, -120%);
    transform-origin:left top;
    color:var(--text-dim);
    font-weight:900;
  }

  /* ----- Donutâ€™lar ----- */
  .donut-grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
  @media (max-width:980px){ .donut-grid{ grid-template-columns:1fr; } }

  .donut-card{
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:14px;
    padding:12px;
    background:var(--card);
  }
  [data-theme="dark"] .donut-card{ border:1px solid rgba(255,255,255,.10); }

  .donut-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:10px; flex-wrap:wrap }
  .donut-title{ font-weight:900; }

  .legend-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .legend-chip{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    border-radius:999px;
    padding:2px 8px;
    font-weight:850;
    background: color-mix(in oklab, var(--bg-soft) 80%, transparent);
  }
  [data-theme="dark"] .legend-chip{ border:1px solid rgba(255,255,255,.14); }
  .chip-dot{ width:10px; height:10px; border-radius:999px; display:inline-block }

  /* ----- Tablo ----- */
  .table-wrap{ overflow:auto; border-radius:14px; scrollbar-gutter: stable both-edges; }
  .table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px }
  .table th,.table td{
    padding:.72rem .9rem;
    border-bottom:1px solid color-mix(in oklab, var(--line) 84%, transparent);
    text-align:left;
    font-size:.95rem;
    vertical-align:top;
  }
  .table thead th{
    font-size:.80rem; text-transform:uppercase; letter-spacing:.09em;
    color:var(--text-dim);
    position:sticky; top:0; z-index:1;
    background: color-mix(in oklab, var(--surface) 84%, transparent);
    backdrop-filter: blur(6px);
    border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    font-weight:900;
    white-space: nowrap;
  }
  .table tbody tr:hover td{
    background: color-mix(in oklab, var(--primary) 6%, transparent);
  }

  .quick-actions{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap }
  .quick-actions .btns{ display:flex; flex-wrap:wrap; gap:8px }

  /* Fallback (color-mix desteklemeyen tarayÄ±cÄ±) */
  @supports not (color: color-mix(in oklab, white 50%, black)) {
    .kpi, .card, .legend-chip, .table th, .table td { border-color: var(--line); }
  }
</style>

{# ==== KPI hesap: her risk iÃ§in Risk.score() (detaydakiyle aynÄ±) ==== #}
{% set ns = namespace(total=0, low=0, mid=0, high=0, crit=0, sum=0.0, have=0) %}
{% for r in risks or [] %}
  {% set sc = r.score() %}
  {% if sc is not none %}
    {% set ns.sum  = ns.sum + sc %}
    {% set ns.have = ns.have + 1 %}
    {# 1â€“4 DÃ¼ÅŸÃ¼k, 5â€“10 Orta, 11â€“15 YÃ¼ksek, 16â€“25 Ã‡ok YÃ¼ksek #}
    {% if sc <= 4 %}
      {% set ns.low = ns.low + 1 %}
    {% elif sc <= 10 %}
      {% set ns.mid = ns.mid + 1 %}
    {% elif sc <= 15 %}
      {% set ns.high = ns.high + 1 %}
    {% else %}
      {% set ns.crit = ns.crit + 1 %}
    {% endif %}
  {% endif %}
  {% set ns.total = ns.total + 1 %}
{% endfor %}
{% set avg = (ns.sum / ns.have) if ns.have > 0 else None %}

<!-- ===== KPIs ===== -->
<div class="kpis" role="list" aria-label="Ã–zet gÃ¶stergeler">
  <div class="kpi accent" role="listitem">
    <div class="label">Toplam Risk</div>
    <div class="value">{{ ns.total }}</div>
  </div>

  <div class="kpi" role="listitem">
    <div class="label">Ã‡ok YÃ¼ksek</div>
    <div class="value"><span class="badge score-high">{{ ns.crit }}</span></div>
  </div>

  <div class="kpi" role="listitem">
    <div class="label">YÃ¼ksek</div>
    <div class="value"><span class="badge score-high">{{ ns.high }}</span></div>
  </div>

  <div class="kpi" role="listitem">
    <div class="label">Orta</div>
    <div class="value"><span class="badge score-mid">{{ ns.mid }}</span></div>
  </div>

  <div class="kpi" role="listitem">
    <div class="label">DÃ¼ÅŸÃ¼k</div>
    <div class="value"><span class="badge score-low">{{ ns.low }}</span></div>
  </div>

  <div class="kpi" role="listitem">
    <div class="label">Ortalama Skor</div>
    <div class="value">{{ avg and ('%.2f'|format(avg)) or 'â€”' }}</div>
  </div>
</div>

<!-- ===== ÃœST Ä°KÄ°LÄ°: Genel GÃ¶rÃ¼nÃ¼m + Risk Matrisi ===== -->
<div class="grid grid-2">

  <!-- Sol: Genel GÃ¶rÃ¼nÃ¼m -->
  <div class="card" aria-labelledby="genelTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 id="genelTitle" style="margin:0">Genel GÃ¶rÃ¼nÃ¼m</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="{{ url_for('risk_select') }}">Riskler</a>
        {% if session.get('role') == 'admin' %}
          <a class="btn" href="{{ url_for('categories_index') }}">Kategori YÃ¶netimi</a>
        {% endif %}
        <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
      </div>
    </div>

    {% if risks and risks|length > 0 %}
      <div class="table-wrap" style="overflow-x:auto;margin-top:8px">
        <table class="table">
          <thead>
            <tr>
              <th>BaÅŸlÄ±k</th>
              <th style="width:200px">Kategori</th>
              <th style="width:120px; text-align:center">Skor</th>
              <th style="width:160px">Durum</th>
            </tr>
          </thead>
          <tbody>
            {% for r in risks[:8] %}
            {% set sc = r.score() %}
            <tr>
              <td>
                <a href="{{ url_for('risk_detail', risk_id=r.id) }}">{{ r.title }}</a>
                {% if r.description %}
                  <div class="small" style="margin-top:2px; max-width:72ch; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    {{ r.description }}
                  </div>
                {% endif %}
              </td>
              <td>{{ r.category or "-" }}</td>
              <td style="text-align:center">
                {% if sc is not none %}
                  <span class="badge
                              {% if sc<=4 %}score-low
                              {% elif sc<=10 %}score-mid
                              {% else %}score-high{% endif %}"
                        title="Skor: {{ '%.2f'|format(sc) }}">
                    {{ '%.2f'|format(sc) }}
                  </span>
                {% else %}
                  <span class="badge">â€”</span>
                {% endif %}
              </td>
              <td>{{ r.status or 'â€”' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:6px">
        Son gÃ¼ncellenen 8 risk gÃ¶steriliyor. TÃ¼mÃ¼ iÃ§in â€œRisklerâ€ sayfasÄ±na gidin.
      </div>
    {% else %}
      <div class="empty" role="note" aria-live="polite">
        <h4 style="margin:0 0 .3rem">HenÃ¼z risk yok</h4>
        <div class="small">HÄ±zlÄ± baÅŸlamak iÃ§in bir ÅŸablon seÃ§in veya yeni bir risk oluÅŸturun.</div>
        <div style="margin-top:.6rem; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
          <a class="btn btn-primary" href="{{ url_for('risk_new') }}">+ Yeni Risk</a>
          <a class="btn" href="{{ url_for('risk_identify') }}">ğŸ“‹ Åablondan SeÃ§</a>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- SaÄŸ: Risk Matrisi -->
  <div class="card" aria-labelledby="matrixTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 id="matrixTitle" style="margin:0">Risk Matrisi</h3>

      <!-- Legend: artÄ±k inline "turuncu yamalar" yok; hepsi token/uyumlu -->
      <div class="legend" aria-label="Seviye aÃ§Ä±klamalarÄ±">
        <span class="badge score-low">1â€“4 DÃ¼ÅŸÃ¼k</span>
        <span class="badge score-mid">5â€“10 Orta</span>
        <span class="badge" style="background:rgba(251,146,60,.16); border-color:rgba(251,146,60,.30); color:color-mix(in oklab, var(--text) 80%, #000 20%);">
          11â€“15 YÃ¼ksek
        </span>
        <span class="badge score-high">16â€“25 Ã‡ok YÃ¼ksek</span>
      </div>
    </div>

    {% set prob_labels = ['Ã‡ok DÃ¼ÅŸÃ¼k','DÃ¼ÅŸÃ¼k','Orta','YÃ¼ksek','Ã‡ok YÃ¼ksek'] %}
    {% set sev_labels  = ['Ã‡ok DÃ¼ÅŸÃ¼k','DÃ¼ÅŸÃ¼k','Orta','YÃ¼ksek','Ã‡ok YÃ¼ksek'] %}

    <div class="risk-matrix" role="grid" aria-label="OlasÄ±lÄ±k Ã— Åiddet matrisi">
      <div class="rm-corner" aria-hidden="true"></div>

      {# OlasÄ±lÄ±k: 5 â†’ 1 (Ã‡ok YÃ¼ksek â†’ Ã‡ok DÃ¼ÅŸÃ¼k) #}
      {% for p in range(5,0,-1) %}
        <div class="rm-colhead" role="columnheader" aria-label="OlasÄ±lÄ±k {{p}}: {{ prob_labels[p-1] }}">
          <div class="rm-coltitle">{{ prob_labels[p-1] }}</div>
          <div class="rm-colnum">{{ p }}</div>
        </div>
      {% endfor %}

      {# SatÄ±rlar: Åiddet 5 â†’ 1 #}
      {% for s in range(5,0,-1) %}
        <div class="rm-rowhead" role="rowheader" aria-label="Åiddet {{s}}: {{ sev_labels[s-1] }}">
          <div class="rm-rowtitle">{{ sev_labels[s-1] }}</div>
          <div class="rm-rownum">{{ s }}</div>
        </div>

        {% for p in range(5,0,-1) %}
          {% set score = p * s %}
          {% set lvl = 'low' if score<=4 else ('mid' if score<=10 else ('hi' if score<=15 else 'crit')) %}

          {% set cell = namespace(cnt=0) %}
          {% for r in risks or [] %}
            {% set evals = (r.evaluations or [])|sort(attribute='id') %}
            {% if evals %}
              {% set last_eval = evals|last %}
              {% if last_eval.probability == p and last_eval.severity == s %}
                {% set cell.cnt = cell.cnt + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}

          <a class="rm-cell {{ lvl }}"
             href="{{ url_for('risk_select') }}?p={{p}}&s={{s}}"
             title="Åiddet {{s}} Â· OlasÄ±lÄ±k {{p}} â†’ Skor {{score}} Â· {{cell.cnt}} adet"
             role="gridcell"
             aria-label="S={{s}}, P={{p}}, Skor {{score}}, {{cell.cnt}} adet"
             tabindex="0">
            <span class="rm-score">{{ score }}</span>
            <span class="rm-count">{{ cell.cnt }}</span>
          </a>
        {% endfor %}
      {% endfor %}
    </div>

    <div class="small" style="margin-top:8px">
      HÃ¼crelerde bÃ¼yÃ¼k sayÄ± <strong>skor (PÃ—S)</strong>, saÄŸ altta <strong>adet</strong> gÃ¶sterilir.
    </div>
  </div>
</div>

<!-- ===== 2 Donut: Kategori DaÄŸÄ±lÄ±mÄ± + Risk Seviyeleri ===== -->
<div class="card" style="margin-top:12px" aria-labelledby="donutTitle">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
    <h3 id="donutTitle" style="margin:0">Kategori & Risk DaÄŸÄ±lÄ±mÄ± (Donut)</h3>
    <div class="small">DÃ¼ÅŸÃ¼k / Orta / YÃ¼ksek / Ã‡ok YÃ¼ksek</div>
  </div>

  {% if category_stats and category_stats|length > 0 %}
    <script id="categoryStats" type="application/json">{{ category_stats|tojson }}</script>

    <div class="donut-grid">
      <div class="donut-card">
        <div class="donut-head">
          <div class="donut-title">1- Kategori BazÄ±nda DaÄŸÄ±lÄ±m</div>
          <div class="small" id="catTotal"></div>
        </div>
        <canvas id="donut-categories" height="220" aria-label="Kategori daÄŸÄ±lÄ±m donut" role="img"></canvas>
        <div class="legend-row" id="legend-cats"></div>
      </div>

      <div class="donut-card">
        <div class="donut-head">
          <div class="donut-title">2- Risk Seviyeleri (Toplam)</div>
        </div>
        <canvas id="donut-levels" height="220" aria-label="Seviye daÄŸÄ±lÄ±m donut" role="img"></canvas>
        <div class="legend-row" id="legend-levels"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function(){
        const raw = document.getElementById('categoryStats');
        const stats = raw ? JSON.parse(raw.textContent || '[]') : [];
        const rows = stats.filter(r => (r.cat || '').toLowerCase() !== 'toplam riskler');

        // RiskApp uyumlu palet: 1. renk primary (#2866bd), kalanlar dengeli
        const PALETTE = [
          '#2866bd', // primary
          '#60a5fa',
          '#34d399',
          '#f59e0b',
          '#fb923c',
          '#a78bfa',
          '#22d3ee',
          '#84cc16',
          '#f472b6',
          '#f97316'
        ];

        const LEVEL_COLORS = {
          low:  '#22c55e',
          mid:  '#f59e0b',
          high: '#fb923c',
          vhigh:'#ef4444'
        };

        // --- 1) Kategori Donut ---
        const catLabels = rows.map(r => r.cat);
        const catCounts = rows.map(r => Number(r.total)||0);
        const catColors = catLabels.map((_,i)=> PALETTE[i % PALETTE.length]);

        new Chart(document.getElementById('donut-categories').getContext('2d'), {
          type: 'doughnut',
          data: { labels: catLabels, datasets: [{ data: catCounts, backgroundColor: catColors, borderWidth: 0 }]},
          options: {
            cutout: '65%',
            plugins: {
              legend: { display:false },
              tooltip: { callbacks:{ label:(c)=> `${c.label}: ${c.parsed} adet` } }
            }
          }
        });

        const totalCat = catCounts.reduce((a,b)=>a+b,0);
        const catTotalEl = document.getElementById('catTotal');
        if (catTotalEl) catTotalEl.textContent = `${totalCat} adet`;

        const legendCats = document.getElementById('legend-cats');
        catLabels.forEach((lbl, i) => {
          const n = catCounts[i]||0;
          const el = document.createElement('span');
          el.className = 'legend-chip';
          el.innerHTML = `<span class="chip-dot" style="background:${catColors[i]}"></span>${lbl} (${n})`;
          legendCats.appendChild(el);
        });

        // --- 2) Seviye Donut ---
        const sum = k => rows.reduce((a,r)=> a + (Number(r[k])||0), 0);
        const lvlLabels = ['DÃ¼ÅŸÃ¼k','Orta','YÃ¼ksek','Ã‡ok YÃ¼ksek'];
        const lvlKeys   = ['low','mid','high','vhigh'];
        const lvlData   = lvlKeys.map(k => sum(k));
        const lvlColors = lvlKeys.map(k => LEVEL_COLORS[k]);

        new Chart(document.getElementById('donut-levels').getContext('2d'), {
          type: 'doughnut',
          data: { labels: lvlLabels, datasets: [{ data: lvlData, backgroundColor: lvlColors, borderWidth: 0 }]},
          options: {
            cutout: '65%',
            plugins: {
              legend: { display:false },
              tooltip: { callbacks:{ label:(c)=> `${c.label}: ${c.parsed} adet` } }
            }
          }
        });

        const legendLvls = document.getElementById('legend-levels');
        lvlLabels.forEach((lbl, i) => {
          const el = document.createElement('span');
          el.className = 'legend-chip';
          el.innerHTML = `<span class="chip-dot" style="background:${lvlColors[i]}"></span>${lbl} (${lvlData[i]})`;
          legendLvls.appendChild(el);
        });
      })();
    </script>
  {% else %}
    <div class="empty">Grafik oluÅŸturmak iÃ§in yeterli veri yok.</div>
  {% endif %}
</div>

<!-- ===== Alt: HÄ±zlÄ± Ä°ÅŸlemler ===== -->
<div class="card" style="margin-top:12px">
  <div class="quick-actions">
    <h3 style="margin:0">HÄ±zlÄ± Ä°ÅŸlemler</h3>
    <div class="btns">
      <a class="btn" href="{{ url_for('risk_identify') }}">ğŸ“‹ Risk TanÄ±mla</a>
      {% if session.get('role') == 'admin' %}
        <a class="btn" href="{{ url_for('categories_index') }}">ğŸ—‚ï¸ Kategori YÃ¶netimi</a>
        <a class="btn" href="{{ url_for('import_suggestions') }}">â¬†ï¸ CSV Ä°Ã§e Aktar</a>
      {% endif %}
      <a class="btn" href="{{ url_for('risks_export_csv') }}">â¬‡ï¸ CSV DÄ±ÅŸa Aktar</a>
      <a class="btn" href="{{ url_for('settings_account') }}">âš™ï¸ Hesap AyarlarÄ±</a>
      <a class="btn" href="{{ url_for('settings_project') }}">ğŸ·ï¸ Proje Bilgileri</a>
    </div>
  </div>
</div>

{% endblock %}
