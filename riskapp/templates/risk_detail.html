{% extends "base.html" %}
{% block title %}Risk Detayƒ± ¬∑ {{ r.title }}{% endblock %}
{% block content %}

<style>
  /* ========= A√áIK TEMA ========= */
  [data-theme="light"] .is-hidden { display:none; }
  [data-theme="light"] .comment { border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#fff; }
  [data-theme="light"] .comment.system { background:#f8fafc; border-color:#dbeafe; }
  [data-theme="light"] .comment .meta { color:#64748b; font-size:.875rem; display:flex; justify-content:space-between; gap:8px; }
  [data-theme="light"] .comment pre { white-space:pre-wrap; margin:0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  [data-theme="light"] .ai-controls { display:flex; gap:8px; flex-wrap:wrap; }
  [data-theme="light"] .badge { display:inline-block; padding:.15rem .4rem; background:#eef2ff; color:#3730a3; border-radius:999px; font-size:.75rem; }
  [data-theme="light"] .small { font-size:.875rem; color:#6b7280; }

  [data-theme="light"] .table { width:100%; border-collapse:collapse; }
  [data-theme="light"] .table th,
  [data-theme="light"] .table td { border:1px solid #e5e7eb; padding:.4rem .5rem; text-align:left; }

  [data-theme="light"] .grid { display:grid; gap:10px; }
  [data-theme="light"] .grid-2 { grid-template-columns: 1fr 1fr; }
  [data-theme="light"] .grid-3 { grid-template-columns: repeat(3, 1fr); }

  [data-theme="light"] .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
  [data-theme="light"] .input { width:100%; padding:.5rem .6rem; border:1px solid #e5e7eb; border-radius:8px; background:#fff; color:#0a1328; }
  [data-theme="light"] .btn { border:1px solid #cbd5e1; background:#f8fafc; padding:.45rem .7rem; border-radius:8px; cursor:pointer; color:#0f182d; }
  [data-theme="light"] .btn:hover { background:#f1f5f9; }
  [data-theme="light"] .btn-primary { background:#2563eb; border-color:#1d4ed8; color:#fff; }
  [data-theme="light"] .btn-success { background:#059669; border-color:#059669; color:#fff; }
  [data-theme="light"] .flash.info { background:#eff6ff; border:1px solid #bfdbfe; color:#1e40af; padding:.5rem .6rem; border-radius:8px; }

  /* ========= KOYU TEMA ========= */
  [data-theme="dark"] .is-hidden { display:none; }

  [data-theme="dark"] .card{
    background: var(--card);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:12px;
    color: var(--text);
    box-shadow: var(--elev-card);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
  }

  [data-theme="dark"] .comment{
    border:1px solid rgba(255,255,255,.12);
    border-radius:8px;
    padding:10px;
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    color: var(--text);
  }
  [data-theme="dark"] .comment.system{
    background: linear-gradient(180deg, rgba(255,223,128,.12), rgba(255,223,128,.08));
    border-color: rgba(255,223,128,.35);
  }
  [data-theme="dark"] .comment .meta{
    color: var(--muted);
    font-size:.875rem;
    display:flex;
    justify-content:space-between;
    gap:8px;
  }
  [data-theme="dark"] .comment pre{
    white-space:pre-wrap;
    margin:0;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    color: inherit;
  }

  [data-theme="dark"] .ai-controls { display:flex; gap:8px; flex-wrap:wrap; }
  [data-theme="dark"] .badge{
    display:inline-block;
    padding:.15rem .4rem;
    border-radius:999px;
    font-size:.75rem;
    background: rgba(110,168,255,.18);
    color:#eaf0ff;
    border:1px solid rgba(110,168,255,.28);
  }
  [data-theme="dark"] .small{ font-size:.875rem; color: var(--muted); }

  [data-theme="dark"] .table{ width:100%; border-collapse:collapse; }
  [data-theme="dark"] .table th,
  [data-theme="dark"] .table td{
    border:1px solid rgba(255,255,255,.08);
    padding:.4rem .5rem;
    text-align:left;
    color: var(--text);
  }

  [data-theme="dark"] .grid{ display:grid; gap:10px; }
  [data-theme="dark"] .grid-2{ grid-template-columns: 1fr 1fr; }
  [data-theme="dark"] .grid-3{ grid-template-columns: repeat(3, 1fr); }

  [data-theme="dark"] .input{
    width:100%;
    padding:.5rem .6rem;
    border-radius:8px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border:1px solid rgba(150,170,220,.35);
    color:#f6f8ff;
    outline:none;
  }
  [data-theme="dark"] .input:focus{
    border-color: rgba(110,168,255,.85);
    box-shadow: 0 0 0 4px rgba(110,168,255,.22);
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    color:#ffffff;
  }
  [data-theme="dark"] input,
  [data-theme="dark"] select,
  [data-theme="dark"] textarea{ color-scheme: dark; }

  [data-theme="dark"] .btn{
    border:1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    color:#eaf0ff;
    padding:.45rem .7rem;
    border-radius:8px;
    cursor:pointer;
  }
  [data-theme="dark"] .btn:hover{ filter: brightness(1.03); }
  [data-theme="dark"] .btn-primary{
    background: color-mix(in oklab, var(--primary) 82%, #000 18%);
    border-color: transparent;
    color:#0a1228;
    text-shadow: 0 1px 0 rgba(255,255,255,.25);
  }
  [data-theme="dark"] .btn-success{
    background:#16a34a;
    border-color:#16a34a;
    color:#06141d;
  }

  [data-theme="dark"] .flash.info{
    background: linear-gradient(180deg, rgba(110,168,255,.12), rgba(110,168,255,.08));
    border:1px solid rgba(110,168,255,.35);
    color:#eaf0ff;
    padding:.5rem .6rem;
    border-radius:8px;
  }

  /* Mobil grid */
  @media (max-width: 980px) {
    [data-theme="light"] .grid-2, [data-theme="light"] .grid-3,
    [data-theme="dark"]  .grid-2, [data-theme="dark"]  .grid-3 { grid-template-columns: 1fr; }
  }

  @media print { .noprint { display:none !important; } }
</style>

<div class="grid grid-2">
  <!-- SOL: Rƒ∞SK KARTI -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
      <h2 style="margin:0">{{ r.title }}</h2>

      <!-- ü§ñ AI butonlarƒ± -->
      <div class="ai-controls noprint">
        <form method="post" action="{{ url_for('ai_suggest', risk_id=r.id) }}" class="noprint" style="display:inline">
          <button class="btn btn-success" type="submit" title="Riske g√∂re benzer √∂nerilerden aksiyon planƒ± √ºretir">
            ü§ñ √ñneri √úret
          </button>
        </form>

        <form method="post" action="{{ url_for('ai_comment_add', risk_id=r.id) }}" class="noprint" style="display:inline">
          <button class="btn btn-primary" type="submit" title="Sayƒ±sal √∂zet + RACI + KPI + kapanƒ±≈ü kriteri">
            ‚ú® Zengin AI Yorum
          </button>
        </form>
      </div>
    </div>

    {% if consensus %}
      <div class="flash info" style="margin:10px 0 8px">
        üîî Konsens√ºs: P={{ consensus.p }}, ≈û={{ consensus.s }} ({{ consensus.count }} oy, e≈üik {{ threshold }})
      </div>

      <div class="card" style="border-style:dashed; margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <strong>Hƒ±zlƒ± Doldur</strong>
            <div class="small">Konsens√ºs deƒüerlerini (P={{ consensus.p }}, ≈û={{ consensus.s }}) forma uygula.</div>
          </div>
          <button
            class="btn"
            type="button"
            data-p="{{ consensus.p|int }}"
            data-s="{{ consensus.s|int }}"
            onclick="applyConsensus(this.dataset.p, this.dataset.s)">
            Uygula
          </button>
        </div>
      </div>
    {% endif %}

    <form method="post" class="grid grid-2">
      <div>
        <label>Ba≈ülƒ±k</label>
        <input class="input" name="title" value="{{ r.title }}">
      </div>

      {% set _needs_custom = r.category and (r.category not in categories) %}
      <div>
        <label>Kategori</label>
        <select class="input" name="category" id="detail-category-select" required>
          <option value="" {% if not r.category %}selected{% endif %}>‚Äî Se√ßin ‚Äî</option>
          {% for c in categories %}
            <option value="{{ c }}" {% if r.category==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
          <option value="__custom__" {% if _needs_custom %}selected{% endif %}>Diƒüer (manuel)</option>
        </select>

        <div id="detail-category-custom" class="{% if not _needs_custom %}is-hidden{% endif %}" style="margin-top:6px;">
          <input class="input" name="category_custom" placeholder="Kategori adƒ± yazƒ±n"
                 value="{{ r.category if _needs_custom else '' }}">
          <div class="small" style="color:#8aa0b2">Sadece ‚ÄúDiƒüer (manuel)‚Äù se√ßeneƒüinde kullanƒ±lƒ±r.</div>
        </div>

        <div class="small" style="margin-top:.25rem">
          Kategori listesi <em>Risk Kategorileri</em> ekranƒ±ndan gelir.
        </div>
      </div>

      <div>
        <label>Durum</label>
        <select class="input" name="status">
          {% for s in ['Open','Assessed','Mitigating','Closed'] %}
            <option value="{{ s }}" {% if r.status==s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label>Risk Tipi</label>
        <select class="input" name="risk_type">
          <option value="" {% if not r.risk_type %}selected{% endif %}>‚Äî</option>
          <option value="product"    {% if r.risk_type=='product' %}selected{% endif %}>√úr√ºn</option>
          <option value="project"    {% if r.risk_type=='project' %}selected{% endif %}>Proje</option>
          <option value="process"    {% if r.risk_type=='process' %}selected{% endif %}>S√ºre√ß/Operasyon</option>
          <option value="schedule"   {% if r.risk_type=='schedule' %}selected{% endif %}>Zaman/Program</option>
          <option value="cost"       {% if r.risk_type=='cost' %}selected{% endif %}>Maliyet/Finans</option>
          <option value="quality"    {% if r.risk_type=='quality' %}selected{% endif %}>Kalite</option>
          <option value="safety"     {% if r.risk_type=='safety' %}selected{% endif %}>ƒ∞SG/G√ºvenlik</option>
          <option value="supplier"   {% if r.risk_type=='supplier' %}selected{% endif %}>Tedarik√ßi/Alty√ºklenici</option>
          <option value="legal"      {% if r.risk_type=='legal' %}selected{% endif %}>Hukuk/S√∂zle≈üme</option>
          <option value="compliance" {% if r.risk_type=='compliance' %}selected{% endif %}>Uyum/Reg√ºlasyon</option>
          <option value="environment"{% if r.risk_type=='environment' %}selected{% endif %}>√áevresel</option>
          <option value="security"   {% if r.risk_type=='security' %}selected{% endif %}>Bilgi G√ºvenliƒüi</option>
          <option value="stakeholder"{% if r.risk_type=='stakeholder' %}selected{% endif %}>Payda≈ü/ƒ∞leti≈üim</option>
          <option value="technology" {% if r.risk_type=='technology' %}selected{% endif %}>Teknoloji/Altyapƒ±</option>
        </select>
      </div>

      <div>
        <label>Sorumlu</label>
        <input class="input" name="responsible" value="{{ r.responsible or '' }}">
      </div>

      <div style="grid-column:1/-1">
        <label>A√ßƒ±klama</label>
        <textarea class="input" name="description" rows="3">{{ r.description or '' }}</textarea>
      </div>

      <div style="grid-column:1/-1">
        <label>√ñnlemler (Mitigation)</label>
        <textarea class="input" name="mitigation" rows="3">{{ r.mitigation or '' }}</textarea>
      </div>

      <!-- G√ñR√úN√úR DATE + Gƒ∞ZLƒ∞ YYYY-MM -->
      <div>
        <label>Ba≈ülangƒ±√ß Tarihi</label>
        <input class="input" type="date" id="start_date" value="{{ (r.start_month ~ '-01') if r.start_month else '' }}">
        <input type="hidden" name="start_month" id="start_month" value="{{ r.start_month or '' }}">
      </div>

      <div>
        <label>Biti≈ü Tarihi</label>
        <input class="input" type="date" id="end_date" value="{{ (r.end_month ~ '-28') if r.end_month else '' }}">
        <input type="hidden" name="end_month" id="end_month" value="{{ r.end_month or '' }}">
      </div>

      <div style="grid-column:1/-1">
        <label>Etki S√ºresi</label>
        <input class="input" name="duration" value="{{ r.duration or '' }}" placeholder="√∂rn. 6 ay / proje boyunca">
      </div>

      <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn btn-primary">Kaydet</button>
      </div>
    </form>
  </div>

  <!-- SAƒû: DEƒûERLENDƒ∞RMELER -->
  <div class="card">
    <h3>Deƒüerlendirmeler</h3>

    <!-- RPN √ñzeti -->
    <div class="grid grid-2" style="margin-bottom:10px">
      <div>
        <div class="small">Ortalama P / S</div>
        <strong>
          P={{ '%.1f'|format(r.avg_prob() or 0) }},
          S={{ '%.1f'|format(r.avg_sev() or 0) }}
        </strong>
      </div>
      <div>
        <div class="small">RPN (P√óS)</div>
        {% set avg_rpn = r.avg_rpn() %}
        {% set grade = r.grade() %}
        {% if avg_rpn is not none %}
          <span class="badge">{{ '%.2f'|format(avg_rpn) }} ¬∑ {{ grade }}</span>
        {% else %}‚Äî{% endif %}
      </div>
    </div>

    <!-- Sistemin √ñnerdiƒüi P/S -->
    {% if ps_reco and (ps_reco.p or ps_reco.s) %}
      <div class="card" style="margin-bottom:10px">
        <h4 style="margin:.25rem 0">Sistemin √ñnerdiƒüi P/S</h4>
        <p class="small" style="margin-top:.25rem">Aynƒ± kategorideki ge√ßmi≈ü deƒüerlendirmelerin moduna g√∂re hesaplanƒ±r.</p>

        <div style="display:flex; gap:10px; align-items:center; margin:.25rem 0 .5rem">
          <span class="badge">P: {{ ps_reco.p or '‚Äî' }}</span>
          <span class="badge">S: {{ ps_reco.s or '‚Äî' }}</span>
        </div>

        <form method="post" action="{{ url_for('add_eval', risk_id=r.id) }}" style="display:flex; gap:.5rem; flex-wrap:wrap">
          <input type="hidden" name="probability" value="{{ ps_reco.p or '' }}">
          <input type="hidden" name="severity"    value="{{ ps_reco.s or '' }}">
          <input class="input" style="flex:1; min-width:200px" type="text" name="comment" placeholder="Yorum (opsiyonel)">
          <button class="btn btn-success" type="submit">Bu P/S ile deƒüerlendir</button>
        </form>
      </div>
    {% endif %}

    <!-- Deƒüerlendirme Formu -->
    <form id="evalForm" method="post" action="{{ url_for('add_eval', risk_id=r.id) }}" class="grid">
      <div class="grid grid-2">
        <div>
          <label>Olasƒ±lƒ±k (P)</label>
          <select class="input" name="probability">
            {% for i in range(1,6) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>≈ûiddet (S)</label>
          <select class="input" name="severity">
            {% for i in range(1,6) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
          </select>
        </div>
      </div>

      <input class="input" name="evaluator" placeholder="Deƒüerlendiren (opsiyonel)">
      <input class="input" name="comment" placeholder="Yorum (opsiyonel)">
      <button class="btn btn-success">Deƒüerlendirmeyi Ekle</button>
    </form>

    <!-- Deƒüerlendirme Tablosu -->
    <table class="table" style="margin-top:10px">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Deƒüerlendiren</th>
          <th>P</th>
          <th>≈û</th>
          <th>RPN</th>
          <th>Yorum</th>
        </tr>
      </thead>
      <tbody>
        {% for e in r.evaluations|sort(attribute='id', reverse=True) %}
          <tr>
            <td>{{ e.created_at.strftime('%d.%m.%Y %H:%M') if e.created_at else '-' }}</td>
            <td>{{ e.evaluator or '-' }}</td>
            <td>{{ e.probability }}</td>
            <td>{{ e.severity }}</td>
            <td>{{ (e.probability * e.severity) if (e.probability and e.severity) else '‚Äî' }}</td>
            <td>{{ e.comment or '-' }}</td>
          </tr>
        {% else %}
          <tr><td colspan="6">Hen√ºz deƒüerlendirme yok.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ALT: YORUMLAR -->
  <div class="card" style="grid-column:1/-1">
    <h3>Yorumlar</h3>

    <div class="grid">
      {% for c in r.comments|sort(attribute='id', reverse=True) %}
        <div class="comment {% if c.is_system %}system{% endif %}">
          <div class="meta">
            <strong>{% if c.is_system %}Sistem{% else %}Kullanƒ±cƒ±{% endif %}</strong>
            <span>
              {{ c.created_at.strftime('%d.%m.%Y') if c.created_at else '' }} ¬∑
              {{ c.created_at.strftime('%H:%M') if c.created_at else '' }}
            </span>
          </div>

          {% set _txt = c.text or '' %}
          {% set _is_long = _txt|length > 900 %}
          {% if _is_long %}
            <details>
              <summary class="small" style="cursor:pointer; user-select:none">Yorumu a√ß/kapat</summary>
              <pre style="margin-top:.35rem">{{ _txt }}</pre>
            </details>
          {% else %}
            <pre>{{ _txt }}</pre>
          {% endif %}
        </div>
      {% else %}
        <div class="small">Yorum yok.</div>
      {% endfor %}
    </div>

    {% if session.get('role') == 'admin' %}
      <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}" style="margin-top:12px">
        <label>Yeni Yorum</label>
        <textarea class="input" name="text" rows="2" placeholder="G√ºncelleme veya not girin"></textarea>
        <div style="display:flex;justify-content:flex-end;margin-top:8px">
          <button class="btn">Yorum Ekle</button>
        </div>
      </form>

      <form
        method="post"
        action="{{ url_for('risk_delete', risk_id=r.id) }}"
        onsubmit="return confirm('Bu riski kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?');"
        style="margin-top:12px; display:flex; justify-content:flex-end">
        <button class="btn" style="background:#ef4444; color:#fff; border-color:transparent">
          ‚ùå Risk Sil
        </button>
      </form>
    {% endif %}
  </div>
</div>

{% if suggestions and suggestions|length %}
  <div class="card" style="margin-top:12px">
    <h3>√ñneriler ({{ r.category }})</h3>
    <ul style="padding-left:1rem; margin:0">
      {% for s in suggestions %}
        <li style="margin:.35rem 0">
          {{ s.text }}
          {% if s.default_prob or s.default_sev %}
            <span class="badge small" title="Varsayƒ±lan Olasƒ±lƒ±k/≈ûiddet">
              P/S: {{ s.default_prob or '‚Äî' }}/{{ s.default_sev or '‚Äî' }}
            </span>
          {% endif %}
          {% if s.risk_code %}
            <span class="badge small" title="Risk Kodu">{{ s.risk_code }}</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<script>
  // Konsens√ºs P/S'yi forma bas
  function applyConsensus(p, s) {
    try {
      const form = document.getElementById('evalForm');
      if (!form) return;
      const pSel = form.querySelector('select[name="probability"]');
      const sSel = form.querySelector('select[name="severity"]');
      if (pSel) pSel.value = String(p);
      if (sSel) sSel.value = String(s);
      form.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } catch (e) {
      console.error(e);
    }
  }

  // Kategori "Diƒüer (manuel)" g√∂ster/gizle
  (function(){
    const sel  = document.getElementById('detail-category-select');
    const wrap = document.getElementById('detail-category-custom');
    function toggleCustom(){
      if(!sel || !wrap) return;
      if(sel.value === '__custom__'){ wrap.classList.remove('is-hidden'); }
      else{
        wrap.classList.add('is-hidden');
        const inp = wrap.querySelector('input[name="category_custom"]');
        if (inp) inp.value = '';
      }
    }
    if(sel){
      sel.addEventListener('change', toggleCustom);
      toggleCustom();
    }
  })();

  // G√∂r√ºn√ºr date -> gizli YYYY-MM senkronu
  (function(){
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');
    const startYM   = document.getElementById('start_month');
    const endYM     = document.getElementById('end_month');

    const toYM = (v) => (v && v.length >= 7) ? v.slice(0,7) : "";

    // ƒ∞lk y√ºkleme
    if (startDate && startDate.value) startYM.value = toYM(startDate.value);
    if (endDate   && endDate.value)   endYM.value   = toYM(endDate.value);

    // Deƒüi≈üiklikler
    if (startDate) {
      startDate.addEventListener('change', () => {
        startYM.value = toYM(startDate.value);
        if (endDate && endDate.value && new Date(endDate.value) < new Date(startDate.value)) {
          endDate.value = startDate.value;
          endYM.value = toYM(endDate.value);
        }
      });
    }
    if (endDate) {
      endDate.addEventListener('change', () => {
        endYM.value = toYM(endDate.value);
        if (startDate && startDate.value && new Date(endDate.value) < new Date(startDate.value)) {
          startDate.value = endDate.value;
          startYM.value = toYM(startDate.value);
        }
      });
    }
  })();
</script>

{% endblock %}
