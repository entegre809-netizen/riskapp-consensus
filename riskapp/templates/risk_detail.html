{% extends "base.html" %}
{% block title %}Risk DetayÄ± Â· {{ r.title }}{% endblock %}
{% block content %}

<style>
  /* ===== Genel dÃ¼zen ===== */
  .page { display:grid; gap:12px; }
  .cols { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
  @media (max-width: 1060px){ .cols{ grid-template-columns: 1fr; } }

  .sticky-top{
    position: sticky; top: 8px; z-index: 5;
    background: var(--bg, transparent);
    padding: 8px 0 0;
  }

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:.25rem .55rem;
    border-radius:999px; font-size:.8rem;
    border:1px solid var(--line,#e5e7eb);
  }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:.2rem .5rem; border-radius:8px;
    border:1px solid var(--line,#e5e7eb);
    font-size:.78rem; opacity:.9;
  }

  /* tablo */
  .table { width:100%; border-collapse: collapse; }
  .table th, .table td {
    padding:.45rem .55rem;
    border:1px solid var(--line,#e5e7eb);
    text-align:left;
  }
  .table th {
    position: sticky; top: 0;
    background: var(--card, #fff); z-index: 1;
  }

  /* buton gruplarÄ± */
  .btnbar{ display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
  .btn-tab{
    padding:.35rem .6rem;
    border:1px solid var(--line,#e5e7eb);
    border-radius:8px;
    cursor:pointer;
  }
  .btn-tab[aria-pressed="true"]{
    outline: 2px solid color-mix(in oklab, var(--primary,#6ea8ff) 80%, black 20%);
  }

  /* yardÄ±mcÄ±lar */
  .muted{ opacity:.8; font-size:.88rem; }
  .row{ display:flex; gap:8px; align-items:center; }
  .grow{ flex:1; }
  .nowrap{ white-space:nowrap; }
  .right{ display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }
  .danger{ background:#ef4444; border-color:transparent; color:#fff; }

  /* dark tema */
  [data-theme="dark"] .pill,
  [data-theme="dark"] .chip{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
    color: var(--text);
  }
</style>

<div class="page">

  {# ========= TÃœM SAYFADA KULLANILACAK SON DEÄERLENDÄ°RME ========= #}
  {% set evals = (r.evaluations or [])|sort(attribute='id') %}
  {% if evals %}
    {% set last_eval = evals|last %}
  {% else %}
    {% set last_eval = None %}
  {% endif %}

  {% if last_eval %}
    {% set last_rpn = (last_eval.probability or 0) * (last_eval.severity or 0) %}
    {% set last_rpn_display = last_rpn %}
    {% if last_eval.comment and 'RPN ort:' in last_eval.comment %}
      {% set _chunk = last_eval.comment.split('RPN ort:')[1].strip() %}
      {% set _num   = _chunk.split(')')[0].strip() %}
      {% set last_rpn_display = _num %}
    {% endif %}
  {% else %}
    {% set last_rpn = None %}
    {% set last_rpn_display = None %}
  {% endif %}

  {# ========= ÃœST Ã–ZET + AKSÄ°YONLAR ========= #}
  <div class="card sticky-top">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div class="grow">

        {# --- baÅŸlÄ±k + pill'ler --- #}
        <div class="row" style="gap:10px; flex-wrap:wrap">
          <h2 style="margin:0">{{ r.title }}</h2>

          {# Ã‡oklu kategori; yoksa tekil category'yi kullan #}
          {% set __cats = [] %}
          {% if r.categories_list %}
            {% set __cats = r.categories_list %}
          {% elif r.category %}
            {% set __cats = [r.category] %}
          {% endif %}

          {% for c in __cats %}
            <span class="pill" title="Kategori"><strong>ğŸ“‚</strong> {{ c }}</span>
          {% endfor %}

          {% if r.risk_type %}
            <span class="pill" title="Risk Tipi"><strong>ğŸ·ï¸</strong> {{ r.risk_type }}</span>
          {% endif %}

          {# grade backend'den gelsin, ama RPN sadece SON kayÄ±t Ã¼zerinden hesaplansÄ±n #}
          {% if r.grade is defined %}
            {% if r.grade is callable %}
              {% set grade = r.grade() %}
            {% else %}
              {% set grade = r.grade %}
            {% endif %}
          {% else %}
            {% set grade = '' %}
          {% endif %}

          {% if last_rpn_display is not none %}
            <span class="pill" title="RPN">
              <strong>RPN</strong> {{ last_rpn_display }}{% if grade %} Â· {{ grade }}{% endif %}
            </span>
          {% endif %}
        </div>

        {% if last_eval %}
          <div class="muted" style="margin-top:4px">
            Son deÄŸerlendirme:
            P = {{ last_eval.probability }},
            S = {{ last_eval.severity }},
            RPN = {{ last_rpn_display }}
            (toplam {{ evals|length }} kayÄ±t)
          </div>
        {% else %}
          <div class="muted" style="margin-top:4px">
            Bu risk iÃ§in henÃ¼z deÄŸerlendirme yok.
          </div>
        {% endif %}
      </div>

      {# --- saÄŸ taraftaki aksiyon butonlarÄ± --- #}
      <div class="btnbar noprint">
        <a class="btn" href="{{ url_for('risk_identify') }}"
           title="TanÄ±mlÄ± risk kÃ¼tÃ¼phanesine git">
          ğŸ“š Åablon KÃ¼tÃ¼phanesi
        </a>

        <a class="btn" href="{{ url_for('risk_new') }}"
           title="Åablondan yeni risk oluÅŸtur">
          â• Yeni Risk
        </a>

        <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}">
          <button class="btn btn-primary" type="submit"
                  title="SayÄ±sal Ã¶zet + RACI + KPI">
            AI Yorum
          </button>
        </form>

        <a class="btn" href="{{ url_for('index') }}">â† Risk Listesine DÃ¶n</a>
      </div>
    </div>

    {% if consensus %}
      <div class="flash info" style="margin-top:10px">
        ğŸ”” KonsensÃ¼s: P={{ consensus.p }}, Å={{ consensus.s }}
        ({{ consensus.count }} oy, eÅŸik {{ threshold }})
        <button class="btn btn-tab" type="button"
                data-p="{{ consensus.p|int }}"
                data-s="{{ consensus.s|int }}"
                onclick="applyConsensus(this.dataset.p, this.dataset.s)">
          KonsensÃ¼sÃ¼ Forma Uygula
        </button>
      </div>
    {% endif %}
  </div>

  <div class="cols">
    {# ========= SOL: RÄ°SK FORMU ========= #}
    <div class="card">
      <form id="riskForm" method="post" class="grid grid-2">

        <div>
          <label>BaÅŸlÄ±k</label>
          <input class="input" name="title" value="{{ r.title }}" required>
        </div>

        <div>
          <label>Durum</label>
          <select class="input" name="status">
            {% for s in ['Open','Assessed','Mitigating','Closed'] %}
              <option value="{{ s }}" {% if r.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Risk Tipi</label>
          <select class="input" name="risk_type">
            <option value="" {% if not r.risk_type %}selected{% endif %}>â€”</option>
            <option value="product"    {% if r.risk_type=='product' %}selected{% endif %}>ÃœrÃ¼n</option>
            <option value="project"    {% if r.risk_type=='project' %}selected{% endif %}>Proje</option>
            <option value="process"    {% if r.risk_type=='process' %}selected{% endif %}>SÃ¼reÃ§/Operasyon</option>
            <option value="schedule"   {% if r.risk_type=='schedule' %}selected{% endif %}>Zaman/Program</option>
            <option value="cost"       {% if r.risk_type=='cost' %}selected{% endif %}>Maliyet/Finans</option>
            <option value="quality"    {% if r.risk_type=='quality' %}selected{% endif %}>Kalite</option>
            <option value="safety"     {% if r.risk_type=='safety' %}selected{% endif %}>Ä°SG/GÃ¼venlik</option>
            <option value="supplier"   {% if r.risk_type=='supplier' %}selected{% endif %}>TedarikÃ§i/AltyÃ¼klenici</option>
            <option value="legal"      {% if r.risk_type=='legal' %}selected{% endif %}>Hukuk/SÃ¶zleÅŸme</option>
            <option value="compliance" {% if r.risk_type=='compliance' %}selected{% endif %}>Uyum/RegÃ¼lasyon</option>
            <option value="environment"{% if r.risk_type=='environment' %}selected{% endif %}>Ã‡evresel</option>
            <option value="security"   {% if r.risk_type=='security' %}selected{% endif %}>Bilgi GÃ¼venliÄŸi</option>
            <option value="stakeholder"{% if r.risk_type=='stakeholder' %}selected{% endif %}>PaydaÅŸ/Ä°letiÅŸim</option>
            <option value="technology" {% if r.risk_type=='technology' %}selected{% endif %}>Teknoloji/AltyapÄ±</option>
          </select>
        </div>

        <div>
          <label>Sorumlu</label>
          <input class="input" name="responsible" value="{{ r.responsible or '' }}">
        </div>

        <div style="grid-column:1/-1">
          <label>AÃ§Ä±klama</label>
          <textarea class="input" name="description" rows="3"
                    placeholder="Riskin baÄŸlamÄ±nÄ± yazÄ±n">{{ r.description or '' }}</textarea>
        </div>

        <div style="grid-column:1/-1">
          <label>Ã–nlemler (Mitigation)</label>
          <textarea class="input"
                    id="mitigation-textarea"
                    name="mitigation"
                    rows="3"
                    placeholder="Ã–nerilen aksiyonlar">{{ r.mitigation or '' }}</textarea>
        </div>

        {# Tarihler #}
        <div>
          <label>BaÅŸlangÄ±Ã§ Tarihi</label>
          <input class="input" type="date" id="start_date"
                 value="{{ (r.start_month ~ '-01') if r.start_month else '' }}">
          <input type="hidden" name="start_month" id="start_month"
                 value="{{ r.start_month or '' }}">
        </div>

        <div>
          <label>BitiÅŸ Tarihi</label>
          <input class="input" type="date" id="end_date"
                 value="{{ (r.end_month ~ '-28') if r.end_month else '' }}">
          <input type="hidden" name="end_month" id="end_month"
                 value="{{ r.end_month or '' }}">
        </div>

        <div class="right" style="grid-column:1/-1">
          <button class="btn btn-primary" id="saveBtn" title="Ctrl+S">Kaydet</button>
        </div>
      </form>
    </div>

    {# ========= SAÄ: DEÄERLENDÄ°RMELER ========= #}
    <div class="card">
      <h3 style="margin-top:0">GeÃ§miÅŸ Ä°ÅŸlem Verileri</h3>

      <div class="grid grid-2" style="margin-bottom:10px">
        <div class="chip">
          <strong>Son P/S</strong> Â·
          {% if last_eval %}
            P={{ last_eval.probability }},
            S={{ last_eval.severity }},
            RPN={{ last_rpn_display }}
          {% else %}
            HenÃ¼z deÄŸerlendirme yok
          {% endif %}
        </div>
        <div class="chip">
          <strong>RPN Rozeti</strong>:
          {% if last_rpn_display is not none %}
            {{ last_rpn_display }}{% if grade %} Â· {{ grade }}{% endif %}
          {% else %}
            â€”
          {% endif %}
        </div>
      </div>

      {# Sistem Ã¶nerisi (ps_reco yoksa sessizce geÃ§) #}
      {% if ps_reco and (ps_reco.p or ps_reco.s) %}
        <div class="card" style="margin-bottom:10px">
          <div class="row" style="justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <h4 style="margin:.25rem 0">Sistemin Ã–nerdiÄŸi P/S</h4>
              <div class="muted">
                AynÄ± kategorideki geÃ§miÅŸ deÄŸerlendirmelerin <em>modu</em>.
              </div>
              <div style="margin-top:6px" class="btnbar">
                <span class="pill">P: {{ ps_reco.p or 'â€”' }}</span>
                <span class="pill">S: {{ ps_reco.s or 'â€”' }}</span>
              </div>
            </div>
            <form method="post" action="{{ url_for('add_eval', risk_id=r.id) }}"
                  class="right" style="min-width:260px">
              <input type="hidden" name="probability" value="{{ ps_reco.p or '' }}">
              <input type="hidden" name="severity"    value="{{ ps_reco.s or '' }}">
              <input class="input grow" type="text" name="comment"
                     placeholder="Yorum (opsiyonel)">
              <button class="btn btn-success" type="submit">
                Bu P/S ile deÄŸerlendir
              </button>
            </form>
          </div>
        </div>
      {% endif %}

      {# ========= Ã‡OKLU RÄ°SK Ä°Ã‡Ä°N DEÄERLENDÄ°RME FORMLARI ========= #}
      {# bulk_risks backend'ten geliyorsa hepsini kullan, yoksa sadece r #}
      {% if bulk_risks is defined and bulk_risks %}
        {% set eval_targets = bulk_risks %}
      {% else %}
        {% set eval_targets = [r] %}
      {% endif %}

      {% for rr in eval_targets %}
        {% for rr in eval_targets %}
  <div class="eval-block" data-risk-id="{{ rr.id }}">

          {% if eval_targets|length > 1 %}
            <div class="muted" style="margin-bottom:4px">
              <strong>{{ rr.code or ('Risk #' ~ rr.id) }}</strong> Â· {{ rr.title }}
            </div>
          {% endif %}
          <form method="post"
                action="{{ url_for('add_eval', risk_id=rr.id) }}"
                class="grid">
            <div class="grid grid-2">
              <div>
                <label>OlasÄ±lÄ±k (P)</label>
                <select class="input probSel" name="probability">
                  {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
                <div class="btnbar" style="margin-top:6px">
                  {% for i in range(1,6) %}
                    <button class="btn btn-tab" type="button" data-setp="{{i}}">{{ i }}</button>
                  {% endfor %}
                </div>
              </div>
              <div>
                <label>Åiddet (S)</label>
                <select class="input sevSel" name="severity">
                  {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
                <div class="btnbar" style="margin-top:6px">
                  {% for i in range(1,6) %}
                    <button class="btn btn-tab" type="button" data-sets="{{i}}">{{ i }}</button>
                  {% endfor %}
                </div>
              </div>
            </div>

            <div class="row">
              <input class="input grow" name="evaluator"
                     placeholder="DeÄŸerlendiren (opsiyonel)">
              <span class="pill nowrap liveRpn">RPN: 1Ã—1 = 1</span>
            </div>
            <input class="input" name="comment" placeholder="Yorum (opsiyonel)">
            <div class="right">
              <button class="btn btn-success">DeÄŸerlendirmeyi Ekle</button>
            </div>
          </form>
        </div>
      {% endfor %}

      {# ========= GEÃ‡MÄ°Å KAYIT TABLOSU â€” VARSAYILAN GÄ°ZLÄ° ========= #}
      <details class="history-details" style="margin-top:10px">
        <summary class="muted" style="cursor:pointer; padding:.35rem .1rem;">
          GeÃ§miÅŸ deÄŸerlendirmeleri gÃ¶ster/gizle
        </summary>
        <div style="margin-top:6px; max-height:260px; overflow:auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>DeÄŸerlendiren</th>
                <th>P</th>
                <th>Å</th>
                <th>RPN</th>
                <th>Yorum</th>
              </tr>
            </thead>
            <tbody>
              {% for e in r.evaluations|sort(attribute='id', reverse=True) %}
                <tr>
                  <td>{{ e.created_at.strftime('%d.%m.%Y %H:%M') if e.created_at else '-' }}</td>
                  <td>{{ e.evaluator or '-' }}</td>
                  <td>{{ e.probability }}</td>
                  <td>{{ e.severity }}</td>
                  <td>
                    {% if e.probability and e.severity %}
                      {% set row_rpn = e.probability * e.severity %}
                      {% set row_rpn_display = row_rpn %}
                      {% if e.comment and 'RPN ort:' in e.comment %}
                        {% set __chunk = e.comment.split('RPN ort:')[1].strip() %}
                        {% set __num   = __chunk.split(')')[0].strip() %}
                        {% set row_rpn_display = __num %}
                      {% endif %}
                      {{ row_rpn_display }}
                    {% else %}
                      â€”
                    {% endif %}
                  </td>
                  <td>{{ e.comment or '-' }}</td>
                </tr>
              {% else %}
                <tr><td colspan="6">HenÃ¼z deÄŸerlendirme yok.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>

    {# ========= ALT: YORUMLAR ========= #}
    <div class="card" style="grid-column:1/-1">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin-top:0">Yorumlar</h3>
        <div class="muted">{{ (r.comments|length) or 0 }} yorum</div>
      </div>

      <div class="grid">
        {% for c in r.comments|sort(attribute='id', reverse=True) %}
          <div class="comment {% if c.is_system %}system{% endif %}">
            <div class="row meta" style="justify-content:space-between">
              <strong>{% if c.is_system %}Sistem{% else %}KullanÄ±cÄ±{% endif %}</strong>
              <span class="muted">
                {{ c.created_at.strftime('%d.%m.%Y') if c.created_at else '' }} Â·
                {{ c.created_at.strftime('%H:%M') if c.created_at else '' }}
              </span>
            </div>

            {% set _txt = c.text or '' %}
            {% set _is_long = _txt|length > 900 %}
            {% if _is_long %}
              <details style="margin-top:.35rem">
                <summary class="muted" style="cursor:pointer">Yorumu aÃ§/kapat</summary>
                <pre style="margin-top:.35rem">{{ _txt }}</pre>
              </details>
            {% else %}
              <pre style="margin-top:.35rem">{{ _txt }}</pre>
            {% endif %}
          </div>
        {% else %}
          <div class="muted">Yorum yok.</div>
        {% endfor %}
      </div>

      {% if session.get('role') == 'admin' %}
        <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}"
              style="margin-top:12px">
          <label>Yeni Yorum</label>
          <textarea class="input" name="text" rows="2"
                    placeholder="GÃ¼ncelleme veya not girin"></textarea>
          <div class="right" style="margin-top:8px">
            <button class="btn">Yorum Ekle</button>
          </div>
        </form>

        <form method="post"
              action="{{ url_for('risk_delete', risk_id=r.id) }}"
              onsubmit="return confirm('Bu riski kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?');"
              style="margin-top:12px" class="right">
          <button class="btn danger">âŒ Risk Sil</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // KonsensÃ¼s P/S'yi ilk deÄŸerlendirme bloÄŸuna bas
  function applyConsensus(p, s) {
    try {
      const block = document.querySelector('.eval-block');
      if (!block) return;
      const pSel = block.querySelector('.probSel');
      const sSel = block.querySelector('.sevSel');
      if (pSel) pSel.value = String(p);
      if (sSel) sSel.value = String(s);
      updateLiveRpnBlock(block);
      block.scrollIntoView({ behavior:'smooth', block:'center' });
    } catch(e){ console.error(e); }
  }

  // Belirli bir eval-block iÃ§in canlÄ± RPN gÃ¼ncelle
  function updateLiveRpnBlock(block){
    const pSel = block.querySelector('.probSel');
    const sSel = block.querySelector('.sevSel');
    if (!pSel || !sSel) return;
    const p = parseInt(pSel.value || '1', 10);
    const s = parseInt(sSel.value || '1', 10);
    const el = block.querySelector('.liveRpn');
    if(el) el.textContent = `RPN: ${p}Ã—${s} = ${p*s}`;
  }

  // TÃ¼m eval-block'larÄ± baÅŸlat
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.eval-block').forEach(block=>{
      const pSel = block.querySelector('.probSel');
      const sSel = block.querySelector('.sevSel');

      if (pSel) pSel.addEventListener('change', ()=>updateLiveRpnBlock(block));
      if (sSel) sSel.addEventListener('change', ()=>updateLiveRpnBlock(block));

      block.querySelectorAll('[data-setp]').forEach(b=>{
        b.addEventListener('click',()=>{
          const v=b.dataset.setp;
          if(pSel){ pSel.value=v; updateLiveRpnBlock(block); }
        });
      });
      block.querySelectorAll('[data-sets]').forEach(b=>{
        b.addEventListener('click',()=>{
          const v=b.dataset.sets;
          if(sSel){ sSel.value=v; updateLiveRpnBlock(block); }
        });
      });

      updateLiveRpnBlock(block);
    });
  });

  // Tarih alanlarÄ± â†’ YYYY-MM
  (function(){
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');
    const startYM   = document.getElementById('start_month');
    const endYM     = document.getElementById('end_month');
    const toYM = (v) => (v && v.length >= 7) ? v.slice(0,7) : "";

    if (startDate && startDate.value) startYM.value = toYM(startDate.value);
    if (endDate   && endDate.value)   endYM.value   = toYM(endDate.value);

    if (startDate) startDate.addEventListener('change', () => {
      startYM.value = toYM(startDate.value);
      if (endDate && endDate.value && new Date(endDate.value) < new Date(startDate.value)) {
        endDate.value = startDate.value; endYM.value = toYM(endDate.value);
      }
    });

    if (endDate) endDate.addEventListener('change', () => {
      endYM.value = toYM(endDate.value);
      if (startDate && startDate.value && new Date(endDate.value) < new Date(startDate.value)) {
        startDate.value = endDate.value; startYM.value = toYM(startDate.value);
      }
    });
  })();

  // Ctrl/Cmd+S -> form kaydet
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      e.preventDefault();
      document.getElementById('saveBtn')?.click();
    }
  });

  // ========= AI SUGGEST: fetch + reload =========
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('aiSuggestForm');
    const btn  = document.getElementById('btn-ai-suggest');

    if (!form || !btn) return;

    form.addEventListener('submit', function (ev) {
      ev.preventDefault();

      const oldText = btn.innerText;
      btn.disabled = true;
      btn.innerText = 'ğŸ¤– Ã‡alÄ±ÅŸÄ±yor...';

      fetch(form.action, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(resp => {
        if (!resp.ok) throw new Error("AI isteÄŸi baÅŸarÄ±sÄ±z");
        return resp.text();
      })
      .then(() => {
        window.location.reload();
      })
      .catch(err => {
        console.error(err);
        alert("AI Ã§aÄŸrÄ±sÄ±nda hata oluÅŸtu.");
        btn.disabled = false;
        btn.innerText = oldText;
      });
    });
  });
</script>

{% endblock %}
