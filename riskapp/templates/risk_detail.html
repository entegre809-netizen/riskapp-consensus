{% extends "base.html" %}
{% block title %}Risk DetayÄ± Â· {{ r.title }}{% endblock %}
{% block content %}

<style>
  /* ===== Genel dÃ¼zen ===== */
  .page { display:grid; gap:12px; }
  .cols { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
  @media (max-width: 1060px){ .cols{ grid-template-columns: 1fr; } }

  .sticky-top{
    position: sticky; top: 8px; z-index: 5;
    background: var(--bg, transparent);
    padding: 8px 0 0;
  }

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:.25rem .55rem;
    border-radius:999px; font-size:.8rem;
    border:1px solid var(--line,#e5e7eb);
  }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:.2rem .5rem; border-radius:8px;
    border:1px solid var(--line,#e5e7eb);
    font-size:.78rem; opacity:.9;
  }

  /* tablo */
  .table { width:100%; border-collapse: collapse; }
  .table th, .table td {
    padding:.45rem .55rem;
    border:1px solid var(--line,#e5e7eb);
    text-align:left;
  }
  .table th {
    position: sticky; top: 0;
    background: var(--card, #fff); z-index: 1;
  }

  /* Mitigation tablo ekstra stiller */
  .mit-table th, .mit-table td{
    font-size:.88rem;
    vertical-align: middle;
  }
  .mit-table input,
  .mit-table select{
    width:100%;
    box-sizing:border-box;
  }
  .mit-actions{
    white-space:nowrap;
    text-align:center;
  }

  .btn-sm{
    padding:.25rem .45rem;
    font-size:.78rem;
    border-radius:6px;
  }

  /* buton gruplarÄ± */
  .btnbar{ display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
  .btn-tab{
    padding:.35rem .6rem;
    border:1px solid var(--line,#e5e7eb);
    border-radius:8px;
    cursor:pointer;
  }
  .btn-tab[aria-pressed="true"]{
    outline: 2px solid color-mix(in oklab, var(--primary,#6ea8ff) 80%, black 20%);
  }

  /* yardÄ±mcÄ±lar */
  .muted{ opacity:.8; font-size:.88rem; }
  .row{ display:flex; gap:8px; align-items:center; }
  .grow{ flex:1; }
  .nowrap{ white-space:nowrap; }
  .right{ display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }
  .danger{ background:#ef4444; border-color:transparent; color:#fff; }

  /* dark tema */
  [data-theme="dark"] .pill,
  [data-theme="dark"] .chip{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
    color: var(--text);
  }

  /* âœ… Costs mini table */
  .cost-mini td, .cost-mini th{ font-size:.88rem; }
  .cost-mini .sumrow td{ font-weight:600; }

  /* âœ… Risk Pareto card */
  .pareto-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    align-items:end;
  }
  @media (max-width: 920px){ .pareto-grid{ grid-template-columns:1fr; } }
  .field{
    display:flex; flex-direction:column; gap:6px;
  }
  .field label{ font-size:.85rem; opacity:.85; }
  .field .input{ width:100%; }
  .hint{
    font-size:.82rem;
    opacity:.8;
    margin-top:6px;
  }
  .chart-box{
    margin-top:10px;
    padding:10px;
    border:1px solid var(--line,#e5e7eb);
    border-radius:12px;
    background: color-mix(in oklab, var(--card, #fff) 96%, transparent);
  }
  [data-theme="dark"] .chart-box{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }

  /* ============================================================
     âœ… SOL: Risk Formu (tasarÄ±m)
     ============================================================ */
  .rf-card{
    padding: 14px 14px 12px;
    border-radius: 14px;
  }
  .rf-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding: 6px 6px 14px;
    border-bottom: 1px solid var(--line,#e5e7eb);
    margin-bottom: 14px;
  }
  .rf-left{
    display:flex; align-items:center; gap:10px;
    font-weight:800;
  }
  .rf-ico{
    width:30px; height:30px;
    border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    background: color-mix(in oklab, var(--primary,#2563eb) 10%, transparent);
    border: 1px solid color-mix(in oklab, var(--primary,#2563eb) 25%, transparent);
  }
  .rf-title{
    margin:0;
    font-size: 1.02rem;
    font-weight: 900;
  }
  .rf-badge{
    font-size:.7rem;
    font-weight:900;
    letter-spacing:.08em;
    padding:.18rem .55rem;
    border-radius: 999px;
    color: color-mix(in oklab, var(--primary,#2563eb) 92%, black 8%);
    background: color-mix(in oklab, var(--primary,#2563eb) 14%, transparent);
    border:1px solid color-mix(in oklab, var(--primary,#2563eb) 22%, transparent);
    white-space: nowrap;
  }
  .rf-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  @media (max-width: 900px){
    .rf-grid{ grid-template-columns:1fr; }
  }
  .rf-field{ display:flex; flex-direction:column; gap:7px; }
  .rf-field label{
    font-size:.84rem;
    font-weight:800;
    color: color-mix(in oklab, var(--text,#0f172a) 90%, transparent);
  }
  .rf-field .input{
    height: 42px;
    border-radius: 10px;
    border: 1px solid color-mix(in oklab, var(--line,#e5e7eb) 85%, transparent);
    background: color-mix(in oklab, var(--card,#fff) 92%, transparent);
    padding: .55rem .75rem;
    outline: none;
    box-shadow: 0 0 0 0 rgba(0,0,0,0);
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .rf-field textarea.input{
    height:auto;
    min-height: 96px;
    padding: .65rem .75rem;
    resize: vertical;
  }
  .rf-field .input:focus{
    border-color: color-mix(in oklab, var(--primary,#2563eb) 55%, var(--line,#e5e7eb) 45%);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary,#2563eb) 18%, transparent);
  }

  .rf-wide{ grid-column: 1 / -1; }
  .rf-actions{
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--line,#e5e7eb);
  }
  .rf-save{
    width:100%;
    display:flex; align-items:center; justify-content:center; gap:10px;
    border-radius: 12px;
    padding: .9rem 1rem;
    font-weight: 900;
    color:#fff;
    background: color-mix(in oklab, var(--primary,#2563eb) 92%, white 8%);
    border:1px solid color-mix(in oklab, var(--primary,#2563eb) 80%, black 20%);
    box-shadow: 0 10px 26px color-mix(in oklab, var(--primary,#2563eb) 22%, transparent);
    cursor:pointer;
  }
  .rf-save:hover{
    filter: brightness(0.98);
    transform: translateY(-1px);
  }
  .rf-save:active{ transform: translateY(0); }

  [data-theme="dark"] .rf-head,
  [data-theme="dark"] .rf-actions{
    border-color: rgba(255,255,255,.12);
  }
  [data-theme="dark"] .rf-field .input{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    color: var(--text,#e5e7eb);
  }
  [data-theme="dark"] .rf-field label{
    color: rgba(226,232,240,.92);
  }

  /* ============================================================
     âœ… SAÄ PANEL (gÃ¶nderdiÄŸin tasarÄ±m): geÃ§miÅŸ + deÄŸerlendirme + maliyet
     ============================================================ */
  .rd-card{ padding: 14px; border-radius: 14px; }
  .rd-section-title{
    font-size:.72rem;
    font-weight:900;
    letter-spacing:.08em;
    opacity:.7;
    text-transform: uppercase;
    margin: 2px 0 10px;
  }
  .rd-kpis{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  @media (max-width: 520px){
    .rd-kpis{ grid-template-columns: 1fr; }
  }
  .rd-kpi{
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    border-radius: 12px;
    padding:10px 10px;
    background: color-mix(in oklab, var(--card,#fff) 96%, transparent);
  }
  .rd-kpi .k{ font-size:.65rem; font-weight:900; letter-spacing:.08em; opacity:.7; text-transform:uppercase; }
  .rd-kpi .v{ margin-top:6px; font-size:1.1rem; font-weight:900; }
  .rd-kpi.rpn{
    background: color-mix(in oklab, #ef4444 8%, transparent);
    border-color: color-mix(in oklab, #ef4444 18%, transparent);
  }
  .rd-kpi.rpn .k{ color:#ef4444; opacity:1; }
  .rd-kpi.rpn .v{ color:#b91c1c; }

  [data-theme="dark"] .rd-kpi{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }
  [data-theme="dark"] .rd-kpi.rpn{
    background: color-mix(in oklab, #ef4444 12%, transparent);
    border-color: color-mix(in oklab, #ef4444 20%, transparent);
  }
  [data-theme="dark"] .rd-kpi.rpn .v{ color:#fecaca; }
  [data-theme="dark"] .rd-kpi.rpn .k{ color:#fca5a5; }

  .rd-add-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin: 2px 0 10px;
  }
  .rd-add-head h3{
    margin:0;
    font-size:1rem;
    font-weight:900;
  }
  .rd-live-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border-radius: 999px;
    padding: .25rem .6rem;
    background: color-mix(in oklab, #f59e0b 16%, transparent);
    border:1px solid color-mix(in oklab, #f59e0b 25%, transparent);
    font-size:.75rem;
    font-weight:900;
    white-space:nowrap;
  }
  .rd-live-pill b{
    font-size: 1rem;
    color: color-mix(in oklab, #b45309 65%, black 35%);
  }
  [data-theme="dark"] .rd-live-pill{
    background: color-mix(in oklab, #f59e0b 18%, transparent);
    border-color: color-mix(in oklab, #f59e0b 25%, transparent);
  }
  [data-theme="dark"] .rd-live-pill b{ color:#fde68a; }

  .rd-score-row{ margin-top:10px; display:grid; gap:12px; }
  .rd-score-block label{
    font-size:.86rem;
    font-weight:900;
    margin-bottom:8px;
    display:block;
  }
  .rd-score-buttons{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:8px;
  }
  .rd-score-btn{
    height: 36px;
    border-radius: 10px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 70%, transparent);
    background: color-mix(in oklab, var(--card,#fff) 96%, transparent);
    font-weight:900;
    cursor:pointer;
  }
  .rd-score-btn:hover{
    border-color: color-mix(in oklab, var(--primary,#2563eb) 30%, var(--line,#e5e7eb) 70%);
  }
  .rd-score-btn.active{
    background: color-mix(in oklab, var(--primary,#2563eb) 16%, transparent);
    border:2px solid color-mix(in oklab, var(--primary,#2563eb) 70%, transparent);
    color: color-mix(in oklab, var(--primary,#2563eb) 88%, black 12%);
  }
  [data-theme="dark"] .rd-score-btn{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }
  [data-theme="dark"] .rd-score-btn.active{
    background: color-mix(in oklab, var(--primary,#6ea8ff) 18%, transparent);
    border-color: color-mix(in oklab, var(--primary,#6ea8ff) 45%, transparent);
    color: #bfdbfe;
  }

  .rd-cost-head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding: 10px 2px 8px;
  }
  .rd-cost-head h3{ margin:0; font-size:.9rem; font-weight:900; letter-spacing:.08em; text-transform:uppercase; opacity:.78; }
  .rd-add-link{
    display:inline-flex; align-items:center; gap:6px;
    font-size:.78rem; font-weight:900;
    color: var(--primary,#2563eb);
    text-decoration:none;
  }
  .rd-add-link:hover{ text-decoration: underline; }

  .rd-cost-table{
    width:100%;
    border-collapse: collapse;
    overflow:hidden;
    border-radius: 12px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
  }
  .rd-cost-table th, .rd-cost-table td{
    padding: .55rem .6rem;
    font-size:.86rem;
    border-bottom:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    text-align:left;
  }
  .rd-cost-table th{
    font-size:.62rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    opacity:.7;
    background: color-mix(in oklab, var(--bg-soft,#f3f4f6) 90%, transparent);
  }
  .rd-cost-table tr:last-child td{ border-bottom:none; }
  .rd-money{ font-weight:900; color:#dc2626; }
  .rd-date{ font-size:.78rem; opacity:.65; white-space:nowrap; }
  [data-theme="dark"] .rd-cost-table{
    border-color: rgba(255,255,255,.14);
  }
  [data-theme="dark"] .rd-cost-table th{
    background: rgba(255,255,255,.04);
  }
  [data-theme="dark"] .rd-cost-table th,
  [data-theme="dark"] .rd-cost-table td{
    border-bottom-color: rgba(255,255,255,.10);
  }
  [data-theme="dark"] .rd-money{ color:#fca5a5; }

  /* ============================================================
     âœ… Yorumlar ve Ä°ÅŸlem GeÃ§miÅŸi (tasarÄ±m)
     ============================================================ */
  .yh-wrap{ padding: 10px 10px 12px; }
  .yh-header{
    display:flex; align-items:center; gap:10px;
    padding: 8px 10px 12px;
    border-bottom:1px solid var(--line,#e5e7eb);
  }
  .yh-header .yh-ico{
    width:34px; height:34px;
    display:flex; align-items:center; justify-content:center;
    border-radius:10px;
    background: color-mix(in oklab, var(--primary,#6ea8ff) 12%, transparent);
    border:1px solid color-mix(in oklab, var(--primary,#6ea8ff) 28%, transparent);
  }
  .yh-title{ font-weight:800; margin:0; }
  .yh-list{ padding: 12px 10px 6px; }
  .yh-item{ display:flex; gap:12px; padding: 10px 6px; }
  .yh-item + .yh-item{ border-top: 1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent); }
  .yh-avatar{
    width:42px; height:42px;
    border-radius:999px;
    display:flex; align-items:center; justify-content:center;
    flex:0 0 42px;
    border: 2px solid color-mix(in oklab, var(--line,#e5e7eb) 55%, transparent);
    background: color-mix(in oklab, var(--bg-soft,#f3f4f6) 92%, transparent);
    overflow:hidden;
  }
  .yh-avatar.system{
    border-color: color-mix(in oklab, var(--primary,#6ea8ff) 35%, transparent);
    background: color-mix(in oklab, var(--primary,#6ea8ff) 14%, transparent);
  }
  .yh-meta{
    display:flex; gap:8px; align-items:baseline; flex-wrap:wrap;
    margin-bottom:4px;
  }
  .yh-name{ font-weight:800; font-size:.95rem; }
  .yh-date{ font-size:.78rem; opacity:.7; }
  .yh-bubble{
    width:100%;
    padding: 10px 12px;
    border-radius: 10px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    background: color-mix(in oklab, var(--bg-soft,#f3f4f6) 92%, transparent);
    font-size:.92rem;
    line-height:1.45;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .yh-bubble.system{
    font-style: italic;
    background: color-mix(in oklab, var(--bg-soft,#f3f4f6) 80%, transparent);
  }
  .yh-actions{
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:12px;
    padding: 12px 10px 0;
    border-top:1px solid var(--line,#e5e7eb);
    align-items:stretch;
  }
  @media (max-width: 980px){
    .yh-actions{ grid-template-columns: 1fr; }
  }
  .yh-newlabel{
    font-size:.72rem;
    letter-spacing:.08em;
    font-weight:800;
    opacity:.75;
    margin-bottom:8px;
  }
  .yh-textarea{ min-height: 74px; resize: vertical; }
  .yh-compose{ display:flex; gap:10px; align-items:flex-end; }
  .yh-compose .grow{ flex:1; }
  .yh-send{ min-width: 92px; }
  .yh-deletebox{
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:stretch;
    justify-content:center;
    padding: 10px;
    border-radius: 12px;
    border:1px solid color-mix(in oklab, var(--line,#e5e7eb) 65%, transparent);
    background: color-mix(in oklab, #ef4444 5%, transparent);
  }
  .yh-deletehint{
    font-size:.72rem;
    opacity:.75;
    text-align:center;
  }

  [data-theme="dark"] .yh-header,
  [data-theme="dark"] .yh-item + .yh-item,
  [data-theme="dark"] .yh-actions{
    border-color: rgba(255,255,255,.12);
  }
  [data-theme="dark"] .yh-bubble{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }
  [data-theme="dark"] .yh-bubble.system{
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.035));
  }
  [data-theme="dark"] .yh-deletebox{
    border-color: rgba(255,255,255,.12);
    background: color-mix(in oklab, #ef4444 10%, transparent);
  }
</style>

<div class="page">

  {# ========= TÃœM SAYFADA KULLANILACAK SON DEÄERLENDÄ°RME ========= #}
  {% set evals = (r.evaluations or [])|sort(attribute='id') %}
  {% set last_eval = (evals|last) if evals else None %}

  {% if last_eval %}
    {% set last_rpn = (last_eval.probability or 0) * (last_eval.severity or 0) %}
    {% set last_rpn_display = last_rpn %}
    {% if last_eval.comment and 'RPN ort:' in last_eval.comment %}
      {% set _chunk = last_eval.comment.split('RPN ort:')[1].strip() %}
      {% set _num   = _chunk.split(')')[0].strip() %}
      {% set last_rpn_display = _num %}
    {% endif %}
  {% else %}
    {% set last_rpn = None %}
    {% set last_rpn_display = None %}
  {% endif %}

  {# RPN seviyesini Excel Ã¶lÃ§eÄŸine gÃ¶re Ã¼ret:
     1â€“4 DÃ¼ÅŸÃ¼k, 5â€“10 Orta, 11â€“15 YÃ¼ksek, 16â€“25 Ã‡ok YÃ¼ksek #}
  {% set grade = '' %}
  {% if last_rpn is not none and last_rpn > 0 %}
    {% if last_rpn <= 4 %}
      {% set grade = 'DÃ¼ÅŸÃ¼k' %}
    {% elif last_rpn <= 10 %}
      {% set grade = 'Orta' %}
    {% elif last_rpn <= 15 %}
      {% set grade = 'YÃ¼ksek' %}
    {% else %}
      {% set grade = 'Ã‡ok YÃ¼ksek' %}
    {% endif %}
  {% endif %}

  {# ========= ÃœST Ã–ZET + AKSÄ°YONLAR ========= #}
  <div class="card sticky-top">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div class="grow">

        <div class="row" style="gap:10px; flex-wrap:wrap">
          <h2 style="margin:0">{{ r.title }}</h2>

          {% set __cats = [] %}
          {% if r.categories_list %}
            {% set __cats = r.categories_list %}
          {% elif r.category %}
            {% set __cats = [r.category] %}
          {% endif %}

          {% for c in __cats %}
            <span class="pill" title="Kategori"><strong>ğŸ“‚</strong> {{ c }}</span>
          {% endfor %}

          {% if r.risk_type %}
            <span class="pill" title="Risk Tipi"><strong>ğŸ·ï¸</strong> {{ r.risk_type }}</span>
          {% endif %}

          {% if last_rpn_display is not none %}
            <span class="pill" title="RPN">
              <strong>RPN</strong> {{ last_rpn_display }}{% if grade %} Â· {{ grade }}{% endif %}
            </span>
          {% endif %}
        </div>

        {% if last_eval %}
          <div class="muted" style="margin-top:4px">
            Son deÄŸerlendirme:
            P = {{ last_eval.probability }},
            S = {{ last_eval.severity }},
            RPN = {{ last_rpn_display }}
            (toplam {{ evals|length }} kayÄ±t)
          </div>
        {% else %}
          <div class="muted" style="margin-top:4px">
            Bu risk iÃ§in henÃ¼z deÄŸerlendirme yok.
          </div>
        {% endif %}
      </div>

      <div class="btnbar noprint">
        <a class="btn" href="{{ url_for('risk_identify') }}" title="TanÄ±mlÄ± risk kÃ¼tÃ¼phanesine git">ğŸ“š Åablon KÃ¼tÃ¼phanesi</a>
        <a class="btn" href="{{ url_for('risk_new') }}" title="Åablondan yeni risk oluÅŸtur">â• Yeni Risk</a>

        <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}">
          <button class="btn btn-primary" type="submit" title="SayÄ±sal Ã¶zet + RACI + KPI">AI Yorum</button>
        </form>

        <a class="btn" href="{{ url_for('index') }}">â† Risk Listesine DÃ¶n</a>
      </div>
    </div>

    {% if consensus %}
      <div class="flash info" style="margin-top:10px">
        ğŸ”” KonsensÃ¼s: P={{ consensus.p }}, Å={{ consensus.s }}
        ({{ consensus.count }} oy, eÅŸik {{ threshold }})
        <button class="btn btn-tab" type="button"
                data-p="{{ consensus.p|int }}"
                data-s="{{ consensus.s|int }}"
                onclick="applyConsensus(this.dataset.p, this.dataset.s)">
          KonsensÃ¼sÃ¼ Forma Uygula
        </button>
      </div>
    {% endif %}
  </div>

  <div class="cols">
    {# ========= SOL: RÄ°SK FORMU (tasarÄ±m eklendi) ========= #}
    <div class="card rf-card">
      <div class="rf-head">
        <div class="rf-left">
          <div class="rf-ico" aria-hidden="true">
            <span class="material-symbols-outlined" style="font-size:18px">assignment</span>
          </div>
          <h3 class="rf-title">Risk Formu</h3>
        </div>
        <span class="rf-badge">TASLAK MODU</span>
      </div>

      <form id="riskForm" method="post" class="rf-grid">
        <div class="rf-field rf-wide">
          <label>Risk BaÅŸlÄ±ÄŸÄ±</label>
          <input class="input" name="title" value="{{ r.title }}" required>
        </div>

        <div class="rf-field">
          <label>Durum</label>
          <select class="input" name="status">
            {% for s in ['Aktif','DeÄŸerlendirildi','AzaltÄ±cÄ±','kapandÄ±'] %}
              <option value="{{ s }}" {% if r.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="rf-field">
          <label>Risk TÃ¼rÃ¼</label>
          <select class="input" name="risk_type">
            <option value="" {% if not r.risk_type %}selected{% endif %}>â€”</option>
            <option value="product"    {% if r.risk_type=='product' %}selected{% endif %}>ÃœrÃ¼n</option>
            <option value="project"    {% if r.risk_type=='project' %}selected{% endif %}>Proje</option>
            <option value="process"    {% if r.risk_type=='process' %}selected{% endif %}>SÃ¼reÃ§/Operasyon</option>
            <option value="schedule"   {% if r.risk_type=='schedule' %}selected{% endif %}>Zaman/Program</option>
            <option value="cost"       {% if r.risk_type=='cost' %}selected{% endif %}>Maliyet/Finans</option>
            <option value="quality"    {% if r.risk_type=='quality' %}selected{% endif %}>Kalite</option>
            <option value="safety"     {% if r.risk_type=='safety' %}selected{% endif %}>Ä°SG/GÃ¼venlik</option>
            <option value="supplier"   {% if r.risk_type=='supplier' %}selected{% endif %}>TedarikÃ§i/AltyÃ¼klenici</option>
            <option value="legal"      {% if r.risk_type=='legal' %}selected{% endif %}>Hukuk/SÃ¶zleÅŸme</option>
            <option value="compliance" {% if r.risk_type=='compliance' %}selected{% endif %}>Uyum/RegÃ¼lasyon</option>
            <option value="environment"{% if r.risk_type=='environment' %}selected{% endif %}>Ã‡evresel</option>
            <option value="security"   {% if r.risk_type=='security' %}selected{% endif %}>Bilgi GÃ¼venliÄŸi</option>
            <option value="stakeholder"{% if r.risk_type=='stakeholder' %}selected{% endif %}>PaydaÅŸ/Ä°letiÅŸim</option>
            <option value="technology" {% if r.risk_type=='technology' %}selected{% endif %}>Teknoloji/AltyapÄ±</option>
          </select>
        </div>

        <div class="rf-field rf-wide">
          <label>Sorumlu KiÅŸi</label>
          <input class="input" name="responsible" value="{{ r.responsible or '' }}">
        </div>

        <div class="rf-field rf-wide">
          <label>Risk AÃ§Ä±klamasÄ±</label>
          <textarea class="input" name="description" rows="3"
                    placeholder="Riskin baÄŸlamÄ±nÄ± yazÄ±n">{{ r.description or '' }}</textarea>
        </div>

        <div class="rf-field rf-wide">
          <label>Ã–nleyici Faaliyetler (Mitigation)</label>
          <textarea class="input"
                    id="mitigation-textarea"
                    name="mitigation"
                    rows="3"
                    placeholder="Ã–nerilen aksiyonlarÄ±n genel Ã¶zeti">{{ r.mitigation or '' }}</textarea>
          <p class="muted" style="margin:6px 0 0">
            AÅŸaÄŸÄ±daki tabloda ise aksiyonlarÄ± satÄ±r satÄ±r tanÄ±mlayabilirsiniz.
          </p>
        </div>

        {# Mitigation tablon varsa buraya koy. JS aÅŸaÄŸÄ±da mitBody/addMitRow arÄ±yor. #}

        <div class="rf-field">
          <label>BaÅŸlangÄ±Ã§ Tarihi</label>
          <input class="input" type="date" id="start_date"
                 value="{{ (r.start_month ~ '-01') if r.start_month else '' }}">
          <input type="hidden" name="start_month" id="start_month"
                 value="{{ r.start_month or '' }}">
        </div>

        <div class="rf-field">
          <label>Termin Tarihi</label>
          <input class="input" type="date" id="end_date"
                 value="{{ (r.end_month ~ '-28') if r.end_month else '' }}">
          <input type="hidden" name="end_month" id="end_month"
                 value="{{ r.end_month or '' }}">
        </div>

        <div class="rf-actions rf-wide">
          <button class="rf-save" id="saveBtn" title="Ctrl+S" type="submit">
            <span class="material-symbols-outlined" style="font-size:18px">save</span>
            Kaydet ve GÃ¼ncelle
          </button>
        </div>
      </form>
    </div>

    {# ========= SAÄ: TasarÄ±mlÄ± panel (geÃ§miÅŸ + deÄŸerlendirme + maliyet) ========= #}
    <div class="card rd-card">
      <div class="rd-section-title">GeÃ§miÅŸ Ä°ÅŸlem Verileri</div>

      <div class="rd-kpis" style="margin-bottom:14px">
        <div class="rd-kpi">
          <div class="k">OlasÄ±lÄ±k (P)</div>
          <div class="v">
            {% if last_eval %}{{ last_eval.probability }}{% else %}â€”{% endif %}
            <span style="font-size:.75rem; font-weight:700; opacity:.55"> / 5</span>
          </div>
        </div>
        <div class="rd-kpi">
          <div class="k">Åiddet (S)</div>
          <div class="v">
            {% if last_eval %}{{ last_eval.severity }}{% else %}â€”{% endif %}
            <span style="font-size:.75rem; font-weight:700; opacity:.55"> / 5</span>
          </div>
        </div>
        <div class="rd-kpi rpn">
          <div class="k">RPN</div>
          <div class="v">
            {% if last_rpn_display is not none %}{{ last_rpn_display }}{% else %}â€”{% endif %}
          </div>
        </div>
      </div>

      {# âœ… Ä°steÄŸe baÄŸlÄ±: ps_reco kartÄ± aynen kalsÄ±n #}
      {% if ps_reco and (ps_reco.p or ps_reco.s) %}
        <div class="card" style="margin: 0 0 12px; padding:12px">
          <div class="row" style="justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <h4 style="margin:.15rem 0 .2rem">Sistemin Ã–nerdiÄŸi P/S</h4>
              <div class="muted">AynÄ± kategorideki geÃ§miÅŸ deÄŸerlendirmelerin <em>modu</em>.</div>
              <div style="margin-top:6px" class="btnbar">
                <span class="pill">P: {{ ps_reco.p or 'â€”' }}</span>
                <span class="pill">S: {{ ps_reco.s or 'â€”' }}</span>
              </div>
            </div>

            <form method="post" action="{{ url_for('add_eval', risk_id=r.id) }}"
                  class="right" style="min-width:260px">
              <input type="hidden" name="probability" value="{{ ps_reco.p or '' }}">
              <input type="hidden" name="severity"    value="{{ ps_reco.s or '' }}">
              <input class="input grow" type="text" name="comment" placeholder="Yorum (opsiyonel)">
              <button class="btn btn-success" type="submit">Bu P/S ile deÄŸerlendir</button>
            </form>
          </div>
        </div>
      {% endif %}

      {# âœ… Eval hedefleri (bulk) aynÄ± #}
      {% if bulk_risks is defined and bulk_risks %}
        {% set eval_targets = bulk_risks %}
      {% else %}
        {% set eval_targets = [r] %}
      {% endif %}

      {% for rr in eval_targets %}
        {% set _lrpn = 0 %}
        <div class="eval-block" data-risk-id="{{ rr.id }}" style="margin-top:10px">

          {% if eval_targets|length > 1 %}
            <div class="muted" style="margin-bottom:6px">
              <strong>{{ rr.code or ('Risk #' ~ rr.id) }}</strong> Â· {{ rr.title }}
            </div>
          {% endif %}

          <div class="rd-add-head">
            <h3>DeÄŸerlendirmeyi Ekle</h3>
            <span class="rd-live-pill">
              <span style="opacity:.85;">CANLI RPN:</span>
              <b class="liveRpnNum">1</b>
            </span>
          </div>

          <form method="post" action="{{ url_for('add_eval', risk_id=rr.id) }}" class="grid">
            <div class="rd-score-row">
              <div class="rd-score-block">
                <label>OlasÄ±lÄ±k Derecesi (Probability)</label>
                <select class="input probSel" name="probability" style="display:none">
                  {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>

                <div class="rd-score-buttons">
                  {% for i in range(1,6) %}
                    <button class="rd-score-btn" type="button" data-setp="{{i}}" aria-pressed="false">{{ i }}</button>
                  {% endfor %}
                </div>
              </div>

              <div class="rd-score-block">
                <label>Åiddet Derecesi (Severity)</label>
                <select class="input sevSel" name="severity" style="display:none">
                  {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>

                <div class="rd-score-buttons">
                  {% for i in range(1,6) %}
                    <button class="rd-score-btn" type="button" data-sets="{{i}}" aria-pressed="false">{{ i }}</button>
                  {% endfor %}
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <input class="input grow" name="evaluator" placeholder="DeÄŸerlendiren (opsiyonel)">
              <span class="pill nowrap liveRpn" style="display:none">RPN: 1Ã—1 = 1</span>
            </div>

            <input class="input" name="comment" placeholder="Yorum (opsiyonel)" style="margin-top:10px">

            <div class="right" style="margin-top:10px">
              <button class="btn btn-success">DeÄŸerlendirmeyi Ekle</button>
            </div>
          </form>
        </div>
      {% endfor %}

      {# âœ… Maliyetler: tasarÄ±mlÄ± mini tablo #}
      <div style="margin-top:16px">
        <div class="rd-cost-head">
          <h3>Bu Riske BaÄŸlÄ± Maliyetler</h3>
          <a class="rd-add-link" href="{{ url_for('costs') }}?risk_id={{ r.id }}">
            <span class="material-symbols-outlined" style="font-size:16px">add_circle</span> Ekle
          </a>
        </div>

        {% if risk_costs and risk_costs|length > 0 %}
          <table class="rd-cost-table">
            <thead>
              <tr>
                <th>Ã–ge</th>
                <th class="nowrap">Maliyet</th>
                <th class="nowrap">Tarih</th>
              </tr>
            </thead>
            <tbody>
              {% for c in risk_costs[:8] %}
                <tr>
                  <td>{{ c.title or 'â€”' }}</td>
                  <td class="rd-money">
                    {% if c.currency %}{{ c.currency|upper }} {% endif %}
                    {{ '%.2f'|format((c.total or 0)|float) }}
                  </td>
                  <td class="rd-date">
                    {{ c.created_at.strftime('%d.%m.%Y') if c.created_at else '-' }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          {% if cost_totals %}
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:6px">Toplam:</div>
              {% for cur, val in cost_totals.items() %}
                <span class="pill" style="margin-right:6px">
                  {{ '%.2f'|format((val or 0)|float) }} {{ cur }}
                </span>
              {% endfor %}
            </div>
          {% endif %}

          {# âœ… Pareto kartÄ±n (Ã¶zellik) AYNEN KALDI #}
          <div class="card" style="margin-top:12px">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div class="grow">
                <h3 style="margin:0">Risk Pareto Analizi</h3>
                <div class="muted">
                  Bu riskâ€™e baÄŸlÄ± maliyetlerin baz para biriminde daÄŸÄ±lÄ±mÄ± (Top-10 + DiÄŸer).
                </div>
              </div>
              <span class="pill" title="Bu riskteki maliyet sayÄ±sÄ±">ğŸ“Œ {{ risk_costs|length }} kalem</span>
            </div>

            <div class="pareto-grid" style="margin-top:10px">
              <div class="field">
                <label>Baz para birimi</label>
                <select class="input" id="rdBaseCurrency">
                  <option value="TRY">TRY</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </div>

              <div class="field">
                <label>Gruplama</label>
                <select class="input" id="rdGroupBy">
                  <option value="category">Kategoriye gÃ¶re</option>
                  <option value="title">BaÅŸlÄ±ÄŸa gÃ¶re</option>
                </select>
              </div>

              <div class="field">
                <label>USD/TRY</label>
                <input class="input" id="rdFxUSDTRY" inputmode="decimal" placeholder="Ã¶rn: 35.20">
              </div>

              <div class="field">
                <label>EUR/TRY</label>
                <input class="input" id="rdFxEURTRY" inputmode="decimal" placeholder="Ã¶rn: 38.10">
              </div>

              <div class="field">
                <label>Tek Sefer yÄ±llÄ±klaÅŸtÄ±rma</label>
                <select class="input" id="rdOneTimePolicy">
                  <option value="1x">1x (yÄ±l iÃ§ine aynen yaz)</option>
                  <option value="0x">0x (yÄ±llÄ±kta yok say)</option>
                  <option value="amortize">Amortize et</option>
                </select>
                <div class="row" style="gap:8px; margin-top:6px">
                  <span class="muted nowrap">YÄ±l:</span>
                  <input class="input" id="rdAmortizeYears" type="number" min="1" value="3" style="max-width:120px">
                  <span class="muted">amortize seÃ§ilirse</span>
                </div>
              </div>

              <div class="field">
                <label>YÄ±llÄ±klaÅŸtÄ±r</label>
                <div class="row" style="align-items:center; gap:10px">
                  <input type="checkbox" id="rdUseAnnual" checked>
                  <span class="muted">AylÄ±k=12, YÄ±llÄ±k=1, TekSefer=policy</span>
                </div>
              </div>
            </div>

            <div class="hint">
              Kur yoksa Ã§oklu para biriminde grafik Ã¼retmez. Ã‡Ã¼nkÃ¼ â€œ0 yazÄ±p yalan sÃ¶ylemekâ€ insan iÅŸi.
            </div>

            <div class="chart-box">
              <div id="rdParetoEmpty" class="muted" style="display:none"></div>
              <canvas id="rdParetoChart" height="120"></canvas>
            </div>
          </div>

        {% else %}
          <div class="muted" style="margin-top:10px">
            Bu riskâ€™e baÄŸlÄ± maliyet yok. â€œEkleâ€ ile baÄŸlayabilirsin.
          </div>
        {% endif %}
      </div>

      {# geÃ§miÅŸ deÄŸerlendirme tablosu (Ã¶zellik) aynen kalsÄ±n #}
      <details class="history-details" style="margin-top:14px">
        <summary class="muted" style="cursor:pointer; padding:.35rem .1rem;">
          GeÃ§miÅŸ deÄŸerlendirmeleri gÃ¶ster/gizle
        </summary>
        <div style="margin-top:6px; max-height:260px; overflow:auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>DeÄŸerlendiren</th>
                <th>P</th>
                <th>Å</th>
                <th>RPN</th>
                <th>Yorum</th>
              </tr>
            </thead>
            <tbody>
              {% for e in (r.evaluations or [])|sort(attribute='id', reverse=True) %}
                <tr>
                  <td>{{ e.created_at.strftime('%d.%m.%Y %H:%M') if e.created_at else '-' }}</td>
                  <td>{{ e.evaluator or '-' }}</td>
                  <td>{{ e.probability }}</td>
                  <td>{{ e.severity }}</td>
                  <td>
                    {% if e.probability and e.severity %}
                      {% set row_rpn = e.probability * e.severity %}
                      {% set row_rpn_display = row_rpn %}
                      {% if e.comment and 'RPN ort:' in e.comment %}
                        {% set __chunk = e.comment.split('RPN ort:')[1].strip() %}
                        {% set __num   = __chunk.split(')')[0].strip() %}
                        {% set row_rpn_display = __num %}
                      {% endif %}
                      {{ row_rpn_display }}
                    {% else %}
                      â€”
                    {% endif %}
                  </td>
                  <td>{{ e.comment or '-' }}</td>
                </tr>
              {% else %}
                <tr><td colspan="6">HenÃ¼z deÄŸerlendirme yok.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>

    {# ============================================================
       âœ… YORUMLAR ve Ä°ÅLEM GEÃ‡MÄ°ÅÄ° (tasarÄ±m)
       ============================================================ #}
    <div class="card" style="grid-column:1/-1">
      <div class="yh-header">
        <div class="yh-ico" aria-hidden="true">
          <span class="material-symbols-outlined" style="font-size:18px">chat</span>
        </div>
        <div class="grow">
          <div class="row" style="justify-content:space-between; align-items:baseline;">
            <h3 class="yh-title">Yorumlar ve Ä°ÅŸlem GeÃ§miÅŸi</h3>
            <div class="muted">{{ (r.comments|length) or 0 }} kayÄ±t</div>
          </div>
        </div>
      </div>

      <div class="yh-wrap">
        <div class="yh-list">
          {% for c in (r.comments or [])|sort(attribute='id', reverse=True) %}
            {% set who = 'System Bot' if c.is_system else (c.author or c.evaluator or 'KullanÄ±cÄ±') %}
            {% set date_str = (c.created_at.strftime('%d.%m.%Y') if c.created_at else '') %}
            {% set time_str = (c.created_at.strftime('%H:%M') if c.created_at else '') %}
            {% set txt = c.text or '' %}
            {% set is_long = txt|length > 900 %}

            <div class="yh-item">
              <div class="yh-avatar {% if c.is_system %}system{% endif %}">
                {% if c.is_system %}
                  <span class="material-symbols-outlined" style="font-size:18px; color: var(--primary,#2563eb)">smart_toy</span>
                {% else %}
                  <span style="font-weight:800; opacity:.75">
                    {{ (who[:1] if who else 'K')|upper }}
                  </span>
                {% endif %}
              </div>

              <div class="grow">
                <div class="yh-meta">
                  <span class="yh-name">{{ who }}</span>
                  <span class="yh-date">
                    {{ date_str }}{% if date_str and time_str %} Â· {% endif %}{{ time_str }}
                  </span>
                </div>

                {% if is_long %}
                  <details>
                    <summary class="muted" style="cursor:pointer; padding:2px 0 8px;">MesajÄ± aÃ§/kapat</summary>
                    <div class="yh-bubble {% if c.is_system %}system{% endif %}">{{ txt }}</div>
                  </details>
                {% else %}
                  <div class="yh-bubble {% if c.is_system %}system{% endif %}">
                    {{ txt }}
                  </div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <div class="muted" style="padding:10px 6px">Yorum yok.</div>
          {% endfor %}
        </div>

        {% if session.get('role') == 'admin' %}
          <div class="yh-actions">
            <div>
              <div class="yh-newlabel">YENÄ° YORUM EKLE</div>

              <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}">
                <div class="yh-compose">
                  <div class="grow">
                    <textarea class="input yh-textarea" name="text" rows="2" placeholder="Fikrinizi paylaÅŸÄ±n..."></textarea>
                  </div>
                  <button class="btn btn-primary yh-send" type="submit">GÃ¶nder</button>
                </div>
              </form>
            </div>

            <div class="yh-deletebox">
              <form method="post"
                    action="{{ url_for('risk_delete', risk_id=r.id) }}"
                    onsubmit="return confirm('Bu riski kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?');">
                <button class="btn danger" type="submit" style="width:100%; padding:.7rem .9rem;">
                  <span class="material-symbols-outlined" style="font-size:18px; vertical-align:-4px; margin-right:6px;">delete</span>
                  Riski Sil
                </button>
              </form>
              <div class="yh-deletehint">Sadece admin yetkisiyle silinebilir.</div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

{# âœ… Risk cost data: JS iÃ§in JSON #}
<script id="riskCostsData" type="application/json">
[
{% if risk_costs and risk_costs|length %}
  {% for c in risk_costs %}
    {
      "title": {{ (c.title or 'â€”')|tojson }},
      "category": {{ (c.category or 'â€”')|tojson }},
      "total": {{ ((c.total or 0)|float) }},
      "currency": {{ ((c.currency or 'TRY')|upper)|tojson }},
      "frequency": {{ (c.frequency or 'Tek Sefer')|tojson }}
    }{{ "," if not loop.last else "" }}
  {% endfor %}
{% endif %}
]
</script>

<script>
  // =============================
  // âœ… Chart.js yÃ¼kle (yoksa)
  // =============================
  function ensureChartJs(){
    return new Promise((resolve) => {
      if (window.Chart) return resolve(true);
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
      s.onload = () => resolve(true);
      s.onerror = () => resolve(false);
      document.head.appendChild(s);
    });
  }

  // =============================
  // KonsensÃ¼s P/S
  // =============================
  function applyConsensus(p, s) {
    try {
      const block = document.querySelector('.eval-block');
      if (!block) return;
      const pSel = block.querySelector('.probSel');
      const sSel = block.querySelector('.sevSel');
      if (pSel) pSel.value = String(p);
      if (sSel) sSel.value = String(s);
      syncButtonsFromSelect(block);
      updateLiveRpnBlock(block);
      block.scrollIntoView({ behavior:'smooth', block:'center' });
    } catch(e){ console.error(e); }
  }

  function updateLiveRpnBlock(block){
    const pSel = block.querySelector('.probSel');
    const sSel = block.querySelector('.sevSel');
    if (!pSel || !sSel) return;
    const p = parseInt(pSel.value || '1', 10);
    const s = parseInt(sSel.value || '1', 10);

    // eski pill (gizli) da gÃ¼ncelle
    const el = block.querySelector('.liveRpn');
    if(el) el.textContent = `RPN: ${p}Ã—${s} = ${p*s}`;

    // yeni header'daki canlÄ± sayÄ±
    const num = block.querySelector('.liveRpnNum');
    if (num) num.textContent = String(p*s);
  }

  function syncButtonsFromSelect(block){
    const pSel = block.querySelector('.probSel');
    const sSel = block.querySelector('.sevSel');
    const pV = pSel ? String(pSel.value || "1") : "1";
    const sV = sSel ? String(sSel.value || "1") : "1";

    block.querySelectorAll('[data-setp]').forEach(b=>{
      const on = (b.dataset.setp === pV);
      b.setAttribute("aria-pressed", on ? "true" : "false");
      b.classList.toggle("active", on);
    });
    block.querySelectorAll('[data-sets]').forEach(b=>{
      const on = (b.dataset.sets === sV);
      b.setAttribute("aria-pressed", on ? "true" : "false");
      b.classList.toggle("active", on);
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{

    // P/S butonlarÄ± + select senkron
    document.querySelectorAll('.eval-block').forEach(block=>{
      const pSel = block.querySelector('.probSel');
      const sSel = block.querySelector('.sevSel');

      // varsayÄ±lan seÃ§imi 1 yap
      if (pSel) pSel.value = pSel.value || "1";
      if (sSel) sSel.value = sSel.value || "1";

      block.querySelectorAll('[data-setp]').forEach(b=>{
        b.addEventListener('click',()=>{
          const v=b.dataset.setp;
          if(pSel){ pSel.value=v; }
          syncButtonsFromSelect(block);
          updateLiveRpnBlock(block);
        });
      });
      block.querySelectorAll('[data-sets]').forEach(b=>{
        b.addEventListener('click',()=>{
          const v=b.dataset.sets;
          if(sSel){ sSel.value=v; }
          syncButtonsFromSelect(block);
          updateLiveRpnBlock(block);
        });
      });

      // ilk init
      syncButtonsFromSelect(block);
      updateLiveRpnBlock(block);
    });

    // AI suggest form varsa: fetch + reload
    const form = document.getElementById('aiSuggestForm');
    const btn  = document.getElementById('btn-ai-suggest');
    if (form && btn){
      form.addEventListener('submit', function (ev) {
        ev.preventDefault();

        const oldText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'ğŸ¤– Ã‡alÄ±ÅŸÄ±yor...';

        fetch(form.action, { method: "POST", headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(resp => {
          if (!resp.ok) throw new Error("AI isteÄŸi baÅŸarÄ±sÄ±z");
          return resp.text();
        })
        .then(() => window.location.reload())
        .catch(err => {
          console.error(err);
          alert("AI Ã§aÄŸrÄ±sÄ±nda hata oluÅŸtu.");
          btn.disabled = false;
          btn.innerText = oldText;
        });
      });
    }
  });

  // =============================
  // Tarih alanlarÄ± â†’ YYYY-MM
  // =============================
  (function(){
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');
    const startYM   = document.getElementById('start_month');
    const endYM     = document.getElementById('end_month');
    const toYM = (v) => (v && v.length >= 7) ? v.slice(0,7) : "";

    if (startDate && startDate.value) startYM.value = toYM(startDate.value);
    if (endDate   && endDate.value)   endYM.value   = toYM(endDate.value);

    if (startDate) startDate.addEventListener('change', () => {
      startYM.value = toYM(startDate.value);
      if (endDate && endDate.value && new Date(endDate.value) < new Date(startDate.value)) {
        endDate.value = startDate.value; endYM.value = toYM(endDate.value);
      }
    });

    if (endDate) endDate.addEventListener('change', () => {
      endYM.value = toYM(endDate.value);
      if (startDate && startDate.value && new Date(endDate.value) < new Date(startDate.value)) {
        startDate.value = endDate.value; startYM.value = toYM(startDate.value);
      }
    });
  })();

  // Ctrl/Cmd+S -> form kaydet
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      e.preventDefault();
      document.getElementById('saveBtn')?.click();
    }
  });

  // Mitigation satÄ±rlarÄ±: dinamik tablo (varsa)
  (function(){
    const tbody = document.getElementById('mitBody');
    const addBtn = document.getElementById('addMitRow');
    if (!tbody || !addBtn) return;

    function bindRow(row){
      const delBtn = row.querySelector('.btn-mit-del');
      if (!delBtn) return;
      delBtn.addEventListener('click', function(e){
        e.preventDefault();
        const rows = tbody.querySelectorAll('tr');
        if (rows.length <= 1){
          row.querySelectorAll('input,select').forEach(el => {
            if (el.tagName === 'SELECT'){ el.selectedIndex = 0; }
            else { el.value = ''; }
          });
        } else {
          row.remove();
        }
      });
    }

    tbody.querySelectorAll('tr').forEach(bindRow);

    addBtn.addEventListener('click', function(e){
      e.preventDefault();
      const template = tbody.querySelector('tr');
      if (!template) return;
      const clone = template.cloneNode(true);
      clone.querySelectorAll('input,select').forEach(el => {
        if (el.tagName === 'SELECT'){ el.selectedIndex = 0; }
        else { el.value = ''; }
      });
      tbody.appendChild(clone);
      bindRow(clone);
    });
  })();

  // ============================================================
  // âœ… RISK DETAIL MINI PARETO (costs_settings_v1 ile ortak)
  // ============================================================
  (function(){
    const LS_KEY = "costs_settings_v1";

    const baseEl = document.getElementById("rdBaseCurrency");
    const usdEl  = document.getElementById("rdFxUSDTRY");
    const eurEl  = document.getElementById("rdFxEURTRY");
    const polEl  = document.getElementById("rdOneTimePolicy");
    const yrsEl  = document.getElementById("rdAmortizeYears");
    const annEl  = document.getElementById("rdUseAnnual");
    const grpEl  = document.getElementById("rdGroupBy");

    const canvas = document.getElementById("rdParetoChart");
    const empty  = document.getElementById("rdParetoEmpty");

    if (!canvas || !empty) return; // maliyet yoksa chart da yok

    const nf2 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function loadSettings(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}") || {}; }
      catch { return {}; }
    }
    function saveSettings(next){
      localStorage.setItem(LS_KEY, JSON.stringify(next || {}));
    }

    function upper(s){ return (s||"").toString().trim().toUpperCase(); }

    function getRatesToTRY(){
      const s = loadSettings();
      const usdTry = parseFloat(usdEl?.value || s.usdTry || "");
      const eurTry = parseFloat(eurEl?.value || s.eurTry || "");
      return {
        TRY: 1,
        USD: Number.isFinite(usdTry) && usdTry > 0 ? usdTry : null,
        EUR: Number.isFinite(eurTry) && eurTry > 0 ? eurTry : null,
      };
    }

    function convertToBase(amount, cur, baseCur){
      const a = Number.isFinite(amount) ? amount : 0;
      const from = upper(cur || "TRY");
      const to = upper(baseCur || "TRY");
      if (from === to) return { ok:true, value:a, reason:"" };

      const rates = getRatesToTRY();
      const rFrom = rates[from];
      const rTo   = rates[to];
      if (rFrom == null || rTo == null){
        return { ok:false, value:a, reason:`Kur eksik: ${from}->TRY veya ${to}->TRY` };
      }
      const tryVal  = a * rFrom;
      const baseVal = tryVal / rTo;
      return { ok:true, value:baseVal, reason:"" };
    }

    function annualFactor(freq){
      if (freq === "AylÄ±k") return 12;
      if (freq === "YÄ±llÄ±k") return 1;

      const s = loadSettings();
      const pol = polEl?.value || s.oneTimePolicy || "1x";
      if (pol === "0x") return 0;
      if (pol === "amortize"){
        const y = Math.max(1, parseInt(yrsEl?.value || s.amortizeYears || 3, 10));
        return 1 / y;
      }
      return 1; // 1x
    }

    function formatMoney(a, cur){
      const safe = Number.isFinite(a) ? a : 0;
      return `${nf2.format(safe)} ${cur||""}`.trim();
    }

    function readRiskCosts(){
      const el = document.getElementById("riskCostsData");
      if (!el) return [];
      try{
        const v = JSON.parse(el.textContent || "[]");
        return Array.isArray(v) ? v : [];
      }catch{
        return [];
      }
    }

    function syncSettings(){
      const s = loadSettings();
      const next = {
        ...s,
        baseCurrency: baseEl?.value || s.baseCurrency || "TRY",
        usdTry: usdEl?.value || s.usdTry || "",
        eurTry: eurEl?.value || s.eurTry || "",
        oneTimePolicy: polEl?.value || s.oneTimePolicy || "1x",
        amortizeYears: yrsEl?.value || s.amortizeYears || 3,
        paretoUseAnnual: !!annEl?.checked,
        paretoGroupBy: grpEl?.value || s.paretoGroupBy || "category",
      };
      saveSettings(next);
    }

    // init UI from shared settings
    (function init(){
      const s = loadSettings();
      if (baseEl) baseEl.value = s.baseCurrency || "TRY";
      if (usdEl) usdEl.value = s.usdTry ?? "";
      if (eurEl) eurEl.value = s.eurTry ?? "";
      if (polEl) polEl.value = s.oneTimePolicy || "1x";
      if (yrsEl) yrsEl.value = s.amortizeYears || 3;
      if (annEl) annEl.checked = (s.paretoUseAnnual ?? true);
      if (grpEl) grpEl.value = s.paretoGroupBy || "category";
    })();

    let chart = null;

    function buildPareto(){
      const rows = readRiskCosts();
      const baseCur = upper(baseEl?.value || "TRY");
      const useAnnual = !!annEl?.checked;
      const groupBy = grpEl?.value || "category";

      const map = new Map();
      let allOk = true;

      rows.forEach(r => {
        const cur = upper(r.currency || "TRY");
        const freq = r.frequency || "Tek Sefer";
        const factor = useAnnual ? annualFactor(freq) : 1;

        const totalRaw = parseFloat(r.total || "0");
        const total = (Number.isFinite(totalRaw) ? totalRaw : 0) * factor;

        const label = (groupBy === "title")
          ? ((r.title || "â€”").trim() || "â€”")
          : ((r.category || "â€”").trim() || "â€”");

        const conv = convertToBase(total, cur, baseCur);
        if (!conv.ok) allOk = false;
        if (conv.ok){
          map.set(label, (map.get(label) || 0) + conv.value);
        }
      });

      const items = Array.from(map.entries())
        .map(([label, value]) => ({ label, value }))
        .filter(x => x.value > 1e-9)
        .sort((a,b) => b.value - a.value);

      const TOP_N = 10;
      let top = items;
      if (items.length > TOP_N){
        const head = items.slice(0, TOP_N);
        const tail = items.slice(TOP_N);
        const otherSum = tail.reduce((s,x)=>s+x.value,0);
        top = [...head, { label:"DiÄŸer", value: otherSum }];
      }

      const sum = top.reduce((s,x)=>s+x.value,0) || 1;
      let cum = 0;

      const labels = [];
      const bars = [];
      const line = [];
      top.forEach(x => {
        cum += x.value;
        labels.push(x.label);
        bars.push(Number(x.value.toFixed(6)));
        line.push(Number(((cum / sum) * 100).toFixed(2)));
      });

      return { ok: allOk, labels, bars, line, baseCur, useAnnual };
    }

    async function render(){
      const okLib = await ensureChartJs();
      if (!okLib || !window.Chart){
        empty.style.display = "block";
        empty.textContent = "Chart.js yÃ¼klenemedi. Ä°nternet/CDN engelli olabilir.";
        if (chart){ chart.destroy(); chart = null; }
        return;
      }

      const p = buildPareto();

      if (!p.ok){
        empty.style.display = "block";
        empty.textContent = "Pareto iÃ§in baz dÃ¶nÃ¼ÅŸÃ¼m lazÄ±m. USD/TRY ve EUR/TRY gir (Ã§oklu para birimi varsa).";
      } else {
        empty.style.display = "none";
      }

      if (!p.labels || p.labels.length === 0){
        empty.style.display = "block";
        empty.textContent = "Pareto iÃ§in yeterli veri yok.";
        if (chart){ chart.destroy(); chart = null; }
        return;
      }

      if (chart){ chart.destroy(); chart = null; }

      const yLabel = p.useAnnual
        ? `Toplam (YÄ±llÄ±klaÅŸtÄ±rÄ±lmÄ±ÅŸ, ${p.baseCur})`
        : `Toplam (${p.baseCur})`;

      chart = new Chart(canvas, {
        type: "bar",
        data: {
          labels: p.labels,
          datasets: [
            { type:"bar", label: yLabel, data: p.bars },
            { type:"line", label: "KÃ¼mÃ¼latif %", data: p.line, yAxisID:"y1" }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y:  { beginAtZero:true, title:{ display:true, text:yLabel } },
            y1: {
              beginAtZero:true, position:"right",
              min:0, max:100,
              grid:{ drawOnChartArea:false },
              title:{ display:true, text:"%" }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(ctx){
                  if (ctx.dataset.type === "line") return ` ${ctx.dataset.label}: ${ctx.parsed.y}%`;
                  return ` ${ctx.dataset.label}: ${formatMoney(ctx.parsed.y, p.baseCur)}`;
                }
              }
            }
          }
        }
      });
    }

    [baseEl, usdEl, eurEl, polEl, yrsEl, annEl, grpEl].filter(Boolean).forEach(el => {
      el.addEventListener("change", ()=>{ syncSettings(); render(); });
      el.addEventListener("input",  ()=>{ syncSettings(); render(); });
    });

    render();
  })();
</script>

{% endblock %}
