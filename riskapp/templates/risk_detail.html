{% extends "base.html" %}
{% block title %}Risk DetayÄ± Â· {{ r.title }}{% endblock %}
{% block content %}

<style>
  /* ===== Genel dÃ¼zen ===== */
  .page { display:grid; gap:12px; }
  .cols { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
  @media (max-width: 1060px){ .cols{ grid-template-columns: 1fr; } }

  .sticky-top{
    position: sticky; top: 8px; z-index: 5;
    background: var(--bg, transparent);
    padding: 8px 0 0;
  }

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:.25rem .55rem;
    border-radius:999px; font-size:.8rem;
    border:1px solid var(--line,#e5e7eb);
  }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:.2rem .5rem; border-radius:8px;
    border:1px solid var(--line,#e5e7eb);
    font-size:.78rem; opacity:.9;
  }

  /* tablo */
  .table { width:100%; border-collapse: collapse; }
  .table th, .table td {
    padding:.45rem .55rem;
    border:1px solid var(--line,#e5e7eb);
    text-align:left;
  }
  .table th {
    position: sticky; top: 0;
    background: var(--card, #fff); z-index: 1;
  }

  /* Mitigation tablo ekstra stiller */
  .mit-table th, .mit-table td{
    font-size:.88rem;
    vertical-align: middle;
  }
  .mit-table input,
  .mit-table select{
    width:100%;
    box-sizing:border-box;
  }
  .mit-actions{
    white-space:nowrap;
    text-align:center;
  }

  .btn-sm{
    padding:.25rem .45rem;
    font-size:.78rem;
    border-radius:6px;
  }

  /* buton gruplarÄ± */
  .btnbar{ display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
  .btn-tab{
    padding:.35rem .6rem;
    border:1px solid var(--line,#e5e7eb);
    border-radius:8px;
    cursor:pointer;
  }
  .btn-tab[aria-pressed="true"]{
    outline: 2px solid color-mix(in oklab, var(--primary,#6ea8ff) 80%, black 20%);
  }

  /* yardÄ±mcÄ±lar */
  .muted{ opacity:.8; font-size:.88rem; }
  .row{ display:flex; gap:8px; align-items:center; }
  .grow{ flex:1; }
  .nowrap{ white-space:nowrap; }
  .right{ display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }
  .danger{ background:#ef4444; border-color:transparent; color:#fff; }

  /* dark tema */
  [data-theme="dark"] .pill,
  [data-theme="dark"] .chip{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
    color: var(--text);
  }

  /* ===== Yorum bloklarÄ± (Sistem + KullanÄ±cÄ±) ===== */
  .comment{
    margin-bottom:10px;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid color-mix(in oklab, var(--line) 80%, transparent);
    background: color-mix(in oklab, var(--bg-soft) 96%, transparent);
  }
  .comment.system{
    border-color: color-mix(in oklab, var(--primary) 55%, var(--line) 45%);
    background:
      radial-gradient(circle at 0 0,
        color-mix(in oklab, var(--primary) 18%, transparent),
        color-mix(in oklab, var(--bg-soft) 96%, transparent));
  }
  .comment .meta{
    font-size:.8rem;
    opacity:.85;
  }
  .comment pre{
    margin-top:.4rem;
    padding:10px 12px;
    border-radius:8px;
    background:#020617;
    color:#e5e7eb;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                 "Liberation Mono","Courier New", monospace;
    font-size:.85rem;
    line-height:1.45;
    white-space:pre-wrap;
  }
  html[data-theme="light"] .comment pre{ background:#0b1120; color:#e5e7eb; }
  html[data-theme="dark"] .comment pre{ background:#020617; color:#e5e7eb; }

  /* âœ… Costs mini table */
  .cost-mini td, .cost-mini th{ font-size:.88rem; }
  .cost-mini .sumrow td{ font-weight:600; }

  /* âœ… Risk Pareto card */
  .pareto-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    align-items:end;
  }
  @media (max-width: 920px){ .pareto-grid{ grid-template-columns:1fr; } }
  .field{
    display:flex; flex-direction:column; gap:6px;
  }
  .field label{ font-size:.85rem; opacity:.85; }
  .field .input{ width:100%; }
  .hint{
    font-size:.82rem;
    opacity:.8;
    margin-top:6px;
  }
  .chart-box{
    margin-top:10px;
    padding:10px;
    border:1px solid var(--line,#e5e7eb);
    border-radius:12px;
    background: color-mix(in oklab, var(--card, #fff) 96%, transparent);
  }
  [data-theme="dark"] .chart-box{
    border-color: rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }
</style>

<div class="page">

  {# ========= TÃœM SAYFADA KULLANILACAK SON DEÄERLENDÄ°RME ========= #}
  {% set evals = (r.evaluations or [])|sort(attribute='id') %}
  {% set last_eval = (evals|last) if evals else None %}

  {% if last_eval %}
    {% set last_rpn = (last_eval.probability or 0) * (last_eval.severity or 0) %}
    {% set last_rpn_display = last_rpn %}
    {% if last_eval.comment and 'RPN ort:' in last_eval.comment %}
      {% set _chunk = last_eval.comment.split('RPN ort:')[1].strip() %}
      {% set _num   = _chunk.split(')')[0].strip() %}
      {% set last_rpn_display = _num %}
    {% endif %}
  {% else %}
    {% set last_rpn = None %}
    {% set last_rpn_display = None %}
  {% endif %}

  {# RPN seviyesini Excel Ã¶lÃ§eÄŸine gÃ¶re Ã¼ret:
     1â€“4 DÃ¼ÅŸÃ¼k, 5â€“10 Orta, 11â€“15 YÃ¼ksek, 16â€“25 Ã‡ok YÃ¼ksek #}
  {% set grade = '' %}
  {% if last_rpn is not none and last_rpn > 0 %}
    {% if last_rpn <= 4 %}
      {% set grade = 'DÃ¼ÅŸÃ¼k' %}
    {% elif last_rpn <= 10 %}
      {% set grade = 'Orta' %}
    {% elif last_rpn <= 15 %}
      {% set grade = 'YÃ¼ksek' %}
    {% else %}
      {% set grade = 'Ã‡ok YÃ¼ksek' %}
    {% endif %}
  {% endif %}

  {# ========= ÃœST Ã–ZET + AKSÄ°YONLAR ========= #}
  <div class="card sticky-top">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div class="grow">

        <div class="row" style="gap:10px; flex-wrap:wrap">
          <h2 style="margin:0">{{ r.title }}</h2>

          {% set __cats = [] %}
          {% if r.categories_list %}
            {% set __cats = r.categories_list %}
          {% elif r.category %}
            {% set __cats = [r.category] %}
          {% endif %}

          {% for c in __cats %}
            <span class="pill" title="Kategori"><strong>ğŸ“‚</strong> {{ c }}</span>
          {% endfor %}

          {% if r.risk_type %}
            <span class="pill" title="Risk Tipi"><strong>ğŸ·ï¸</strong> {{ r.risk_type }}</span>
          {% endif %}

          {% if last_rpn_display is not none %}
            <span class="pill" title="RPN">
              <strong>RPN</strong> {{ last_rpn_display }}{% if grade %} Â· {{ grade }}{% endif %}
            </span>
          {% endif %}
        </div>

        {% if last_eval %}
          <div class="muted" style="margin-top:4px">
            Son deÄŸerlendirme:
            P = {{ last_eval.probability }},
            S = {{ last_eval.severity }},
            RPN = {{ last_rpn_display }}
            (toplam {{ evals|length }} kayÄ±t)
          </div>
        {% else %}
          <div class="muted" style="margin-top:4px">
            Bu risk iÃ§in henÃ¼z deÄŸerlendirme yok.
          </div>
        {% endif %}
      </div>

      <div class="btnbar noprint">
        <a class="btn" href="{{ url_for('risk_identify') }}" title="TanÄ±mlÄ± risk kÃ¼tÃ¼phanesine git">ğŸ“š Åablon KÃ¼tÃ¼phanesi</a>
        <a class="btn" href="{{ url_for('risk_new') }}" title="Åablondan yeni risk oluÅŸtur">â• Yeni Risk</a>

        <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}">
          <button class="btn btn-primary" type="submit" title="SayÄ±sal Ã¶zet + RACI + KPI">AI Yorum</button>
        </form>

        <a class="btn" href="{{ url_for('index') }}">â† Risk Listesine DÃ¶n</a>
      </div>
    </div>

    {% if consensus %}
      <div class="flash info" style="margin-top:10px">
        ğŸ”” KonsensÃ¼s: P={{ consensus.p }}, Å={{ consensus.s }}
        ({{ consensus.count }} oy, eÅŸik {{ threshold }})
        <button class="btn btn-tab" type="button"
                data-p="{{ consensus.p|int }}"
                data-s="{{ consensus.s|int }}"
                onclick="applyConsensus(this.dataset.p, this.dataset.s)">
          KonsensÃ¼sÃ¼ Forma Uygula
        </button>
      </div>
    {% endif %}
  </div>

  <div class="cols">
    {# ========= SOL: RÄ°SK FORMU ========= #}
    <div class="card">
      <form id="riskForm" method="post" class="grid grid-2">

        <div>
          <label>BaÅŸlÄ±k</label>
          <input class="input" name="title" value="{{ r.title }}" required>
        </div>

        <div>
          <label>Durum</label>
          <select class="input" name="status">
            {% for s in ['Aktif','DeÄŸerlendirildi','AzaltÄ±cÄ±','kapandÄ±'] %}
              <option value="{{ s }}" {% if r.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Risk Tipi</label>
          <select class="input" name="risk_type">
            <option value="" {% if not r.risk_type %}selected{% endif %}>â€”</option>
            <option value="product"    {% if r.risk_type=='product' %}selected{% endif %}>ÃœrÃ¼n</option>
            <option value="project"    {% if r.risk_type=='project' %}selected{% endif %}>Proje</option>
            <option value="process"    {% if r.risk_type=='process' %}selected{% endif %}>SÃ¼reÃ§/Operasyon</option>
            <option value="schedule"   {% if r.risk_type=='schedule' %}selected{% endif %}>Zaman/Program</option>
            <option value="cost"       {% if r.risk_type=='cost' %}selected{% endif %}>Maliyet/Finans</option>
            <option value="quality"    {% if r.risk_type=='quality' %}selected{% endif %}>Kalite</option>
            <option value="safety"     {% if r.risk_type=='safety' %}selected{% endif %}>Ä°SG/GÃ¼venlik</option>
            <option value="supplier"   {% if r.risk_type=='supplier' %}selected{% endif %}>TedarikÃ§i/AltyÃ¼klenici</option>
            <option value="legal"      {% if r.risk_type=='legal' %}selected{% endif %}>Hukuk/SÃ¶zleÅŸme</option>
            <option value="compliance" {% if r.risk_type=='compliance' %}selected{% endif %}>Uyum/RegÃ¼lasyon</option>
            <option value="environment"{% if r.risk_type=='environment' %}selected{% endif %}>Ã‡evresel</option>
            <option value="security"   {% if r.risk_type=='security' %}selected{% endif %}>Bilgi GÃ¼venliÄŸi</option>
            <option value="stakeholder"{% if r.risk_type=='stakeholder' %}selected{% endif %}>PaydaÅŸ/Ä°letiÅŸim</option>
            <option value="technology" {% if r.risk_type=='technology' %}selected{% endif %}>Teknoloji/AltyapÄ±</option>
          </select>
        </div>

        <div>
          <label>Sorumlu</label>
          <input class="input" name="responsible" value="{{ r.responsible or '' }}">
        </div>

        <div style="grid-column:1/-1">
          <label>AÃ§Ä±klama</label>
          <textarea class="input" name="description" rows="3"
                    placeholder="Riskin baÄŸlamÄ±nÄ± yazÄ±n">{{ r.description or '' }}</textarea>
        </div>

        <div style="grid-column:1/-1">
          <label>Ã–nlemler (Mitigation) â€“ genel aÃ§Ä±klama</label>
          <textarea class="input"
                    id="mitigation-textarea"
                    name="mitigation"
                    rows="3"
                    placeholder="Ã–nerilen aksiyonlarÄ±n genel Ã¶zeti">{{ r.mitigation or '' }}</textarea>
          <p class="muted" style="margin-top:4px">
            AÅŸaÄŸÄ±daki tabloda ise aksiyonlarÄ± satÄ±r satÄ±r tanÄ±mlayabilirsiniz.
          </p>
        </div>

        {# Mitigation tablon varsa buraya koy. JS aÅŸaÄŸÄ±da mitBody/addMitRow arÄ±yor. #}

        <div>
          <label>BaÅŸlangÄ±Ã§ Tarihi</label>
          <input class="input" type="date" id="start_date"
                 value="{{ (r.start_month ~ '-01') if r.start_month else '' }}">
          <input type="hidden" name="start_month" id="start_month"
                 value="{{ r.start_month or '' }}">
        </div>

        <div>
          <label>BitiÅŸ Tarihi</label>
          <input class="input" type="date" id="end_date"
                 value="{{ (r.end_month ~ '-28') if r.end_month else '' }}">
          <input type="hidden" name="end_month" id="end_month"
                 value="{{ r.end_month or '' }}">
        </div>

        <div class="right" style="grid-column:1/-1">
          <button class="btn btn-primary" id="saveBtn" title="Ctrl+S">Kaydet</button>
        </div>
      </form>
    </div>

    {# ========= SAÄ: DEÄERLENDÄ°RMELER + COST BLOÄU ========= #}
    <div class="card">
      <h3 style="margin-top:0">GeÃ§miÅŸ Ä°ÅŸlem Verileri</h3>

      <div class="grid grid-2" style="margin-bottom:10px">
        <div class="chip">
          <strong>Son P/S</strong> Â·
          {% if last_eval %}
            P={{ last_eval.probability }},
            S={{ last_eval.severity }},
            RPN={{ last_rpn_display }}
          {% else %}
            HenÃ¼z deÄŸerlendirme yok
          {% endif %}
        </div>
        <div class="chip">
          <strong>RPN Rozeti</strong>:
          {% if last_rpn_display is not none %}
            {{ last_rpn_display }}{% if grade %} Â· {{ grade }}{% endif %}
          {% else %}
            â€”
          {% endif %}
        </div>
      </div>

      {% if ps_reco and (ps_reco.p or ps_reco.s) %}
        <div class="card" style="margin-bottom:10px">
          <div class="row" style="justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <h4 style="margin:.25rem 0">Sistemin Ã–nerdiÄŸi P/S</h4>
              <div class="muted">
                AynÄ± kategorideki geÃ§miÅŸ deÄŸerlendirmelerin <em>modu</em>.
              </div>
              <div style="margin-top:6px" class="btnbar">
                <span class="pill">P: {{ ps_reco.p or 'â€”' }}</span>
                <span class="pill">S: {{ ps_reco.s or 'â€”' }}</span>
              </div>
            </div>

            <form method="post" action="{{ url_for('add_eval', risk_id=r.id) }}"
                  class="right" style="min-width:260px">
              <input type="hidden" name="probability" value="{{ ps_reco.p or '' }}">
              <input type="hidden" name="severity"    value="{{ ps_reco.s or '' }}">
              <input class="input grow" type="text" name="comment" placeholder="Yorum (opsiyonel)">
              <button class="btn btn-success" type="submit">Bu P/S ile deÄŸerlendir</button>
            </form>
          </div>
        </div>
      {% endif %}

      {% if bulk_risks is defined and bulk_risks %}
        {% set eval_targets = bulk_risks %}
      {% else %}
        {% set eval_targets = [r] %}
      {% endif %}

      {% for rr in eval_targets %}
        <div class="eval-block" data-risk-id="{{ rr.id }}">

          {% if eval_targets|length > 1 %}
            <div class="muted" style="margin-bottom:4px">
              <strong>{{ rr.code or ('Risk #' ~ rr.id) }}</strong> Â· {{ rr.title }}
            </div>
          {% endif %}

          <form method="post" action="{{ url_for('add_eval', risk_id=rr.id) }}" class="grid">
            <div class="grid grid-2">
              <div>
                <label>OlasÄ±lÄ±k (P)</label>
                <select class="input probSel" name="probability">
                  {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
                <div class="btnbar" style="margin-top:6px">
                  {% for i in range(1,6) %}
                    <button class="btn btn-tab" type="button" data-setp="{{i}}" aria-pressed="false">{{ i }}</button>
                  {% endfor %}
                </div>
              </div>
              <div>
                <label>Åiddet (S)</label>
                <select class="input sevSel" name="severity">
                  {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
                <div class="btnbar" style="margin-top:6px">
                  {% for i in range(1,6) %}
                    <button class="btn btn-tab" type="button" data-sets="{{i}}" aria-pressed="false">{{ i }}</button>
                  {% endfor %}
                </div>
              </div>
            </div>

            <div class="row">
              <input class="input grow" name="evaluator" placeholder="DeÄŸerlendiren (opsiyonel)">
              <span class="pill nowrap liveRpn">RPN: 1Ã—1 = 1</span>
            </div>
            <input class="input" name="comment" placeholder="Yorum (opsiyonel)">
            <div class="right">
              <button class="btn btn-success">DeÄŸerlendirmeyi Ekle</button>
            </div>
          </form>
        </div>
      {% endfor %}

      <details class="history-details" style="margin-top:10px">
        <summary class="muted" style="cursor:pointer; padding:.35rem .1rem;">
          GeÃ§miÅŸ deÄŸerlendirmeleri gÃ¶ster/gizle
        </summary>
        <div style="margin-top:6px; max-height:260px; overflow:auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>DeÄŸerlendiren</th>
                <th>P</th>
                <th>Å</th>
                <th>RPN</th>
                <th>Yorum</th>
              </tr>
            </thead>
            <tbody>
              {% for e in (r.evaluations or [])|sort(attribute='id', reverse=True) %}
                <tr>
                  <td>{{ e.created_at.strftime('%d.%m.%Y %H:%M') if e.created_at else '-' }}</td>
                  <td>{{ e.evaluator or '-' }}</td>
                  <td>{{ e.probability }}</td>
                  <td>{{ e.severity }}</td>
                  <td>
                    {% if e.probability and e.severity %}
                      {% set row_rpn = e.probability * e.severity %}
                      {% set row_rpn_display = row_rpn %}
                      {% if e.comment and 'RPN ort:' in e.comment %}
                        {% set __chunk = e.comment.split('RPN ort:')[1].strip() %}
                        {% set __num   = __chunk.split(')')[0].strip() %}
                        {% set row_rpn_display = __num %}
                      {% endif %}
                      {{ row_rpn_display }}
                    {% else %}
                      â€”
                    {% endif %}
                  </td>
                  <td>{{ e.comment or '-' }}</td>
                </tr>
              {% else %}
                <tr><td colspan="6">HenÃ¼z deÄŸerlendirme yok.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>

      {# ===========================
         âœ… Bu riske baÄŸlÄ± maliyetler
         Backend -> risk_costs, cost_totals
         =========================== #}
      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div>
            <h3 style="margin:0">Bu Riske BaÄŸlÄ± Maliyetler</h3>
            <div class="muted">Risk_id = {{ r.id }} ile baÄŸlÄ± CostItemâ€™lar.</div>
          </div>

          <div class="btnbar">
            <a class="btn btn-primary" href="{{ url_for('costs') }}?risk_id={{ r.id }}">
              â• Bu riske maliyet ekle
            </a>
          </div>
        </div>

        {% if risk_costs and risk_costs|length > 0 %}
          <div style="margin-top:10px; max-height:280px; overflow:auto;">
            <table class="table cost-mini">
              <thead>
                <tr>
                  <th>BaÅŸlÄ±k</th>
                  <th>Kategori</th>
                  <th class="nowrap">Toplam</th>
                  <th class="nowrap">SÄ±klÄ±k</th>
                  <th class="nowrap">Para</th>
                  <th class="nowrap">Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody>
                {% for c in risk_costs %}
                  <tr>
                    <td>{{ c.title or 'â€”' }}</td>
                    <td>{{ c.category or 'â€”' }}</td>
                    <td class="nowrap">{{ '%.2f'|format((c.total or 0)|float) }}</td>
                    <td class="nowrap">{{ c.frequency or 'Tek Sefer' }}</td>
                    <td class="nowrap">{{ c.currency or 'TRY' }}</td>
                    <td class="nowrap">
                      <a class="btn btn-sm" href="{{ url_for('cost_edit', cost_id=c.id) }}">DÃ¼zenle</a>
                    </td>
                  </tr>
                {% endfor %}

                {% if cost_totals %}
                  <tr class="sumrow">
                    <td colspan="6">
                      Toplam:
                      {% for cur, val in cost_totals.items() %}
                        <span class="pill" style="margin-left:6px">
                          {{ '%.2f'|format((val or 0)|float) }} {{ cur }}
                        </span>
                      {% endfor %}
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          {# ===========================
             âœ… Risk iÃ§i mini Pareto
             =========================== #}
          <div class="card" style="margin-top:12px">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div class="grow">
                <h3 style="margin:0">Risk Pareto Analizi</h3>
                <div class="muted">
                  Bu riskâ€™e baÄŸlÄ± maliyetlerin baz para biriminde daÄŸÄ±lÄ±mÄ± (Top-10 + DiÄŸer).
                </div>
              </div>
              <span class="pill" title="Bu riskteki maliyet sayÄ±sÄ±">ğŸ“Œ {{ risk_costs|length }} kalem</span>
            </div>

            <div class="pareto-grid" style="margin-top:10px">
              <div class="field">
                <label>Baz para birimi</label>
                <select class="input" id="rdBaseCurrency">
                  <option value="TRY">TRY</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </div>

              <div class="field">
                <label>Gruplama</label>
                <select class="input" id="rdGroupBy">
                  <option value="category">Kategoriye gÃ¶re</option>
                  <option value="title">BaÅŸlÄ±ÄŸa gÃ¶re</option>
                </select>
              </div>

              <div class="field">
                <label>USD/TRY</label>
                <input class="input" id="rdFxUSDTRY" inputmode="decimal" placeholder="Ã¶rn: 35.20">
              </div>

              <div class="field">
                <label>EUR/TRY</label>
                <input class="input" id="rdFxEURTRY" inputmode="decimal" placeholder="Ã¶rn: 38.10">
              </div>

              <div class="field">
                <label>Tek Sefer yÄ±llÄ±klaÅŸtÄ±rma</label>
                <select class="input" id="rdOneTimePolicy">
                  <option value="1x">1x (yÄ±l iÃ§ine aynen yaz)</option>
                  <option value="0x">0x (yÄ±llÄ±kta yok say)</option>
                  <option value="amortize">Amortize et</option>
                </select>
                <div class="row" style="gap:8px; margin-top:6px">
                  <span class="muted nowrap">YÄ±l:</span>
                  <input class="input" id="rdAmortizeYears" type="number" min="1" value="3" style="max-width:120px">
                  <span class="muted">amortize seÃ§ilirse</span>
                </div>
              </div>

              <div class="field">
                <label>YÄ±llÄ±klaÅŸtÄ±r</label>
                <div class="row" style="align-items:center; gap:10px">
                  <input type="checkbox" id="rdUseAnnual" checked>
                  <span class="muted">AylÄ±k=12, YÄ±llÄ±k=1, TekSefer=policy</span>
                </div>
              </div>
            </div>

            <div class="hint">
              Kur yoksa Ã§oklu para biriminde grafik Ã¼retmez. Ã‡Ã¼nkÃ¼ â€œ0 yazÄ±p yalan sÃ¶ylemekâ€ insan iÅŸi.
            </div>

            <div class="chart-box">
              <div id="rdParetoEmpty" class="muted" style="display:none"></div>
              <canvas id="rdParetoChart" height="120"></canvas>
            </div>
          </div>

        {% else %}
          <div class="muted" style="margin-top:10px">
            Bu riskâ€™e baÄŸlÄ± maliyet yok. â€œBu riske maliyet ekleâ€ ile baÄŸlayabilirsin.
          </div>
        {% endif %}
      </div>

    </div>

    {# ========= ALT: YORUMLAR ========= #}
    <div class="card" style="grid-column:1/-1">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin-top:0">Yorumlar</h3>
        <div class="muted">{{ (r.comments|length) or 0 }} yorum</div>
      </div>

      <div class="grid">
        {% for c in (r.comments or [])|sort(attribute='id', reverse=True) %}
          <div class="comment {% if c.is_system %}system{% endif %}">
            <div class="row meta" style="justify-content:space-between">
              <strong>{% if c.is_system %}Sistem{% else %}KullanÄ±cÄ±{% endif %}</strong>
              <span class="muted">
                {{ c.created_at.strftime('%d.%m.%Y') if c.created_at else '' }} Â·
                {{ c.created_at.strftime('%H:%M') if c.created_at else '' }}
              </span>
            </div>

            {% set _txt = c.text or '' %}
            {% set _is_long = _txt|length > 900 %}
            {% if _is_long %}
              <details style="margin-top:.35rem">
                <summary class="muted" style="cursor:pointer">Yorumu aÃ§/kapat</summary>
                <pre>{{ _txt }}</pre>
              </details>
            {% else %}
              <pre>{{ _txt }}</pre>
            {% endif %}
          </div>
        {% else %}
          <div class="muted">Yorum yok.</div>
        {% endfor %}
      </div>

      {% if session.get('role') == 'admin' %}
        <form method="post" action="{{ url_for('add_comment', risk_id=r.id) }}" style="margin-top:12px">
          <label>Yeni Yorum</label>
          <textarea class="input" name="text" rows="2" placeholder="GÃ¼ncelleme veya not girin"></textarea>
          <div class="right" style="margin-top:8px">
            <button class="btn">Yorum Ekle</button>
          </div>
        </form>

        <form method="post"
              action="{{ url_for('risk_delete', risk_id=r.id) }}"
              onsubmit="return confirm('Bu riski kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?');"
              style="margin-top:12px" class="right">
          <button class="btn danger">âŒ Risk Sil</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

{# âœ… Risk cost data: JS iÃ§in JSON #}
<script id="riskCostsData" type="application/json">
[
{% if risk_costs and risk_costs|length %}
  {% for c in risk_costs %}
    {
      "title": {{ (c.title or 'â€”')|tojson }},
      "category": {{ (c.category or 'â€”')|tojson }},
      "total": {{ ((c.total or 0)|float) }},
      "currency": {{ ((c.currency or 'TRY')|upper)|tojson }},
      "frequency": {{ (c.frequency or 'Tek Sefer')|tojson }}
    }{{ "," if not loop.last else "" }}
  {% endfor %}
{% endif %}
]
</script>

<script>
  // =============================
  // âœ… Chart.js yÃ¼kle (yoksa)
  // =============================
  function ensureChartJs(){
    return new Promise((resolve) => {
      if (window.Chart) return resolve(true);
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
      s.onload = () => resolve(true);
      s.onerror = () => resolve(false);
      document.head.appendChild(s);
    });
  }

  // =============================
  // KonsensÃ¼s P/S
  // =============================
  function applyConsensus(p, s) {
    try {
      // ilk eval bloÄŸa uygula (sayfada birden fazla olabilir)
      const block = document.querySelector('.eval-block');
      if (!block) return;
      const pSel = block.querySelector('.probSel');
      const sSel = block.querySelector('.sevSel');
      if (pSel) pSel.value = String(p);
      if (sSel) sSel.value = String(s);
      syncButtonsFromSelect(block);
      updateLiveRpnBlock(block);
      block.scrollIntoView({ behavior:'smooth', block:'center' });
    } catch(e){ console.error(e); }
  }

  function updateLiveRpnBlock(block){
    const pSel = block.querySelector('.probSel');
    const sSel = block.querySelector('.sevSel');
    if (!pSel || !sSel) return;
    const p = parseInt(pSel.value || '1', 10);
    const s = parseInt(sSel.value || '1', 10);
    const el = block.querySelector('.liveRpn');
    if(el) el.textContent = `RPN: ${p}Ã—${s} = ${p*s}`;
  }

  function syncButtonsFromSelect(block){
    const pSel = block.querySelector('.probSel');
    const sSel = block.querySelector('.sevSel');
    const pV = pSel ? String(pSel.value || "1") : "1";
    const sV = sSel ? String(sSel.value || "1") : "1";

    block.querySelectorAll('[data-setp]').forEach(b=>{
      b.setAttribute("aria-pressed", b.dataset.setp === pV ? "true" : "false");
    });
    block.querySelectorAll('[data-sets]').forEach(b=>{
      b.setAttribute("aria-pressed", b.dataset.sets === sV ? "true" : "false");
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{

    // P/S butonlarÄ± + select senkron
    document.querySelectorAll('.eval-block').forEach(block=>{
      const pSel = block.querySelector('.probSel');
      const sSel = block.querySelector('.sevSel');

      if (pSel) pSel.addEventListener('change', ()=>{
        syncButtonsFromSelect(block);
        updateLiveRpnBlock(block);
      });
      if (sSel) sSel.addEventListener('change', ()=>{
        syncButtonsFromSelect(block);
        updateLiveRpnBlock(block);
      });

      block.querySelectorAll('[data-setp]').forEach(b=>{
        b.addEventListener('click',()=>{
          const v=b.dataset.setp;
          if(pSel){ pSel.value=v; }
          syncButtonsFromSelect(block);
          updateLiveRpnBlock(block);
        });
      });
      block.querySelectorAll('[data-sets]').forEach(b=>{
        b.addEventListener('click',()=>{
          const v=b.dataset.sets;
          if(sSel){ sSel.value=v; }
          syncButtonsFromSelect(block);
          updateLiveRpnBlock(block);
        });
      });

      // ilk init
      syncButtonsFromSelect(block);
      updateLiveRpnBlock(block);
    });

    // AI suggest form varsa: fetch + reload
    const form = document.getElementById('aiSuggestForm');
    const btn  = document.getElementById('btn-ai-suggest');
    if (form && btn){
      form.addEventListener('submit', function (ev) {
        ev.preventDefault();

        const oldText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'ğŸ¤– Ã‡alÄ±ÅŸÄ±yor...';

        fetch(form.action, { method: "POST", headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(resp => {
          if (!resp.ok) throw new Error("AI isteÄŸi baÅŸarÄ±sÄ±z");
          return resp.text();
        })
        .then(() => window.location.reload())
        .catch(err => {
          console.error(err);
          alert("AI Ã§aÄŸrÄ±sÄ±nda hata oluÅŸtu.");
          btn.disabled = false;
          btn.innerText = oldText;
        });
      });
    }
  });

  // =============================
  // Tarih alanlarÄ± â†’ YYYY-MM
  // =============================
  (function(){
    const startDate = document.getElementById('start_date');
    const endDate   = document.getElementById('end_date');
    const startYM   = document.getElementById('start_month');
    const endYM     = document.getElementById('end_month');
    const toYM = (v) => (v && v.length >= 7) ? v.slice(0,7) : "";

    if (startDate && startDate.value) startYM.value = toYM(startDate.value);
    if (endDate   && endDate.value)   endYM.value   = toYM(endDate.value);

    if (startDate) startDate.addEventListener('change', () => {
      startYM.value = toYM(startDate.value);
      if (endDate && endDate.value && new Date(endDate.value) < new Date(startDate.value)) {
        endDate.value = startDate.value; endYM.value = toYM(endDate.value);
      }
    });

    if (endDate) endDate.addEventListener('change', () => {
      endYM.value = toYM(endDate.value);
      if (startDate && startDate.value && new Date(endDate.value) < new Date(startDate.value)) {
        startDate.value = endDate.value; startYM.value = toYM(startDate.value);
      }
    });
  })();

  // Ctrl/Cmd+S -> form kaydet
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      e.preventDefault();
      document.getElementById('saveBtn')?.click();
    }
  });

  // Mitigation satÄ±rlarÄ±: dinamik tablo (varsa)
  (function(){
    const tbody = document.getElementById('mitBody');
    const addBtn = document.getElementById('addMitRow');
    if (!tbody || !addBtn) return;

    function bindRow(row){
      const delBtn = row.querySelector('.btn-mit-del');
      if (!delBtn) return;
      delBtn.addEventListener('click', function(e){
        e.preventDefault();
        const rows = tbody.querySelectorAll('tr');
        if (rows.length <= 1){
          row.querySelectorAll('input,select').forEach(el => {
            if (el.tagName === 'SELECT'){ el.selectedIndex = 0; }
            else { el.value = ''; }
          });
        } else {
          row.remove();
        }
      });
    }

    tbody.querySelectorAll('tr').forEach(bindRow);

    addBtn.addEventListener('click', function(e){
      e.preventDefault();
      const template = tbody.querySelector('tr');
      if (!template) return;
      const clone = template.cloneNode(true);
      clone.querySelectorAll('input,select').forEach(el => {
        if (el.tagName === 'SELECT'){ el.selectedIndex = 0; }
        else { el.value = ''; }
      });
      tbody.appendChild(clone);
      bindRow(clone);
    });
  })();

  // ============================================================
  // âœ… RISK DETAIL MINI PARETO (costs_settings_v1 ile ortak)
  // ============================================================
  (function(){
    const LS_KEY = "costs_settings_v1";

    const baseEl = document.getElementById("rdBaseCurrency");
    const usdEl  = document.getElementById("rdFxUSDTRY");
    const eurEl  = document.getElementById("rdFxEURTRY");
    const polEl  = document.getElementById("rdOneTimePolicy");
    const yrsEl  = document.getElementById("rdAmortizeYears");
    const annEl  = document.getElementById("rdUseAnnual");
    const grpEl  = document.getElementById("rdGroupBy");

    const canvas = document.getElementById("rdParetoChart");
    const empty  = document.getElementById("rdParetoEmpty");

    if (!canvas || !empty) return; // maliyet yoksa chart da yok

    const nf2 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function loadSettings(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}") || {}; }
      catch { return {}; }
    }
    function saveSettings(next){
      localStorage.setItem(LS_KEY, JSON.stringify(next || {}));
    }

    function upper(s){ return (s||"").toString().trim().toUpperCase(); }

    function getRatesToTRY(){
      const s = loadSettings();
      const usdTry = parseFloat(usdEl?.value || s.usdTry || "");
      const eurTry = parseFloat(eurEl?.value || s.eurTry || "");
      return {
        TRY: 1,
        USD: Number.isFinite(usdTry) && usdTry > 0 ? usdTry : null,
        EUR: Number.isFinite(eurTry) && eurTry > 0 ? eurTry : null,
      };
    }

    function convertToBase(amount, cur, baseCur){
      const a = Number.isFinite(amount) ? amount : 0;
      const from = upper(cur || "TRY");
      const to = upper(baseCur || "TRY");
      if (from === to) return { ok:true, value:a, reason:"" };

      const rates = getRatesToTRY();
      const rFrom = rates[from];
      const rTo   = rates[to];
      if (rFrom == null || rTo == null){
        return { ok:false, value:a, reason:`Kur eksik: ${from}->TRY veya ${to}->TRY` };
      }
      const tryVal  = a * rFrom;
      const baseVal = tryVal / rTo;
      return { ok:true, value:baseVal, reason:"" };
    }

    function annualFactor(freq){
      if (freq === "AylÄ±k") return 12;
      if (freq === "YÄ±llÄ±k") return 1;

      const s = loadSettings();
      const pol = polEl?.value || s.oneTimePolicy || "1x";
      if (pol === "0x") return 0;
      if (pol === "amortize"){
        const y = Math.max(1, parseInt(yrsEl?.value || s.amortizeYears || 3, 10));
        return 1 / y;
      }
      return 1; // 1x
    }

    function formatMoney(a, cur){
      const safe = Number.isFinite(a) ? a : 0;
      return `${nf2.format(safe)} ${cur||""}`.trim();
    }

    function readRiskCosts(){
      const el = document.getElementById("riskCostsData");
      if (!el) return [];
      try{
        const v = JSON.parse(el.textContent || "[]");
        return Array.isArray(v) ? v : [];
      }catch{
        return [];
      }
    }

    function syncSettings(){
      const s = loadSettings();
      const next = {
        ...s,
        baseCurrency: baseEl?.value || s.baseCurrency || "TRY",
        usdTry: usdEl?.value || s.usdTry || "",
        eurTry: eurEl?.value || s.eurTry || "",
        oneTimePolicy: polEl?.value || s.oneTimePolicy || "1x",
        amortizeYears: yrsEl?.value || s.amortizeYears || 3,
        paretoUseAnnual: !!annEl?.checked,
        paretoGroupBy: grpEl?.value || s.paretoGroupBy || "category",
      };
      saveSettings(next);
    }

    // init UI from shared settings
    (function init(){
      const s = loadSettings();
      if (baseEl) baseEl.value = s.baseCurrency || "TRY";
      if (usdEl) usdEl.value = s.usdTry ?? "";
      if (eurEl) eurEl.value = s.eurTry ?? "";
      if (polEl) polEl.value = s.oneTimePolicy || "1x";
      if (yrsEl) yrsEl.value = s.amortizeYears || 3;
      if (annEl) annEl.checked = (s.paretoUseAnnual ?? true);
      if (grpEl) grpEl.value = s.paretoGroupBy || "category";
    })();

    let chart = null;

    function buildPareto(){
      const rows = readRiskCosts();
      const baseCur = upper(baseEl?.value || "TRY");
      const useAnnual = !!annEl?.checked;
      const groupBy = grpEl?.value || "category";

      const map = new Map();
      let allOk = true;

      rows.forEach(r => {
        const cur = upper(r.currency || "TRY");
        const freq = r.frequency || "Tek Sefer";
        const factor = useAnnual ? annualFactor(freq) : 1;

        const totalRaw = parseFloat(r.total || "0");
        const total = (Number.isFinite(totalRaw) ? totalRaw : 0) * factor;

        const label = (groupBy === "title")
          ? ((r.title || "â€”").trim() || "â€”")
          : ((r.category || "â€”").trim() || "â€”");

        const conv = convertToBase(total, cur, baseCur);
        if (!conv.ok) allOk = false;
        if (conv.ok){
          map.set(label, (map.get(label) || 0) + conv.value);
        }
      });

      const items = Array.from(map.entries())
        .map(([label, value]) => ({ label, value }))
        .filter(x => x.value > 1e-9)
        .sort((a,b) => b.value - a.value);

      const TOP_N = 10;
      let top = items;
      if (items.length > TOP_N){
        const head = items.slice(0, TOP_N);
        const tail = items.slice(TOP_N);
        const otherSum = tail.reduce((s,x)=>s+x.value,0);
        top = [...head, { label:"DiÄŸer", value: otherSum }];
      }

      const sum = top.reduce((s,x)=>s+x.value,0) || 1;
      let cum = 0;

      const labels = [];
      const bars = [];
      const line = [];
      top.forEach(x => {
        cum += x.value;
        labels.push(x.label);
        bars.push(Number(x.value.toFixed(6)));
        line.push(Number(((cum / sum) * 100).toFixed(2)));
      });

      return { ok: allOk, labels, bars, line, baseCur, useAnnual };
    }

    async function render(){
      const okLib = await ensureChartJs();
      if (!okLib || !window.Chart){
        empty.style.display = "block";
        empty.textContent = "Chart.js yÃ¼klenemedi. Ä°nternet/CDN engelli olabilir.";
        if (chart){ chart.destroy(); chart = null; }
        return;
      }

      const p = buildPareto();

      if (!p.ok){
        empty.style.display = "block";
        empty.textContent = "Pareto iÃ§in baz dÃ¶nÃ¼ÅŸÃ¼m lazÄ±m. USD/TRY ve EUR/TRY gir (Ã§oklu para birimi varsa).";
      } else {
        empty.style.display = "none";
      }

      if (!p.labels || p.labels.length === 0){
        empty.style.display = "block";
        empty.textContent = "Pareto iÃ§in yeterli veri yok.";
        if (chart){ chart.destroy(); chart = null; }
        return;
      }

      if (chart){ chart.destroy(); chart = null; }

      const yLabel = p.useAnnual
        ? `Toplam (YÄ±llÄ±klaÅŸtÄ±rÄ±lmÄ±ÅŸ, ${p.baseCur})`
        : `Toplam (${p.baseCur})`;

      chart = new Chart(canvas, {
        type: "bar",
        data: {
          labels: p.labels,
          datasets: [
            { type:"bar", label: yLabel, data: p.bars },
            { type:"line", label: "KÃ¼mÃ¼latif %", data: p.line, yAxisID:"y1" }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y:  { beginAtZero:true, title:{ display:true, text:yLabel } },
            y1: {
              beginAtZero:true, position:"right",
              min:0, max:100,
              grid:{ drawOnChartArea:false },
              title:{ display:true, text:"%" }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(ctx){
                  if (ctx.dataset.type === "line") return ` ${ctx.dataset.label}: ${ctx.parsed.y}%`;
                  return ` ${ctx.dataset.label}: ${formatMoney(ctx.parsed.y, p.baseCur)}`;
                }
              }
            }
          }
        }
      });
    }

    [baseEl, usdEl, eurEl, polEl, yrsEl, annEl, grpEl].filter(Boolean).forEach(el => {
      el.addEventListener("change", ()=>{ syncSettings(); render(); });
      el.addEventListener("input",  ()=>{ syncSettings(); render(); });
    });

    render();
  })();
</script>

{% endblock %}
