{# templates/costs.html #}
{% extends "base.html" %}

{% block title %}Maliyetler{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/costs.css') }}">

{# âœ… risk_detail'den gelince ?risk_id=... ile gelir #}
{% set ctx_risk_id = request.args.get('risk_id', '') %}
{% set selection_mode = (ctx_risk_id and ctx_risk_id|length > 0) %}

<div class="costs-page"
     data-selection-mode="{% if selection_mode %}1{% else %}0{% endif %}"
     data-ctx-risk-id="{{ ctx_risk_id|e }}">
  <div class="container py-4">

    <!-- Header -->
    <div class="page-head">
      <div>
        <h2 class="mb-1">Maliyet YÃ¶netimi</h2>
        <div class="page-sub">
          Åablondan seÃ§, maliyet gir, aÃ§Ä±klamasÄ±nÄ± yaz; sonra Pareto/Pareto Front ile nereye odaklanacaÄŸÄ±nÄ± gÃ¶r.
        </div>

        {% if selection_mode %}
          <div class="alert alert-info mt-3 mb-0">
            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
              <div>
                <strong>SeÃ§im Modu:</strong> Mevcut maliyetlerden seÃ§ip <strong>Risk #{{ ctx_risk_id }}</strong> ile baÄŸlayabilirsin.
                <div class="small text-muted mt-1">
                  Ä°pucu: AÅŸaÄŸÄ±daki tabloda checkboxâ€™lardan seÃ§ â†’ â€œSeÃ§ilileri Bu Riske BaÄŸlaâ€.
                </div>
              </div>
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('costs') }}">SeÃ§im modundan Ã§Ä±k</a>
            </div>
          </div>
        {% endif %}

        <!-- FX panel -->
        <div class="fx-panel mt-3">
          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <div class="small text-muted">Baz Para:</div>
              <select class="form-select form-select-sm" id="baseCurrency" style="width:110px;">
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>

              <div class="small text-muted ms-2">Tek Sefer:</div>
              <select class="form-select form-select-sm" id="oneTimePolicy" style="width:190px;">
                <option value="1x">YÄ±llÄ±ÄŸa dahil et (1x)</option>
                <option value="0x">YÄ±llÄ±ÄŸa dahil etme (0x)</option>
                <option value="amortize">Amortisman</option>
              </select>

              <div class="d-flex align-items-center gap-2">
                <input type="number" min="1" step="1" id="amortizeYears"
                       class="form-control form-control-sm"
                       style="width:90px;" value="3">
                <span class="small text-muted">yÄ±l</span>
              </div>

              <div class="form-check ms-2">
                <input class="form-check-input" type="checkbox" id="paretoUseAnnual" checked>
                <label class="form-check-label small text-muted" for="paretoUseAnnual">
                  Paretoâ€™da yÄ±llÄ±klaÅŸtÄ±r
                </label>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <div class="small text-muted">Kur (TRY):</div>
              <input class="form-control form-control-sm" id="fxUSDTRY" placeholder="USD/TRY" style="width:110px;">
              <input class="form-control form-control-sm" id="fxEURTRY" placeholder="EUR/TRY" style="width:110px;">
              <span class="small text-muted">Kaydedilir (local)</span>
            </div>
          </div>

          <div class="small text-muted mt-2">
            Not: DÃ¶nÃ¼ÅŸÃ¼m iÃ§in USD/TRY ve EUR/TRY girmen gerekir (USD/EUR satÄ±rlarÄ±n varsa).
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="chip" title="Tablodaki gÃ¶rÃ¼nen satÄ±rlar">
          AnlÄ±k: <strong id="liveTotal">â€”</strong>
        </span>
        <span class="chip" title="Tablodaki gÃ¶rÃ¼nen satÄ±rlar">
          YÄ±llÄ±k: <strong id="liveAnnual">â€”</strong>
        </span>
        <span class="chip" title="Baz para (tablodaki gÃ¶rÃ¼nen satÄ±rlar)">
          AnlÄ±k (Baz): <strong id="liveTotalBase">0</strong>
        </span>
        <span class="chip" title="Baz para (tablodaki gÃ¶rÃ¼nen satÄ±rlar)">
          YÄ±llÄ±k (Baz): <strong id="liveAnnualBase">0</strong>
        </span>
      </div>
    </div>

    <div class="row g-3">

      <!-- LEFT: Templates -->
      <div class="col-12 col-lg-5">
        <div class="card glass-card">
          <div class="card-header d-flex align-items-center justify-content-between gap-2">
            <div>
              <div class="fw-semibold">Maliyet ÅablonlarÄ±</div>
              <small class="text-muted">Formu otomatik doldurur</small>
            </div>

            <button type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#tplCreateModal">
              + Yeni Åablon
            </button>
          </div>

          <div class="card-body">
            <div class="template-toolbar">
              <div class="input-group" style="max-width: 360px;">
                <span class="input-group-text">Ara</span>
                <input class="form-control" id="tplSearch" placeholder="Ã–rn: lisans, ekipman, eÄŸitim">
                <button class="btn btn-outline-secondary" id="tplClearSearch" type="button">Temizle</button>
              </div>

              <div class="d-flex gap-2">
                <select class="form-select" id="tplCategory" style="min-width: 170px;">
                  <option value="">TÃ¼mÃ¼</option>
                  <option value="Ä°ÅŸ GÃ¼cÃ¼">Ä°ÅŸ GÃ¼cÃ¼</option>
                  <option value="Ekipman">Ekipman</option>
                  <option value="YazÄ±lÄ±m">YazÄ±lÄ±m</option>
                  <option value="EÄŸitim">EÄŸitim</option>
                  <option value="Hizmet">Hizmet</option>
                  <option value="Operasyon">Operasyon</option>
                </select>
              </div>
            </div>

            <div class="row g-2" id="tplGrid">

              {% if cost_templates and cost_templates|length > 0 %}
                <div class="col-12">
                  <div class="d-flex align-items-center justify-content-between mb-1">
                    <div class="fw-semibold">Senin ÅablonlarÄ±n</div>
                    <span class="tpl-badge">{{ cost_templates|length }} adet</span>
                  </div>
                </div>

                {% for t in cost_templates %}
                  <div class="col-12">
                    <div class="template-card"
                         data-tpl-id="{{ t.id }}"
                         data-title="{{ (t.title or '')|e }}"
                         data-category="{{ (t.category or '')|e }}"
                         data-unit="{{ (t.unit or '')|e }}"
                         data-currency="{{ (t.currency or 'TRY')|upper|e }}"
                         data-frequency="{{ (t.frequency or 'Tek Sefer')|e }}"
                         data-desc="{{ (t.description or '')|e }}"
                         data-edit-url="{{ url_for('cost_template_edit_post', tpl_id=t.id) }}"
                         data-search="{{ ((t.title or '') ~ ' ' ~ (t.category or '') ~ ' ' ~ (t.unit or '') ~ ' ' ~ (t.currency or '') ~ ' ' ~ (t.frequency or '') ~ ' ' ~ (t.description or ''))|lower|e }}"
                         role="button" tabindex="0">

                      <div class="d-flex align-items-start justify-content-between gap-2">
                        <div>
                          <div class="fw-semibold">{{ t.title }}</div>
                          <div class="template-meta">
                            {{ t.category }} â€¢ {{ t.unit }} â€¢ {{ (t.currency or 'TRY')|upper }} â€¢ {{ t.frequency }}
                          </div>
                        </div>

                        <div class="tpl-actions">
                          <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>

                          <button type="button"
                                  class="btn btn-sm btn-outline-secondary tpl-edit"
                                  data-bs-toggle="modal"
                                  data-bs-target="#tplEditModal">
                            DÃ¼zenle
                          </button>

                          <form method="post"
                                action="{{ url_for('cost_template_delete', tpl_id=t.id) }}"
                                class="d-inline"
                                onsubmit="return confirm('Bu ÅŸablonu silmek istiyor musun?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                              Sil
                            </button>
                          </form>
                        </div>
                      </div>

                      <div class="small text-muted mt-2">
                        {{ t.description or '-' }}
                      </div>
                    </div>
                  </div>
                {% endfor %}

                <hr class="my-3">
              {% endif %}

              <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <div class="fw-semibold">VarsayÄ±lan Åablonlar</div>
                  <span class="tpl-badge">HazÄ±r</span>
                </div>
              </div>

              <!-- Default templates -->
              <div class="col-12">
                <div class="template-card"
                     data-title="Personel / Mesai"
                     data-category="Ä°ÅŸ GÃ¼cÃ¼"
                     data-unit="saat"
                     data-currency="TRY"
                     data-frequency="Tek Sefer"
                     data-desc="Ek mesai, vardiya, geÃ§ici personel, fazla iÅŸ yÃ¼kÃ¼ iÃ§in maliyet."
                     data-search="personel mesai iÅŸ gÃ¼cÃ¼ saat try tek sefer ek mesai vardiya geÃ§ici personel fazla iÅŸ yÃ¼kÃ¼ maliyet"
                     role="button" tabindex="0">
                  <div class="d-flex align-items-start justify-content-between gap-2">
                    <div>
                      <div class="fw-semibold">Personel / Mesai</div>
                      <div class="template-meta">Ä°ÅŸ GÃ¼cÃ¼ â€¢ saat â€¢ TRY â€¢ Tek Sefer</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                  </div>
                  <div class="small text-muted mt-2">Ek mesai, vardiya, geÃ§ici personel gibi kalemler.</div>
                </div>
              </div>

              <div class="col-12">
                <div class="template-card"
                     data-title="YazÄ±lÄ±m LisansÄ±"
                     data-category="YazÄ±lÄ±m"
                     data-unit="lisans"
                     data-currency="USD"
                     data-frequency="YÄ±llÄ±k"
                     data-desc="YÄ±llÄ±k abonelik / lisans bedelleri (SaaS, gÃ¼venlik, ERP vb.)."
                     data-search="yazÄ±lÄ±m lisansÄ± saas abonelik yÄ±llÄ±k usd yazÄ±lÄ±m gÃ¼venlik erp"
                     role="button" tabindex="0">
                  <div class="d-flex align-items-start justify-content-between gap-2">
                    <div>
                      <div class="fw-semibold">YazÄ±lÄ±m LisansÄ±</div>
                      <div class="template-meta">YazÄ±lÄ±m â€¢ lisans â€¢ USD â€¢ YÄ±llÄ±k</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                  </div>
                  <div class="small text-muted mt-2">SaaS/abonelik/lisans kalemleri.</div>
                </div>
              </div>

              <div class="col-12">
                <div class="template-card"
                     data-title="Ekipman / DonanÄ±m"
                     data-category="Ekipman"
                     data-unit="adet"
                     data-currency="EUR"
                     data-frequency="Tek Sefer"
                     data-desc="Cihaz, ekipman, donanÄ±m alÄ±mÄ± (tek seferlik)."
                     data-search="ekipman donanÄ±m cihaz adet eur tek sefer alÄ±m satÄ±n alma"
                     role="button" tabindex="0">
                  <div class="d-flex align-items-start justify-content-between gap-2">
                    <div>
                      <div class="fw-semibold">Ekipman / DonanÄ±m</div>
                      <div class="template-meta">Ekipman â€¢ adet â€¢ EUR â€¢ Tek Sefer</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                  </div>
                  <div class="small text-muted mt-2">Tek seferlik donanÄ±m alÄ±mÄ±.</div>
                </div>
              </div>

              <div class="col-12">
                <div class="template-card"
                     data-title="EÄŸitim / Sertifika"
                     data-category="EÄŸitim"
                     data-unit="kiÅŸi"
                     data-currency="TRY"
                     data-frequency="Tek Sefer"
                     data-desc="Ä°Ã§/dÄ±ÅŸ eÄŸitim, sertifika, workshop, danÄ±ÅŸmanlÄ±k eÄŸitimi."
                     data-search="eÄŸitim sertifika workshop kiÅŸi try tek sefer danÄ±ÅŸmanlÄ±k"
                     role="button" tabindex="0">
                  <div class="d-flex align-items-start justify-content-between gap-2">
                    <div>
                      <div class="fw-semibold">EÄŸitim / Sertifika</div>
                      <div class="template-meta">EÄŸitim â€¢ kiÅŸi â€¢ TRY â€¢ Tek Sefer</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                  </div>
                  <div class="small text-muted mt-2">EÄŸitim ve sertifika maliyetleri.</div>
                </div>
              </div>

              <div class="col-12">
                <div class="template-card"
                     data-title="Operasyon / BakÄ±m"
                     data-category="Operasyon"
                     data-unit="ay"
                     data-currency="TRY"
                     data-frequency="AylÄ±k"
                     data-desc="BakÄ±m, iÅŸletme, operasyonel aylÄ±k giderler."
                     data-search="operasyon bakÄ±m aylÄ±k gider iÅŸletme ay try"
                     role="button" tabindex="0">
                  <div class="d-flex align-items-start justify-content-between gap-2">
                    <div>
                      <div class="fw-semibold">Operasyon / BakÄ±m</div>
                      <div class="template-meta">Operasyon â€¢ ay â€¢ TRY â€¢ AylÄ±k</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                  </div>
                  <div class="small text-muted mt-2">AylÄ±k operasyon/bakÄ±m masraflarÄ±.</div>
                </div>
              </div>

            </div>

            <hr class="my-3">
            <div class="muted-hint">
              Åablonlar â€œtemel varsayÄ±mlarâ€ iÃ§indir. GerÃ§ek dÃ¼nyada her ÅŸey daha karmaÅŸÄ±k.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Add cost form -->
      <div class="col-12 col-lg-7">
        <div class="card glass-card">
          <div class="card-header fw-semibold">Maliyet Ekle</div>
          <div class="card-body">

            <form method="post" action="{{ url_for('costs') }}" id="costForm" novalidate>
              <div class="row g-3">

                <div class="col-12 col-md-6">
                  <label class="form-label">BaÅŸlÄ±k</label>
                  <input class="form-control" name="title" id="title" placeholder="Ã–rn: YazÄ±lÄ±m lisansÄ±" required>
                  <div class="invalid-feedback">BaÅŸlÄ±k gerekli.</div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Kategori</label>
                  <select class="form-select" name="category" id="category" required>
                    <option value="">â€” SeÃ§ â€”</option>
                    {% set cats = cost_categories if cost_categories is defined else ["Ä°ÅŸ GÃ¼cÃ¼","Ekipman","YazÄ±lÄ±m","EÄŸitim","Hizmet","Operasyon"] %}
                    {% for cat in cats %}
                      <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">Kategori gerekli.</div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Birim</label>
                  <input class="form-control" name="unit" id="unit" placeholder="adet / saat / gÃ¼n / lisans" required>
                  <div class="invalid-feedback">Birim gerekli.</div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Para Birimi</label>
                  <select class="form-select" name="currency" id="currency">
                    <option value="TRY">TRY</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                  </select>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">SÄ±klÄ±k</label>
                  <select class="form-select" name="frequency" id="frequency">
                    <option>Tek Sefer</option>
                    <option>AylÄ±k</option>
                    <option>YÄ±llÄ±k</option>
                  </select>
                </div>

                <div class="col-12">
                  <label class="form-label">
                    Riski BaÄŸla (opsiyonel)
                    <span class="text-muted small ms-1">Pareto Front iÃ§in</span>
                  </label>
                  <select class="form-select" name="risk_id" id="risk_id">
                    <option value="">â€” Risk seÃ§me (boÅŸ bÄ±rak) â€”</option>
                    {% if risks and risks|length > 0 %}
                      {% for r in risks %}
                        <option value="{{ r.id }}" {% if selection_mode and (ctx_risk_id|string) == (r.id|string) %}selected{% endif %}>
                          #{{ r.id }} â€¢ {{ r.title }}{% if r.category %} â€¢ {{ r.category }}{% endif %}
                        </option>
                      {% endfor %}
                    {% endif %}
                  </select>
                  <div class="form-text text-muted">
                    Risk seÃ§ersen, bu maliyet Pareto Frontâ€™ta risk skoru (PÃ—S) ile eÅŸleÅŸir.
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Miktar</label>
                  <input class="form-control" type="number" step="0.01" min="0" name="qty" id="qty" placeholder="Ã–rn: 10" required>
                  <div class="invalid-feedback">Miktar gerekli ve 0â€™dan bÃ¼yÃ¼k olmalÄ±.</div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Birim Fiyat</label>
                  <input class="form-control" type="number" step="0.01" min="0" name="unit_price" id="unit_price" placeholder="Ã–rn: 2500" required>
                  <div class="invalid-feedback">Birim fiyat gerekli ve 0â€™dan bÃ¼yÃ¼k olmalÄ±.</div>
                </div>

                <div class="col-12">
                  <label class="form-label">Maliyet AÃ§Ä±klamasÄ±</label>
                  <textarea class="form-control" rows="3" name="description" id="description"
                            placeholder="Bu maliyet neden var, hangi riske/Ã¶nleme baÄŸlÄ±, varsayÄ±mlar neler?"></textarea>
                </div>

                <div class="col-12 d-flex flex-wrap gap-2">
                  <button type="submit" class="btn btn-primary">Kaydet</button>
                  <button type="button" class="btn btn-outline-secondary" id="clearForm">Formu Temizle</button>

                  <div class="ms-auto text-muted small d-flex align-items-center gap-2">
                    <span>AnlÄ±k: <span class="fw-semibold" id="liveTotalInline">0</span></span>
                    <span class="d-none d-md-inline">â€¢</span>
                    <span>YÄ±llÄ±k: <span class="fw-semibold" id="liveAnnualInline">0</span></span>
                  </div>
                </div>

              </div>
            </form>

          </div>
        </div>

        <!-- Costs list -->
        <div class="card glass-card mt-3">
          <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div class="fw-semibold">Mevcut Maliyetler</div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <div class="input-group input-group-sm" style="max-width: 260px;">
                <span class="input-group-text">Filtre</span>
                <input class="form-control" id="tableSearch" placeholder="BaÅŸlÄ±k / kategori">
                <button class="btn btn-outline-secondary" id="tableClearSearch" type="button">X</button>
              </div>

              <select class="form-select form-select-sm" id="tableCurrency" style="min-width: 110px;">
                <option value="">PB</option>
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>

              <select class="form-select form-select-sm" id="tableFrequency" style="min-width: 120px;">
                <option value="">SÄ±klÄ±k</option>
                <option>Tek Sefer</option>
                <option>AylÄ±k</option>
                <option>YÄ±llÄ±k</option>
              </select>

              <button class="btn btn-sm btn-outline-primary" id="exportCsv" type="button">CSV</button>
            </div>
          </div>

          {# âœ… seÃ§im modunda bulk attach bar #}
          {% if selection_mode %}
            <div class="px-3 py-2 border-bottom d-flex flex-wrap gap-2 align-items-center justify-content-between">
              <div class="small text-muted">
                Risk #{{ ctx_risk_id }} iÃ§in seÃ§: <strong id="pickedCount">0</strong>
              </div>

              <form method="post" action="{{ url_for('costs_attach') }}" id="attachForm" class="d-flex gap-2 align-items-center m-0">
                <input type="hidden" name="risk_id" value="{{ ctx_risk_id }}">
                <div id="attachHiddenInputs"></div>

                <button type="submit" class="btn btn-sm btn-primary" id="attachBtn" disabled>
                  SeÃ§ilileri Bu Riske BaÄŸla
                </button>

                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('risk_detail', risk_id=ctx_risk_id) }}">
                  â† Risk DetayÄ±na DÃ¶n
                </a>
              </form>
            </div>
          {% endif %}

          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0 align-middle" id="costTable">
                <thead>
                  <tr>
                    {% if selection_mode %}
                      <th style="width:44px;" class="text-center">
                        <input type="checkbox" id="pickAll" title="Hepsini seÃ§">
                      </th>
                    {% endif %}

                    <th role="button" class="sortable" data-sort="title">BaÅŸlÄ±k</th>
                    <th role="button" class="sortable" data-sort="category">Kategori</th>
                    <th role="button" class="sortable text-end" data-sort="qty">Miktar</th>
                    <th role="button" class="sortable text-end" data-sort="unit_price">Birim Fiyat</th>
                    <th role="button" class="sortable text-end" data-sort="total">Toplam</th>
                    <th role="button" class="sortable text-end" data-sort="frequency">SÄ±klÄ±k</th>
                    <th class="text-end">Detay</th>
                    <th class="text-end">Ä°ÅŸlem</th>
                  </tr>
                </thead>

                <tbody id="costTbody">
                  {% if costs and costs|length > 0 %}
                    {% for c in costs %}
                      {% set cur = (c.currency or 'TRY')|upper %}
                      <tr class="cost-row"
                          data-id="{{ c.id }}"
                          data-title="{{ (c.title or '')|e }}"
                          data-category="{{ (c.category or '')|e }}"
                          data-currency="{{ cur|e }}"
                          data-frequency="{{ (c.frequency or 'Tek Sefer')|e }}"
                          data-qty="{{ c.qty if c.qty is not none else 0 }}"
                          data-unit_price="{{ c.unit_price if c.unit_price is not none else 0 }}"
                          data-total="{{ c.total if c.total is not none else ((c.qty or 0) * (c.unit_price or 0)) }}"
                          data-risk-id="{{ c.risk_id if c.risk_id is not none else '' }}">

                        {% if selection_mode %}
                          <td class="text-center">
                            <input class="pickCost" type="checkbox" value="{{ c.id }}">
                          </td>
                        {% endif %}

                        <td class="fw-semibold">{{ c.title }}</td>
                        <td>{{ c.category }}</td>
                        <td class="text-end">{{ c.qty }}</td>
                        <td class="text-end">{{ c.unit_price }} {{ cur }}</td>
                        <td class="text-end fw-semibold">{{ c.total }} {{ cur }}</td>
                        <td class="text-end">{{ c.frequency }}</td>

                        <td class="text-end cost-actions">
                          {% if c.description %}
                            <button class="btn btn-sm btn-outline-secondary"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#desc_{{ loop.index }}">
                              AÃ§Ä±klama
                            </button>
                          {% else %}
                            <span class="text-muted small">-</span>
                          {% endif %}
                        </td>

                        <td class="text-end">
                          <div class="actions-wrap">
                            <a class="btn btn-outline-primary btn-sm btn-icon"
                               href="{{ url_for('cost_edit', cost_id=c.id) }}"
                               title="DÃ¼zenle">âœ</a>

                            <form method="post"
                                  action="{{ url_for('cost_delete', cost_id=c.id) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('Bu maliyeti silmek istiyor musun?');">
                              <button type="submit"
                                      class="btn btn-outline-danger btn-sm btn-icon"
                                      title="Sil">ğŸ—‘</button>
                            </form>
                          </div>
                        </td>
                      </tr>

                      {% if c.description %}
                        <tr class="desc-row">
                          <td colspan="{% if selection_mode %}9{% else %}8{% endif %}" class="p-0">
                            <div class="collapse" id="desc_{{ loop.index }}">
                              <div class="p-3 small">
                                <span class="fw-semibold">AÃ§Ä±klama:</span>
                                <span class="text-muted">{{ c.description }}</span>
                              </div>
                            </div>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="{% if selection_mode %}9{% else %}8{% endif %}" class="text-center text-muted py-4">
                        HenÃ¼z maliyet yok.
                      </td>
                    </tr>
                  {% endif %}
                </tbody>

                <tfoot>
                  <tr>
                    <th colspan="{% if selection_mode %}5{% else %}4{% endif %}" class="text-end">GÃ¶rÃ¼nen satÄ±rlarÄ±n toplamÄ±</th>
                    <th class="text-end" id="tableTotalCell">0</th>
                    <th class="text-end small text-muted">Baz</th>
                    <th class="text-end" id="tableTotalBaseCell" title="">0</th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="px-3 py-2 small text-muted" id="tableHint">
              Ä°pucu: BaÅŸlÄ±klara tÄ±klayÄ±p sÄ±ralayabilirsin. Filtreler sadece tabloda gÃ¶rÃ¼nenleri etkiler.
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mt-2">
      <div class="col-12 col-lg-6">
        <div class="card glass-card">
          <div class="card-header fw-semibold">Pareto Analizi</div>
          <div class="card-body">
            <div class="text-muted small mb-2">
              En yÃ¼ksek etkiyi en az kaynakla yakalama denemesi. Matematik romantizmi.
            </div>
            <canvas id="paretoChart" height="140"></canvas>
            <div id="paretoEmpty" class="text-muted small mt-2" style="display:none;">
              Pareto verisi yok (ya da kur/yÄ±llÄ±klaÅŸtÄ±rma yÃ¼zÃ¼nden hesaplanamadÄ±).
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card glass-card">
          <div class="card-header fw-semibold">Pareto Front</div>
          <div class="card-body">
            <div class="text-muted small mb-2">
              Maliyet (x) ve fayda/azaltÄ±m (y) arasÄ±nda â€œen iyiâ€ noktalar kÃ¼mesi.
            </div>
            <canvas id="frontChart" height="140"></canvas>
            <div id="frontEmpty" class="text-muted small mt-2" style="display:none;">
              Pareto front verisi yok (ya da backend henÃ¼z gÃ¶ndermiyor).
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script id="frontData" type="application/json">{{ front_json|default(None)|tojson }}</script>

<!-- Modals (aynÄ±) -->
<div class="modal fade" id="tplCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('cost_template_create') }}" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Yeni Åablon Ekle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">BaÅŸlÄ±k</label>
              <input class="form-control" name="title" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Kategori</label>
              <select class="form-select" name="category" required>
                <option value="">â€” SeÃ§ â€”</option>
                {% set cats = cost_categories if cost_categories is defined else ["Ä°ÅŸ GÃ¼cÃ¼","Ekipman","YazÄ±lÄ±m","EÄŸitim","Hizmet","Operasyon"] %}
                {% for cat in cats %}
                  <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Birim</label>
              <input class="form-control" name="unit" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Para Birimi</label>
              <select class="form-select" name="currency">
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">SÄ±klÄ±k</label>
              <select class="form-select" name="frequency">
                <option>Tek Sefer</option>
                <option>AylÄ±k</option>
                <option>YÄ±llÄ±k</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">AÃ§Ä±klama</label>
              <textarea class="form-control" rows="3" name="description"
                        placeholder="VarsayÄ±mlar / kullanÄ±m amacÄ±"></textarea>
            </div>

            <div class="col-12">
              <div class="text-muted small">
                Not: Bu ÅŸablon sadece sol taraftaki listeyi bÃ¼yÃ¼tÃ¼r.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">VazgeÃ§</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="tplEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="tplEditForm" action="#">
        <div class="modal-header">
          <h5 class="modal-title">Åablonu DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">BaÅŸlÄ±k</label>
              <input class="form-control" name="title" id="tplEditTitle" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Kategori</label>
              <select class="form-select" name="category" id="tplEditCategory" required>
                <option value="">â€” SeÃ§ â€”</option>
                {% set cats = cost_categories if cost_categories is defined else ["Ä°ÅŸ GÃ¼cÃ¼","Ekipman","YazÄ±lÄ±m","EÄŸitim","Hizmet","Operasyon"] %}
                {% for cat in cats %}
                  <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Birim</label>
              <input class="form-control" name="unit" id="tplEditUnit" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Para Birimi</label>
              <select class="form-select" name="currency" id="tplEditCurrency">
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">SÄ±klÄ±k</label>
              <select class="form-select" name="frequency" id="tplEditFrequency">
                <option>Tek Sefer</option>
                <option>AylÄ±k</option>
                <option>YÄ±llÄ±k</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">AÃ§Ä±klama</label>
              <textarea class="form-control" rows="3" name="description" id="tplEditDesc"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button type="submit" class="btn btn-primary">GÃ¼ncelle</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="{{ url_for('static', filename='js/costs.js') }}"></script>

  {# âœ… seÃ§im modu JS (costs.js'e dokunmadan, VS Code hatasÄ± yok) #}
  <script>
    (function(){
      const page = document.querySelector(".costs-page");
      if(!page) return;

      const selectionMode = page.dataset.selectionMode === "1";
      if(!selectionMode) return;

      const pickAll = document.getElementById("pickAll");
      const picks = Array.from(document.querySelectorAll(".pickCost"));
      const pickedCount = document.getElementById("pickedCount");
      const attachBtn = document.getElementById("attachBtn");
      const hiddenBox = document.getElementById("attachHiddenInputs");

      function rebuildHidden(){
        if(!hiddenBox) return;
        hiddenBox.innerHTML = "";
        const chosen = picks.filter(x => x.checked).map(x => x.value);

        chosen.forEach(id => {
          const inp = document.createElement("input");
          inp.type = "hidden";
          inp.name = "cost_ids";
          inp.value = id;
          hiddenBox.appendChild(inp);
        });

        const n = chosen.length;
        if(pickedCount) pickedCount.textContent = String(n);
        if(attachBtn) attachBtn.disabled = (n === 0);
      }

      if(pickAll){
        pickAll.addEventListener("change", () => {
          const on = !!pickAll.checked;
          picks.forEach(cb => { cb.checked = on; });
          rebuildHidden();
        });
      }

      picks.forEach(cb => cb.addEventListener("change", () => {
        if(pickAll){
          const allOn = picks.length > 0 && picks.every(x => x.checked);
          const anyOn = picks.some(x => x.checked);
          pickAll.checked = allOn;
          pickAll.indeterminate = (!allOn && anyOn);
        }
        rebuildHidden();
      }));

      rebuildHidden();
    })();
  </script>
{% endblock %}
