{# templates/costs.html #}
{% extends "base.html" %}

{% block title %}Maliyetler{% endblock %}

{% block content %}
<div class="container py-4">

  <style>
    /* --- Layout polish --- */
    .page-head{
      display:flex; flex-wrap:wrap; gap:.75rem;
      align-items:flex-end; justify-content:space-between;
      margin-bottom: 1rem;
    }
    .page-sub{ color: var(--bs-secondary-color); }

    /* --- Template cards --- */
    .template-toolbar{
      display:flex; flex-wrap:wrap; gap:.5rem;
      align-items:center; justify-content:space-between;
      margin-bottom:.75rem;
    }

    .template-card{
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: .75rem;
      padding: .85rem;
      background: #fff;
    }
    .template-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 .55rem 1.2rem rgba(0,0,0,.08);
      border-color: rgba(13,110,253,.35) !important;
    }
    .template-card.active{
      border-color: rgba(13,110,253,.75) !important;
      box-shadow: 0 .75rem 1.25rem rgba(13,110,253,.12);
      background: rgba(13,110,253,.04);
    }
    .template-meta{
      font-size:.85rem;
      color: var(--bs-secondary-color);
    }

    .tpl-badge{
      font-size:.75rem;
      padding:.15rem .45rem;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.02);
      color: var(--bs-secondary-color);
      white-space: nowrap;
    }

    /* --- Live totals --- */
    #liveTotal, #liveAnnual{
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    /* --- Table --- */
    .table thead th{ white-space: nowrap; }
    .cost-row{ vertical-align: middle; }
    .cost-actions{ white-space: nowrap; }
    .desc-row td{ background: rgba(108,117,125,.08); }

    /* --- Small helpers --- */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding: .15rem .55rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.02);
      font-size: .82rem;
      color: var(--bs-secondary-color);
      white-space: nowrap;
    }
    .muted-hint{ color: var(--bs-secondary-color); font-size: .9rem; }

    /* --- Actions buttons --- */
    .btn-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 34px;
      height: 34px;
      padding: 0;
      border-radius: .6rem;
    }
    .actions-wrap{
      display:inline-flex;
      gap:.35rem;
      justify-content:flex-end;
    }
    .tpl-actions{
      display:flex;
      gap:.35rem;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
  </style>

  <!-- Header -->
  <div class="page-head">
    <div>
      <h2 class="mb-1">Maliyet YÃ¶netimi</h2>
      <div class="page-sub">
        Åablondan seÃ§, maliyet gir, aÃ§Ä±klamasÄ±nÄ± yaz; sonra Pareto/Pareto Front ile nereye odaklanacaÄŸÄ±nÄ± gÃ¶r.
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="chip">AnlÄ±k Toplam: <strong id="liveTotal">0</strong></span>
      <span class="chip">YÄ±llÄ±klaÅŸtÄ±rÄ±lmÄ±ÅŸ: <strong id="liveAnnual">0</strong></span>
    </div>
  </div>

  <div class="row g-3">

    <!-- LEFT: Templates -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between gap-2">
          <div>
            <div class="fw-semibold">Maliyet ÅablonlarÄ±</div>
            <small class="text-muted">Formu otomatik doldurur</small>
          </div>

          <!-- âœ… Yeni Åablon butonu (Ã‡ALIÅIR: modal aÃ§ar) -->
          <button type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#tplCreateModal">
            + Yeni Åablon
          </button>
        </div>

        <div class="card-body">
          <div class="template-toolbar">
            <div class="input-group" style="max-width: 360px;">
              <span class="input-group-text">Ara</span>
              <input class="form-control" id="tplSearch" placeholder="Ã–rn: lisans, ekipman, eÄŸitim">
              <button class="btn btn-outline-secondary" id="tplClearSearch" type="button">Temizle</button>
            </div>

            <div class="d-flex gap-2">
              <select class="form-select" id="tplCategory" style="min-width: 170px;">
                <option value="">TÃ¼mÃ¼</option>
                <option value="Ä°ÅŸ GÃ¼cÃ¼">Ä°ÅŸ GÃ¼cÃ¼</option>
                <option value="Ekipman">Ekipman</option>
                <option value="YazÄ±lÄ±m">YazÄ±lÄ±m</option>
                <option value="EÄŸitim">EÄŸitim</option>
                <option value="Hizmet">Hizmet</option>
                <option value="Operasyon">Operasyon</option>
              </select>
            </div>
          </div>

          <div class="row g-2" id="tplGrid">

            {# âœ… 1) DBâ€™den gelen ÅŸablonlar (edit/delete burada) #}
            {% if cost_templates and cost_templates|length > 0 %}
              <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <div class="fw-semibold">Senin ÅablonlarÄ±n</div>
                  <span class="tpl-badge">{{ cost_templates|length }} adet</span>
                </div>
              </div>

              {% for t in cost_templates %}
                <div class="col-12">
                  <div class="template-card"
                       data-tpl-id="{{ t.id }}"
                       data-title="{{ (t.title or '')|e }}"
                       data-category="{{ (t.category or '')|e }}"
                       data-unit="{{ (t.unit or '')|e }}"
                       data-currency="{{ (t.currency or 'TRY')|e }}"
                       data-frequency="{{ (t.frequency or 'Tek Sefer')|e }}"
                       data-desc="{{ (t.description or '')|e }}"
                       data-edit-url="{{ url_for('cost_template_edit_post', tpl_id=t.id) }}"
                       role="button" tabindex="0" aria-label="Åablon: {{ t.title|e }}">

                    <div class="d-flex align-items-start justify-content-between gap-2">
                      <div>
                        <div class="fw-semibold">{{ t.title }}</div>
                        <div class="template-meta">
                          {{ t.category }} â€¢ {{ t.unit }} â€¢ {{ t.currency }} â€¢ {{ t.frequency }}
                        </div>
                      </div>

                      <div class="tpl-actions">
                        <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>

                        <!-- âœ… DÃ¼zenle -->
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary tpl-edit"
                                data-bs-toggle="modal"
                                data-bs-target="#tplEditModal">
                          DÃ¼zenle
                        </button>

                        <!-- âœ… Sil -->
                        <form method="post"
                              action="{{ url_for('cost_template_delete', tpl_id=t.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Bu ÅŸablonu silmek istiyor musun?');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Sil
                          </button>
                        </form>
                      </div>
                    </div>

                    <div class="small text-muted mt-2">
                      {{ t.description or '-' }}
                    </div>
                  </div>
                </div>
              {% endfor %}

              <hr class="my-3">
            {% endif %}

            {# 2) VarsayÄ±lan ÅŸablonlar (hard-coded, sadece uygula) #}
            <div class="col-12">
              <div class="d-flex align-items-center justify-content-between mb-1">
                <div class="fw-semibold">VarsayÄ±lan Åablonlar</div>
                <span class="tpl-badge">HazÄ±r</span>
              </div>
            </div>

            <!-- Åablon KartlarÄ± -->
            <div class="col-12">
              <div class="template-card"
                   data-title="Personel / Mesai"
                   data-category="Ä°ÅŸ GÃ¼cÃ¼"
                   data-unit="saat"
                   data-currency="TRY"
                   data-frequency="Tek Sefer"
                   data-desc="Ek mesai, vardiya, geÃ§ici personel, fazla iÅŸ yÃ¼kÃ¼ iÃ§in maliyet."
                   role="button" tabindex="0" aria-label="Åablon: Personel / Mesai">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">Personel / Mesai</div>
                    <div class="template-meta">Ä°ÅŸ GÃ¼cÃ¼ â€¢ saat â€¢ TRY â€¢ Tek Sefer</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">Ek mesai, vardiya, geÃ§ici personel gibi kalemler.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="Ekipman / DonanÄ±m"
                   data-category="Ekipman"
                   data-unit="adet"
                   data-currency="TRY"
                   data-frequency="Tek Sefer"
                   data-desc="DonanÄ±m alÄ±mÄ±, yedek parÃ§a, sensÃ¶r, cihaz, aÄŸ ekipmanÄ± vb."
                   role="button" tabindex="0" aria-label="Åablon: Ekipman / DonanÄ±m">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">Ekipman / DonanÄ±m</div>
                    <div class="template-meta">Ekipman â€¢ adet â€¢ TRY â€¢ Tek Sefer</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">DonanÄ±m, yedek parÃ§a, cihaz, kurulum.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="YazÄ±lÄ±m LisansÄ±"
                   data-category="YazÄ±lÄ±m"
                   data-unit="lisans"
                   data-currency="USD"
                   data-frequency="AylÄ±k"
                   data-desc="Abonelik, lisans yenileme, kullanÄ±cÄ± baÅŸÄ± Ã¼cret vb."
                   role="button" tabindex="0" aria-label="Åablon: YazÄ±lÄ±m LisansÄ±">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">YazÄ±lÄ±m LisansÄ±</div>
                    <div class="template-meta">YazÄ±lÄ±m â€¢ lisans â€¢ USD â€¢ AylÄ±k</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">Abonelik, kullanÄ±cÄ± baÅŸÄ± Ã¼cret, lisans yenileme.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="EÄŸitim / Sertifika"
                   data-category="EÄŸitim"
                   data-unit="kiÅŸi"
                   data-currency="TRY"
                   data-frequency="Tek Sefer"
                   data-desc="EÄŸitim, sertifika, workshop, onboarding maliyetleri."
                   role="button" tabindex="0" aria-label="Åablon: EÄŸitim / Sertifika">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">EÄŸitim / Sertifika</div>
                    <div class="template-meta">EÄŸitim â€¢ kiÅŸi â€¢ TRY â€¢ Tek Sefer</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">EÄŸitim, sertifika, workshop, onboarding.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="DanÄ±ÅŸmanlÄ±k / DÄ±ÅŸ Kaynak"
                   data-category="Hizmet"
                   data-unit="gÃ¼n"
                   data-currency="TRY"
                   data-frequency="Tek Sefer"
                   data-desc="DanÄ±ÅŸmanlÄ±k gÃ¼nÃ¼, dÄ±ÅŸ kaynak ekip, audit, test hizmetleri vb."
                   role="button" tabindex="0" aria-label="Åablon: DanÄ±ÅŸmanlÄ±k / DÄ±ÅŸ Kaynak">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">DanÄ±ÅŸmanlÄ±k / DÄ±ÅŸ Kaynak</div>
                    <div class="template-meta">Hizmet â€¢ gÃ¼n â€¢ TRY â€¢ Tek Sefer</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">DanÄ±ÅŸmanlÄ±k, audit, dÄ±ÅŸ kaynak geliÅŸtirme, test.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="BakÄ±m / OnarÄ±m"
                   data-category="Operasyon"
                   data-unit="iÅŸ"
                   data-currency="TRY"
                   data-frequency="Tek Sefer"
                   data-desc="ArÄ±za, bakÄ±m, onarÄ±m, bakÄ±m anlaÅŸmasÄ± dÄ±ÅŸÄ± iÅŸler."
                   role="button" tabindex="0" aria-label="Åablon: BakÄ±m / OnarÄ±m">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">BakÄ±m / OnarÄ±m</div>
                    <div class="template-meta">Operasyon â€¢ iÅŸ â€¢ TRY â€¢ Tek Sefer</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">ArÄ±za, bakÄ±m, servis, parÃ§a deÄŸiÅŸimi.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="Seyahat / UlaÅŸÄ±m"
                   data-category="Operasyon"
                   data-unit="gÃ¼n"
                   data-currency="TRY"
                   data-frequency="Tek Sefer"
                   data-desc="Saha ziyareti, yol, konaklama, harcÄ±rah vb."
                   role="button" tabindex="0" aria-label="Åablon: Seyahat / UlaÅŸÄ±m">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">Seyahat / UlaÅŸÄ±m</div>
                    <div class="template-meta">Operasyon â€¢ gÃ¼n â€¢ TRY â€¢ Tek Sefer</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">Saha iÅŸi, yol, konaklama, harcÄ±rah.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="Bulut / Sunucu"
                   data-category="YazÄ±lÄ±m"
                   data-unit="ay"
                   data-currency="USD"
                   data-frequency="AylÄ±k"
                   data-desc="Sunucu, storage, trafik, managed servis, izleme vb."
                   role="button" tabindex="0" aria-label="Åablon: Bulut / Sunucu">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">Bulut / Sunucu</div>
                    <div class="template-meta">YazÄ±lÄ±m â€¢ ay â€¢ USD â€¢ AylÄ±k</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">Sunucu, storage, trafik, izleme, backup.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="template-card"
                   data-title="Denetim / Uyum"
                   data-category="Hizmet"
                   data-unit="iÅŸ"
                   data-currency="TRY"
                   data-frequency="YÄ±llÄ±k"
                   data-desc="ISO, KVKK, gÃ¼venlik denetimi, uyum danÄ±ÅŸmanlÄ±ÄŸÄ± vb."
                   role="button" tabindex="0" aria-label="Åablon: Denetim / Uyum">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold">Denetim / Uyum</div>
                    <div class="template-meta">Hizmet â€¢ iÅŸ â€¢ TRY â€¢ YÄ±llÄ±k</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary use-template">Uygula</button>
                </div>
                <div class="small text-muted mt-2">Denetim, sertifikasyon, uyum iÅŸleri.</div>
              </div>
            </div>

          </div>

          <hr class="my-3">
          <div class="muted-hint">
            Åablonlar â€œtemel varsayÄ±mlarâ€ iÃ§indir. GerÃ§ek dÃ¼nyada her ÅŸey daha karmaÅŸÄ±k.
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Add cost form -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Maliyet Ekle</div>
        <div class="card-body">

          <form method="post" action="{{ url_for('costs') }}" id="costForm" novalidate>
            {# Flask-WTF kullanÄ±yorsan aÃ§: {{ form.csrf_token }} #}

            <div class="row g-3">

              <div class="col-12 col-md-6">
                <label class="form-label">BaÅŸlÄ±k</label>
                <input class="form-control" name="title" id="title" placeholder="Ã–rn: YazÄ±lÄ±m lisansÄ±" required>
                <div class="invalid-feedback">BaÅŸlÄ±k gerekli.</div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Kategori</label>
                <input class="form-control" name="category" id="category" placeholder="Ã–rn: YazÄ±lÄ±m" required>
                <div class="invalid-feedback">Kategori gerekli.</div>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">Birim</label>
                <input class="form-control" name="unit" id="unit" placeholder="adet / saat / gÃ¼n / lisans" required>
                <div class="invalid-feedback">Birim gerekli.</div>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">Para Birimi</label>
                <select class="form-select" name="currency" id="currency">
                  <option value="TRY">TRY</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">SÄ±klÄ±k</label>
                <select class="form-select" name="frequency" id="frequency">
                  <option>Tek Sefer</option>
                  <option>AylÄ±k</option>
                  <option>YÄ±llÄ±k</option>
                </select>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Miktar (adet/saat/gÃ¼n)</label>
                <input class="form-control" type="number" step="0.01" min="0" name="qty" id="qty" placeholder="Ã–rn: 10" required>
                <div class="invalid-feedback">Miktar gerekli ve 0â€™dan bÃ¼yÃ¼k olmalÄ±.</div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Birim Fiyat</label>
                <input class="form-control" type="number" step="0.01" min="0" name="unit_price" id="unit_price" placeholder="Ã–rn: 2500" required>
                <div class="invalid-feedback">Birim fiyat gerekli ve 0â€™dan bÃ¼yÃ¼k olmalÄ±.</div>
              </div>

              <div class="col-12">
                <label class="form-label">Maliyet AÃ§Ä±klamasÄ±</label>
                <textarea class="form-control" rows="3" name="description" id="description"
                          placeholder="Bu maliyet neden var, hangi riske/Ã¶nleme baÄŸlÄ±, varsayÄ±mlar neler?"></textarea>
              </div>

              <div class="col-12 d-flex flex-wrap gap-2">
                <button type="submit" class="btn btn-primary">Kaydet</button>
                <button type="button" class="btn btn-outline-secondary" id="clearForm">Formu Temizle</button>

                <div class="ms-auto text-muted small d-flex align-items-center gap-2">
                  <span>AnlÄ±k: <span class="fw-semibold" id="liveTotalInline">0</span></span>
                  <span class="d-none d-md-inline">â€¢</span>
                  <span>YÄ±llÄ±k: <span class="fw-semibold" id="liveAnnualInline">0</span></span>
                </div>
              </div>

            </div>
          </form>

        </div>
      </div>

      <!-- Costs list -->
      <div class="card shadow-sm mt-3">
        <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div class="fw-semibold">Mevcut Maliyetler</div>

          <div class="d-flex flex-wrap gap-2 align-items-center">
            <div class="input-group input-group-sm" style="max-width: 260px;">
              <span class="input-group-text">Filtre</span>
              <input class="form-control" id="tableSearch" placeholder="BaÅŸlÄ±k / kategori">
              <button class="btn btn-outline-secondary" id="tableClearSearch" type="button">X</button>
            </div>

            <select class="form-select form-select-sm" id="tableCurrency" style="min-width: 110px;">
              <option value="">PB</option>
              <option value="TRY">TRY</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>

            <select class="form-select form-select-sm" id="tableFrequency" style="min-width: 120px;">
              <option value="">SÄ±klÄ±k</option>
              <option>Tek Sefer</option>
              <option>AylÄ±k</option>
              <option>YÄ±llÄ±k</option>
            </select>

            <button class="btn btn-sm btn-outline-primary" id="exportCsv" type="button">CSV</button>
          </div>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle" id="costTable">
              <thead class="table-light">
                <tr>
                  <th role="button" class="sortable" data-sort="title">BaÅŸlÄ±k</th>
                  <th role="button" class="sortable" data-sort="category">Kategori</th>
                  <th class="text-end" role="button" class="sortable" data-sort="qty">Miktar</th>
                  <th class="text-end" role="button" class="sortable" data-sort="unit_price">Birim Fiyat</th>
                  <th class="text-end" role="button" class="sortable" data-sort="total">Toplam</th>
                  <th class="text-end" role="button" class="sortable" data-sort="frequency">SÄ±klÄ±k</th>
                  <th class="text-end">Detay</th>
                  <th class="text-end">Ä°ÅŸlem</th>
                </tr>
              </thead>

              <tbody id="costTbody">
                {% if costs and costs|length > 0 %}
                  {% for c in costs %}
                    <tr class="cost-row"
                        data-id="{{ c.id }}"
                        data-title="{{ (c.title or '')|e }}"
                        data-category="{{ (c.category or '')|e }}"
                        data-currency="{{ (c.currency or '')|e }}"
                        data-frequency="{{ (c.frequency or '')|e }}"
                        data-qty="{{ c.qty }}"
                        data-unit_price="{{ c.unit_price }}"
                        data-total="{{ c.total }}">
                      <td class="fw-semibold">{{ c.title }}</td>
                      <td>{{ c.category }}</td>
                      <td class="text-end">{{ c.qty }}</td>
                      <td class="text-end">{{ c.unit_price }} {{ c.currency }}</td>
                      <td class="text-end fw-semibold">{{ c.total }} {{ c.currency }}</td>
                      <td class="text-end">{{ c.frequency }}</td>

                      <td class="text-end cost-actions">
                        {% if c.description %}
                          <button class="btn btn-sm btn-outline-secondary"
                                  type="button"
                                  data-bs-toggle="collapse"
                                  data-bs-target="#desc_{{ loop.index }}"
                                  aria-expanded="false"
                                  aria-controls="desc_{{ loop.index }}">
                            AÃ§Ä±klama
                          </button>
                        {% else %}
                          <span class="text-muted small">-</span>
                        {% endif %}
                      </td>

                      <td class="text-end">
                        <div class="actions-wrap">
                          <a class="btn btn-outline-primary btn-sm btn-icon"
                             href="{{ url_for('cost_edit', cost_id=c.id) }}"
                             title="DÃ¼zenle"
                             aria-label="DÃ¼zenle">âœ</a>

                          <form method="post"
                                action="{{ url_for('cost_delete', cost_id=c.id) }}"
                                class="d-inline"
                                onsubmit="return confirm('Bu maliyeti silmek istiyor musun?');">
                            <button type="submit"
                                    class="btn btn-outline-danger btn-sm btn-icon"
                                    title="Sil"
                                    aria-label="Sil">ğŸ—‘</button>
                          </form>
                        </div>
                      </td>
                    </tr>

                    {% if c.description %}
                      <tr class="desc-row">
                        <td colspan="8" class="p-0">
                          <div class="collapse" id="desc_{{ loop.index }}">
                            <div class="p-3 small">
                              <span class="fw-semibold">AÃ§Ä±klama:</span>
                              <span class="text-muted">{{ c.description }}</span>
                            </div>
                          </div>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                      HenÃ¼z maliyet yok.
                    </td>
                  </tr>
                {% endif %}
              </tbody>

              <tfoot class="table-light">
                <tr>
                  <th colspan="4" class="text-end">GÃ¶rÃ¼nen satÄ±rlarÄ±n toplamÄ±</th>
                  <th class="text-end" id="tableTotalCell">0</th>
                  <th colspan="3"></th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="px-3 py-2 small text-muted" id="tableHint">
            Ä°pucu: BaÅŸlÄ±klara tÄ±klayÄ±p sÄ±ralayabilirsin. Filtreler sadece tabloda gÃ¶rÃ¼nenleri etkiler.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Charts: Pareto + Pareto Front -->
  <div class="row g-3 mt-2">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Pareto Analizi</div>
        <div class="card-body">
          <div class="text-muted small mb-2">
            En yÃ¼ksek etkiyi en az kaynakla yakalama denemesi. Matematik romantizmi.
          </div>
          <canvas id="paretoChart" height="140"></canvas>
          <div id="paretoEmpty" class="text-muted small mt-2" style="display:none;">
            Pareto verisi yok (ya da backend henÃ¼z gÃ¶ndermiyor).
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Pareto Front</div>
        <div class="card-body">
          <div class="text-muted small mb-2">
            Maliyet (x) ve fayda/azaltÄ±m (y) arasÄ±nda â€œen iyiâ€ noktalar kÃ¼mesi.
          </div>
          <canvas id="frontChart" height="140"></canvas>
          <div id="frontEmpty" class="text-muted small mt-2" style="display:none;">
            Pareto front verisi yok (ya da backend henÃ¼z gÃ¶ndermiyor).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Source cards -->
  <div class="card shadow-sm mt-3">
    <div class="card-header fw-semibold">Kaynak (resimdeki linkler)</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <a class="text-decoration-none" target="_blank"
             href="https://youtu.be/Rv5vV_PV_lg?si=lTJGKHGMMY2mrIB7">
            <div class="border rounded p-3 h-100">
              <div class="fw-semibold">Pareto Front Optimization in EXCEL (3 Minutes!)</div>
              <div class="text-muted small mt-1">
                â€œMaliyet vs faydaâ€ gÃ¶rselleÅŸtirme fikri.
              </div>
              <div class="small mt-2">YouTubeâ€™a git â†’</div>
            </div>
          </a>
        </div>
        <div class="col-12 col-lg-6">
          <a class="text-decoration-none" target="_blank"
             href="https://youtu.be/kMDMA3KqSl4?si=cZffA-cUFpqVR-m9">
            <div class="border rounded p-3 h-100">
              <div class="fw-semibold">Pareto Analysis (Risk Analysis and Management)</div>
              <div class="text-muted small mt-1">
                Pareto mantÄ±ÄŸÄ± ile â€œÃ¶nce neye odaklanalÄ±mâ€ kararÄ±.
              </div>
              <div class="small mt-2">YouTubeâ€™a git â†’</div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- JSON: gÃ¼venli gÃ¶mme -->
<script id="paretoData" type="application/json">{{ pareto_json|default(None)|tojson }}</script>
<script id="frontData"  type="application/json">{{ front_json|default(None)|tojson }}</script>

<!-- =========================
     âœ… TEMPLATE MODALS
========================= -->

<!-- Create Template Modal -->
<div class="modal fade" id="tplCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('cost_template_create') }}" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Yeni Åablon Ekle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">BaÅŸlÄ±k</label>
              <input class="form-control" name="title" required>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Kategori</label>
              <input class="form-control" name="category" required>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Birim</label>
              <input class="form-control" name="unit" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Para Birimi</label>
              <select class="form-select" name="currency">
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">SÄ±klÄ±k</label>
              <select class="form-select" name="frequency">
                <option>Tek Sefer</option>
                <option>AylÄ±k</option>
                <option>YÄ±llÄ±k</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">AÃ§Ä±klama</label>
              <textarea class="form-control" rows="3" name="description"
                        placeholder="VarsayÄ±mlar / kullanÄ±m amacÄ±"></textarea>
            </div>

            <div class="col-12">
              <div class="text-muted small">
                Not: Bu ÅŸablon sadece sol taraftaki â€œÅablonlarâ€ listesini bÃ¼yÃ¼tÃ¼r. Maliyet eklemek iÃ§in saÄŸdaki formu kullanÄ±rsÄ±n.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">VazgeÃ§</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Template Modal -->
<div class="modal fade" id="tplEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="tplEditForm" action="#">
        <div class="modal-header">
          <h5 class="modal-title">Åablonu DÃ¼zenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">BaÅŸlÄ±k</label>
              <input class="form-control" name="title" id="tplEditTitle" required>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Kategori</label>
              <input class="form-control" name="category" id="tplEditCategory" required>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Birim</label>
              <input class="form-control" name="unit" id="tplEditUnit" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Para Birimi</label>
              <select class="form-select" name="currency" id="tplEditCurrency">
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">SÄ±klÄ±k</label>
              <select class="form-select" name="frequency" id="tplEditFrequency">
                <option>Tek Sefer</option>
                <option>AylÄ±k</option>
                <option>YÄ±llÄ±k</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">AÃ§Ä±klama</label>
              <textarea class="form-control" rows="3" name="description" id="tplEditDesc"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
          <button type="submit" class="btn btn-primary">GÃ¼ncelle</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    (function(){
      function onReady(fn){
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
        else fn();
      }

      onReady(() => {
        const $  = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        const nf2 = new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function safeParseJSON(txt){
          const t = (txt || '').trim();
          if (!t) return null;
          try {
            const v = JSON.parse(t);
            if (typeof v === 'string') {
              try { return JSON.parse(v); } catch { return v; }
            }
            return v;
          } catch {
            return null;
          }
        }

        function readJson(id) {
          const el = document.getElementById(id);
          if (!el) return null;
          return safeParseJSON(el.textContent || 'null');
        }

        function numVal(id) {
          const v = parseFloat(document.getElementById(id)?.value ?? '0');
          return Number.isFinite(v) ? v : 0;
        }

        function setVal(id, val) {
          const el = document.getElementById(id);
          if (el) el.value = val ?? '';
        }

        function markActiveTemplate(card) {
          $$('.template-card.active').forEach(x => x.classList.remove('active'));
          if (card) card.classList.add('active');
        }

        function annualFactor(freq){
          if (freq === 'AylÄ±k') return 12;
          if (freq === 'YÄ±llÄ±k') return 1;
          return 1; // Tek Sefer
        }

        function formatMoney(amount, cur){
          const safe = Number.isFinite(amount) ? amount : 0;
          return `${nf2.format(safe)} ${cur || ''}`.trim();
        }

        function updateLiveTotals() {
          const qty = numVal('qty');
          const unitPrice = numVal('unit_price');
          const cur = $('#currency')?.value || '';
          const freq = $('#frequency')?.value || 'Tek Sefer';

          const total = qty * unitPrice;
          const annual = total * annualFactor(freq);

          const t1 = $('#liveTotal');
          const t2 = $('#liveAnnual');
          const i1 = $('#liveTotalInline');
          const i2 = $('#liveAnnualInline');

          const totalTxt = formatMoney(total, cur);
          const annualTxt = formatMoney(annual, cur);

          if (t1) t1.textContent = totalTxt;
          if (t2) t2.textContent = annualTxt;
          if (i1) i1.textContent = totalTxt;
          if (i2) i2.textContent = annualTxt;
        }

        function applyTemplate(card) {
          const title     = card.getAttribute('data-title')     || '';
          const category  = card.getAttribute('data-category')  || '';
          const unit      = card.getAttribute('data-unit')      || '';
          const currency  = card.getAttribute('data-currency')  || 'TRY';
          const frequency = card.getAttribute('data-frequency') || 'Tek Sefer';
          const desc      = card.getAttribute('data-desc')      || '';

          setVal('title', title);
          setVal('category', category);
          setVal('unit', unit);
          setVal('currency', currency);
          setVal('frequency', frequency);

          const d = $('#description');
          if (d && !d.value.trim()) d.value = desc;

          markActiveTemplate(card);
          updateLiveTotals();
          $('#qty')?.focus();
        }

        function clearForm() {
          ['title','category','unit','qty','unit_price','description'].forEach(id => setVal(id, ''));
          setVal('currency', 'TRY');
          setVal('frequency', 'Tek Sefer');
          markActiveTemplate(null);
          updateLiveTotals();
          $('#title')?.focus();
        }

        /* -----------------------
           Templates: filter/search
        ------------------------*/
        function normalize(s){ return (s || '').toString().toLowerCase().trim(); }

        function filterTemplates(){
          const q = normalize($('#tplSearch')?.value);
          const cat = $('#tplCategory')?.value || '';

          $$('.template-card', $('#tplGrid')).forEach(card => {
            const t = normalize(card.getAttribute('data-title'));
            const c = card.getAttribute('data-category') || '';
            const okQ = !q || t.includes(q) || normalize(card.textContent).includes(q);
            const okC = !cat || c === cat;
            const col = card.closest('.col-12');
            if (col) col.style.display = (okQ && okC) ? '' : 'none';
          });
        }

        $('#tplSearch')?.addEventListener('input', filterTemplates);
        $('#tplCategory')?.addEventListener('change', filterTemplates);
        $('#tplClearSearch')?.addEventListener('click', () => { $('#tplSearch').value=''; filterTemplates(); });

        /* -----------------------
           Click delegation
        ------------------------*/
        document.addEventListener('click', (e) => {
          const clearBtn = e.target.closest('#clearForm');
          if (clearBtn) { e.preventDefault(); clearForm(); return; }

          // âœ… Template apply
          const applyBtn = e.target.closest('.use-template');
          if (applyBtn) {
            e.preventDefault();
            const card = applyBtn.closest('.template-card');
            if (card) applyTemplate(card);
            return;
          }

          // âœ… Template edit (modal iÃ§ini doldur)
          const editBtn = e.target.closest('.tpl-edit');
          if (editBtn) {
            const card = editBtn.closest('.template-card');
            if (!card) return;

            const editUrl = card.getAttribute('data-edit-url') || '#';
            const form = document.getElementById('tplEditForm');
            if (form) form.action = editUrl;

            const get = (k) => card.getAttribute(k) || '';

            const title = get('data-title');
            const category = get('data-category');
            const unit = get('data-unit');
            const currency = get('data-currency');
            const frequency = get('data-frequency');
            const desc = get('data-desc');

            const t = document.getElementById('tplEditTitle');
            const c = document.getElementById('tplEditCategory');
            const u = document.getElementById('tplEditUnit');
            const cu = document.getElementById('tplEditCurrency');
            const f = document.getElementById('tplEditFrequency');
            const d = document.getElementById('tplEditDesc');

            if (t) t.value = title;
            if (c) c.value = category;
            if (u) u.value = unit;
            if (cu) cu.value = currency || 'TRY';
            if (f) f.value = frequency || 'Tek Sefer';
            if (d) d.value = desc || '';

            return;
          }

          // âœ… Card click -> apply (ama buton/form/a vb tÄ±klanÄ±nca apply olmasÄ±n)
          const card = e.target.closest('.template-card');
          if (card) {
            const blocked = e.target.closest('button, a, input, select, textarea, label, form');
            if (!blocked) applyTemplate(card);
          }
        });

        document.addEventListener('keydown', (e) => {
          const card = e.target.closest?.('.template-card');
          if (!card) return;
          if (e.key === 'Enter' || e.key === ' ') {
            const blocked = e.target.closest('button, a, input, select, textarea, label, form');
            if (blocked) return;
            e.preventDefault();
            applyTemplate(card);
          }
        });

        /* -----------------------
           Live total updates
        ------------------------*/
        document.addEventListener('input', (e) => {
          if (e.target.matches('#qty, #unit_price, #currency, #frequency')) updateLiveTotals();
        });
        document.addEventListener('change', (e) => {
          if (e.target.matches('#qty, #unit_price, #currency, #frequency')) updateLiveTotals();
        });
        updateLiveTotals();

        /* -----------------------
           Form validation (Bootstrap-ish)
        ------------------------*/
        $('#costForm')?.addEventListener('submit', (e) => {
          let ok = true;

          ['title','category','unit'].forEach(id => {
            const el = $('#' + id);
            if (!el) return;
            const good = !!el.value.trim();
            el.classList.toggle('is-invalid', !good);
            ok = ok && good;
          });

          ['qty','unit_price'].forEach(id => {
            const el = $('#' + id);
            if (!el) return;
            const v = parseFloat(el.value);
            const good = Number.isFinite(v) && v > 0;
            el.classList.toggle('is-invalid', !good);
            ok = ok && good;
          });

          if (!ok) {
            e.preventDefault();
            e.stopPropagation();
          }
        });

        /* -----------------------
           Table: filter/sort/total/csv
        ------------------------*/
        const tbody = $('#costTbody');
        const tableTotalCell = $('#tableTotalCell');
        const tableSearch = $('#tableSearch');
        const tableCurrency = $('#tableCurrency');
        const tableFrequency = $('#tableFrequency');

        function visibleCostRows(){
          if (!tbody) return [];
          return $$('.cost-row', tbody).filter(r => r.style.display !== 'none');
        }

        function recomputeTableTotal(){
          const rows = visibleCostRows();
          const sums = {};
          rows.forEach(r => {
            const cur = r.dataset.currency || '';
            const total = parseFloat(r.dataset.total || '0');
            if (!Number.isFinite(total)) return;
            sums[cur] = (sums[cur] || 0) + total;
          });

          const currencies = Object.keys(sums).filter(Boolean);
          if (!tableTotalCell) return;

          if (currencies.length === 0) {
            tableTotalCell.textContent = '0';
            tableTotalCell.title = '';
            return;
          }

          if (currencies.length === 1) {
            const cur = currencies[0];
            tableTotalCell.textContent = formatMoney(sums[cur], cur);
            tableTotalCell.title = '';
            return;
          }

          tableTotalCell.textContent = 'â€”';
          tableTotalCell.title = currencies.map(c => `${c}: ${nf2.format(sums[c])}`).join(' | ');
        }

        function filterTable(){
          const q = normalize(tableSearch?.value);
          const cur = tableCurrency?.value || '';
          const freq = tableFrequency?.value || '';

          $$('.cost-row', tbody).forEach(r => {
            const t = normalize(r.dataset.title);
            const c = normalize(r.dataset.category);
            const okQ = !q || t.includes(q) || c.includes(q);
            const okC = !cur || (r.dataset.currency === cur);
            const okF = !freq || (r.dataset.frequency === freq);

            r.style.display = (okQ && okC && okF) ? '' : 'none';

            const next = r.nextElementSibling;
            if (next && next.classList.contains('desc-row')) {
              next.style.display = r.style.display;
            }
          });

          recomputeTableTotal();
        }

        tableSearch?.addEventListener('input', filterTable);
        tableCurrency?.addEventListener('change', filterTable);
        tableFrequency?.addEventListener('change', filterTable);
        $('#tableClearSearch')?.addEventListener('click', () => { tableSearch.value=''; filterTable(); });

        let sortState = { key: null, dir: 1 };

        function rowKey(row, key){
          const d = row.dataset;
          if (key === 'qty' || key === 'unit_price' || key === 'total') {
            const v = parseFloat(d[key] || '0');
            return Number.isFinite(v) ? v : 0;
          }
          if (key === 'frequency') return (d.frequency || '');
          if (key === 'title') return (d.title || '');
          if (key === 'category') return (d.category || '');
          return '';
        }

        function sortTable(key){
          if (!tbody) return;

          if (sortState.key === key) sortState.dir *= -1;
          else { sortState.key = key; sortState.dir = 1; }

          const rows = $$('.cost-row', tbody);
          rows.sort((a,b) => {
            const av = rowKey(a, key);
            const bv = rowKey(b, key);
            if (typeof av === 'number' && typeof bv === 'number') return (av - bv) * sortState.dir;
            return av.toString().localeCompare(bv.toString(), 'tr', { sensitivity: 'base' }) * sortState.dir;
          });

          rows.forEach(r => {
            const desc = (r.nextElementSibling && r.nextElementSibling.classList.contains('desc-row'))
              ? r.nextElementSibling
              : null;

            tbody.appendChild(r);
            if (desc) tbody.appendChild(desc);
          });

          filterTable();
        }

        $$('.sortable').forEach(th => {
          th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort');
            if (key) sortTable(key);
          });
        });

        function exportVisibleCSV(){
          const rows = visibleCostRows();
          const headers = ['BaÅŸlÄ±k','Kategori','Miktar','Birim Fiyat','Toplam','Para Birimi','SÄ±klÄ±k'];
          const lines = [headers.join(',')];

          rows.forEach(r => {
            const title = (r.dataset.title || '').replaceAll('"','""');
            const cat   = (r.dataset.category || '').replaceAll('"','""');
            const qty   = r.dataset.qty || '';
            const up    = r.dataset.unit_price || '';
            const tot   = r.dataset.total || '';
            const cur   = r.dataset.currency || '';
            const frq   = r.dataset.frequency || '';
            lines.push(`"${title}","${cat}",${qty},${up},${tot},${cur},"${frq}"`);
          });

          const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'maliyetler.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        $('#exportCsv')?.addEventListener('click', exportVisibleCSV);

        // Ä°lk hesap
        filterTable();

        /* -----------------------
           Charts
        ------------------------*/
        const paretoRaw = readJson('paretoData');
        const frontRaw  = readJson('frontData');

        const pareto = Array.isArray(paretoRaw)
          ? { labels: paretoRaw.map(x => x.label),
              bars:   paretoRaw.map(x => x.value),
              line:   paretoRaw.map(x => x.cum_pct) }
          : paretoRaw;

        const front = Array.isArray(frontRaw)
          ? { points: frontRaw }
          : frontRaw;

        (function renderPareto() {
          const canvas = $('#paretoChart');
          const empty = $('#paretoEmpty');
          if (!canvas) return;

          if (!window.Chart) { if (empty) empty.style.display = 'block'; return; }
          if (!pareto || !pareto.labels || !pareto.bars || pareto.labels.length === 0) {
            if (empty) empty.style.display = 'block';
            return;
          }

          new Chart(canvas, {
            type: 'bar',
            data: {
              labels: pareto.labels,
              datasets: [
                { type: 'bar',  label: 'Skor / Etki', data: pareto.bars },
                { type: 'line', label: 'KÃ¼mÃ¼latif %', data: pareto.line || [], yAxisID: 'y1' }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Skor' } },
                y1: {
                  beginAtZero: true,
                  position: 'right',
                  min: 0,
                  max: 100,
                  grid: { drawOnChartArea: false },
                  title: { display: true, text: '%' }
                }
              }
            }
          });
        })();

        (function renderFront() {
          const canvas = $('#frontChart');
          const empty = $('#frontEmpty');
          if (!canvas) return;

          if (!window.Chart) { if (empty) empty.style.display = 'block'; return; }
          if (!front || !front.points || !Array.isArray(front.points) || front.points.length === 0) {
            if (empty) empty.style.display = 'block';
            return;
          }

          new Chart(canvas, {
            type: 'scatter',
            data: {
              datasets: [{
                label: 'Pareto NoktalarÄ±',
                data: front.points.map(p => ({ x: p.x, y: p.y })),
              }]
            },
            options: {
              responsive: true,
              parsing: false,
              scales: {
                x: { title: { display: true, text: 'Maliyet' } },
                y: { title: { display: true, text: 'Fayda / AzaltÄ±m' } }
              }
            }
          });
        })();

      });
    })();
  </script>
    <script>
    document.addEventListener('hidden.bs.modal', function () {
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('padding-right');
      document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    }, true);
  </script>

{% endblock %}
